!function e(t,r,n){function i(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};t[s][0].call(l.exports,(function(e){return i(t[s][1][e]||e)}),l,l.exports,e,t,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){t.exports=function(e){if(Array.isArray(e))return e}},{}],2:[function(e,t,r){t.exports=function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}},{}],3:[function(e,t,r){t.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},{}],4:[function(e,t,r){t.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],5:[function(e,t,r){var n=e("./setPrototypeOf");function i(e,r,o){return!function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?t.exports=i=function(e,t,r){var i=[null];i.push.apply(i,t);var o=new(Function.bind.apply(e,i));return r&&n(o,r.prototype),o}:t.exports=i=Reflect.construct,i.apply(null,arguments)}t.exports=i},{"./setPrototypeOf":18}],6:[function(e,t,r){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}t.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},{}],7:[function(e,t,r){t.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},{}],8:[function(e,t,r){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n},{}],9:[function(e,t,r){var n=e("./setPrototypeOf");t.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}},{"./setPrototypeOf":18}],10:[function(e,t,r){t.exports=function(e){return e&&e.__esModule?e:{default:e}}},{}],11:[function(e,t,r){var n=e("../helpers/typeof");function i(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return i=function(){return e},e}t.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==n(e)&&"function"!=typeof e)return{default:e};var t=i();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var a=o?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,t&&t.set(e,r),r}},{"../helpers/typeof":21}],12:[function(e,t,r){t.exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}},{}],13:[function(e,t,r){t.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},{}],14:[function(e,t,r){t.exports=function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}}},{}],15:[function(e,t,r){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},{}],16:[function(e,t,r){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},{}],17:[function(e,t,r){var n=e("../helpers/typeof"),i=e("./assertThisInitialized");t.exports=function(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?i(e):t}},{"../helpers/typeof":21,"./assertThisInitialized":3}],18:[function(e,t,r){function n(e,r){return t.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,r)}t.exports=n},{}],19:[function(e,t,r){var n=e("./arrayWithHoles"),i=e("./iterableToArrayLimit"),o=e("./nonIterableRest");t.exports=function(e,t){return n(e)||i(e,t)||o()}},{"./arrayWithHoles":1,"./iterableToArrayLimit":14,"./nonIterableRest":15}],20:[function(e,t,r){var n=e("./arrayWithoutHoles"),i=e("./iterableToArray"),o=e("./nonIterableSpread");t.exports=function(e){return n(e)||i(e)||o()}},{"./arrayWithoutHoles":2,"./iterableToArray":13,"./nonIterableSpread":16}],21:[function(e,t,r){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(e){return typeof e}:t.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}t.exports=n},{}],22:[function(e,t,r){var n=e("./getPrototypeOf"),i=e("./setPrototypeOf"),o=e("./isNativeFunction"),s=e("./construct");function a(e){var r="function"==typeof Map?new Map:void 0;return t.exports=a=function(e){if(null===e||!o(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return s(e,arguments,n(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i(t,e)},a(e)}t.exports=a},{"./construct":5,"./getPrototypeOf":8,"./isNativeFunction":12,"./setPrototypeOf":18}],23:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":43}],24:[function(e,t,r){"use strict";for(var n=/[\\\"\x00-\x1F]/g,i={},o=0;o<32;++o)i[String.fromCharCode(o)]="\\U"+("0000"+o.toString(16)).slice(-4).toUpperCase();function s(e){return n.lastIndex=0,e.replace(n,(function(e){return i[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=a(e[n]);return","!=t?"[]":r+"]"}(e):function(e){var t="{",r="",n=Object.keys(e);n.sort();for(var i=0;i<n.length;++i){var o=n[i];r+=t+'"'+s(o)+'":',t=",",r+=a(e[o])}return","!=t?"{}":r+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}i["\b"]="\\b",i["\t"]="\\t",i["\n"]="\\n",i["\f"]="\\f",i["\r"]="\\r",i['"']='\\"',i["\\"]="\\\\",t.exports={stringify:a}},{}],25:[function(e,t,r){"use strict";var n=e("safe-buffer").Buffer;t.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");var t=new Uint8Array(256);t.fill(255);for(var r=0;r<e.length;r++){var i=e.charAt(r),o=i.charCodeAt(0);if(255!==t[o])throw new TypeError(i+" is ambiguous");t[o]=r}var s=e.length,a=e.charAt(0),u=Math.log(s)/Math.log(256),c=Math.log(256)/Math.log(s);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return n.alloc(0);var r=0;if(" "!==e[r]){for(var i=0,o=0;e[r]===a;)i++,r++;for(var c=(e.length-r)*u+1>>>0,l=new Uint8Array(c);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var h=0,p=c-1;(0!==d||h<o)&&-1!==p;p--,h++)d+=s*l[p]>>>0,l[p]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");o=h,r++}if(" "!==e[r]){for(var f=c-o;f!==c&&0===l[f];)f++;var v=n.allocUnsafe(i+(c-f));v.fill(0,0,i);for(var g=i;f!==c;)v[g++]=l[f++];return v}}}return{encode:function(t){if(!n.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var r=0,i=0,o=0,u=t.length;o!==u&&0===t[o];)o++,r++;for(var l=(u-o)*c+1>>>0,d=new Uint8Array(l);o!==u;){for(var h=t[o],p=0,f=l-1;(0!==h||p<i)&&-1!==f;f--,p++)h+=256*d[f]>>>0,d[f]=h%s>>>0,h=h/s>>>0;if(0!==h)throw new Error("Non-zero carry");i=p,o++}for(var v=l-i;v!==l&&0===d[v];)v++;for(var g=a.repeat(r);v<l;++v)g+=e.charAt(d[v]);return g},decodeUnsafe:l,decode:function(e){var t=l(e);if(t)return t;throw new Error("Non-base"+s+" character")}}}},{"safe-buffer":44}],26:[function(e,t,r){"use strict";r.byteLength=function(e){var t=c(e),r=t[0],n=t[1];return 3*(r+n)/4-n},r.toByteArray=function(e){var t,r,n=c(e),s=n[0],a=n[1],u=new o(function(e,t,r){return 3*(t+r)/4-r}(0,s,a)),l=0,d=a>0?s-4:s;for(r=0;r<d;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;2===a&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,u[l++]=255&t);1===a&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t);return u},r.fromByteArray=function(e){for(var t,r=e.length,i=r%3,o=[],s=0,a=r-i;s<a;s+=16383)o.push(l(e,s,s+16383>a?a:s+16383));1===i?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return o.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,u=s.length;a<u;++a)n[a]=s[a],i[s.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var i,o,s=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],27:[function(e,t,r){var n,i;n=this,i=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");function t(o,s){if("function"!=typeof s)throw new Error("Bad callback given: "+s);if(!o)throw new Error("No options given");var a=o.onResponse;if((o="string"==typeof o?{uri:o}:JSON.parse(JSON.stringify(o))).onResponse=a,o.verbose&&(t.log=function(){var e,t,r={},o=["trace","debug","info","warn","error"];for(t=0;t<o.length;t++)r[e=o[t]]=n,"undefined"!=typeof console&&console&&console[e]&&(r[e]=i(console,e));return r}()),o.url&&(o.uri=o.url,delete o.url),!o.uri&&""!==o.uri)throw new Error("options.uri is a required argument");if("string"!=typeof o.uri)throw new Error("options.uri must be a string");for(var u=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],c=0;c<u.length;c++)if(o[u[c]])throw new Error("options."+u[c]+" is not supported");if(o.callback=s,o.method=o.method||"GET",o.headers=o.headers||{},o.body=o.body||null,o.timeout=o.timeout||t.DEFAULT_TIMEOUT,o.headers.host)throw new Error("Options.headers.host is not supported");o.json&&(o.headers.accept=o.headers.accept||"application/json","GET"!==o.method&&(o.headers["content-type"]="application/json"),"boolean"!=typeof o.json?o.body=JSON.stringify(o.json):"string"!=typeof o.body&&(o.body=JSON.stringify(o.body)));var l=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")};if(o.qs){var d="string"==typeof o.qs?o.qs:l(o.qs);-1!==o.uri.indexOf("?")?o.uri=o.uri+"&"+d:o.uri=o.uri+"?"+d}if(o.form){if("string"==typeof o.form)throw"form name unsupported";if("POST"===o.method){var h=(o.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(o.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":o.body=l(o.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+n+'"\n\n'+e[n]+"\n");return r.push("--"+t.boundry+"--"),t.body=r.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(o.form);o.body=p.body,o.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+h)}}}return o.onResponse=o.onResponse||n,!0===o.onResponse&&(o.onResponse=s,o.callback=n),!o.headers.authorization&&o.auth&&(o.headers.authorization="Basic "+function(e){var t,r,n,i,o,s,a,u,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,d=0,h="",p=[];if(!e)return e;do{t=e.charCodeAt(l++),r=e.charCodeAt(l++),n=e.charCodeAt(l++),i=(u=t<<16|r<<8|n)>>18&63,o=u>>12&63,s=u>>6&63,a=63&u,p[d++]=c.charAt(i)+c.charAt(o)+c.charAt(s)+c.charAt(a)}while(l<e.length);switch(h=p.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h}(o.auth.username+":"+o.auth.password)),function(n){var i=new e,o=!1,s=function(e){var t,r=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var n=r.exec(t.toLowerCase())||[],i=r.exec(e.toLowerCase());return!(!i||i[1]==n[1]&&i[2]==n[2]&&(i[3]||("http:"===i[1]?80:443))==(n[3]||("http:"===n[1]?80:443)))}(n.uri),a="withCredentials"in i;if(r+=1,i.seq_id=r,i.id=r+": "+n.method+" "+n.uri,i._id=i.id,s&&!a){var u=new Error("Browser does not support cross-origin request: "+n.uri);return u.cors="unsupported",n.callback(u,i)}i.timeoutTimer=setTimeout((function(){o=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=n.timeout,t.log.error("Timeout",{id:i._id,milliseconds:n.timeout}),n.callback(e,i)}),n.timeout);var c={response:!1,loading:!1,end:!1};return i.onreadystatechange=function(r){if(o)return t.log.debug("Ignoring timed out state change",{state:i.readyState,id:i.id});if(t.log.debug("State change",{state:i.readyState,id:i.id,timed_out:o}),i.readyState===e.OPENED)for(var s in t.log.debug("Request started",{id:i.id}),n.headers)i.setRequestHeader(s,n.headers[s]);else i.readyState===e.HEADERS_RECEIVED?l():i.readyState===e.LOADING?(l(),d()):i.readyState===e.DONE&&(l(),d(),function(){if(!c.end){if(c.end=!0,t.log.debug("Request done",{id:i.id}),i.body=i.responseText,n.json)try{i.body=JSON.parse(i.responseText)}catch(e){return n.callback(e,i)}n.callback(null,i,i.body)}}())},i.open(n.method,n.uri,!0),s&&(i.withCredentials=!!n.withCredentials),i.send(n.body),i;function l(){if(!c.response){if(c.response=!0,t.log.debug("Got response",{id:i.id,status:i.status}),clearTimeout(i.timeoutTimer),i.statusCode=i.status,s&&0==i.statusCode){var e=new Error("CORS request rejected: "+n.uri);return e.cors="rejected",c.loading=!0,c.end=!0,n.callback(e,i)}n.onResponse(null,i)}}function d(){c.loading||(c.loading=!0,t.log.debug("Response body loading",{id:i.id}))}}(o)}t.log={trace:n,debug:n,info:n,warn:n,error:n};var r=0;function n(){}function i(e,t){return function(r,n){return"object"==typeof n&&(r+=" "+JSON.stringify(n)),e[t].call(e,r)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,r){var n=function(t){return function(r,n){for(var i in r="string"==typeof r?{uri:r}:JSON.parse(JSON.stringify(r)),e)void 0===r[i]&&(r[i]=e[i]);return t(r,n)}},i=n(t);return i.get=n(t.get),i.post=n(t.post),i.put=n(t.put),i.head=n(t.head),i},["get","put","post","head"].forEach((function(e){var r=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:r,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=r;var n=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,n)}})),t.couch=function(e,r){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,r=r||n,t(e,(function(e,t,n){if(e)return r(e,t,n);if((t.statusCode<200||t.statusCode>299)&&n.error){for(var i in e=new Error("CouchDB error: "+(n.error.reason||n.error.error)),n)e[i]=n[i];return r(e,t,n)}return r(e,t,n)}))},t},"function"==typeof define&&define.amd?define([],i):"object"==typeof r?t.exports=i():n.returnExports=i()},{}],28:[function(e,t,r){(function(e){!function(n){var i="object"==typeof r&&r&&!r.nodeType&&r,o="object"==typeof t&&t&&!t.nodeType&&t,s="object"==typeof e&&e;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var a,u,c=2147483647,l=36,d=1,h=26,p=38,f=700,v=72,g=128,m="-",y=/^xn--/,_=/[^\x20-\x7E]/,b=/[\x2E\u3002\uFF0E\uFF61]/g,S={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},k=l-d,E=Math.floor,w=String.fromCharCode;function I(e){throw new RangeError(S[e])}function R(e,t){for(var r=e.length,n=[];r--;)n[r]=t(e[r]);return n}function T(e,t){var r=e.split("@"),n="";return r.length>1&&(n=r[0]+"@",e=r[1]),n+R((e=e.replace(b,".")).split("."),t).join(".")}function x(e){for(var t,r,n=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(r=e.charCodeAt(i++)))?n.push(((1023&t)<<10)+(1023&r)+65536):(n.push(t),i--):n.push(t);return n}function O(e){return R(e,(function(e){var t="";return e>65535&&(t+=w((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=w(e)})).join("")}function C(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function D(e,t,r){var n=0;for(e=r?E(e/f):e>>1,e+=E(e/t);e>k*h>>1;n+=l)e=E(e/k);return E(n+(k+1)*e/(e+p))}function A(e){var t,r,n,i,o,s,a,u,p,f,y,_=[],b=e.length,S=0,k=g,w=v;for((r=e.lastIndexOf(m))<0&&(r=0),n=0;n<r;++n)e.charCodeAt(n)>=128&&I("not-basic"),_.push(e.charCodeAt(n));for(i=r>0?r+1:0;i<b;){for(o=S,s=1,a=l;i>=b&&I("invalid-input"),((u=(y=e.charCodeAt(i++))-48<10?y-22:y-65<26?y-65:y-97<26?y-97:l)>=l||u>E((c-S)/s))&&I("overflow"),S+=u*s,!(u<(p=a<=w?d:a>=w+h?h:a-w));a+=l)s>E(c/(f=l-p))&&I("overflow"),s*=f;w=D(S-o,t=_.length+1,0==o),E(S/t)>c-k&&I("overflow"),k+=E(S/t),S%=t,_.splice(S++,0,k)}return O(_)}function P(e){var t,r,n,i,o,s,a,u,p,f,y,_,b,S,k,R=[];for(_=(e=x(e)).length,t=g,r=0,o=v,s=0;s<_;++s)(y=e[s])<128&&R.push(w(y));for(n=i=R.length,i&&R.push(m);n<_;){for(a=c,s=0;s<_;++s)(y=e[s])>=t&&y<a&&(a=y);for(a-t>E((c-r)/(b=n+1))&&I("overflow"),r+=(a-t)*b,t=a,s=0;s<_;++s)if((y=e[s])<t&&++r>c&&I("overflow"),y==t){for(u=r,p=l;!(u<(f=p<=o?d:p>=o+h?h:p-o));p+=l)k=u-f,S=l-f,R.push(w(C(f+k%S,0))),u=E(k/S);R.push(w(C(u,0))),o=D(r,b,n==i),r=0,++n}++r,++t}return R.join("")}if(a={version:"1.4.1",ucs2:{decode:x,encode:O},decode:A,encode:P,toASCII:function(e){return T(e,(function(e){return _.test(e)?"xn--"+P(e):e}))},toUnicode:function(e){return T(e,(function(e){return y.test(e)?A(e.slice(4).toLowerCase()):e}))}},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",(function(){return a}));else if(i&&o)if(t.exports==i)o.exports=a;else for(u in a)a.hasOwnProperty(u)&&(i[u]=a[u]);else n.punycode=a}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],29:[function(e,t,r){var n=e("base-x");t.exports=n("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},{"base-x":25}],30:[function(e,t,r){(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
"use strict";var n=e("base64-js"),i=e("ieee754"),o="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=t,r.SlowBuffer=function(e){+e!=e&&(e=0);return t.alloc(+e)},r.INSPECT_MAX_BYTES=50;var s=2147483647;function a(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var r=new Uint8Array(e);return Object.setPrototypeOf(r,t.prototype),r}function t(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return l(e)}return u(e,t,r)}function u(e,r,n){if("string"==typeof e)return function(e,r){"string"==typeof r&&""!==r||(r="utf8");if(!t.isEncoding(r))throw new TypeError("Unknown encoding: "+r);var n=0|p(e,r),i=a(n),o=i.write(e,r);o!==n&&(i=i.slice(0,o));return i}(e,r);if(ArrayBuffer.isView(e))return d(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(K(e,ArrayBuffer)||e&&K(e.buffer,ArrayBuffer))return function(e,r,n){if(r<0||e.byteLength<r)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<r+(n||0))throw new RangeError('"length" is outside of buffer bounds');var i;i=void 0===r&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,r):new Uint8Array(e,r,n);return Object.setPrototypeOf(i,t.prototype),i}(e,r,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var i=e.valueOf&&e.valueOf();if(null!=i&&i!==e)return t.from(i,r,n);var o=function(e){if(t.isBuffer(e)){var r=0|h(e.length),n=a(r);return 0===n.length?n:(e.copy(n,0,0,r),n)}if(void 0!==e.length)return"number"!=typeof e.length||j(e.length)?a(0):d(e);if("Buffer"===e.type&&Array.isArray(e.data))return d(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return t.from(e[Symbol.toPrimitive]("string"),r,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function l(e){return c(e),a(e<0?0:0|h(e))}function d(e){for(var t=e.length<0?0:0|h(e.length),r=a(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function h(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function p(e,r){if(t.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||K(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var n=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===n)return 0;for(var o=!1;;)switch(r){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return L(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return N(e).length;default:if(o)return i?-1:L(e).length;r=(""+r).toLowerCase(),o=!0}}function f(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,r);case"utf8":case"utf-8":return I(this,t,r);case"ascii":return T(this,t,r);case"latin1":case"binary":return x(this,t,r);case"base64":return w(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function v(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function g(e,r,n,i,o){if(0===e.length)return-1;if("string"==typeof n?(i=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),j(n=+n)&&(n=o?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(o)return-1;n=e.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof r&&(r=t.from(r,i)),t.isBuffer(r))return 0===r.length?-1:m(e,r,n,i,o);if("number"==typeof r)return r&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,r,n):Uint8Array.prototype.lastIndexOf.call(e,r,n):m(e,[r],n,i,o);throw new TypeError("val must be string, number or Buffer")}function m(e,t,r,n,i){var o,s=1,a=e.length,u=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,u/=2,r/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(o=r;o<a;o++)if(c(e,o)===c(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===u)return l*s}else-1!==l&&(o-=o-l),l=-1}else for(r+u>a&&(r=a-u),o=r;o>=0;o--){for(var d=!0,h=0;h<u;h++)if(c(e,o+h)!==c(t,h)){d=!1;break}if(d)return o}return-1}function y(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=t.length;n>o/2&&(n=o/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(j(a))return s;e[r+s]=a}return s}function _(e,t,r,n){return B(L(t,e.length-r),e,r,n)}function b(e,t,r,n){return B(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function S(e,t,r,n){return b(e,t,r,n)}function k(e,t,r,n){return B(N(t),e,r,n)}function E(e,t,r,n){return B(function(e,t){for(var r,n,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,i=r%256,o.push(i),o.push(n);return o}(t,e.length-r),e,r,n)}function w(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function I(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var o,s,a,u,c=e[i],l=null,d=c>239?4:c>223?3:c>191?2:1;if(i+d<=r)switch(d){case 1:c<128&&(l=c);break;case 2:128==(192&(o=e[i+1]))&&(u=(31&c)<<6|63&o)>127&&(l=u);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(u=(15&c)<<12|(63&o)<<6|63&s)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(u=(15&c)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(l=u)}null===l?(l=65533,d=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),i+=d}return function(e){var t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=R));return r}(n)}r.kMaxLength=s,t.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),t.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(t.prototype,"parent",{enumerable:!0,get:function(){if(t.isBuffer(this))return this.buffer}}),Object.defineProperty(t.prototype,"offset",{enumerable:!0,get:function(){if(t.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&t[Symbol.species]===t&&Object.defineProperty(t,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),t.poolSize=8192,t.from=function(e,t,r){return u(e,t,r)},Object.setPrototypeOf(t.prototype,Uint8Array.prototype),Object.setPrototypeOf(t,Uint8Array),t.alloc=function(e,t,r){return function(e,t,r){return c(e),e<=0?a(e):void 0!==t?"string"==typeof r?a(e).fill(t,r):a(e).fill(t):a(e)}(e,t,r)},t.allocUnsafe=function(e){return l(e)},t.allocUnsafeSlow=function(e){return l(e)},t.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==t.prototype},t.compare=function(e,r){if(K(e,Uint8Array)&&(e=t.from(e,e.offset,e.byteLength)),K(r,Uint8Array)&&(r=t.from(r,r.offset,r.byteLength)),!t.isBuffer(e)||!t.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===r)return 0;for(var n=e.length,i=r.length,o=0,s=Math.min(n,i);o<s;++o)if(e[o]!==r[o]){n=e[o],i=r[o];break}return n<i?-1:i<n?1:0},t.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},t.concat=function(e,r){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return t.alloc(0);var n;if(void 0===r)for(r=0,n=0;n<e.length;++n)r+=e[n].length;var i=t.allocUnsafe(r),o=0;for(n=0;n<e.length;++n){var s=e[n];if(K(s,Uint8Array)&&(s=t.from(s)),!t.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(i,o),o+=s.length}return i},t.byteLength=p,t.prototype._isBuffer=!0,t.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)v(this,t,t+1);return this},t.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},t.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},t.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?I(this,0,e):f.apply(this,arguments)},t.prototype.toLocaleString=t.prototype.toString,t.prototype.equals=function(e){if(!t.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===t.compare(this,e)},t.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},o&&(t.prototype[o]=t.prototype.inspect),t.prototype.compare=function(e,r,n,i,o){if(K(e,Uint8Array)&&(e=t.from(e,e.offset,e.byteLength)),!t.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===r&&(r=0),void 0===n&&(n=e?e.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),r<0||n>e.length||i<0||o>this.length)throw new RangeError("out of range index");if(i>=o&&r>=n)return 0;if(i>=o)return-1;if(r>=n)return 1;if(this===e)return 0;for(var s=(o>>>=0)-(i>>>=0),a=(n>>>=0)-(r>>>=0),u=Math.min(s,a),c=this.slice(i,o),l=e.slice(r,n),d=0;d<u;++d)if(c[d]!==l[d]){s=c[d],a=l[d];break}return s<a?-1:a<s?1:0},t.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},t.prototype.indexOf=function(e,t,r){return g(this,e,t,r,!0)},t.prototype.lastIndexOf=function(e,t,r){return g(this,e,t,r,!1)},t.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return y(this,e,t,r);case"utf8":case"utf-8":return _(this,e,t,r);case"ascii":return b(this,e,t,r);case"latin1":case"binary":return S(this,e,t,r);case"base64":return k(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},t.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var R=4096;function T(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function x(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function O(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=t;o<r;++o)i+=F[e[o]];return i}function C(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function D(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function A(e,r,n,i,o,s){if(!t.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(r>o||r<s)throw new RangeError('"value" argument is out of bounds');if(n+i>e.length)throw new RangeError("Index out of range")}function P(e,t,r,n,i,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function M(e,t,r,n,o){return t=+t,r>>>=0,o||P(e,0,r,4),i.write(e,t,r,n,23,4),r+4}function U(e,t,r,n,o){return t=+t,r>>>=0,o||P(e,0,r,8),i.write(e,t,r,n,52,8),r+8}t.prototype.slice=function(e,r){var n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(r=void 0===r?n:~~r)<0?(r+=n)<0&&(r=0):r>n&&(r=n),r<e&&(r=e);var i=this.subarray(e,r);return Object.setPrototypeOf(i,t.prototype),i},t.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||D(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},t.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||D(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},t.prototype.readUInt8=function(e,t){return e>>>=0,t||D(e,1,this.length),this[e]},t.prototype.readUInt16LE=function(e,t){return e>>>=0,t||D(e,2,this.length),this[e]|this[e+1]<<8},t.prototype.readUInt16BE=function(e,t){return e>>>=0,t||D(e,2,this.length),this[e]<<8|this[e+1]},t.prototype.readUInt32LE=function(e,t){return e>>>=0,t||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},t.prototype.readUInt32BE=function(e,t){return e>>>=0,t||D(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},t.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||D(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},t.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||D(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},t.prototype.readInt8=function(e,t){return e>>>=0,t||D(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},t.prototype.readInt16LE=function(e,t){e>>>=0,t||D(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},t.prototype.readInt16BE=function(e,t){e>>>=0,t||D(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},t.prototype.readInt32LE=function(e,t){return e>>>=0,t||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},t.prototype.readInt32BE=function(e,t){return e>>>=0,t||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},t.prototype.readFloatLE=function(e,t){return e>>>=0,t||D(e,4,this.length),i.read(this,e,!0,23,4)},t.prototype.readFloatBE=function(e,t){return e>>>=0,t||D(e,4,this.length),i.read(this,e,!1,23,4)},t.prototype.readDoubleLE=function(e,t){return e>>>=0,t||D(e,8,this.length),i.read(this,e,!0,52,8)},t.prototype.readDoubleBE=function(e,t){return e>>>=0,t||D(e,8,this.length),i.read(this,e,!1,52,8)},t.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,o=0;for(this[t]=255&e;++o<r&&(i*=256);)this[t+o]=e/i&255;return t+r},t.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+r},t.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,255,0),this[t]=255&e,t+1},t.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},t.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},t.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},t.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},t.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);A(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},t.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);A(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},t.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},t.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},t.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},t.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},t.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},t.prototype.writeFloatLE=function(e,t,r){return M(this,e,t,!0,r)},t.prototype.writeFloatBE=function(e,t,r){return M(this,e,t,!1,r)},t.prototype.writeDoubleLE=function(e,t,r){return U(this,e,t,!0,r)},t.prototype.writeDoubleBE=function(e,t,r){return U(this,e,t,!1,r)},t.prototype.copy=function(e,r,n,i){if(!t.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),i||0===i||(i=this.length),r>=e.length&&(r=e.length),r||(r=0),i>0&&i<n&&(i=n),i===n)return 0;if(0===e.length||0===this.length)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-r<i-n&&(i=e.length-r+n);var o=i-n;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(r,n,i);else if(this===e&&n<r&&r<i)for(var s=o-1;s>=0;--s)e[s+r]=this[s+n];else Uint8Array.prototype.set.call(e,this.subarray(n,i),r);return o},t.prototype.fill=function(e,r,n,i){if("string"==typeof e){if("string"==typeof r?(i=r,r=0,n=this.length):"string"==typeof n&&(i=n,n=this.length),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!t.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(1===e.length){var o=e.charCodeAt(0);("utf8"===i&&o<128||"latin1"===i)&&(e=o)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(r<0||this.length<r||this.length<n)throw new RangeError("Out of range index");if(n<=r)return this;var s;if(r>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(s=r;s<n;++s)this[s]=e;else{var a=t.isBuffer(e)?e:t.from(e,i),u=a.length;if(0===u)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<n-r;++s)this[s+r]=a[s%u]}return this};var q=/[^+/0-9A-Za-z-_]/g;function L(e,t){var r;t=t||1/0;for(var n=e.length,i=null,o=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function N(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(q,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function B(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function K(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function j(e){return e!=e}var F=function(){for(var e=new Array(256),t=0;t<16;++t)for(var r=16*t,n=0;n<16;++n)e[r+n]="0123456789abcdef"[t]+"0123456789abcdef"[n];return e}()}).call(this,e("buffer").Buffer)},{"base64-js":26,buffer:30,ieee754:33}],31:[function(e,t,r){
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var n=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,i=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,u=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(o.test(t))return t;if(t.length>0&&!i.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}r.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!u.test(r))throw new TypeError("invalid type");var n=r;if(t&&"object"==typeof t)for(var i,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(i=s[a],!o.test(i))throw new TypeError("invalid parameter name");n+="; "+i+"="+c(t[i])}return n},r.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var r=t.indexOf(";"),i=-1!==r?t.substr(0,r).trim():t.trim();if(!u.test(i))throw new TypeError("invalid media type");var o=new l(i.toLowerCase());if(-1!==r){var a,c,d;for(n.lastIndex=r;c=n.exec(t);){if(c.index!==r)throw new TypeError("invalid parameter format");r+=c[0].length,a=c[1].toLowerCase(),'"'===(d=c[2])[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),o.parameters[a]=d}if(r!==t.length)throw new TypeError("invalid parameter format")}return o}},{}],32:[function(e,t,r){var n=Object.create||function(e){var t=function(){};return t.prototype=e,new t},i=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return r},o=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=n(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var a,u=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),a=0===c.x}catch(e){a=!1}function l(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,r){if(t)e.call(r);else for(var n=e.length,i=S(e,n),o=0;o<n;++o)i[o].call(r)}function h(e,t,r,n){if(t)e.call(r,n);else for(var i=e.length,o=S(e,i),s=0;s<i;++s)o[s].call(r,n)}function p(e,t,r,n,i){if(t)e.call(r,n,i);else for(var o=e.length,s=S(e,o),a=0;a<o;++a)s[a].call(r,n,i)}function f(e,t,r,n,i,o){if(t)e.call(r,n,i,o);else for(var s=e.length,a=S(e,s),u=0;u<s;++u)a[u].call(r,n,i,o)}function v(e,t,r,n){if(t)e.apply(r,n);else for(var i=e.length,o=S(e,i),s=0;s<i;++s)o[s].apply(r,n)}function g(e,t,r,i){var o,s,a;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]):(s=e._events=n(null),e._eventsCount=0),a){if("function"==typeof a?a=s[t]=i?[r,a]:[a,r]:i?a.unshift(r):a.push(r),!a.warned&&(o=l(e))&&o>0&&a.length>o){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=a.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",u.name,u.message)}}else a=s[t]=r,++e._eventsCount;return e}function m(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function y(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=o.call(m,n);return i.listener=r,n.wrapFn=i,i}function _(e,t,r){var n=e._events;if(!n)return[];var i=n[t];return i?"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):S(i,i.length):[]}function b(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function S(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}a?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');u=e}}):s.defaultMaxListeners=u,s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(e){var t,r,n,i,o,s,a="error"===e;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var u=new Error('Unhandled "error" event. ('+t+")");throw u.context=t,u}if(!(r=s[e]))return!1;var c="function"==typeof r;switch(n=arguments.length){case 1:d(r,c,this);break;case 2:h(r,c,this,arguments[1]);break;case 3:p(r,c,this,arguments[1],arguments[2]);break;case 4:f(r,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),o=1;o<n;o++)i[o-1]=arguments[o];v(r,c,this,i)}return!0},s.prototype.addListener=function(e,t){return g(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return g(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,y(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,y(this,e,t)),this},s.prototype.removeListener=function(e,t){var r,i,o,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=n(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(o=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){a=r[s].listener,o=s;break}if(o<0)return this;0===o?r.shift():function(e,t){for(var r=t,n=r+1,i=e.length;n<i;r+=1,n+=1)e[r]=e[n];e.pop()}(r,o),1===r.length&&(i[e]=r[0]),i.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.removeAllListeners=function(e){var t,r,o;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=n(null),this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=n(null):delete r[e]),this;if(0===arguments.length){var s,a=i(r);for(o=0;o<a.length;++o)"removeListener"!==(s=a[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=n(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this},s.prototype.listeners=function(e){return _(this,e,!0)},s.prototype.rawListeners=function(e){return _(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):b.call(e,t)},s.prototype.listenerCount=b,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],33:[function(e,t,r){r.read=function(e,t,r,n,i){var o,s,a=8*i-n-1,u=(1<<a)-1,c=u>>1,l=-7,d=r?i-1:0,h=r?-1:1,p=e[t+d];for(d+=h,o=p&(1<<-l)-1,p>>=-l,l+=a;l>0;o=256*o+e[t+d],d+=h,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=n;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),o-=c}return(p?-1:1)*s*Math.pow(2,o-n)},r.write=function(e,t,r,n,i,o){var s,a,u,c=8*o-i-1,l=(1<<c)-1,d=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:o-1,f=n?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+d>=1?h/u:h*Math.pow(2,1-d))*u>=2&&(s++,u/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*u-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[r+p]=255&a,p+=f,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[r+p]=255&s,p+=f,s/=256,c-=8);e[r+p-f]|=128*v}},{}],34:[function(e,t,r){!function(e,r){"use strict";"function"==typeof define&&define.amd?define(r):"object"==typeof t&&t.exports?t.exports=r():e.log=r()}(this,(function(){"use strict";var e=function(){},t="undefined",r=typeof window!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function i(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(t,r){for(var i=0;i<n.length;i++){var o=n[i];this[o]=i<t?e:this.methodFactory(o,t,r)}this.log=this.debug}function a(e,r,n){return function(){typeof console!==t&&(s.call(this,r,n),this[e].apply(this,arguments))}}function u(n,s,u){return function(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?o:void 0!==console[n]?i(console,n):void 0!==console.log?i(console,"log"):e)}(n)||a.apply(this,arguments)}function c(e,r,i){var o,a=this,c="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[c]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(c)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===a.levels[e]&&(e=void 0),e}}e&&(c+=":"+e),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=i||u,a.getLevel=function(){return o},a.setLevel=function(r,i){if("string"==typeof r&&void 0!==a.levels[r.toUpperCase()]&&(r=a.levels[r.toUpperCase()]),!("number"==typeof r&&r>=0&&r<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+r;if(o=r,!1!==i&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[c]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"="+r+";"}catch(e){}}}(r),s.call(a,r,e),typeof console===t&&r<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){l()||a.setLevel(e,!1)},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var d=l();null==d&&(d=null==r?"WARN":r),a.setLevel(d,!1)}var l=new c,d={};l.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new c(e,l.getLevel(),l.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return d},l}))},{}],35:[function(e,t,r){"use strict";var n=String.prototype.replace,i=/%20/g,o=e("./utils"),s={RFC1738:"RFC1738",RFC3986:"RFC3986"};t.exports=o.assign({default:s.RFC3986,formatters:{RFC1738:function(e){return n.call(e,i,"+")},RFC3986:function(e){return String(e)}}},s)},{"./utils":39}],36:[function(e,t,r){"use strict";var n=e("./stringify"),i=e("./parse"),o=e("./formats");t.exports={formats:o,parse:i,stringify:n}},{"./formats":35,"./parse":37,"./stringify":38}],37:[function(e,t,r){"use strict";var n=e("./utils"),i=Object.prototype.hasOwnProperty,o=Array.isArray,s={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:n.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},u=function(e,t,r){if(e){var n=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,o=/(\[[^[\]]*])/g,s=r.depth>0&&/(\[[^[\]]*])/.exec(n),a=s?n.slice(0,s.index):n,u=[];if(a){if(!r.plainObjects&&i.call(Object.prototype,a)&&!r.allowPrototypes)return;u.push(a)}for(var c=0;r.depth>0&&null!==(s=o.exec(n))&&c<r.depth;){if(c+=1,!r.plainObjects&&i.call(Object.prototype,s[1].slice(1,-1))&&!r.allowPrototypes)return;u.push(s[1])}return s&&u.push("["+n.slice(s.index)+"]"),function(e,t,r){for(var n=t,i=e.length-1;i>=0;--i){var o,s=e[i];if("[]"===s&&r.parseArrays)o=[].concat(n);else{o=r.plainObjects?Object.create(null):{};var a="["===s.charAt(0)&&"]"===s.charAt(s.length-1)?s.slice(1,-1):s,u=parseInt(a,10);r.parseArrays||""!==a?!isNaN(u)&&s!==a&&String(u)===a&&u>=0&&r.parseArrays&&u<=r.arrayLimit?(o=[])[u]=n:o[a]=n:o={0:n}}n=o}return n}(u,t,r)}};t.exports=function(e,t){var r=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?s.charset:e.charset;return{allowDots:void 0===e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:s.comma,decoder:"function"==typeof e.decoder?e.decoder:s.decoder,delimiter:"string"==typeof e.delimiter||n.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}}(t);if(""===e||null==e)return r.plainObjects?Object.create(null):{};for(var c="string"==typeof e?function(e,t){var r,u={},c=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,l=t.parameterLimit===1/0?void 0:t.parameterLimit,d=c.split(t.delimiter,l),h=-1,p=t.charset;if(t.charsetSentinel)for(r=0;r<d.length;++r)0===d[r].indexOf("utf8=")&&("utf8=%E2%9C%93"===d[r]?p="utf-8":"utf8=%26%2310003%3B"===d[r]&&(p="iso-8859-1"),h=r,r=d.length);for(r=0;r<d.length;++r)if(r!==h){var f,v,g=d[r],m=g.indexOf("]="),y=-1===m?g.indexOf("="):m+1;-1===y?(f=t.decoder(g,s.decoder,p,"key"),v=t.strictNullHandling?null:""):(f=t.decoder(g.slice(0,y),s.decoder,p,"key"),v=t.decoder(g.slice(y+1),s.decoder,p,"value")),v&&t.interpretNumericEntities&&"iso-8859-1"===p&&(v=a(v)),v&&"string"==typeof v&&t.comma&&v.indexOf(",")>-1&&(v=v.split(",")),g.indexOf("[]=")>-1&&(v=o(v)?[v]:v),i.call(u,f)?u[f]=n.combine(u[f],v):u[f]=v}return u}(e,r):e,l=r.plainObjects?Object.create(null):{},d=Object.keys(c),h=0;h<d.length;++h){var p=d[h],f=u(p,c[p],r);l=n.merge(l,f,r)}return n.compact(l)}},{"./utils":39}],38:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./formats"),o=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,u=Array.prototype.push,c=function(e,t){u.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,d=i.default,h={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:n.encode,encodeValuesOnly:!1,format:d,formatter:i.formatters[d],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},p=function e(t,r,i,o,s,u,l,d,p,f,v,g,m){var y,_=t;if("function"==typeof l?_=l(r,_):_ instanceof Date?_=f(_):"comma"===i&&a(_)&&(_=_.join(",")),null===_){if(o)return u&&!g?u(r,h.encoder,m,"key"):r;_=""}if("string"==typeof(y=_)||"number"==typeof y||"boolean"==typeof y||"symbol"==typeof y||"bigint"==typeof y||n.isBuffer(_))return u?[v(g?r:u(r,h.encoder,m,"key"))+"="+v(u(_,h.encoder,m,"value"))]:[v(r)+"="+v(String(_))];var b,S=[];if(void 0===_)return S;if(a(l))b=l;else{var k=Object.keys(_);b=d?k.sort(d):k}for(var E=0;E<b.length;++E){var w=b[E];s&&null===_[w]||(a(_)?c(S,e(_[w],"function"==typeof i?i(r,w):r,i,o,s,u,l,d,p,f,v,g,m)):c(S,e(_[w],r+(p?"."+w:"["+w+"]"),i,o,s,u,l,d,p,f,v,g,m)))}return S};t.exports=function(e,t){var r,n=e,u=function(e){if(!e)return h;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||h.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=i.default;if(void 0!==e.format){if(!o.call(i.formatters,e.format))throw new TypeError("Unknown format option provided.");r=e.format}var n=i.formatters[r],s=h.filter;return("function"==typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:h.addQueryPrefix,allowDots:void 0===e.allowDots?h.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:h.charsetSentinel,delimiter:void 0===e.delimiter?h.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:h.encode,encoder:"function"==typeof e.encoder?e.encoder:h.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:h.encodeValuesOnly,filter:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:h.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:h.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:h.strictNullHandling}}(t);"function"==typeof u.filter?n=(0,u.filter)("",n):a(u.filter)&&(r=u.filter);var l,d=[];if("object"!=typeof n||null===n)return"";l=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var f=s[l];r||(r=Object.keys(n)),u.sort&&r.sort(u.sort);for(var v=0;v<r.length;++v){var g=r[v];u.skipNulls&&null===n[g]||c(d,p(n[g],g,f,u.strictNullHandling,u.skipNulls,u.encode?u.encoder:null,u.filter,u.sort,u.allowDots,u.serializeDate,u.formatter,u.encodeValuesOnly,u.charset))}var m=d.join(u.delimiter),y=!0===u.addQueryPrefix?"?":"";return u.charsetSentinel&&("iso-8859-1"===u.charset?y+="utf8=%26%2310003%3B&":y+="utf8=%E2%9C%93&"),m.length>0?y+m:""}},{"./formats":35,"./utils":39}],39:[function(e,t,r){"use strict";var n=Object.prototype.hasOwnProperty,i=Array.isArray,o=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),s=function(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},n=0;n<e.length;++n)void 0!==e[n]&&(r[n]=e[n]);return r};t.exports={arrayToObject:s,assign:function(e,t){return Object.keys(t).reduce((function(e,r){return e[r]=t[r],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],n=0;n<t.length;++n)for(var o=t[n],s=o.obj[o.prop],a=Object.keys(s),u=0;u<a.length;++u){var c=a[u],l=s[c];"object"==typeof l&&null!==l&&-1===r.indexOf(l)&&(t.push({obj:s,prop:c}),r.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),r=t.obj[t.prop];if(i(r)){for(var n=[],o=0;o<r.length;++o)void 0!==r[o]&&n.push(r[o]);t.obj[t.prop]=n}}}(t),e},decode:function(e,t,r){var n=e.replace(/\+/g," ");if("iso-8859-1"===r)return n.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(n)}catch(e){return n}},encode:function(e,t,r){if(0===e.length)return e;var n=e;if("symbol"==typeof e?n=Symbol.prototype.toString.call(e):"string"!=typeof e&&(n=String(e)),"iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var i="",s=0;s<n.length;++s){var a=n.charCodeAt(s);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?i+=n.charAt(s):a<128?i+=o[a]:a<2048?i+=o[192|a>>6]+o[128|63&a]:a<55296||a>=57344?i+=o[224|a>>12]+o[128|a>>6&63]+o[128|63&a]:(s+=1,a=65536+((1023&a)<<10|1023&n.charCodeAt(s)),i+=o[240|a>>18]+o[128|a>>12&63]+o[128|a>>6&63]+o[128|63&a])}return i},isBuffer:function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},merge:function e(t,r,o){if(!r)return t;if("object"!=typeof r){if(i(t))t.push(r);else{if(!t||"object"!=typeof t)return[t,r];(o&&(o.plainObjects||o.allowPrototypes)||!n.call(Object.prototype,r))&&(t[r]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(r);var a=t;return i(t)&&!i(r)&&(a=s(t,o)),i(t)&&i(r)?(r.forEach((function(r,i){if(n.call(t,i)){var s=t[i];s&&"object"==typeof s&&r&&"object"==typeof r?t[i]=e(s,r,o):t.push(r)}else t[i]=r})),t):Object.keys(r).reduce((function(t,i){var s=r[i];return n.call(t,i)?t[i]=e(t[i],s,o):t[i]=s,t}),a)}}},{}],40:[function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,r,o){t=t||"&",r=r||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var u=1e3;o&&"number"==typeof o.maxKeys&&(u=o.maxKeys);var c=e.length;u>0&&c>u&&(c=u);for(var l=0;l<c;++l){var d,h,p,f,v=e[l].replace(a,"%20"),g=v.indexOf(r);g>=0?(d=v.substr(0,g),h=v.substr(g+1)):(d=v,h=""),p=decodeURIComponent(d),f=decodeURIComponent(h),n(s,p)?i(s[p])?s[p].push(f):s[p]=[s[p],f]:s[p]=f}return s};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],41:[function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?o(s(e),(function(s){var a=encodeURIComponent(n(s))+r;return i(e[s])?o(e[s],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[s]))})).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var s=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},{}],42:[function(e,t,r){"use strict";r.decode=r.parse=e("./decode"),r.encode=r.stringify=e("./encode")},{"./decode":40,"./encode":41}],43:[function(e,t,r){var n=function(e){"use strict";var t,r=Object.prototype,n=r.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function u(e,t,r,n){var i=t&&t.prototype instanceof v?t:v,o=Object.create(i.prototype),s=new T(n||[]);return o._invoke=function(e,t,r){var n=l;return function(i,o){if(n===h)throw new Error("Generator is already running");if(n===p){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=w(s,r);if(a){if(a===f)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===l)throw n=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=h;var u=c(e,t,r);if("normal"===u.type){if(n=r.done?p:d,u.arg===f)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=p,r.method="throw",r.arg=u.arg)}}}(e,r,s),o}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l="suspendedStart",d="suspendedYield",h="executing",p="completed",f={};function v(){}function g(){}function m(){}var y={};y[o]=function(){return this};var _=Object.getPrototypeOf,b=_&&_(_(x([])));b&&b!==r&&n.call(b,o)&&(y=b);var S=m.prototype=v.prototype=Object.create(y);function k(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function E(e){var t;this._invoke=function(r,i){function o(){return new Promise((function(t,o){!function t(r,i,o,s){var a=c(e[r],e,i);if("throw"!==a.type){var u=a.arg,l=u.value;return l&&"object"==typeof l&&n.call(l,"__await")?Promise.resolve(l.__await).then((function(e){t("next",e,o,s)}),(function(e){t("throw",e,o,s)})):Promise.resolve(l).then((function(e){u.value=e,o(u)}),(function(e){return t("throw",e,o,s)}))}s(a.arg)}(r,i,t,o)}))}return t=t?t.then(o,o):o()}}function w(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,w(e,r),"throw"===r.method))return f;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var i=c(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,f;var o=i.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,f):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,f)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function x(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}return{next:O}}function O(){return{value:t,done:!0}}return g.prototype=S.constructor=m,m.constructor=g,m[a]=g.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},k(E.prototype),E.prototype[s]=function(){return this},e.AsyncIterator=E,e.async=function(t,r,n,i){var o=new E(u(t,r,n,i));return e.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},k(S),S[a]="Generator",S[o]=function(){return this},S.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=x,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return a.type="throw",a.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var u=n.call(s,"catchLoc"),c=n.call(s,"finallyLoc");if(u&&c){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(u){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:x(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),f}},e}("object"==typeof t?t.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}},{}],44:[function(e,t,r){var n=e("buffer"),i=n.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(o(n,r),r.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:30}],45:[function(e,t,r){t.exports={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"b","":"b","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"'''","":"'''","":"''''","":"'B","":"'D","":"'n","":"'P","":"'T","":"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b'","":"bl","":"","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"c","":"c","":"C","":"C","":"C'","":"c/o","":"c/u","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G'","":"","":"","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"O,","":"O.","":"o'","":"O'","":"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r'","":"rn",m:"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"u","":"U","":"U","":"U","":"U'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"w","":"w","":"W","":"w","":"","":"","":"","":"","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"/","":"","":"","":"","":"","":"","":"'","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"b","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}},{}],46:[function(e,t,r){"use strict";var n=e("./data.json");var i=RegExp(Object.keys(n).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function o(e){return n[e]}t.exports=function(e){return e.replace(i,o)}},{"./data.json":45}],47:[function(e,t,r){"use strict";var n=e("punycode"),i=e("./util");function o(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}r.parse=_,r.resolve=function(e,t){return _(e,!1,!0).resolve(t)},r.resolveObject=function(e,t){return e?_(e,!1,!0).resolveObject(t):t},r.format=function(e){i.isString(e)&&(e=_(e));return e instanceof o?e.format():o.prototype.format.call(e)},r.Url=o;var s=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,u=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(c),d=["%","/","?",";","#"].concat(l),h=["/","?","#"],p=/^[+a-z0-9A-Z_-]{0,63}$/,f=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,v={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},m={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y=e("querystring");function _(e,t,r){if(e&&i.isObject(e)&&e instanceof o)return e;var n=new o;return n.parse(e,t,r),n}o.prototype.parse=function(e,t,r){if(!i.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var o=e.indexOf("?"),a=-1!==o&&o<e.indexOf("#")?"?":"#",c=e.split(a);c[0]=c[0].replace(/\\/g,"/");var _=e=c.join(a);if(_=_.trim(),!r&&1===e.split("#").length){var b=u.exec(_);if(b)return this.path=_,this.href=_,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?y.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var S=s.exec(_);if(S){var k=(S=S[0]).toLowerCase();this.protocol=k,_=_.substr(S.length)}if(r||S||_.match(/^\/\/[^@\/]+@[^@\/]+/)){var E="//"===_.substr(0,2);!E||S&&g[S]||(_=_.substr(2),this.slashes=!0)}if(!g[S]&&(E||S&&!m[S])){for(var w,I,R=-1,T=0;T<h.length;T++){-1!==(x=_.indexOf(h[T]))&&(-1===R||x<R)&&(R=x)}-1!==(I=-1===R?_.lastIndexOf("@"):_.lastIndexOf("@",R))&&(w=_.slice(0,I),_=_.slice(I+1),this.auth=decodeURIComponent(w)),R=-1;for(T=0;T<d.length;T++){var x;-1!==(x=_.indexOf(d[T]))&&(-1===R||x<R)&&(R=x)}-1===R&&(R=_.length),this.host=_.slice(0,R),_=_.slice(R),this.parseHost(),this.hostname=this.hostname||"";var O="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!O)for(var C=this.hostname.split(/\./),D=(T=0,C.length);T<D;T++){var A=C[T];if(A&&!A.match(p)){for(var P="",M=0,U=A.length;M<U;M++)A.charCodeAt(M)>127?P+="x":P+=A[M];if(!P.match(p)){var q=C.slice(0,T),L=C.slice(T+1),N=A.match(f);N&&(q.push(N[1]),L.unshift(N[2])),L.length&&(_="/"+L.join(".")+_),this.hostname=q.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),O||(this.hostname=n.toASCII(this.hostname));var B=this.port?":"+this.port:"",K=this.hostname||"";this.host=K+B,this.href+=this.host,O&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==_[0]&&(_="/"+_))}if(!v[k])for(T=0,D=l.length;T<D;T++){var j=l[T];if(-1!==_.indexOf(j)){var F=encodeURIComponent(j);F===j&&(F=escape(j)),_=_.split(j).join(F)}}var G=_.indexOf("#");-1!==G&&(this.hash=_.substr(G),_=_.slice(0,G));var V=_.indexOf("?");if(-1!==V?(this.search=_.substr(V),this.query=_.substr(V+1),t&&(this.query=y.parse(this.query)),_=_.slice(0,V)):t&&(this.search="",this.query={}),_&&(this.pathname=_),m[k]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){B=this.pathname||"";var W=this.search||"";this.path=B+W}return this.href=this.format(),this},o.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",o=!1,s="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&i.isObject(this.query)&&Object.keys(this.query).length&&(s=y.stringify(this.query));var a=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||m[t])&&!1!==o?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+o+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},o.prototype.resolve=function(e){return this.resolveObject(_(e,!1,!0)).format()},o.prototype.resolveObject=function(e){if(i.isString(e)){var t=new o;t.parse(e,!1,!0),e=t}for(var r=new o,n=Object.keys(this),s=0;s<n.length;s++){var a=n[s];r[a]=this[a]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var u=Object.keys(e),c=0;c<u.length;c++){var l=u[c];"protocol"!==l&&(r[l]=e[l])}return m[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!m[e.protocol]){for(var d=Object.keys(e),h=0;h<d.length;h++){var p=d[h];r[p]=e[p]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||g[e.protocol])r.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),r.pathname=f.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var v=r.pathname||"",y=r.search||"";r.path=v+y}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),S=b||_||r.host&&e.pathname,k=S,E=r.pathname&&r.pathname.split("/")||[],w=(f=e.pathname&&e.pathname.split("/")||[],r.protocol&&!m[r.protocol]);if(w&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),S=S&&(""===f[0]||""===E[0])),b)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,E=f;else if(f.length)E||(E=[]),E.pop(),E=E.concat(f),r.search=e.search,r.query=e.query;else if(!i.isNullOrUndefined(e.search)){if(w)r.hostname=r.host=E.shift(),(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift());return r.search=e.search,r.query=e.query,i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var I=E.slice(-1)[0],R=(r.host||e.host||E.length>1)&&("."===I||".."===I)||""===I,T=0,x=E.length;x>=0;x--)"."===(I=E[x])?E.splice(x,1):".."===I?(E.splice(x,1),T++):T&&(E.splice(x,1),T--);if(!S&&!k)for(;T--;T)E.unshift("..");!S||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),R&&"/"!==E.join("/").substr(-1)&&E.push("");var O,C=""===E[0]||E[0]&&"/"===E[0].charAt(0);w&&(r.hostname=r.host=C?"":E.length?E.shift():"",(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift()));return(S=S||r.host&&E.length)&&!C&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},o.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":48,punycode:28,querystring:42}],48:[function(e,t,r){"use strict";t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}],49:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.ReEmitter=void 0;var i=n(e("@babel/runtime/helpers/classCallCheck")),o=n(e("@babel/runtime/helpers/createClass")),s=function(){function e(t){(0,i.default)(this,e),this.target=t,this.boundHandlers={}}return(0,o.default)(e,[{key:"_handleEvent",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(t=this.target).emit.apply(t,[e].concat(n))}},{key:"reEmit",value:function(e,t){var r=function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];t.apply(void 0,n.concat([e]))},n=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value;void 0===this.boundHandlers[u]&&(this.boundHandlers[u]=this._handleEvent.bind(this,u));var c=r.bind(this,this.boundHandlers[u]);e.on(u,c)}}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}}}]),e}();r.ReEmitter=s},{"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10}],50:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.AutoDiscovery=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/createClass")),s=n(e("@babel/runtime/helpers/classCallCheck")),a=e("./logger"),u=e("url"),c=function(){function t(){(0,s.default)(this,t)}return(0,o.default)(t,null,[{key:"fromDiscoveryConfig",value:function(e){var r,n,o,s,u,c;return i.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(r={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},e&&e["m.homeserver"]){l.next=6;break}return a.logger.error("No m.homeserver key in config"),r["m.homeserver"].state=t.FAIL_PROMPT,r["m.homeserver"].error=t.ERROR_INVALID,l.abrupt("return",Promise.resolve(r));case 6:if(e["m.homeserver"].base_url){l.next=11;break}return a.logger.error("No m.homeserver base_url in config"),r["m.homeserver"].state=t.FAIL_PROMPT,r["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,l.abrupt("return",Promise.resolve(r));case 11:if(n=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url)){l.next=16;break}return a.logger.error("Invalid base_url for m.homeserver"),r["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,l.abrupt("return",Promise.resolve(r));case 16:return l.next=18,i.default.awrap(this._fetchWellKnownObject("".concat(n,"/_matrix/client/versions")));case 18:if((o=l.sent)&&o.raw.versions){l.next=24;break}return a.logger.error("Invalid /versions response"),r["m.homeserver"].error=t.ERROR_INVALID_HOMESERVER,r["m.homeserver"].base_url=n,l.abrupt("return",Promise.resolve(r));case 24:if(r["m.homeserver"]={state:t.SUCCESS,error:null,base_url:n},s="",!e["m.identity_server"]){l.next=41;break}if(u={"m.homeserver":r["m.homeserver"],"m.identity_server":{state:t.FAIL_PROMPT,error:t.ERROR_INVALID_IS,base_url:null}},s=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url)){l.next=33;break}return a.logger.error("Invalid base_url for m.identity_server"),u["m.identity_server"].error=t.ERROR_INVALID_IS_BASE_URL,l.abrupt("return",Promise.resolve(u));case 33:return l.next=35,i.default.awrap(this._fetchWellKnownObject("".concat(s,"/_matrix/identity/api/v1")));case 35:if((c=l.sent)&&c.raw&&"SUCCESS"===c.action){l.next=41;break}return a.logger.error("Invalid /api/v1 response"),u["m.identity_server"].error=t.ERROR_INVALID_IDENTITY_SERVER,u["m.identity_server"].base_url=s,l.abrupt("return",Promise.resolve(u));case 41:return s&&s.length>0&&(r["m.identity_server"]={state:t.SUCCESS,error:null,base_url:s}),Object.keys(e).map((function(t){if("m.homeserver"===t||"m.identity_server"===t)for(var n=["error","state","base_url"],i=0,o=Object.keys(e[t]);i<o.length;i++){var s=o[i];n.includes(s)||(r[t][s]=e[t][s])}else r[t]=e[t]})),l.abrupt("return",Promise.resolve(r));case 44:case"end":return l.stop()}}),null,this)}},{key:"findClientConfig",value:function(e){var r,n;return i.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(e&&"string"==typeof e&&0!==e.length){o.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return r={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},o.next=5,i.default.awrap(this._fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client")));case 5:if((n=o.sent)&&"SUCCESS"===n.action){o.next=11;break}return a.logger.error("No response or error when parsing .well-known"),n.reason&&a.logger.error(n.reason),"IGNORE"===n.action?r["m.homeserver"]={state:t.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=t.FAIL_PROMPT,r["m.homeserver"].error=t.ERROR_INVALID),o.abrupt("return",Promise.resolve(r));case 11:return o.abrupt("return",t.fromDiscoveryConfig(n.raw));case 12:case"end":return o.stop()}}),null,this)}},{key:"getRawClientConfig",value:function(e){var t;return i.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e&&"string"==typeof e&&0!==e.length){r.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return r.next=4,i.default.awrap(this._fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client")));case 4:if(t=r.sent){r.next=7;break}return r.abrupt("return",{});case 7:return r.abrupt("return",t.raw||{});case 8:case"end":return r.stop()}}),null,this)}},{key:"_sanitizeWellKnownUrl",value:function(e){if(!e)return!1;try{var t=null;try{t=u.URL?new u.URL(e):new URL(e)}catch(r){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;var r=t.port?":".concat(t.port):"",n=t.pathname?t.pathname:"",i="".concat(t.protocol,"//").concat(t.hostname).concat(r).concat(n);return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return a.logger.error(e),!1}}},{key:"_fetchWellKnownObject",value:function(r){return i.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise((function(n,i){var o=e("./matrix").getRequest();if(!o)throw new Error("No request library available");o({method:"GET",uri:r,timeout:5e3},(function(e,r,i){if(e||r.statusCode<200||r.statusCode>=300){var o="FAIL_PROMPT",s=(e?e.message:null)||"General failure";return 404===r.statusCode&&(o="IGNORE",s=t.ERROR_MISSING_WELLKNOWN),void n({raw:{},action:o,reason:s,error:e})}try{n({raw:JSON.parse(i),action:"SUCCESS"})}catch(e){var a=t.ERROR_INVALID;"SyntaxError"===e.name&&(a=t.ERROR_INVALID_JSON),n({raw:{},action:"FAIL_PROMPT",reason:a,error:e})}}))})));case 1:case"end":return n.stop()}}))}},{key:"ERROR_INVALID",get:function(){return"Invalid homeserver discovery response"}},{key:"ERROR_GENERIC_FAILURE",get:function(){return"Failed to get autodiscovery configuration from server"}},{key:"ERROR_INVALID_HS_BASE_URL",get:function(){return"Invalid base_url for m.homeserver"}},{key:"ERROR_INVALID_HOMESERVER",get:function(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}},{key:"ERROR_INVALID_IS_BASE_URL",get:function(){return"Invalid base_url for m.identity_server"}},{key:"ERROR_INVALID_IDENTITY_SERVER",get:function(){return"Identity server URL does not appear to be a valid identity server"}},{key:"ERROR_INVALID_IS",get:function(){return"Invalid identity server discovery response"}},{key:"ERROR_MISSING_WELLKNOWN",get:function(){return"No .well-known JSON file found"}},{key:"ERROR_INVALID_JSON",get:function(){return"Invalid JSON"}},{key:"ALL_ERRORS",get:function(){return[t.ERROR_INVALID,t.ERROR_GENERIC_FAILURE,t.ERROR_INVALID_HS_BASE_URL,t.ERROR_INVALID_HOMESERVER,t.ERROR_INVALID_IS_BASE_URL,t.ERROR_INVALID_IDENTITY_SERVER,t.ERROR_INVALID_IS,t.ERROR_MISSING_WELLKNOWN,t.ERROR_INVALID_JSON]}},{key:"FAIL_ERROR",get:function(){return"FAIL_ERROR"}},{key:"FAIL_PROMPT",get:function(){return"FAIL_PROMPT"}},{key:"PROMPT",get:function(){return"PROMPT"}},{key:"SUCCESS",get:function(){return"SUCCESS"}}]),t}();r.AutoDiscovery=c},{"./logger":89,"./matrix":90,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/regenerator":23,url:47}],51:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixBaseApis=p;var o=i(e("@babel/runtime/helpers/typeof")),s=i(e("@babel/runtime/regenerator")),a=e("./service-types"),u=e("./logger"),c=e("./pushprocessor"),l=n(e("./utils")),d=e("./http-api");function h(e,t){switch(e){case a.SERVICE_TYPES.IS:return t+d.PREFIX_IDENTITY_V2+"/terms";case a.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function p(e){l.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;var t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:d.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new d.MatrixHttpApi(this,t),this._txnCtr=0}p.prototype.getHomeserverUrl=function(){return this.baseUrl},p.prototype.getIdentityServerUrl=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},p.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=l.ensureNoTrailingSlash(e),this._http.setIdBaseUrl(this.idBaseUrl)},p.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},p.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},p.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},p.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then((function(e){return e.available}))},p.prototype.register=function(e,t,r,n,i,o,s,a){!0===i?i={email:!0}:null==i&&(i={}),"function"==typeof s&&(a=s,s=void 0),null==n&&(n={}),r&&(n.session=r);var u={auth:n};return null!=e&&(u.username=e),null!=t&&(u.password=t),i.email&&(u.bind_email=!0),i.msisdn&&(u.bind_msisdn=!0),null!=o&&(u.guest_access_token=o),null!=s&&(u.inhibit_login=s),null!=t&&(u.x_show_msisdn=!0),this.registerRequest(u,void 0,a)},p.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},p.prototype.registerRequest=function(e,t,r){var n={};return t&&(n.kind=t),this._http.request(r,"POST","/register",n,e)},p.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},p.prototype.login=function(e,t,r){var n=this,i={type:e};return l.extend(i,t),this._http.authedRequest((function(e,t){t&&t.access_token&&t.user_id&&(n._http.opts.accessToken=t.access_token,n.credentials={userId:t.user_id}),r&&r(e,t)}),"POST","/login",void 0,i)},p.prototype.loginWithPassword=function(e,t,r){return this.login("m.login.password",{user:e,password:t},r)},p.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},p.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},p.prototype.getSsoLoginUrl=function(e,t){return void 0===t&&(t="sso"),this._http.getUrl("/login/"+t+"/redirect",{redirectUrl:e},d.PREFIX_R0)},p.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},p.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},p.prototype.deactivateAccount=function(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");var r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,r)},p.prototype.getFallbackAuthUrl=function(e,t){var r=l.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(r,{session:t},d.PREFIX_R0)},p.prototype.createRoom=function(e,t){return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},p.prototype.fetchRelations=function(e,t,r,n,i){var o,a,u,c;return s.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return o={},i.from&&(o.from=i.from),a=l.encodeParams(o),u=l.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+a,{$roomId:e,$eventId:t,$relationType:r,$eventType:n}),h.next=6,s.default.awrap(this._http.authedRequest(void 0,"GET",u,null,null,{prefix:d.PREFIX_UNSTABLE}));case 6:return c=h.sent,h.abrupt("return",c);case 8:case"end":return h.stop()}}),null,this)},p.prototype.roomState=function(e,t){var r=l.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",r)},p.prototype.fetchRoomEvent=function(e,t,r){var n=l.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(r,"GET",n)},p.prototype.members=function(e,t,r,n,i){var o={};t&&(o.membership=t),r&&(o.not_membership=r),n&&(o.at=n);var s=l.encodeParams(o),a=l.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this._http.authedRequest(i,"GET",a)},p.prototype.upgradeRoom=function(e,t){var r=l.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",r,void 0,{new_version:t})},p.prototype.getGroupSummary=function(e){var t=l.encodeUri("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.getGroupProfile=function(e){var t=l.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.setGroupProfile=function(e,t){var r=l.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",r,void 0,t)},p.prototype.setGroupJoinPolicy=function(e,t){var r=l.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{"m.join_policy":t})},p.prototype.getGroupUsers=function(e){var t=l.encodeUri("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.getGroupInvitedUsers=function(e){var t=l.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.getGroupRooms=function(e){var t=l.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.inviteUserToGroup=function(e,t){var r=l.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},p.prototype.removeUserFromGroup=function(e,t){var r=l.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},p.prototype.addUserToGroupSummary=function(e,t,r){var n=l.encodeUri(r?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:r,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},p.prototype.removeUserFromGroupSummary=function(e,t){var r=l.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},p.prototype.addRoomToGroupSummary=function(e,t,r){var n=l.encodeUri(r?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:r,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},p.prototype.removeRoomFromGroupSummary=function(e,t){var r=l.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},p.prototype.addRoomToGroup=function(e,t,r){void 0===r&&(r=!0);var n=l.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:r?"public":"private"}})},p.prototype.updateGroupRoomVisibility=function(e,t,r){var n=l.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{type:r?"public":"private"})},p.prototype.removeRoomFromGroup=function(e,t){var r=l.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},p.prototype.acceptGroupInvite=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=l.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t||{})},p.prototype.joinGroup=function(e){var t=l.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},p.prototype.leaveGroup=function(e){var t=l.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},p.prototype.getJoinedGroups=function(){var e=l.encodeUri("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},p.prototype.createGroup=function(e){var t=l.encodeUri("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},p.prototype.getPublicisedGroups=function(e){var t=l.encodeUri("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},p.prototype.setGroupPublicity=function(e,t){var r=l.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{publicise:t})},p.prototype.getStateEvent=function(e,t,r,n){var i={$roomId:e,$eventType:t,$stateKey:r},o=l.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==r&&(o=l.encodeUri(o+"/$stateKey",i)),this._http.authedRequest(n,"GET",o)},p.prototype.sendStateEvent=function(e,t,r,n,i){var o={$roomId:e,$eventType:t,$stateKey:n},s=l.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(s=l.encodeUri(s+"/$stateKey",o)),this._http.authedRequest(i,"PUT",s,void 0,r)},p.prototype.roomInitialSync=function(e,t,r){l.isFunction(t)&&(r=t,t=void 0);var n=l.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(r,"GET",n,{limit:t})},p.prototype.setRoomReadMarkersHttpRequest=function(e,t,r,n){var i=l.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),o={"m.fully_read":t,"m.read":r,"m.hidden":Boolean(!!n&&n.hidden)};return this._http.authedRequest(void 0,"POST",i,void 0,o)},p.prototype.getJoinedRooms=function(){var e=l.encodeUri("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},p.prototype.getJoinedRoomMembers=function(e){var t=l.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},p.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});var r={};return e.server&&(r.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(r).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",r,e)},p.prototype.createAlias=function(e,t,r){var n=l.encodeUri("/directory/room/$alias",{$alias:e}),i={room_id:t};return this._http.authedRequest(r,"PUT",n,void 0,i)},p.prototype.deleteAlias=function(e,t){var r=l.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",r,void 0,void 0)},p.prototype.unstableGetLocalAliases=function(e,t){var r=l.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),n=d.PREFIX_UNSTABLE+"/org.matrix.msc2432";return this._http.authedRequest(t,"GET",r,null,null,{prefix:n})},p.prototype.getRoomIdForAlias=function(e,t){var r=l.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",r)},p.prototype.resolveRoomAlias=function(e,t){var r=l.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",r)},p.prototype.getRoomDirectoryVisibility=function(e,t){var r=l.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",r)},p.prototype.setRoomDirectoryVisibility=function(e,t,r){var n=l.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(r,"PUT",n,void 0,{visibility:t})},p.prototype.setRoomDirectoryVisibilityAppService=function(e,t,r,n){var i=l.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(n,"PUT",i,void 0,{visibility:r})},p.prototype.searchUserDirectory=function(e){var t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},p.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},p.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},p.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},p.prototype.getProfileInfo=function(e,t,r){l.isFunction(t)&&(r=t,t=void 0);var n=t?l.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):l.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(r,"GET",n)},p.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},p.prototype.addThreePid=function(e,t,r){var n={threePidCreds:e,bind:t};return this._http.authedRequest(r,"POST","/account/3pid",null,n)},p.prototype.addThreePidOnly=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t="/account/3pid/add",n.next=3,s.default.awrap(this.isVersionSupported("r0.6.0"));case 3:if(!n.sent){n.next=7;break}n.t0=d.PREFIX_R0,n.next=8;break;case 7:n.t0=d.PREFIX_UNSTABLE;case 8:return r=n.t0,n.abrupt("return",this._http.authedRequest(void 0,"POST",t,null,e,{prefix:r}));case 10:case"end":return n.stop()}}),null,this)},p.prototype.bindThreePid=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t="/account/3pid/bind",n.next=3,s.default.awrap(this.isVersionSupported("r0.6.0"));case 3:if(!n.sent){n.next=7;break}n.t0=d.PREFIX_R0,n.next=8;break;case 7:n.t0=d.PREFIX_UNSTABLE;case 8:return r=n.t0,n.abrupt("return",this._http.authedRequest(void 0,"POST",t,null,e,{prefix:r}));case 10:case"end":return n.stop()}}),null,this)},p.prototype.unbindThreePid=function(e,t){var r,n,i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return r="/account/3pid/unbind",n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},o.next=4,s.default.awrap(this.isVersionSupported("r0.6.0"));case 4:if(!o.sent){o.next=8;break}o.t0=d.PREFIX_R0,o.next=9;break;case 8:o.t0=d.PREFIX_UNSTABLE;case 9:return i=o.t0,o.abrupt("return",this._http.authedRequest(void 0,"POST",r,null,n,{prefix:i}));case 11:case"end":return o.stop()}}),null,this)},p.prototype.deleteThreePid=function(e,t){var r={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,r)},p.prototype.setPassword=function(e,t,r){var n={auth:e,new_password:t};return this._http.authedRequest(r,"POST","/account/password",null,n)},p.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},p.prototype.setDeviceDetails=function(e,t){var r=l.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t)},p.prototype.deleteDevice=function(e,t){var r=l.encodeUri("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this._http.authedRequest(void 0,"DELETE",r,void 0,n)},p.prototype.deleteMultipleDevices=function(e,t){var r={devices:e};t&&(r.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,r)},p.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},p.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},p.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then((function(e){return c.PushProcessor.rewriteDefaultRules(e)}))},p.prototype.addPushRule=function(e,t,r,n,i){var o=l.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(i,"PUT",o,void 0,n)},p.prototype.deletePushRule=function(e,t,r,n){var i=l.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(n,"DELETE",i)},p.prototype.setPushRuleEnabled=function(e,t,r,n,i){var o=l.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this._http.authedRequest(i,"PUT",o,void 0,{enabled:n})},p.prototype.setPushRuleActions=function(e,t,r,n,i){var o=l.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this._http.authedRequest(i,"PUT",o,void 0,{actions:n})},p.prototype.search=function(e,t){var r={};return e.next_batch&&(r.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",r,e.body)},p.prototype.uploadKeysRequest=function(e,t,r){return this._http.authedRequest(r,"POST","/keys/upload",void 0,e)},p.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:d.PREFIX_UNSTABLE})},p.prototype.downloadKeysForUsers=function(e,t){if(l.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");var r={device_keys:{}};return"token"in(t=t||{})&&(r.token=t.token),e.forEach((function(e){r.device_keys[e]={}})),this._http.authedRequest(void 0,"POST","/keys/query",void 0,r)},p.prototype.claimOneTimeKeys=function(e,t){var r={};void 0===t&&(t="signed_curve25519");for(var n=0;n<e.length;++n){var i=e[n][0],o=e[n][1],s=r[i]||{};r[i]=s,s[o]=t}var a={one_time_keys:r};return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,a)},p.prototype.getKeyChanges=function(e,t){var r={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",r,void 0)},p.prototype.uploadDeviceSigningKeys=function(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,r,{prefix:d.PREFIX_UNSTABLE})},p.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");var t=this.idBaseUrl+d.PREFIX_IDENTITY_V2+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},p.prototype.requestEmailToken=function(e,t,r,n,i,o){var a,c;return s.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return a={client_secret:t,email:e,send_attempt:r,next_link:n},l.prev=1,l.next=4,s.default.awrap(this._http.idServerRequest(void 0,"POST","/validate/email/requestToken",a,d.PREFIX_IDENTITY_V2,o));case 4:return c=l.sent,i&&i(null,c),l.abrupt("return",c);case 9:if(l.prev=9,l.t0=l.catch(1),"rejected"!==l.t0.cors&&404!==l.t0.httpStatus){l.next=16;break}return u.logger.warn("IS doesn't support v2, falling back to deprecated v1"),l.next=15,s.default.awrap(this._http.idServerRequest(i,"POST","/validate/email/requestToken",a,d.PREFIX_IDENTITY_V1));case 15:return l.abrupt("return",l.sent);case 16:throw i&&i(l.t0),l.t0;case 18:case"end":return l.stop()}}),null,this,[[1,9]])},p.prototype.requestMsisdnToken=function(e,t,r,n,i,o,a){var c,l;return s.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return c={client_secret:r,country:e,phone_number:t,send_attempt:n,next_link:i},h.prev=1,h.next=4,s.default.awrap(this._http.idServerRequest(void 0,"POST","/validate/msisdn/requestToken",c,d.PREFIX_IDENTITY_V2,a));case 4:return l=h.sent,o&&o(null,l),h.abrupt("return",l);case 9:if(h.prev=9,h.t0=h.catch(1),"rejected"!==h.t0.cors&&404!==h.t0.httpStatus){h.next=16;break}return u.logger.warn("IS doesn't support v2, falling back to deprecated v1"),h.next=15,s.default.awrap(this._http.idServerRequest(o,"POST","/validate/msisdn/requestToken",c,d.PREFIX_IDENTITY_V1));case 15:return h.abrupt("return",h.sent);case 16:throw o&&o(h.t0),h.t0;case 18:case"end":return h.stop()}}),null,this,[[1,9]])},p.prototype.submitMsisdnToken=function(e,t,r,n){var i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return i={sid:e,client_secret:t,token:r},o.prev=1,o.next=4,s.default.awrap(this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,d.PREFIX_IDENTITY_V2,n));case 4:return o.abrupt("return",o.sent);case 7:if(o.prev=7,o.t0=o.catch(1),"rejected"!==o.t0.cors&&404!==o.t0.httpStatus){o.next=14;break}return u.logger.warn("IS doesn't support v2, falling back to deprecated v1"),o.next=13,s.default.awrap(this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,d.PREFIX_IDENTITY_V1));case 13:return o.abrupt("return",o.sent);case 14:throw o.t0;case 15:case"end":return o.stop()}}),null,this,[[1,7]])},p.prototype.submitMsisdnTokenOtherUrl=function(e,t,r,n){var i={sid:t,client_secret:r,token:n};return this._http.requestOtherUrl(void 0,"POST",e,void 0,i)},p.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,d.PREFIX_IDENTITY_V2,e)},p.prototype.identityHashedLookup=function(e,r){var n,i,o,a,u,c,l,h,p,f,v;return s.default.async((function(g){for(;;)switch(g.prev=g.next){case 0:return n={},g.next=3,s.default.awrap(this.getIdentityHashDetails(r));case 3:if((i=g.sent)&&i.lookup_pepper&&i.algorithms){g.next=6;break}throw new Error("Unsupported identity server: bad response");case 6:if(n.pepper=i.lookup_pepper,o={},!i.algorithms.includes("sha256")){g.next=14;break}a=new t.Olm.Utility,n.addresses=e.map((function(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),i=a.sha256("".concat(t," ").concat(r," ").concat(n.pepper)).replace(/\+/g,"-").replace(/\//g,"_");return o[i]=e[0],i})),n.algorithm="sha256",g.next=20;break;case 14:if(!i.algorithms.includes("none")){g.next=19;break}n.addresses=e.map((function(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n="".concat(t," ").concat(r);return o[n]=e[0],n})),n.algorithm="none",g.next=20;break;case 19:throw new Error("Unsupported identity server: unknown hash algorithm");case 20:return g.next=22,s.default.awrap(this._http.idServerRequest(void 0,"POST","/lookup",n,d.PREFIX_IDENTITY_V2,r));case 22:if((u=g.sent)&&u.mappings){g.next=25;break}return g.abrupt("return",[]);case 25:c=[],l=0,h=Object.keys(u.mappings);case 27:if(!(l<h.length)){g.next=37;break}if(p=h[l],f=u.mappings[p],v=o[p]){g.next=33;break}throw new Error("Identity server returned more results than expected");case 33:c.push({address:v,mxid:f});case 34:l++,g.next=27;break;case 37:return g.abrupt("return",c);case 38:case"end":return g.stop()}}),null,this)},p.prototype.lookupThreePid=function(e,t,r,n){var i,o,a,c;return s.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.prev=0,l.next=3,s.default.awrap(this.identityHashedLookup([[t,e]],n));case 3:if(i=l.sent,o=i.find((function(e){return e.address===t}))){l.next=8;break}return r&&r(null,{}),l.abrupt("return",{});case 8:return a={address:t,medium:e,mxid:o.mxid},r&&r(null,a),l.abrupt("return",a);case 13:if(l.prev=13,l.t0=l.catch(0),"rejected"!==l.t0.cors&&404!==l.t0.httpStatus){l.next=21;break}return c={medium:e,address:t},u.logger.warn("IS doesn't support v2, falling back to deprecated v1"),l.next=20,s.default.awrap(this._http.idServerRequest(r,"GET","/lookup",c,d.PREFIX_IDENTITY_V1));case 20:return l.abrupt("return",l.sent);case 21:throw r&&r(l.t0,void 0),l.t0;case 23:case"end":return l.stop()}}),null,this,[[0,13]])},p.prototype.bulkLookupThreePids=function(e,t){var r,n,i,o,a,c,l,h,p;return s.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return f.prev=0,f.next=3,s.default.awrap(this.identityHashedLookup(e.map((function(e){return[e[1],e[0]]})),t));case 3:for(r=f.sent,n=[],i=!0,o=!1,a=void 0,f.prev=8,c=function(){var t=h.value,r=e.find((function(e){return e[1]===t.address}));if(!r)throw new Error("Identity sever returned unexpected results");n.push([r[0],t.address,t.mxid])},l=r[Symbol.iterator]();!(i=(h=l.next()).done);i=!0)c();f.next=17;break;case 13:f.prev=13,f.t0=f.catch(8),o=!0,a=f.t0;case 17:f.prev=17,f.prev=18,i||null==l.return||l.return();case 20:if(f.prev=20,!o){f.next=23;break}throw a;case 23:return f.finish(20);case 24:return f.finish(17);case 25:return f.abrupt("return",{threepids:n});case 28:if(f.prev=28,f.t1=f.catch(0),"rejected"!==f.t1.cors&&404!==f.t1.httpStatus){f.next=36;break}return p={threepids:e},u.logger.warn("IS doesn't support v2, falling back to deprecated v1"),f.next=35,s.default.awrap(this._http.idServerRequest(void 0,"POST","/bulk_lookup",p,d.PREFIX_IDENTITY_V1,t));case 35:return f.abrupt("return",f.sent);case 36:throw f.t1;case 37:case"end":return f.stop()}}),null,this,[[0,28],[8,13,17,25],[18,,20,24]])},p.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,d.PREFIX_IDENTITY_V2,e)},p.prototype.sendToDevice=function(e,t,r){var n=l.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),i={messages:t},o=Object.keys(t).reduce((function(e,r){return e[r]=Object.keys(t[r]),e}),{});return u.logger.log("PUT ".concat(n),o),this._http.authedRequest(void 0,"PUT",n,void 0,i)},p.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then((function(e){if(!e||"object"!==(0,o.default)(e))throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e}))},p.prototype.getThirdpartyLocation=function(e,t){var r=l.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},p.prototype.getThirdpartyUser=function(e,t){var r=l.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},p.prototype.getTerms=function(e,t){var r=h(e,t);return this._http.requestOtherUrl(void 0,"GET",r)},p.prototype.agreeToTerms=function(e,t,r,n){var i=h(e,t),o={Authorization:"Bearer "+r};return this._http.requestOtherUrl(void 0,"POST",i,null,{user_accepts:n},{headers:o})},p.prototype.reportEvent=function(e,t,r,n){var i=l.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",i,null,{score:r,reason:n})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./http-api":86,"./logger":89,"./pushprocessor":103,"./service-types":107,"./utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/typeof":21,"@babel/runtime/regenerator":23}],52:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault"),i=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0});var o={};r.default=void 0;var s=i(e("./matrix"));Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return s[e]}}))}));var a,u=n(e("browser-request")),c=n(e("qs"));s.request((function(e,t){return e.qs=c.default.stringify(e.qs||{},e.qsStringifyOptions),(0,u.default)(e,t)}));try{a=t.indexedDB}catch(e){}a&&s.setCryptoStoreFactory((function(){return new s.IndexedDBCryptoStore(a,"matrix-js-sdk:crypto")}));var l=s;r.default=l,t.matrixcs=s}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./matrix":90,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"browser-request":27,qs:36}],53:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixClient=M,r.CRYPTO_ENABLED=void 0;var o=i(e("@babel/runtime/helpers/typeof")),s=i(e("@babel/runtime/regenerator")),a=i(e("@babel/runtime/helpers/slicedToArray")),u=i(e("url")),c=e("events"),l=e("./base-apis"),d=e("./filter"),h=e("./sync"),p=e("./models/event"),f=e("./models/event-timeline"),v=e("./models/search-result"),g=e("./store/stub"),m=e("./webrtc/call"),y=n(e("./utils")),_=e("./http-api"),b=e("./content-repo"),S=n(e("./content-helpers")),k=n(e("./crypto/olmlib")),E=e("./ReEmitter"),w=e("./crypto/RoomList"),I=e("./logger"),R=e("./crypto"),T=e("./crypto/recoverykey"),x=e("./crypto/key_passphrase"),O=e("./randomstring"),C=e("./pushprocessor"),D=(0,R.isCryptoAvailable)();r.CRYPTO_ENABLED=D;function A(e,t,r){for(var n=[],i=0,o=Object.entries(e);i<o.length;i++){var s=(0,a.default)(o[i],2),u=s[0],c=s[1];try{var l=P(c,t);l.session_id=u,l.room_id=r,n.push(l)}catch(e){I.logger.log("Failed to decrypt megolm session from backup",e)}}return n}function P(e,t){return JSON.parse(t.decrypt(e.session_data.ephemeral,e.session_data.mac,e.session_data.ciphertext))}function M(e){var t=this;e.baseUrl=y.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=y.ensureNoTrailingSlash(e.idBaseUrl),l.MatrixBaseApis.call(this,e),this.olmVersion=null,this.reEmitter=new E.ReEmitter(this),this.store=e.store||new g.StubStore,this.deviceId=e.deviceId||null;var r=e.userId||null;if(this.credentials={userId:r},e.deviceToImport&&(this.deviceId?I.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?I.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this._exportedOlmDeviceToImport=e.deviceToImport.olmDevice):I.logger.warn("not importing device because no device ID in exported data")),this.scheduler=e.scheduler,this.scheduler){var n=this;this.scheduler.setProcessFunction((function(e){var t=n.getRoom(e.getRoomId());return e.status!==p.EventStatus.SENDING&&B(t,e,p.EventStatus.SENDING),K(n,e)}))}this.clientRunning=!1,this.callList={};var i=(0,m.createNewMatrixCall)(this);this._supportsVoip=!1,i&&(!function(e){var t={},r=[];function n(){if("SYNCING"===e.getSyncState()){if(r.some((function(e){return e.isBeingDecrypted()})))return;for(var t={},n=r.length-1;n>=0;n--){var o=r[n];"m.call.answer"!==o.getType()&&"m.call.hangup"!==o.getType()||(t[o.getContent().call_id]="yep")}r.forEach((function(e){"m.call.invite"===e.getType()&&t[e.getContent().call_id]||i(e)})),r=[]}}function i(r){var n,i=r.getContent(),o=i.call_id?e.callList[i.call_id]:void 0;if("m.call.invite"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(r.getAge()>i.lifetime)return;if(o&&"ended"===o.state)return;if(o&&I.logger.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",i.call_id),!(o=(0,m.createNewMatrixCall)(e,r.getRoomId(),{forceTURN:e._forceTURN})))return void I.logger.log("Incoming call ID "+i.call_id+" but this client doesn't support WebRTC");if(o.callId=i.call_id,o._initWithInvite(r),e.callList[o.callId]=o,t[o.callId])for(n=0;n<t[o.callId].length;n++)o._gotRemoteIceCandidate(t[o.callId][n]);var s,a=y.values(e.callList);for(n=0;n<a.length;++n){var u=a[n];if(o.roomId===u.roomId&&"outbound"===u.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(u.state)){s=u;break}}s?"wait_local_media"===s.state||"create_offer"===s.state||s.callId>o.callId?(I.logger.log("Glare detected: answering incoming call "+o.callId+" and canceling outgoing call "+s.callId),s._replacedBy(o),o.answer()):(I.logger.log("Glare detected: rejecting incoming call "+o.callId+" and keeping outgoing call "+s.callId),o.hangup()):e.emit("Call.incoming",o)}else if("m.call.answer"===r.getType()){if(!o)return;r.getSender()===e.credentials.userId?"ringing"===o.state&&o._onAnsweredElsewhere(i):o._receivedAnswer(i)}else if("m.call.candidates"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(o)for(n=0;n<i.candidates.length;n++)o._gotRemoteIceCandidate(i.candidates[n]);else t[i.call_id]||(t[i.call_id]=[]),t[i.call_id]=t[i.call_id].concat(i.candidates)}else"m.call.hangup"===r.getType()&&(o?"ended"!==o.state&&(o._onHangupReceived(i),delete e.callList[i.call_id]):(o=(0,m.createNewMatrixCall)(e,r.getRoomId()))&&(o.callId=i.call_id,o._initWithHangup(r),e.callList[i.call_id]=o))}e.on("sync",n),e.on("event",(function(e){(0===e.getType().indexOf("m.call.")||e.isBeingDecrypted())&&r.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",(function(){-1!==e.getType().indexOf("m.call.")&&(r.includes(e)?n():i(e))}))}))}(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this._crypto=null,this._cryptoStore=e.cryptoStore,this._sessionStore=e.sessionStore,this._verificationMethods=e.verificationMethods,this._cryptoCallbacks=e.cryptoCallbacks||{},this._forceTURN=e.forceTURN||!1,this._fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this._roomList=new w.RoomList(this._cryptoStore),this._pushProcessor=new C.PushProcessor(this),this._serverVersionsCache=null,this._cachedCapabilities=null,this.on("Event.decrypted",(function(e){var r=e.getPushActions(),n=t._pushProcessor.actionsForEvent(e);e.setPushActions(n);var i=t.getRoom(e.getRoomId());if(i){var o=i.getUnreadNotificationCount("highlight"),s=!(!r||!r.tweaks)&&!!r.tweaks.highlight,a=!(!n||!n.tweaks)&&!!n.tweaks.highlight;if((s!==a||o>0)&&!i.hasUserReadEvent(t.getUserId(),e.getId())){var u=o;a&&!s&&u++,!a&&s&&u--,i.setUnreadNotificationCount("highlight",u),i.getUnreadNotificationCount("total")<u&&i.setUnreadNotificationCount("total",u)}}})),this.on("Room.receipt",(function(e,r){if(r&&t.isRoomEncrypted(r.roomId)){var n=e.getContent();if(!(Object.keys(n).filter((function(e){return Object.keys(n[e]["m.read"]).includes(t.getUserId())})).length>0))return;for(var i=r.getLiveTimeline().getEvents(),o=0,s=i.length-1;s>=0;s--){if(s===i.length-20)return;var a=i[s];if(r.hasUserReadEvent(t.getUserId(),a.getId()))break;o+=t.getPushActionsForEvent(a).tweaks.highlight?1:0}r.setUnreadNotificationCount("highlight",o)}}))}function U(e,t,r,n,i,o){return s.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(e._crypto){a.next=2;break}throw new Error("End-to-End encryption disabled");case 2:return a.next=4,s.default.awrap(e._crypto.setDeviceVerification(t,r,n,i,o));case 4:case"end":return a.stop()}}))}function q(e,t){var r=!0,n=!1,i=void 0;try{for(var o,s=function(){var t=o.value;e.prototype[t]=function(){var e;if(!this._crypto)throw new Error("End-to-end encryption disabled");return(e=this._crypto)[t].apply(e,arguments)}},a=t[Symbol.iterator]();!(r=(o=a.next()).done);r=!0)s()}catch(e){n=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw i}}}function L(e,t,r,n){return Promise.resolve().then((function(){var n=function(e,t,r){if(t.isEncrypted())return null;if(!e.isRoomEncrypted(t.getRoomId()))return null;if("m.reaction"===t.getType())return null;if(!e._crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return e._crypto.encryptEvent(t,r)}(e,r,t);return n?(B(t,r,p.EventStatus.ENCRYPTING),n.then((function(){B(t,r,p.EventStatus.SENDING)}))):null})).then((function(){var n;return e.scheduler&&(n=e.scheduler.queueEvent(r))&&e.scheduler.getQueueForEvent(r).length>1&&B(t,r,p.EventStatus.QUEUED),n||(n=K(e,r)),n})).then((function(e){return t&&t.updatePendingEvent(r,p.EventStatus.SENT,e.event_id),n&&n(null,e),e}),(function(e){I.logger.error("Error sending event",e.stack||e);try{r.error=e,B(t,r,p.EventStatus.NOT_SENT),e.event=r,n&&n(e)}catch(t){I.logger.error("Exception in error handler!",t.stack||e)}throw e}))}function N(e,t,r){return"m.reaction"===r?r:e.isRoomEncrypted(t)?"m.room.encrypted":r}function B(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}function K(e,t){var r,n=t._txnId?t._txnId:e.makeTxnId(),i={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:n};if(t.isState()){var o="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),r=y.encodeUri(o,i)}else if(t.isRedaction()){r=y.encodeUri("/rooms/$roomId/redact/$redactsEventId/$txnId",Object.assign({$redactsEventId:t.event.redacts},i))}else r=y.encodeUri("/rooms/$roomId/send/$eventType/$txnId",i);return e._http.authedRequest(void 0,"PUT",r,void 0,t.getWireContent()).then((function(e){return I.logger.log("Event sent to ".concat(t.getRoomId()," with event id ").concat(e.event_id)),e}))}function j(e,t,r,n,i,o){y.isFunction(i)&&(o=i,i=void 0);var s=y.encodeUri("/rooms/$room_id/$membership",{$room_id:t,$membership:n});return e._http.authedRequest(o,"POST",s,void 0,{user_id:r,reason:i})}function F(e,t,r,n){var i=y.encodeUri("/presence/list/$userId",{$userId:t.credentials.userId});return t._http.authedRequest(e,n,i,void 0,r)}function G(e){e._supportsVoip&&(e.isGuest()||e.turnServer().then((function(t){if(t.uris){I.logger.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");var r={urls:t.uris,username:t.username,credential:t.password};e._turnServers=[r],e._checkTurnServersTimeoutID=setTimeout((function(){G(e)}),1e3*(t.ttl||3600)*.9)}}),(function(t){I.logger.error("Failed to get TURN URIs"),e._checkTurnServersTimeoutID=setTimeout((function(){G(e)}),6e4)})))}function V(e,t,r){e&&e(r),t(r)}function W(e,t,r){e&&e(null,r),t(r)}function $(e){return function(t){var r=new p.MatrixEvent(t);r.isEncrypted()&&(e.reEmitter.reEmit(r,["Event.decrypted"]),r.attemptDecryption(e._crypto));var n=e.getRoom(r.getRoomId());return n&&n.reEmitter.reEmit(r,["Event.replaced"]),r}}y.inherits(M,c.EventEmitter),y.extend(M.prototype,l.MatrixBaseApis.prototype),M.prototype.exportDevice=function(){return s.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._crypto){e.next=3;break}return I.logger.warn("not exporting device if crypto is not enabled"),e.abrupt("return");case 3:return e.t0=this.credentials.userId,e.t1=this.deviceId,e.next=7,s.default.awrap(this._crypto._olmDevice.export());case 7:return e.t2=e.sent,e.abrupt("return",{userId:e.t0,deviceId:e.t1,olmDevice:e.t2});case 9:case"end":return e.stop()}}),null,this)},M.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");var e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),Promise.all(e)},M.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},M.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},M.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},M.prototype.getDeviceId=function(){return this.deviceId},M.prototype.supportsVoip=function(){return this._supportsVoip},M.prototype.setForceTURN=function(e){this._forceTURN=e},M.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},M.prototype.getSyncStateData=function(){return this._syncApi?this._syncApi.getSyncStateData():null},M.prototype.isInitialSyncComplete=function(){var e=this.getSyncState();return!!e&&("PREPARED"===e||"SYNCING"===e)},M.prototype.isGuest=function(){return this._isGuest},M.prototype.getScheduler=function(){return this.scheduler},M.prototype.setGuest=function(e){this._isGuest=e},M.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},M.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},M.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},M.prototype.getCapabilities=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=(new Date).getTime();return this._cachedCapabilities&&!t&&r<this._cachedCapabilities.expiration?(I.logger.log("Returning cached capabilities"),Promise.resolve(this._cachedCapabilities.capabilities)):this._http.authedRequest(void 0,"GET","/capabilities").catch((function(e){return I.logger.error(e),null})).then((function(t){t||(t={});var n=t.capabilities||{},i=Object.keys(n).length?216e5:6e4+5e3*Math.random();return e._cachedCapabilities={capabilities:n,expiration:r+i},I.logger.log("Caching capabilities: ",n),n}))},M.prototype.initCrypto=function(){var e,t;return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if((0,R.isCryptoAvailable)()){r.next=2;break}throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");case 2:if(!this._crypto){r.next=5;break}return I.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient"),r.abrupt("return");case 5:if(this._sessionStore){r.next=7;break}throw new Error("Cannot enable encryption: no sessionStore provided");case 7:if(this._cryptoStore){r.next=9;break}throw new Error("Cannot enable encryption: no cryptoStore provided");case 9:return I.logger.log("Crypto: initialising roomlist..."),r.next=12,s.default.awrap(this._roomList.init());case 12:if(null!==(e=this.getUserId())){r.next=15;break}throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");case 15:if(null!==this.deviceId){r.next=17;break}throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");case 17:return t=new R.Crypto(this,this._sessionStore,e,this.deviceId,this.store,this._cryptoStore,this._roomList,this._verificationMethods),this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),I.logger.log("Crypto: initialising crypto object..."),r.next=22,s.default.awrap(t.init({exportedOlmDevice:this._exportedOlmDeviceToImport}));case 22:delete this._exportedOlmDeviceToImport,this.olmVersion=R.Crypto.getOlmVersion(),t.registerEventHandlers(this),this._crypto=t;case 26:case"end":return r.stop()}}),null,this)},M.prototype.isCryptoEnabled=function(){return null!==this._crypto},M.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},M.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},M.prototype.downloadKeys=function(e,t){return null===this._crypto?Promise.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},M.prototype.getStoredDevicesForUser=function(e){return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(null!==this._crypto){t.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return t.abrupt("return",this._crypto.getStoredDevicesForUser(e)||[]);case 3:case"end":return t.stop()}}),null,this)},M.prototype.getStoredDevice=function(e,t){return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(null!==this._crypto){r.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return r.abrupt("return",this._crypto.getStoredDevice(e,t)||null);case 3:case"end":return r.stop()}}),null,this)},M.prototype.setDeviceVerified=function(e,t,r){void 0===r&&(r=!0);var n=U(this,e,t,r,null);return e==this.credentials.userId&&this._crypto.checkKeyBackup(),n},M.prototype.setDeviceBlocked=function(e,t,r){return void 0===r&&(r=!0),U(this,e,t,null,r)},M.prototype.setDeviceKnown=function(e,t,r){return void 0===r&&(r=!0),U(this,e,t,null,null,r)},M.prototype.requestVerificationDM=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerificationDM(e,t)},M.prototype.findVerificationRequestDMInProgress=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.findVerificationRequestDMInProgress(e)},M.prototype.requestVerification=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerification(e,t)},M.prototype.beginKeyVerification=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.beginKeyVerification(e,t,r)},M.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},M.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},M.prototype.setGlobalErrorOnUnknownDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalErrorOnUnknownDevices(e)},M.prototype.getGlobalErrorOnUnknownDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalErrorOnUnknownDevices()},q(M,["resetCrossSigningKeys","getCrossSigningId","getStoredCrossSigningForUser","checkUserTrust","checkDeviceTrust","checkOwnCrossSigningTrust","checkCrossSigningPrivateKey"]),M.prototype.checkEventSenderTrust=function(e){var t;return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.default.awrap(this.getEventSenderDeviceInfo(e));case 2:if(t=r.sent){r.next=5;break}return r.abrupt("return",0);case 5:return r.next=7,s.default.awrap(this._crypto.checkDeviceTrust(e.getSender(),t.deviceId));case 7:return r.abrupt("return",r.sent);case 8:case"end":return r.stop()}}),null,this)},q(M,["createRecoveryKeyFromPassphrase","bootstrapSecretStorage","addSecretStorageKey","hasSecretStorageKey","storeSecret","getSecret","isSecretStored","requestSecret","getDefaultSecretStorageKeyId","setDefaultSecretStorageKeyId","checkSecretStoragePrivateKey"]),M.prototype.getEventSenderDeviceInfo=function(e){return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._crypto){t.next=2;break}return t.abrupt("return",null);case 2:return t.abrupt("return",this._crypto.getEventSenderDeviceInfo(e));case 3:case"end":return t.stop()}}),null,this)},M.prototype.isEventSenderVerified=function(e){var t;return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.default.awrap(this.getEventSenderDeviceInfo(e));case 2:if(t=r.sent){r.next=5;break}return r.abrupt("return",!1);case 5:return r.abrupt("return",t.isVerified());case 6:case"end":return r.stop()}}),null,this)},M.prototype.cancelAndResendEventRoomKeyRequest=function(e){return e.cancelAndResendKeyRequest(this._crypto,this.getUserId())},M.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t)},M.prototype.isRoomEncrypted=function(e){var t=this.getRoom(e);return!!t&&(!!t.currentState.getStateEvents("m.room.encryption","")||this._roomList.isRoomEncrypted(e))},M.prototype.forceDiscardSession=function(e){if(!this._crypto)throw new Error("End-to-End encryption disabled");this._crypto.forceDiscardSession(e)},M.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))},M.prototype.importRoomKeys=function(e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.importRoomKeys(e)},M.prototype.checkKeyBackup=function(){return this._crypto.checkKeyBackup()},M.prototype.getKeyBackupVersion=function(){return this._http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:_.PREFIX_UNSTABLE}).then((function(e){if(e.algorithm!==k.MEGOLM_BACKUP_ALGORITHM){var t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"===(0,o.default)(e.auth_data)&&e.auth_data.public_key)return e;return Promise.reject("Invalid backup data returned")})).catch((function(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}))},M.prototype.isKeyBackupTrusted=function(e){return this._crypto.isKeyBackupTrusted(e)},M.prototype.getKeyBackupEnabled=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return Boolean(this._crypto.backupKey)},M.prototype.enableKeyBackup=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=e,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=new t.Olm.PkEncryption,this._crypto.backupKey.set_recipient_key(e.auth_data.public_key),this.emit("crypto.keyBackupStatus",!0),this._crypto.scheduleKeyBackupSend()},M.prototype.disableKeyBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=null,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=null,this.emit("crypto.keyBackupStatus",!1)},M.prototype.prepareKeyBackupVersion=function(e){var t,r,n,i,o,u,c,l,d,h=arguments;return s.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(t=h.length>1&&void 0!==h[1]?h[1]:{},r=t.secureSecretStorage,n=void 0!==r&&r,null!==this._crypto){p.next=3;break}throw new Error("End-to-end encryption disabled");case 3:return p.next=5,s.default.awrap(this.createRecoveryKeyFromPassphrase(e));case 5:if(i=p.sent,o=(0,a.default)(i,3),u=o[0],c=o[1],l=o[2],!n){p.next=14;break}return p.next=13,s.default.awrap(this.storeSecret("m.megolm_backup.v1",(0,k.encodeBase64)(l)));case 13:I.logger.info("Key backup private key stored in secret storage");case 14:return d={public_key:u.pubkey},u.passphrase&&(d.private_key_salt=u.passphrase.salt,d.private_key_iterations=u.passphrase.iterations),p.abrupt("return",{algorithm:k.MEGOLM_BACKUP_ALGORITHM,auth_data:d,recovery_key:c});case 17:case"end":return p.stop()}}),null,this)},M.prototype.isKeyBackupKeyStored=function(){return s.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.isSecretStored("m.megolm_backup.v1",!1));case 1:case"end":return e.stop()}}),null,this)},M.prototype.createKeyBackupVersion=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!==this._crypto){n.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return t={algorithm:e.algorithm,auth_data:e.auth_data},n.next=5,s.default.awrap(this._crypto._signObject(t.auth_data));case 5:if(!this._cryptoCallbacks.getCrossSigningKey||!this._crypto._crossSigningInfo.getId()){n.next=8;break}return n.next=8,s.default.awrap(this._crypto._crossSigningInfo.signObject(t.auth_data,"master"));case 8:return n.next=10,s.default.awrap(this._http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:_.PREFIX_UNSTABLE}));case 10:return r=n.sent,n.next=13,s.default.awrap(this.checkKeyBackup());case 13:return this.getKeyBackupEnabled()||I.logger.error("Key backup not usable even though we just created it"),n.abrupt("return",r);case 15:case"end":return n.stop()}}),null,this)},M.prototype.deleteKeyBackupVersion=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo&&this._crypto.backupInfo.version===e&&this.disableKeyBackup();var t=y.encodeUri("/room_keys/version/$version",{$version:e});return this._http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:_.PREFIX_UNSTABLE})},M.prototype._makeKeyBackupPath=function(e,t,r){return{path:void 0!==t?y.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?y.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}},M.prototype.sendKeyBackup=function(e,t,r,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");var i=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"PUT",i.path,i.queryData,n,{prefix:_.PREFIX_UNSTABLE})},M.prototype.scheduleAllGroupSessionsForBackup=function(){return s.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._crypto){e.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return e.next=4,s.default.awrap(this._crypto.scheduleAllGroupSessionsForBackup());case 4:case"end":return e.stop()}}),null,this)},M.prototype.flagAllGroupSessionsForBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.flagAllGroupSessionsForBackup()},M.prototype.isValidRecoveryKey=function(e){try{return(0,T.decodeRecoveryKey)(e),!0}catch(e){return!1}},M.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY",M.prototype.restoreKeyBackupWithPassword=function(e,t,r,n){var i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,s.default.awrap((0,x.keyFromAuthData)(n.auth_data,e));case 2:return i=o.sent,o.abrupt("return",this._restoreKeyBackup(i,t,r,n));case 4:case"end":return o.stop()}}),null,this)},M.prototype.restoreKeyBackupWithSecretStorage=function(e,t,r){var n;return s.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=k.decodeBase64,i.next=3,s.default.awrap(this.getSecret("m.megolm_backup.v1"));case 3:return i.t1=i.sent,n=(0,i.t0)(i.t1),i.abrupt("return",this._restoreKeyBackup(n,t,r,e));case 6:case"end":return i.stop()}}),null,this)},M.prototype.restoreKeyBackupWithRecoveryKey=function(e,t,r,n){var i=(0,T.decodeRecoveryKey)(e);return this._restoreKeyBackup(i,t,r,n)},M.prototype._restoreKeyBackup=function(e,r,n,i){var o=this;if(null===this._crypto)throw new Error("End-to-end encryption disabled");var s,u=0,c=[],l=this._makeKeyBackupPath(r,n,i.version),d=new t.Olm.PkDecryption;try{s=d.init_with_private_key(e)}catch(e){throw d.free(),e}return s!==i.auth_data.public_key?Promise.reject({errcode:M.RESTORE_BACKUP_ERROR_BAD_KEY}):this._http.authedRequest(void 0,"GET",l.path,l.queryData,void 0,{prefix:_.PREFIX_UNSTABLE}).then((function(e){if(e.rooms)for(var t=0,i=Object.entries(e.rooms);t<i.length;t++){var s=(0,a.default)(i[t],2),l=s[0],h=s[1];if(h.sessions){u+=Object.keys(h.sessions).length;var p=A(h.sessions,d,l),f=!0,v=!1,g=void 0;try{for(var m,y=p[Symbol.iterator]();!(f=(m=y.next()).done);f=!0){var _=m.value;_.room_id=l,c.push(_)}}catch(e){v=!0,g=e}finally{try{f||null==y.return||y.return()}finally{if(v)throw g}}}}else if(e.sessions)u=Object.keys(e.sessions).length,c=A(e.sessions,d,r);else{u=1;try{var b=P(e,d);b.room_id=r,b.session_id=n,c.push(b)}catch(e){I.logger.log("Failed to decrypt megolm session from backup",e)}}return o.importRoomKeys(c)})).then((function(){return o._crypto.setTrustedBackupPubKey(s)})).then((function(){return{total:u,imported:c.length}})).finally((function(){d.free()}))},M.prototype.deleteKeysFromBackup=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");var n=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:_.PREFIX_UNSTABLE})},M.prototype.getGroup=function(e){return this.store.getGroup(e)},M.prototype.getGroups=function(){return this.store.getGroups()},M.prototype.getMediaConfig=function(e){return this._http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:_.PREFIX_MEDIA_R0})},M.prototype.getRoom=function(e){return this.store.getRoom(e)},M.prototype.getRooms=function(){return this.store.getRooms()},M.prototype.getVisibleRooms=function(){var e=this.store.getRooms(),t=new Set,r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value.currentState.getStateEvents("m.room.create","");if(a){var u=a.getContent().predecessor;u&&u.room_id&&t.add(u.room_id)}}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return e.filter((function(e){return!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId)}))},M.prototype.getUser=function(e){return this.store.getUser(e)},M.prototype.getUsers=function(){return this.store.getUsers()},M.prototype.setAccountData=function(e,t,r){var n=y.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this._http.authedRequest(r,"PUT",n,void 0,t)},M.prototype.getAccountData=function(e){return this.store.getAccountData(e)},M.prototype.getAccountDataFromServer=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(!this.isInitialSyncComplete()){n.next=5;break}if(t=this.store.getAccountData(e)){n.next=4;break}return n.abrupt("return",null);case 4:return n.abrupt("return",t.getContent());case 5:return r=y.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),n.abrupt("return",this._http.authedRequest(void 0,"GET",r,void 0));case 7:case"end":return n.stop()}}),null,this)},M.prototype.getIgnoredUsers=function(){var e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]},M.prototype.setIgnoredUsers=function(e,t){var r={ignored_users:{}};return e.map((function(e){return r.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",r,t)},M.prototype.isUserIgnored=function(e){return-1!==this.getIgnoredUsers().indexOf(e)},M.prototype.joinRoom=function(e,t,r){if(y.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);var n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);var i=Promise.resolve();t.inviteSignUrl&&(i=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));var o={};t.viaServers&&(o.server_name=t.viaServers);var s={qsStringifyOptions:{arrayFormat:"repeat"}},a=this;return new Promise((function(n,u){i.then((function(t){var r={};t&&(r.third_party_signed=t);var n=y.encodeUri("/join/$roomid",{$roomid:e});return a._http.authedRequest(void 0,"POST",n,o,r,s)})).then((function(e){var r=e.room_id,n=new h.SyncApi(a,a._clientOpts).createRoom(r);return t.syncRoom,Promise.resolve(n)})).then((function(e){W(r,n,e)}),(function(e){V(r,u,e)}))}))},M.prototype.resendEvent=function(e,t){return B(t,e,p.EventStatus.SENDING),L(this,t,e)},M.prototype.cancelPendingEvent=function(e){if([p.EventStatus.QUEUED,p.EventStatus.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e),B(this.getRoom(e.getRoomId()),e,p.EventStatus.CANCELLED)},M.prototype.setRoomName=function(e,t,r){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,r)},M.prototype.setRoomTopic=function(e,t,r){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,r)},M.prototype.getRoomTags=function(e,t){var r=y.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",r,void 0)},M.prototype.setRoomTag=function(e,t,r,n){var i=y.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"PUT",i,void 0,r)},M.prototype.deleteRoomTag=function(e,t,r){var n=y.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(r,"DELETE",n,void 0,void 0)},M.prototype.setRoomAccountData=function(e,t,r,n){var i=y.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(n,"PUT",i,void 0,r)},M.prototype.setPowerLevel=function(e,t,r,n,i){var o={users:{}};n&&"m.room.power_levels"===n.getType()&&(o=y.deepCopy(n.getContent())),o.users[t]=r;var s=y.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(i,"PUT",s,void 0,o)},M.prototype.sendEvent=function(e,t,r,n,i){return this._sendCompleteEvent(e,{type:t,content:r},n,i)},M.prototype._sendCompleteEvent=function(e,t,r,n){y.isFunction(r)&&(n=r,r=void 0),r||(r=this.makeTxnId());var i=new p.MatrixEvent(Object.assign(t,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),s=i.getAssociatedId();if(s&&s.startsWith("~")){var a=o.getPendingEvents().find((function(e){return e.getId()===s}));a.once("Event.localEventIdReplaced",(function(){i.updateAssociatedId(a.getId())}))}var u=i.getType();return I.logger.log("sendEvent of type ".concat(u," in ").concat(e," with txnId ").concat(r)),i._txnId=r,i.setStatus(p.EventStatus.SENDING),o&&o.addPendingEvent(i,r),i.status===p.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):L(this,o,i,n)},M.prototype.redactEvent=function(e,t,r,n){return this._sendCompleteEvent(e,{type:"m.room.redaction",content:{},redacts:t},r,n)},M.prototype.sendMessage=function(e,t,r,n){return y.isFunction(r)&&(n=r,r=void 0),this.sendEvent(e,"m.room.message",t,r,n)},M.prototype.sendTextMessage=function(e,t,r,n){var i=S.makeTextMessage(t);return this.sendMessage(e,i,r,n)},M.prototype.sendNotice=function(e,t,r,n){var i=S.makeNotice(t);return this.sendMessage(e,i,r,n)},M.prototype.sendEmoteMessage=function(e,t,r,n){var i=S.makeEmoteMessage(t);return this.sendMessage(e,i,r,n)},M.prototype.sendImageMessage=function(e,t,r,n,i){y.isFunction(n)&&(i=n,n=void 0),n||(n="Image");var o={msgtype:"m.image",url:t,info:r,body:n};return this.sendMessage(e,o,i)},M.prototype.sendStickerMessage=function(e,t,r,n,i){y.isFunction(n)&&(i=n,n=void 0),n||(n="Sticker");var o={url:t,info:r,body:n};return this.sendEvent(e,"m.sticker",o,i,void 0)},M.prototype.sendHtmlMessage=function(e,t,r,n){var i=S.makeHtmlMessage(t,r);return this.sendMessage(e,i,n)},M.prototype.sendHtmlNotice=function(e,t,r,n){var i=S.makeHtmlNotice(t,r);return this.sendMessage(e,i,n)},M.prototype.sendHtmlEmote=function(e,t,r,n){var i=S.makeHtmlEmote(t,r);return this.sendMessage(e,i,n)},M.prototype.sendReceipt=function(e,t,r,n){if("function"==typeof r&&(n=r,r={}),this.isGuest())return Promise.resolve({});var i=y.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this._http.authedRequest(n,"POST",i,void 0,r||{}),s=this.getRoom(e.getRoomId());return s&&s._addLocalEchoReceipt(this.credentials.userId,e,t),o},M.prototype.sendReadReceipt=function(e,t,r){var n,i,o;return s.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if("function"==typeof t&&(r=t,t={}),t||(t={}),n=e.getId(),!(i=this.getRoom(e.getRoomId()))||!i.hasPendingEvent(n)){s.next=6;break}throw new Error("Cannot set read receipt to a pending event (".concat(n,")"));case 6:return o={"m.hidden":Boolean(t.hidden)},s.abrupt("return",this.sendReceipt(e,"m.read",o,r));case 8:case"end":return s.stop()}}),null,this)},M.prototype.setRoomReadMarkers=function(e,t,r,n){var i,o;return s.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(!(i=this.getRoom(e))||!i.hasPendingEvent(t)){s.next=3;break}throw new Error("Cannot set read marker to a pending event (".concat(t,")"));case 3:if(!r){s.next=8;break}if(o=r.getId(),!i||!i.hasPendingEvent(o)){s.next=7;break}throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));case 7:i&&i._addLocalEchoReceipt(this.credentials.userId,r,"m.read");case 8:return s.abrupt("return",this.setRoomReadMarkersHttpRequest(e,t,o,n));case 9:case"end":return s.stop()}}),null,this)},M.prototype.getUrlPreview=function(e,t,r){var n=t+"_"+e,i=this.urlPreviewCache[n];if(i)return Promise.resolve(i);var o=this;return this._http.authedRequest(r,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:_.PREFIX_MEDIA_R0}).then((function(e){return o.urlPreviewCache[n]=e,e}))},M.prototype.sendTyping=function(e,t,r,n){if(this.isGuest())return Promise.resolve({});var i=y.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=r||2e4),this._http.authedRequest(n,"PUT",i,void 0,o)},M.prototype.getRoomUpgradeHistory=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getRoom(e);if(!r)return[];for(var n=[r],i=r.currentState.getStateEvents("m.room.create","");i;){I.logger.log("Looking at ".concat(i.getId()));var o=i.getContent().predecessor;if(!o||!o.room_id)break;I.logger.log("Looking at predecessor ".concat(o.room_id));var s=this.getRoom(o.room_id);if(!s)break;if(t){var a=s.currentState.getStateEvents("m.room.tombstone","");if(!a||a.getContent().replacement_room!==s.roomId)break}n.splice(0,0,s),i=s.currentState.getStateEvents("m.room.create","")}for(var u=r.currentState.getStateEvents("m.room.tombstone","");u;){var c=this.getRoom(u.getContent().replacement_room);if(!c)break;if(c.roomId===r.roomId)break;if(t){if(!(i=c.currentState.getStateEvents("m.room.create",""))||!i.getContent().predecessor)break;var l=i.getContent().predecessor;if(l.room_id!==r.roomId)break}n.push(c);var d=new Set(n.map((function(e){return e.roomId})));if(d.size<n.length)return n.slice(0,n.length-1);u=(r=c).currentState.getStateEvents("m.room.tombstone","")}return n},M.prototype.invite=function(e,t,r){return j(this,e,t,"invite",void 0,r)},M.prototype.inviteByEmail=function(e,t,r){return this.inviteByThreePid(e,"email",t,r)},M.prototype.inviteByThreePid=function(e,t,r,n){var i,o,a,u;return s.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(i=y.encodeUri("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0)){c.next=4;break}return c.abrupt("return",Promise.reject(new _.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"})));case 4:if(a={id_server:o,medium:t,address:r},c.t0=this.identityServer&&this.identityServer.getAccessToken,!c.t0){c.next=10;break}return c.next=9,s.default.awrap(this.doesServerAcceptIdentityAccessToken());case 9:c.t0=c.sent;case 10:if(!c.t0){c.next=15;break}return c.next=13,s.default.awrap(this.identityServer.getAccessToken());case 13:(u=c.sent)&&(a.id_access_token=u);case 15:return c.abrupt("return",this._http.authedRequest(n,"POST",i,void 0,a));case 16:case"end":return c.stop()}}),null,this)},M.prototype.leave=function(e,t){return j(this,e,void 0,"leave",void 0,t)},M.prototype.leaveRoomChain=function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.getRoomUpgradeHistory(e),i=n;if(!r){i=[];var o=!0,s=!1,a=void 0;try{for(var u,c=n[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var l=u.value;if(i.push(l),l.roomId===e)break}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}}var d={},h=[],p=function(e){return t.leave(e).then((function(){d[e]=null})).catch((function(t){return d[e]=t,null}))},f=!0,v=!1,g=void 0;try{for(var m,y=i[Symbol.iterator]();!(f=(m=y.next()).done);f=!0){var _=m.value;h.push(p(_.roomId))}}catch(e){v=!0,g=e}finally{try{f||null==y.return||y.return()}finally{if(v)throw g}}return Promise.all(h).then((function(){return d}))},M.prototype.ban=function(e,t,r,n){return j(this,e,t,"ban",r,n)},M.prototype.forget=function(e,t,r){void 0===t&&(t=!0);var n=j(this,e,void 0,"forget",void 0,r);if(!t)return n;var i=this;return n.then((function(t){return i.store.removeRoom(e),i.emit("deleteRoom",e),t}))},M.prototype.unban=function(e,t,r){var n=y.encodeUri("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this._http.authedRequest(r,"POST",n,void 0,i)},M.prototype.kick=function(e,t,r,n){return function(e,t,r,n,i,o){y.isFunction(i)&&(o=i,i=void 0);var s=y.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:r});return e._http.authedRequest(o,"PUT",s,void 0,{membership:n,reason:i})}(this,e,t,"leave",r,n)},M.prototype.getPushActionsForEvent=function(e){return e.getPushActions()||e.setPushActions(this._pushProcessor.actionsForEvent(e)),e.getPushActions()},M.prototype.setProfileInfo=function(e,t,r){var n=y.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(r,"PUT",n,void 0,t)},M.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},M.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},M.prototype.mxcUrlToHttp=function(e,t,r,n,i){return(0,b.getHttpUriForMxc)(this.baseUrl,e,t,r,n,i)},M.prototype._unstable_setStatusMessage=function(e){var t=this,r="im.vector.user_status";return Promise.all(this.getRooms().map((function(n){var i="join"===n.getMyMembership(),o=2===n.getInvitedAndJoinedMemberCount();return i&&o&&n.currentState.mayClientSendStateEvent(r,t)?t.sendStateEvent(n.roomId,r,{status:e},t.getUserId()):Promise.resolve()})))},M.prototype.setPresence=function(e,t){var r=y.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",r,void 0,e)},M.prototype.getPresenceList=function(e){return F(e,this,void 0,"GET")},M.prototype.inviteToPresenceList=function(e,t){return F(e,this,{invite:t},"POST")},M.prototype.dropFromPresenceList=function(e,t){return F(e,this,{drop:t},"POST")},M.prototype.scrollback=function(e,t,r){y.isFunction(t)&&(r=t,t=void 0),t=t||30;var n=0,i=this._ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){var o=Date.now()-i.errorTs;n=Math.max(3e3-o,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t-=s;var a=this,u=new Promise((function(i,o){(0,y.sleep)(n).then((function(){return a._createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")})).then((function(t){var n=y.map(t.chunk,$(a));if(t.state){var o=y.map(t.state,$(a));e.currentState.setUnknownStateEvents(o)}e.addEventsToTimeline(n,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),a.store.storeEvents(e,n,t.end,!0),a._ongoingScrollbacks[e.roomId]=null,W(r,i,e)}),(function(t){a._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},V(r,o,t)}))}));return i={promise:u,errorTs:null},this._ongoingScrollbacks[e.roomId]=i,u},M.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));var r=y.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),n=void 0;this._clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(d.Filter.LAZY_LOADING_MESSAGES_FILTER)});var i=this;return i._http.authedRequest(void 0,"GET",r,n).then((function(r){if(!r.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);r.events_after.reverse();var n=r.events_after.concat([r.event]).concat(r.events_before),o=y.map(n,i.getEventMapper()),s=e.getTimelineForEvent(o[0].getId());if(s){var a=y.map(r.state,i.getEventMapper());s.getState(f.EventTimeline.BACKWARDS).setUnknownStateEvents(a)}else(s=e.addTimeline()).initialiseState(y.map(r.state,i.getEventMapper())),s.getState(f.EventTimeline.FORWARDS).paginationToken=r.end;return e.addEventsToTimeline(o,!0,s,r.start),e.getTimelineForEvent(t)||s}))},M.prototype._createMessagesRequest=function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:void 0,o=y.encodeUri("/rooms/$roomId/messages",{$roomId:e});void 0===r&&(r=30);var s={from:t,limit:r,dir:n},a=null;return this._clientOpts.lazyLoadMembers&&(a=Object.assign({},d.Filter.LAZY_LOADING_MESSAGES_FILTER)),i&&(a=a||{},Object.assign(a,i.getRoomTimelineFilterComponent())),a&&(s.filter=JSON.stringify(a)),this._http.authedRequest(void 0,"GET",o,s)},M.prototype.paginateEventTimeline=function(e,t){var r=e.getTimelineSet()===this._notifTimelineSet,n=(t=t||{}).backwards||!1;if(r&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");var i=n?f.EventTimeline.BACKWARDS:f.EventTimeline.FORWARDS,o=e.getPaginationToken(i);if(!o)return Promise.resolve(!1);var s,a,u=e._paginationRequests[i];if(u)return u;var c=this;if(r)"/notifications",s={limit:"limit"in t?t.limit:30,only:"highlight"},o&&"end"!==o&&(s.from=o),a=this._http.authedRequest(void 0,"GET","/notifications",s,void 0).then((function(t){for(var r=t.next_token,o=[],s=0;s<t.notifications.length;s++){var a=t.notifications[s],u=c.getEventMapper()(a.event);u.setPushActions(C.PushProcessor.actionListToActionsObject(a.actions)),u.event.room_id=a.room_id,o[s]=u}return e.getTimelineSet().addEventsToTimeline(o,n,e,r),n&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token})).finally((function(){e._paginationRequests[i]=null})),e._paginationRequests[i]=a;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());(a=this._createMessagesRequest(e.getRoomId(),o,t.limit,i,e.getFilter())).then((function(t){if(t.state){var r=e.getState(i),o=y.map(t.state,c.getEventMapper());r.setUnknownStateEvents(o)}var s=t.end,a=y.map(t.chunk,c.getEventMapper());return e.getTimelineSet().addEventsToTimeline(a,n,e,s),n&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start})).finally((function(){e._paginationRequests[i]=null})),e._paginationRequests[i]=a}return a},M.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",null)},M.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new h.SyncApi(this,this._clientOpts),this._peekSync.peek(e)},M.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},M.prototype.setGuestAccess=function(e,t){var r=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"}),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),Promise.all([n,r])},M.prototype.requestRegisterEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},M.prototype.requestRegisterMsisdnToken=function(e,t,r,n,i){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})},M.prototype.requestAdd3pidEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},M.prototype.requestAdd3pidMsisdnToken=function(e,t,r,n,i){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})},M.prototype.requestPasswordEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},M.prototype.requestPasswordMsisdnToken=function(e,t,r,n,i){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})},M.prototype._requestTokenFromEndpoint=function(e,t){var r,n,i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return r=Object.assign({},t),o.next=3,s.default.awrap(this.doesServerSupportSeparateAddAndBind());case 3:if(o.t0=!o.sent,!o.t0){o.next=6;break}o.t0=this.idBaseUrl;case 6:if(!o.t0){o.next=21;break}if((n=u.default.parse(this.idBaseUrl)).host){o.next=10;break}throw new Error("Invalid ID server URL: "+this.idBaseUrl);case 10:if(r.id_server=n.host,o.t1=this.identityServer&&this.identityServer.getAccessToken,!o.t1){o.next=16;break}return o.next=15,s.default.awrap(this.doesServerAcceptIdentityAccessToken());case 15:o.t1=o.sent;case 16:if(!o.t1){o.next=21;break}return o.next=19,s.default.awrap(this.identityServer.getAccessToken());case 19:(i=o.sent)&&(r.id_access_token=i);case 21:return o.abrupt("return",this._http.request(void 0,"POST",e,void 0,r));case 22:case"end":return o.stop()}}),null,this)},M.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(var r=0;r<this.pushRules[e].room.length;r++){var n=this.pushRules[e].room[r];if(n.rule_id===t)return n}},M.prototype.setRoomMutePushRule=function(e,t,r){var n,i,o=this,s=this.getRoomPushRule(e,t);if(s&&0<=s.actions.indexOf("dont_notify")&&(i=!0),r?s?i||(n=y.defer(),this.deletePushRule(e,"room",s.rule_id).then((function(){o.addPushRule(e,"room",t,{actions:["dont_notify"]}).then((function(){n.resolve()}),(function(e){n.reject(e)}))}),(function(e){n.reject(e)})),n=n.promise):n=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(n=this.deletePushRule(e,"room",s.rule_id)),n)return new Promise((function(e,t){n.then((function(){o.getPushRules().then((function(t){o.pushRules=t,e()}),(function(e){t(e)}))}),(function(e){o.getPushRules().then((function(r){o.pushRules=r,t(e)}),(function(r){t(e)}))}))}))},M.prototype.searchMessageText=function(e,t){var r={search_term:e.query};return"keys"in e&&(r.keys=e.keys),this.search({body:{search_categories:{room_events:r}}},t)},M.prototype.searchRoomEvents=function(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,r))},M.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally((function(){e.pendingRequest=null}));return e.pendingRequest=r,r},M.prototype._processRoomEventsSearch=function(e,t){var r=t.search_categories.room_events;e.count=r.count,e.next_batch=r.next_batch;var n={};r.highlights.forEach((function(e){n[e]=1})),e.highlights.forEach((function(e){n[e]=1})),e.highlights=Object.keys(n);for(var i=0;i<r.results.length;i++){var o=v.SearchResult.fromJson(r.results[i],this.getEventMapper());e.results.push(o)}return e},M.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return Promise.resolve([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;var e=this,t=new h.SyncApi(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then((function(t){I.logger.log("Marking success of sync left room request"),e._syncedLeftRooms=!0})).finally((function(){e._syncLeftRoomsPromise=null})),this._syncLeftRoomsPromise},M.prototype.createFilter=function(e){var t=this,r=y.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",r,void 0,e).then((function(r){var n=d.Filter.fromJson(t.credentials.userId,r.filter_id,e);return t.store.storeFilter(n),n}))},M.prototype.getFilter=function(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var i=this,o=y.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",o,void 0,void 0).then((function(r){var n=d.Filter.fromJson(e,t,r);return i.store.storeFilter(n),n}))},M.prototype.getOrCreateFilter=function(e,t){var r=this.store.getFilterIdByName(e),n=Promise.resolve(),i=this;return r&&(n=i.getFilter(i.credentials.userId,r,!0).then((function(n){var o=n.getDefinition(),s=t.getDefinition();if(y.deepCompare(o,s))return Promise.resolve(r);i.store.setFilterIdByName(e,void 0)}),(function(t){if(404!==t.httpStatus||"M_UNKNOWN"!==t.errcode&&"M_NOT_FOUND"!==t.errcode)throw t;i.store.setFilterIdByName(e,void 0)}))),n.then((function(r){return r||i.createFilter(t.getDefinition()).then((function(t){return i.store.setFilterIdByName(e,t.filterId),t.filterId}))}))},M.prototype.getOpenIdToken=function(){var e=y.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},M.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},M.prototype.getTurnServers=function(){return this._turnServers||[]},M.prototype.setFallbackICEServerAllowed=function(e){this._fallbackICEServerAllowed=e},M.prototype.isFallbackICEServerAllowed=function(){return this._fallbackICEServerAllowed},M.prototype.isSynapseAdministrator=function(){var e=y.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then((function(e){return e.admin}))},M.prototype.whoisSynapseUser=function(e){var t=y.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})},M.prototype.deactivateSynapseUser=function(e){var t=y.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this._http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})},M.prototype.startClient=function(e){var t=this;return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(!this.clientRunning){r.next=2;break}return r.abrupt("return");case 2:this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e}),this._crypto&&(this._crypto.uploadDeviceKeys(),this._crypto.start()),G(this),this._syncApi&&(I.logger.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),(e=Object.assign({},e)).crypto=this._crypto,e.canResetEntireTimeline=function(e){return!!t._canResetTimelineCallback&&t._canResetTimelineCallback(e)},this._clientOpts=e,this._syncApi=new h.SyncApi(this,e),this._syncApi.sync();case 13:case"end":return r.stop()}}),null,this)},M.prototype._storeClientOptions=function(){var e=["boolean","string","number"],t=Object.entries(this._clientOpts).filter((function(t){var r=(0,a.default)(t,2),n=(r[0],r[1]);return e.includes((0,o.default)(n))})).reduce((function(e,t){var r=(0,a.default)(t,2),n=r[0],i=r[1];return e[n]=i,e}),{});return this.store.storeClientOptions(t)},M.prototype.stopClient=function(){I.logger.log("stopping MatrixClient"),this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._crypto&&this._crypto.stop(),this._peekSync&&this._peekSync.stopPeeking(),t.clearTimeout(this._checkTurnServersTimeoutID)},M.prototype.getVersions=function(){return s.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._serverVersionsCache){e.next=4;break}return e.next=3,s.default.awrap(this._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""}));case 3:this._serverVersionsCache=e.sent;case 4:return e.abrupt("return",this._serverVersionsCache);case 5:case"end":return e.stop()}}),null,this)},M.prototype.isVersionSupported=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:return t=n.sent,r=t.versions,n.abrupt("return",r&&r.includes(e));case 5:case"end":return n.stop()}}),null,this)},M.prototype.doesServerSupportLazyLoading=function(){var e,t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:if(e=n.sent){n.next=5;break}return n.abrupt("return",!1);case 5:return t=e.versions,r=e.unstable_features,n.abrupt("return",t&&t.includes("r0.5.0")||r&&r["m.lazy_load_members"]);case 8:case"end":return n.stop()}}),null,this)},M.prototype.doesServerRequireIdServerParam=function(){var e,t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:if(e=n.sent){n.next=5;break}return n.abrupt("return",!0);case 5:if(!(t=e.versions)||!t.includes("r0.6.0")){n.next=8;break}return n.abrupt("return",!1);case 8:if(r=e.unstable_features){n.next=11;break}return n.abrupt("return",!0);case 11:if(void 0!==r["m.require_identity_server"]){n.next=15;break}return n.abrupt("return",!0);case 15:return n.abrupt("return",r["m.require_identity_server"]);case 16:case"end":return n.stop()}}),null,this)},M.prototype.doesServerAcceptIdentityAccessToken=function(){var e,t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:if(e=n.sent){n.next=5;break}return n.abrupt("return",!1);case 5:return t=e.versions,r=e.unstable_features,n.abrupt("return",t&&t.includes("r0.6.0")||r&&r["m.id_access_token"]);case 8:case"end":return n.stop()}}),null,this)},M.prototype.doesServerSupportSeparateAddAndBind=function(){var e,t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:if(e=n.sent){n.next=5;break}return n.abrupt("return",!1);case 5:return t=e.versions,r=e.unstable_features,n.abrupt("return",t&&t.includes("r0.6.0")||r&&r["m.separate_add_and_bind"]);case 8:case"end":return n.stop()}}),null,this)},M.prototype.doesServerSupportUnstableFeature=function(e){var t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(this.getVersions());case 2:if(t=n.sent){n.next=5;break}return n.abrupt("return",!1);case 5:return r=t.unstable_features,n.abrupt("return",r&&!!r[e]);case 7:case"end":return n.stop()}}),null,this)},M.prototype.hasLazyLoadMembersEnabled=function(){return!!this._clientOpts.lazyLoadMembers},M.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},M.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},M.prototype.relations=function(e,t,r,n){var i,o,a,u,c,l,d,h=arguments;return s.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return i=h.length>4&&void 0!==h[4]?h[4]:{},o=N(this,e,n),p.next=4,s.default.awrap(this.fetchRelations(e,t,r,o,i));case 4:if(a=p.sent,u=this.getEventMapper(),a.original_event&&(c=u(a.original_event)),l=a.chunk.map(u),"m.room.encrypted"!==o){p.next=13;break}return d=c?l.concat(c):l,p.next=12,s.default.awrap(Promise.all(d.map((function(e){return new Promise((function(t){return e.once("Event.decrypted",t)}))}))));case 12:l=l.filter((function(e){return e.getType()===n}));case 13:return p.abrupt("return",{originalEvent:c,events:l,nextBatch:a.next_batch});case 14:case"end":return p.stop()}}),null,this)},M.prototype.getEventMapper=function(){return $(this)},M.prototype.generateClientSecret=function(){return(0,O.randomString)(32)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./ReEmitter":49,"./base-apis":51,"./content-helpers":54,"./content-repo":55,"./crypto":67,"./crypto/RoomList":60,"./crypto/key_passphrase":68,"./crypto/olmlib":69,"./crypto/recoverykey":70,"./filter":85,"./http-api":86,"./logger":89,"./models/event":94,"./models/event-timeline":93,"./models/search-result":101,"./pushprocessor":103,"./randomstring":104,"./store/stub":113,"./sync":115,"./utils":117,"./webrtc/call":118,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/helpers/typeof":21,"@babel/runtime/regenerator":23,events:32,url:47}],54:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.makeHtmlMessage=function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeHtmlNotice=function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeHtmlEmote=function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeTextMessage=function(e){return{msgtype:"m.text",body:e}},r.makeNotice=function(e){return{msgtype:"m.notice",body:e}},r.makeEmoteMessage=function(e){return{msgtype:"m.emote",body:e}}},{}],55:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.getHttpUriForMxc=function(e,t,r,n,o,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";var a=t.slice(6),u="/_matrix/media/r0/download/",c={};r&&(c.width=Math.round(r));n&&(c.height=Math.round(n));o&&(c.method=o);i.keys(c).length>0&&(u="/_matrix/media/r0/thumbnail/");var l=a.indexOf("#"),d="";l>=0&&(d=a.substr(l),a=a.substr(0,l));return e+u+a+(0===i.keys(c).length?"":"?"+i.encodeParams(c))+d},r.getIdenticonUri=function(e,t,r,n){if(!t)return null;r||(r=96);n||(n=96);var o={width:r,height:n},s=i.encodeUri("/_matrix/media/unstable/identicon/$ident",{$ident:t});return e+s+(0===i.keys(o).length?"":"?"+i.encodeParams(o))};var i=n(e("./utils"))},{"./utils":117,"@babel/runtime/helpers/interopRequireWildcard":11}],56:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceTrustLevel=r.UserTrustLevel=r.CrossSigningLevel=r.CrossSigningInfo=void 0;var i=n(e("@babel/runtime/helpers/slicedToArray")),o=n(e("@babel/runtime/helpers/defineProperty")),s=n(e("@babel/runtime/regenerator")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/possibleConstructorReturn")),l=n(e("@babel/runtime/helpers/getPrototypeOf")),d=n(e("@babel/runtime/helpers/assertThisInitialized")),h=n(e("@babel/runtime/helpers/inherits")),p=e("./olmlib"),f=e("events"),v=e("../logger");function g(e){return Object.values(e.keys)[0]}var m=function(e){function r(e,t){var n;return(0,a.default)(this,r),n=(0,c.default)(this,(0,l.default)(r).call(this)),Object.defineProperty((0,d.default)(n),"userId",{enumerable:!0,value:e}),n._callbacks=t||{},n.keys={},n.firstUse=!0,n}return(0,h.default)(r,e),(0,u.default)(r,[{key:"getCrossSigningKey",value:function(e,r){var n,i,o;return s.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(this._callbacks.getCrossSigningKey){a.next=2;break}throw new Error("No getCrossSigningKey callback supplied");case 2:return void 0===r&&(r=this.getId(e)),a.next=5,s.default.awrap(this._callbacks.getCrossSigningKey(e,r));case 5:if(n=a.sent){a.next=8;break}throw new Error("getCrossSigningKey callback for "+e+" returned falsey");case 8:if(i=new t.Olm.PkSigning,(o=i.init_with_seed(n))===r){a.next=15;break}throw i.free(),new Error("Key type "+e+" from getCrossSigningKey callback did not match");case 15:return a.abrupt("return",[o,i]);case 16:case"end":return a.stop()}}),null,this)}},{key:"toStorage",value:function(){return{keys:this.keys,firstUse:this.firstUse}}},{key:"isStoredInSecretStorage",value:function(e){var t,r,n,i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:t=!0,r=0,n=["master","self_signing","user_signing"];case 2:if(!(r<n.length)){o.next=11;break}return i=n[r],o.t0=t,o.next=7,s.default.awrap(e.isStored("m.cross_signing.".concat(i),!1));case 7:t=o.t0&=o.sent;case 8:r++,o.next=2;break;case 11:return o.abrupt("return",t);case 12:case"end":return o.stop()}}))}},{key:"getId",value:function(e){return e=e||"master",this.keys[e]?g(this.keys[e]):null}},{key:"resetKeys",value:function(e){var r,n,a,u,c,l,d,h,f,v;return s.default.async((function(g){for(;;)switch(g.prev=g.next){case 0:if(this._callbacks.saveCrossSigningKeys){g.next=2;break}throw new Error("No saveCrossSigningKeys callback supplied");case 2:if(!(void 0===e||e&y.MASTER)&&this.keys.master){g.next=6;break}e=y.MASTER|y.USER_SIGNING|y.SELF_SIGNING,g.next=8;break;case 6:if(0!==e){g.next=8;break}return g.abrupt("return");case 8:if(r={},n={},g.prev=10,!(e&y.MASTER)){g.next=18;break}a=new t.Olm.PkSigning,r.master=a.generate_seed(),u=a.init_with_seed(r.master),n.master={user_id:this.userId,usage:["master"],keys:(0,o.default)({},"ed25519:"+u,u)},g.next=24;break;case 18:return g.next=20,s.default.awrap(this.getCrossSigningKey("master"));case 20:c=g.sent,l=(0,i.default)(c,2),u=l[0],a=l[1];case 24:if(e&y.SELF_SIGNING){d=new t.Olm.PkSigning;try{r.self_signing=d.generate_seed(),h=d.init_with_seed(r.self_signing),n.self_signing={user_id:this.userId,usage:["self_signing"],keys:(0,o.default)({},"ed25519:"+h,h)},(0,p.pkSign)(n.self_signing,a,this.userId,u)}finally{d.free()}}if(e&y.USER_SIGNING){f=new t.Olm.PkSigning;try{r.user_signing=f.generate_seed(),v=f.init_with_seed(r.user_signing),n.user_signing={user_id:this.userId,usage:["user_signing"],keys:(0,o.default)({},"ed25519:"+v,v)},(0,p.pkSign)(n.user_signing,a,this.userId,u)}finally{f.free()}}Object.assign(this.keys,n),this._callbacks.saveCrossSigningKeys(r);case 28:return g.prev=28,a&&a.free(),g.finish(28);case 31:case"end":return g.stop()}}),null,this,[[10,,28,31]])}},{key:"setKeys",value:function(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw v.logger.error(r),new Error(r)}this.keys.master?g(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}var n=g(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){var i="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw v.logger.error(i),new Error(i)}try{(0,p.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw v.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var o="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw v.logger.error(o),new Error(o)}try{(0,p.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw v.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}},{key:"signObject",value:function(e,t){var r,n,o,a;return s.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(this.keys[t]){u.next=2;break}throw new Error("Attempted to sign with "+t+" key but no such key present");case 2:return u.next=4,s.default.awrap(this.getCrossSigningKey(t));case 4:return r=u.sent,n=(0,i.default)(r,2),o=n[0],a=n[1],u.prev=8,(0,p.pkSign)(e,a,this.userId,o),u.abrupt("return",e);case 11:return u.prev=11,a.free(),u.finish(11);case 14:case"end":return u.stop()}}),null,this,[[8,,11,14]])}},{key:"signUser",value:function(e){return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.keys.user_signing){t.next=3;break}return v.logger.info("No user signing key: not signing user"),t.abrupt("return");case 3:return t.abrupt("return",this.signObject(e.keys.master,"user_signing"));case 4:case"end":return t.stop()}}),null,this)}},{key:"signDevice",value:function(e,t){return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e===this.userId){r.next=2;break}throw new Error("Trying to sign ".concat(e,"'s device; can only sign our own device"));case 2:if(this.keys.self_signing){r.next=5;break}return v.logger.info("No self signing key: not signing device"),r.abrupt("return");case 5:return r.abrupt("return",this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing"));case 6:case"end":return r.stop()}}),null,this)}},{key:"checkUserTrust",value:function(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new _(!0,this.firstUse);if(!this.keys.user_signing)return new _(!1,e.firstUse);var t,r=e.keys.master,n=this.getId("user_signing");try{(0,p.pkVerify)(r,n,this.userId),t=!0}catch(e){t=!1}return new _(t,e.firstUse)}},{key:"checkDeviceTrust",value:function(e,t,r){var n=this.checkUserTrust(e),i=e.keys.self_signing;if(!i)return new b(!1,!1,r);var o=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,p.pkVerify)(i,e.getId(),e.userId),(0,p.pkVerify)(o,g(i),e.userId),b.fromUserTrustLevel(n,r)}catch(e){return new b(!1,!1,r)}}}],[{key:"fromStorage",value:function(e,t){var n=new r(t);for(var i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n}},{key:"storeInSecretStorage",value:function(e,t){var r,n,i,o;return s.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:r=0,n=Object.keys(e);case 1:if(!(r<n.length)){a.next=9;break}return i=n[r],o=(0,p.encodeBase64)(e[i]),a.next=6,s.default.awrap(t.store("m.cross_signing.".concat(i),o));case 6:r++,a.next=1;break;case 9:case"end":return a.stop()}}))}},{key:"getFromSecretStorage",value:function(e,t){var r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(t.get("m.cross_signing.".concat(e)));case 2:return r=n.sent,n.abrupt("return",(0,p.decodeBase64)(r));case 4:case"end":return n.stop()}}))}}]),r}(f.EventEmitter);r.CrossSigningInfo=m;var y={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};r.CrossSigningLevel=y;var _=function(){function e(t,r){(0,a.default)(this,e),this._crossSigningVerified=t,this._tofu=r}return(0,u.default)(e,[{key:"isVerified",value:function(){return this.isCrossSigningVerified()}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"isTofu",value:function(){return this._tofu}}]),e}();r.UserTrustLevel=_;var b=function(){function e(t,r,n){(0,a.default)(this,e),this._crossSigningVerified=t,this._tofu=r,this._localVerified=n}return(0,u.default)(e,[{key:"isVerified",value:function(){return this.isCrossSigningVerified()||this.isLocallyVerified()}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"isLocallyVerified",value:function(){return this._localVerified}},{key:"isTofu",value:function(){return this._tofu}}],[{key:"fromUserTrustLevel",value:function(t,r){return new e(t._crossSigningVerified,t._tofu,r)}}]),e}();r.DeviceTrustLevel=b}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"./olmlib":69,"@babel/runtime/helpers/assertThisInitialized":3,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,events:32}],57:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceList=void 0;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/regenerator")),a=i(e("@babel/runtime/helpers/classCallCheck")),u=i(e("@babel/runtime/helpers/createClass")),c=i(e("@babel/runtime/helpers/possibleConstructorReturn")),l=i(e("@babel/runtime/helpers/getPrototypeOf")),d=i(e("@babel/runtime/helpers/assertThisInitialized")),h=i(e("@babel/runtime/helpers/inherits")),p=e("events"),f=e("../logger"),v=e("./deviceinfo"),g=e("./CrossSigning"),m=n(e("./olmlib")),y=e("./store/indexeddb-crypto-store"),_=e("../utils"),b=function(e){function t(e,r,n){var i;return(0,a.default)(this,t),(i=(0,c.default)(this,(0,l.default)(t).call(this)))._cryptoStore=r,i._devices={},i._crossSigningInfo={},i._userByIdentityKey={},i._deviceTrackingStatus={},i._syncToken=null,i._serialiser=new S(e,n,(0,d.default)(i)),i._keyDownloadsInProgressByUser={},i._dirty=!1,i._savePromise=null,i._resolveSavePromise=null,i._savePromiseTime=null,i._saveTimer=null,i}return(0,h.default)(t,e),(0,u.default)(t,[{key:"load",value:function(){var e,t,r,n=this;return s.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,s.default.awrap(this._cryptoStore.doTxn("readonly",[y.IndexedDBCryptoStore.STORE_DEVICE_DATA],(function(e){n._cryptoStore.getEndToEndDeviceData(e,(function(e){n._devices=e?e.devices:{},n._crossSigningInfo=e&&e.crossSigningInfo||{},n._deviceTrackingStatus=e?e.trackingStatus:{},n._syncToken=e?e.syncToken:null,n._userByIdentityKey={};for(var t=0,r=Object.keys(n._devices);t<r.length;t++)for(var i=r[t],o=n._devices[i],s=0,a=Object.keys(o);s<a.length;s++){var u=a[s],c=o[u].keys["curve25519:"+u];void 0!==c&&(n._userByIdentityKey[c]=i)}}))})));case 2:for(e=0,t=Object.keys(this._deviceTrackingStatus);e<t.length;e++)r=t[e],2==this._deviceTrackingStatus[r]&&(this._deviceTrackingStatus[r]=1);case 3:case"end":return i.stop()}}),null,this)}},{key:"stop",value:function(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}},{key:"saveIfDirty",value:function(e){var t,r,n,i=this;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(this._dirty){o.next=2;break}return o.abrupt("return",Promise.resolve(!1));case 2:return void 0===e&&(e=500),t=Date.now+e,this._savePromiseTime&&t<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null),null===(r=this._savePromise)&&(r=new Promise((function(e,t){i._resolveSavePromise=e})),this._savePromise=r),null===this._saveTimer&&(n=this._resolveSavePromise,this._savePromiseTime=t,this._saveTimer=setTimeout((function(){f.logger.log("Saving device tracking data at token "+i._syncToken),i._savePromiseTime=null,i._saveTimer=null,i._savePromise=null,i._resolveSavePromise=null,i._dirty=!1,i._cryptoStore.doTxn("readwrite",[y.IndexedDBCryptoStore.STORE_DEVICE_DATA],(function(e){i._cryptoStore.storeEndToEndDeviceData({devices:i._devices,crossSigningInfo:i._crossSigningInfo,trackingStatus:i._deviceTrackingStatus,syncToken:i._syncToken},e)})).then((function(){n()}))}),e)),o.abrupt("return",r);case 9:case"end":return o.stop()}}),null,this)}},{key:"getSyncToken",value:function(){return this._syncToken}},{key:"setSyncToken",value:function(e){this._syncToken=e}},{key:"downloadKeys",value:function(e,t){var r=this,n=[],i=[];if(e.forEach((function(e){var o=r._deviceTrackingStatus[e];r._keyDownloadsInProgressByUser[e]?(f.logger.log("downloadKeys: already have a download in progress for "+"".concat(e,": awaiting its result")),i.push(r._keyDownloadsInProgressByUser[e])):(t||3!=o)&&n.push(e)})),0!=n.length){f.logger.log("downloadKeys: downloading for",n);var o=this._doKeyDownload(n);i.push(o)}return 0===i.length&&f.logger.log("downloadKeys: already have all necessary keys"),Promise.all(i).then((function(){return r._getDevicesFromStore(e)}))}},{key:"_getDevicesFromStore",value:function(e){var t={},r=this;return e.map((function(e){t[e]={},(r.getStoredDevicesForUser(e)||[]).map((function(r){t[e][r.deviceId]=r}))})),t}},{key:"getStoredDevicesForUser",value:function(e){var t=this._devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(v.DeviceInfo.fromStorage(t[n],n));return r}},{key:"getRawStoredDevicesForUser",value:function(e){return this._devices[e]}},{key:"getStoredCrossSigningForUser",value:function(e){return this._crossSigningInfo[e]?g.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}},{key:"storeCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}},{key:"getStoredDevice",value:function(e,t){var r=this._devices[e];if(r&&r[t])return v.DeviceInfo.fromStorage(r[t],t)}},{key:"getDeviceByIdentityKey",value:function(e,t){var r=this._userByIdentityKey[t];if(!r)return null;if(e!==m.OLM_ALGORITHM&&e!==m.MEGOLM_ALGORITHM)return null;var n=this._devices[r];if(!n)return null;for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];for(var s in o.keys){if(o.keys.hasOwnProperty(s))if(0===s.indexOf("curve25519:"))if(o.keys[s]==t)return v.DeviceInfo.fromStorage(o,i)}}return null}},{key:"storeDevicesForUser",value:function(e,t){if(void 0!==this._devices[e])for(var r=0,n=Object.entries(this._devices[e]);r<n.length;r++){var i=(0,o.default)(n[r],2),s=i[0],a=i[1].keys["curve25519:"+s];delete this._userByIdentityKey[a]}this._devices[e]=t;for(var u=0,c=Object.entries(t);u<c.length;u++){var l=(0,o.default)(c[u],2),d=l[0],h=l[1].keys["curve25519:"+d];this._userByIdentityKey[h]=e}this._dirty=!0}},{key:"startTrackingDeviceList",value:function(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(f.logger.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"stopTrackingDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(f.logger.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}},{key:"stopTrackingAllDeviceLists",value:function(){for(var e=0,t=Object.keys(this._deviceTrackingStatus);e<t.length;e++){var r=t[e];this._deviceTrackingStatus[r]=0}this._dirty=!0}},{key:"invalidateUserDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(f.logger.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"refreshOutdatedDeviceLists",value:function(){this.saveIfDirty();for(var e=[],t=0,r=Object.keys(this._deviceTrackingStatus);t<r.length;t++){var n=r[t];1==this._deviceTrackingStatus[n]&&e.push(n)}return this._doKeyDownload(e)}},{key:"_setRawStoredDevicesForUser",value:function(e,t){if(void 0!==this._devices[e])for(var r=0,n=Object.entries(this._devices[e]);r<n.length;r++){var i=(0,o.default)(n[r],2),s=i[0],a=i[1].keys["curve25519:"+s];delete this._userByIdentityKey[a]}this._devices[e]=t;for(var u=0,c=Object.entries(t);u<c.length;u++){var l=(0,o.default)(c[u],2),d=l[0],h=l[1].keys["curve25519:"+d];this._userByIdentityKey[h]=e}}},{key:"setRawStoredCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t}},{key:"_doKeyDownload",value:function(e){var t=this;if(0===e.length)return Promise.resolve();var r=this._serialiser.updateDevicesForUsers(e,this._syncToken).then((function(){n(!0)}),(function(t){throw f.logger.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((function(e){t._keyDownloadsInProgressByUser[e]=r,1==t._deviceTrackingStatus[e]&&(t._deviceTrackingStatus[e]=2)}));var n=function(n){e.forEach((function(e){(t._dirty=!0,t._keyDownloadsInProgressByUser[e]===r)?(delete t._keyDownloadsInProgressByUser[e],2==t._deviceTrackingStatus[e]&&(n?(t._deviceTrackingStatus[e]=3,f.logger.log("Device list for",e,"now up to date")):t._deviceTrackingStatus[e]=1)):f.logger.log("Another update in the queue for",e,"- not marking up-to-date")})),t.saveIfDirty(),t.emit("crypto.devicesUpdated",e)};return r}}]),t}(p.EventEmitter);r.DeviceList=b;var S=function(){function e(t,r,n){(0,a.default)(this,e),this._baseApis=t,this._olmDevice=r,this._deviceList=n,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}return(0,u.default)(e,[{key:"updateDevicesForUsers",value:function(e,t){var r=this;return e.forEach((function(e){r._keyDownloadsQueuedByUser[e]=!0})),this._queuedQueryDeferred||(this._queuedQueryDeferred=(0,_.defer)()),this._syncToken=t,this._downloadInProgress?(f.logger.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}},{key:"_doQueuedQueries",value:function(){var e=this;if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");var t=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};var r=this._queuedQueryDeferred;this._queuedQueryDeferred=null,f.logger.log("Starting key download for",t),this._downloadInProgress=!0;var n={};return this._syncToken&&(n.token=this._syncToken),this._baseApis.downloadKeysForUsers(t,n).then((function(r){var n=r.device_keys||{},i=r.master_keys||{},o=r.self_signing_keys||{},s=r.user_signing_keys||{},a=Promise.resolve(),u=!0,c=!1,l=void 0;try{for(var d,h=function(){var t=d.value;a=a.then((0,_.sleep)(5)).then((function(){return e._processQueryResponseForUser(t,n[t],{master:i[t],self_signing:o[t],user_signing:s[t]})}))},p=t[Symbol.iterator]();!(u=(d=p.next()).done);u=!0)h()}catch(e){c=!0,l=e}finally{try{u||null==p.return||p.return()}finally{if(c)throw l}}return a})).then((function(){f.logger.log("Completed key download for "+t),e._downloadInProgress=!1,r.resolve(),e._queuedQueryDeferred&&e._doQueuedQueries()}),(function(n){f.logger.warn("Error downloading keys for "+t+":",n),e._downloadInProgress=!1,r.reject(n)})),r.promise}},{key:"_processQueryResponseForUser",value:function(e,t,r,n){var i,o,a,u;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return f.logger.log("got device keys for "+e+":",t),f.logger.log("got cross-signing keys for "+e+":",r),i={},(o=this._deviceList.getRawStoredDevicesForUser(e))&&Object.keys(o).forEach((function(e){var t=v.DeviceInfo.fromStorage(o[e],e);i[e]=t})),n.next=7,s.default.awrap(k(this._olmDevice,e,i,t||{}));case 7:a={},Object.keys(i).forEach((function(e){a[e]=i[e].toStorage()})),this._deviceList._setRawStoredDevicesForUser(e,a),r&&(r.master||r.self_signing||r.user_signing)&&((u=this._deviceList.getStoredCrossSigningForUser(e)||new g.CrossSigningInfo(e)).setKeys(r),this._deviceList.setRawStoredCrossSigningForUser(e,u.toStorage()),this._deviceList.emit("userCrossSigningUpdated",e));case 11:case"end":return n.stop()}}),null,this)}}]),e}();function k(e,t,r,n){var i,o,a,u;return s.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:i=!1,c.t0=s.default.keys(r);case 2:if((c.t1=c.t0()).done){c.next=9;break}if(o=c.t1.value,r.hasOwnProperty(o)){c.next=6;break}return c.abrupt("continue",2);case 6:o in n||(f.logger.log("Device "+t+":"+o+" has been removed"),delete r[o],i=!0),c.next=2;break;case 9:c.t2=s.default.keys(n);case 10:if((c.t3=c.t2()).done){c.next=27;break}if(a=c.t3.value,n.hasOwnProperty(a)){c.next=14;break}return c.abrupt("continue",10);case 14:if((u=n[a]).user_id===t){c.next=18;break}return f.logger.warn("Mismatched user_id "+u.user_id+" in keys from "+t+":"+a),c.abrupt("continue",10);case 18:if(u.device_id===a){c.next=21;break}return f.logger.warn("Mismatched device_id "+u.device_id+" in keys from "+t+":"+a),c.abrupt("continue",10);case 21:return c.next=23,s.default.awrap(E(e,r,u));case 23:if(!c.sent){c.next=25;break}i=!0;case 25:c.next=10;break;case 27:return c.abrupt("return",i);case 28:case"end":return c.stop()}}))}function E(e,t,r){var n,i,o,a,u,c,l;return s.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(r.keys){d.next=2;break}return d.abrupt("return",!1);case 2:if(n=r.device_id,i=r.user_id,o="ed25519:"+n,a=r.keys[o]){d.next=9;break}return f.logger.warn("Device "+i+":"+n+" has no ed25519 key"),d.abrupt("return",!1);case 9:return u=r.unsigned||{},c=r.signatures||{},d.prev=11,d.next=14,s.default.awrap(m.verifySignature(e,r,i,n,a));case 14:d.next=20;break;case 16:return d.prev=16,d.t0=d.catch(11),f.logger.warn("Unable to verify signature on device "+i+":"+n+":"+d.t0),d.abrupt("return",!1);case 20:if(!(n in t)){d.next=27;break}if((l=t[n]).getFingerprint()==a){d.next=25;break}return f.logger.warn("Ed25519 key for device "+i+":"+n+" has changed"),d.abrupt("return",!1);case 25:d.next=28;break;case 27:t[n]=l=new v.DeviceInfo(n);case 28:return l.keys=r.keys||{},l.algorithms=r.algorithms||[],l.unsigned=u,l.signatures=c,d.abrupt("return",!0);case 33:case"end":return d.stop()}}),null,null,[[11,16]])}},{"../logger":89,"../utils":117,"./CrossSigning":56,"./deviceinfo":66,"./olmlib":69,"./store/indexeddb-crypto-store":72,"@babel/runtime/helpers/assertThisInitialized":3,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,events:32}],58:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.OlmDevice=d,r.WITHHELD_MESSAGES=void 0;var o=i(e("@babel/runtime/regenerator")),s=e("../logger"),a=e("./store/indexeddb-crypto-store"),u=n(e("./algorithms")),c=49152;function l(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>c)throw new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is "+c+" bytes.")}function d(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={}}function h(e,t,r,n){return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,o.default.awrap(t.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT,a.IndexedDBCryptoStore.STORE_SESSIONS],(function(r){t.storeAccount(r,e.pickledAccount),e.sessions.forEach((function(e){var n=e.deviceKey,i=e.sessionId,o={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};t.storeEndToEndSession(n,i,o,r)}))})));case 2:n.unpickle(r,e.pickledAccount);case 3:case"end":return i.stop()}}))}function p(e,t,r){return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(e.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(function(n){e.getAccount(n,(function(i){null!==i?r.unpickle(t,i):(r.create(),i=r.pickle(t),e.storeAccount(n,i))}))})));case 2:case"end":return n.stop()}}))}d.prototype.init=function(){var e,r,n,i,s,a=arguments;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(e=a.length>0&&void 0!==a[0]?a[0]:{},n=new t.Olm.Account,i=e.pickleKey,s=e.fromExportedDevice,u.prev=3,!s){u.next=11;break}return i&&console.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=s.pickleKey,u.next=9,o.default.awrap(h(s,this._cryptoStore,this._pickleKey,n));case 9:u.next=14;break;case 11:return i&&(this._pickleKey=i),u.next=14,o.default.awrap(p(this._cryptoStore,this._pickleKey,n));case 14:r=JSON.parse(n.identity_keys()),this._maxOneTimeKeys=n.max_number_of_one_time_keys();case 16:return u.prev=16,n.free(),u.finish(16);case 19:this.deviceCurve25519Key=r.curve25519,this.deviceEd25519Key=r.ed25519;case 21:case"end":return u.stop()}}),null,this,[[3,,16,19]])},d.getOlmVersion=function(){return t.Olm.get_library_version()},d.prototype._getAccount=function(e,r){var n=this;this._cryptoStore.getAccount(e,(function(e){var i=new t.Olm.Account;try{i.unpickle(n._pickleKey,e),r(i)}finally{i.free()}}))},d.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},d.prototype.export=function(){var e,t=this;return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e={pickleKey:this._pickleKey},r.next=3,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT,a.IndexedDBCryptoStore.STORE_SESSIONS],(function(r){t._cryptoStore.getAccount(r,(function(t){e.pickledAccount=t})),e.sessions=[],t._cryptoStore.getAllEndToEndSessions(r,(function(t){e.sessions.push(t)}))})));case 3:return r.abrupt("return",e);case 4:case"end":return r.stop()}}),null,this)},d.prototype._getSession=function(e,t,r,n){var i=this;this._cryptoStore.getEndToEndSession(e,t,r,(function(e){i._unpickleSession(e,n)}))},d.prototype._unpickleSession=function(e,r){var n=new t.Olm.Session;try{n.unpickle(this._pickleKey,e.session),r(Object.assign({},e,{session:n}))}finally{n.free()}},d.prototype._saveSession=function(e,t,r){var n=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,i,r)},d.prototype._getUtility=function(e){var r=new t.Olm.Utility;try{return e(r)}finally{r.free()}},d.prototype.sign=function(e){var t,r=this;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(function(n){r._getAccount(n,(function(r){t=r.sign(e)}))})));case 2:return n.abrupt("return",t);case 3:case"end":return n.stop()}}),null,this)},d.prototype.getOneTimeKeys=function(){var e,t=this;return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(function(r){t._getAccount(r,(function(t){e=JSON.parse(t.one_time_keys())}))})));case 2:return r.abrupt("return",e);case 3:case"end":return r.stop()}}),null,this)},d.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},d.prototype.markKeysAsPublished=function(){var e=this;return o.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(function(t){e._getAccount(t,(function(r){r.mark_keys_as_published(),e._storeAccount(t,r)}))})));case 2:case"end":return t.stop()}}),null,this)},d.prototype.generateOneTimeKeys=function(e){var t=this;return this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(function(r){t._getAccount(r,(function(n){n.generate_one_time_keys(e),t._storeAccount(r,n)}))}))},d.prototype.createOutboundSession=function(e,r){var n,i=this;return o.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT,a.IndexedDBCryptoStore.STORE_SESSIONS],(function(o){i._getAccount(o,(function(s){var a=new t.Olm.Session;try{a.create_outbound(s,e,r),n=a.session_id(),i._storeAccount(o,s);var u={session:a,lastReceivedMessageTs:Date.now()};i._saveSession(e,u,o)}finally{a.free()}}))})));case 2:return s.abrupt("return",n);case 3:case"end":return s.stop()}}),null,this)},d.prototype.createInboundSession=function(e,r,n){var i,s=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(0===r){u.next=2;break}throw new Error("Need messageType == 0 to create inbound session");case 2:return u.next=4,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT,a.IndexedDBCryptoStore.STORE_SESSIONS],(function(o){s._getAccount(o,(function(a){var u=new t.Olm.Session;try{u.create_inbound_from(a,e,n),a.remove_one_time_keys(u),s._storeAccount(o,a);var c=u.decrypt(r,n),l={session:u,lastReceivedMessageTs:Date.now()};s._saveSession(e,l,o),i={payload:c,session_id:u.session_id()}}finally{u.free()}}))})));case 4:return u.abrupt("return",i);case 5:case"end":return u.stop()}}),null,this)},d.prototype.getSessionIdsForDevice=function(e){var t,r=this;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(!this._sessionsInProgress[e]){n.next=9;break}return s.logger.log("waiting for olm session to be created"),n.prev=2,n.next=5,o.default.awrap(this._sessionsInProgress[e]);case 5:n.next=9;break;case 7:n.prev=7,n.t0=n.catch(2);case 9:return n.next=11,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_SESSIONS],(function(n){r._cryptoStore.getEndToEndSessions(e,n,(function(e){t=Object.keys(e)}))})));case 11:return n.abrupt("return",t);case 12:case"end":return n.stop()}}),null,this,[[2,7]])},d.prototype.getSessionIdForDevice=function(e,t){var r,n,i,s,a,u,c;return o.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,o.default.awrap(this.getSessionInfoForDevice(e,t));case 2:if(0!==(r=l.sent).length){l.next=5;break}return l.abrupt("return",null);case 5:for(n=0,i=1;i<r.length;i++)s=r[i],a=void 0===s.lastReceivedMessageTs?0:s.lastReceivedMessageTs,u=r[n],c=void 0===u.lastReceivedMessageTs?0:u.lastReceivedMessageTs,(a>c||a===c&&s.sessionId<u.sessionId)&&(n=i);return l.abrupt("return",r[n].sessionId);case 8:case"end":return l.stop()}}),null,this)},d.prototype.getSessionInfoForDevice=function(e,t){var r,n=this;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._sessionsInProgress[e]||t){i.next=9;break}return s.logger.log("waiting for olm session to be created"),i.prev=2,i.next=5,o.default.awrap(this._sessionsInProgress[e]);case 5:i.next=9;break;case 7:i.prev=7,i.t0=i.catch(2);case 9:return r=[],i.next=12,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_SESSIONS],(function(t){n._cryptoStore.getEndToEndSessions(e,t,(function(e){var t=Object.keys(e).sort(),i=!0,o=!1,s=void 0;try{for(var a,u=function(){var t=a.value;n._unpickleSession(e[t],(function(e){r.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:t})}))},c=t[Symbol.iterator]();!(i=(a=c.next()).done);i=!0)u()}catch(e){o=!0,s=e}finally{try{i||null==c.return||c.return()}finally{if(o)throw s}}}))})));case 12:return i.abrupt("return",r);case 13:case"end":return i.stop()}}),null,this,[[2,7]])},d.prototype.encryptMessage=function(e,t,r){var n,i=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return l(r),u.next=3,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_SESSIONS],(function(o){i._getSession(e,t,o,(function(a){var u=a.session.describe();s.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+u),n=a.session.encrypt(r),i._saveSession(e,a,o)}))})));case 3:return u.abrupt("return",n);case 4:case"end":return u.stop()}}),null,this)},d.prototype.decryptMessage=function(e,t,r,n){var i,u=this;return o.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_SESSIONS],(function(o){u._getSession(e,t,o,(function(a){var c=a.session.describe();s.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),i=a.session.decrypt(r,n),a.lastReceivedMessageTs=Date.now(),u._saveSession(e,a,o)}))})));case 2:return c.abrupt("return",i);case 3:case"end":return c.stop()}}),null,this)},d.prototype.matchesSession=function(e,t,r,n){var i,s=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(0===r){u.next=2;break}return u.abrupt("return",!1);case 2:return u.next=4,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_SESSIONS],(function(r){s._getSession(e,t,r,(function(e){i=e.session.matches_inbound(n)}))})));case 4:return u.abrupt("return",i);case 5:case"end":return u.stop()}}),null,this)},d.prototype.recordSessionProblem=function(e,t,r){return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(this._cryptoStore.storeEndToEndSessionProblem(e,t,r));case 2:case"end":return n.stop()}}),null,this)},d.prototype.sessionMayHaveProblems=function(e,t){return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o.default.awrap(this._cryptoStore.getEndToEndSessionProblem(e,t));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}),null,this)},d.prototype.filterOutNotifiedErrorDevices=function(e){return o.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.default.awrap(this._cryptoStore.filterOutNotifiedErrorDevices(e));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),null,this)},d.prototype._saveOutboundGroupSession=function(e){var t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},d.prototype._getOutboundGroupSession=function(e,r){var n=this._outboundGroupSessionStore[e];if(void 0===n)throw new Error("Unknown outbound group session "+e);var i=new t.Olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,n),r(i)}finally{i.free()}},d.prototype.createOutboundGroupSession=function(){var e=new t.Olm.OutboundGroupSession;try{return e.create(),this._saveOutboundGroupSession(e),e.session_id()}finally{e.free()}},d.prototype.encryptGroupMessage=function(e,t){var r=this;return s.logger.log("encrypting msg with megolm session ".concat(e)),l(t),this._getOutboundGroupSession(e,(function(e){var n=e.encrypt(t);return r._saveOutboundGroupSession(e),n}))},d.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},d.prototype._unpickleInboundGroupSession=function(e,r){var n=new t.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,e.session),r(n)}finally{n.free()}},d.prototype._getInboundGroupSession=function(e,t,r,n,i){var o=this;this._cryptoStore.getEndToEndInboundGroupSession(t,r,n,(function(t,r){if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");o._unpickleInboundGroupSession(t,(function(e){i(e,t,r)}))}else i(null,null,r)}))},d.prototype.addInboundGroupSession=function(e,r,n,i,u,c,l){var d=this;return o.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(o){d._getInboundGroupSession(e,r,i,o,(function(a,h){var p=new t.Olm.InboundGroupSession;try{if(l?p.import_session(u):p.create(u),i!=p.session_id())throw new Error("Mismatched group session ID from senderKey: "+r);if(a&&(s.logger.log("Update for megolm session "+r+"/"+i),a.first_known_index()<=p.first_known_index()))return void s.logger.log("Keeping existing megolm session ".concat(i));var f={room_id:e,session:p.pickle(d._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:n};d._cryptoStore.storeEndToEndInboundGroupSession(r,i,f,o)}finally{p.free()}}))})));case 2:case"end":return h.stop()}}),null,this)},d.prototype.addInboundGroupSessionWithheld=function(e,t,r,n,i){var s=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(o){s._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:n,reason:i},o)})));case 2:case"end":return u.stop()}}),null,this)};var f={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function v(e){return e.code&&e.code in f?f[e.code]:e.reason?e.reason:"decryption key withheld"}r.WITHHELD_MESSAGES=f,d.prototype.decryptGroupMessage=function(e,t,r,n,i,s){var c,l,d=this;return o.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,o.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(o){d._getInboundGroupSession(e,t,r,o,(function(e,a,h){if(null===e)return h&&(l=new u.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",v(h),{session:t+"|"+r})),void(c=null);var p;try{p=e.decrypt(n)}catch(e){return void(l=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new u.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",v(h),{session:t+"|"+r}):e)}var f=p.plaintext;if(void 0===f)f=p;else{var g=t+"|"+r+"|"+p.message_index;if(g in d._inboundGroupSessionMessageIndexes){var m=d._inboundGroupSessionMessageIndexes[g];if(m.id!==i||m.timestamp!==s)return void(l=new Error("Duplicate message index, possible replay attack: "+g))}d._inboundGroupSessionMessageIndexes[g]={id:i,timestamp:s}}a.session=e.pickle(d._pickleKey),d._cryptoStore.storeEndToEndInboundGroupSession(t,r,a,o),c={result:f,keysClaimed:a.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:a.forwardingCurve25519KeyChain||[]}}))})));case 2:if(!l){h.next=4;break}throw l;case 4:return h.abrupt("return",c);case 5:case"end":return h.stop()}}),null,this)},d.prototype.hasInboundSessionKeys=function(e,t,r){var n,i=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(o){i._cryptoStore.getEndToEndInboundGroupSession(t,r,o,(function(i){null!==i?e!==i.room_id?(s.logger.warn("requested keys for inbound group session ".concat(t,"|")+"".concat(r,", with incorrect room_id ")+"(expected ".concat(i.room_id,", ")+"was ".concat(e,")")),n=!1):n=!0:n=!1}))})));case 2:return u.abrupt("return",n);case 3:case"end":return u.stop()}}),null,this)},d.prototype.getInboundGroupSessionKey=function(e,t,r,n){var i,s=this;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return u.next=2,o.default.awrap(this._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,a.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(o){s._getInboundGroupSession(e,t,r,o,(function(e,t){if(null!==e){void 0===n&&(n=e.first_known_index());var r=e.export_session(n),o=(t.keysClaimed||{}).ed25519||null;i={chain_index:n,key:r,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:o}}else i=null}))})));case 2:return u.abrupt("return",i);case 3:case"end":return u.stop()}}),null,this)},d.prototype.exportInboundGroupSession=function(e,t,r){return this._unpickleInboundGroupSession(r,(function(n){var i=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index()}}))},d.prototype.verifySignature=function(e,t,r){this._getUtility((function(n){n.ed25519_verify(e,t,r)}))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"./algorithms":63,"./store/indexeddb-crypto-store":72,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],59:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.OutgoingRoomKeyRequestManager=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/classCallCheck")),a=i(e("@babel/runtime/helpers/createClass")),u=e("../logger"),c=n(e("../utils")),l=0,d=1,h=2,p=3,f=function(){function e(t,r,n){(0,s.default)(this,e),this._baseApis=t,this._deviceId=r,this._cryptoStore=n,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}return(0,a.default)(e,[{key:"start",value:function(){this._clientRunning=!0,this._startTimer()}},{key:"stop",value:function(){u.logger.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}},{key:"sendRoomKeyRequest",value:function(e,t){var r,n,i,s,a,c=arguments;return o.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return r=c.length>2&&void 0!==c[2]&&c[2],f.next=3,o.default.awrap(this._cryptoStore.getOutgoingRoomKeyRequest(e));case 3:if(n=f.sent){f.next=9;break}return f.next=7,o.default.awrap(this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:l}));case 7:f.next=36;break;case 9:f.t0=n.state,f.next=f.t0===p?12:f.t0===l?12:f.t0===h?13:f.t0===d?17:35;break;case 12:return f.abrupt("return");case 13:return i=r?p:d,f.next=16,o.default.awrap(this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,h,{state:i,cancellationTxnId:this._baseApis.makeTxnId()}));case 16:return f.abrupt("break",36);case 17:if(!r){f.next=34;break}return s=p,f.next=21,o.default.awrap(this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,d,{state:s,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()}));case 21:if(a=f.sent){f.next=26;break}return f.next=25,o.default.awrap(this.sendRoomKeyRequest(e,t,r));case 25:return f.abrupt("return",f.sent);case 26:return f.prev=26,f.next=29,o.default.awrap(this._sendOutgoingRoomKeyRequestCancellation(a,!0));case 29:f.next=34;break;case 31:f.prev=31,f.t1=f.catch(26),u.logger.error("Error sending room key request cancellation; will retry later.",f.t1);case 34:return f.abrupt("break",36);case 35:throw new Error("unhandled state: "+n.state);case 36:this._startTimer();case 37:case"end":return f.stop()}}),null,this,[[26,31]])}},{key:"cancelRoomKeyRequest",value:function(e){var t=this;return this._cryptoStore.getOutgoingRoomKeyRequest(e).then((function(r){if(r)switch(r.state){case h:case p:return;case l:return u.logger.log("deleting unnecessary room key request for "+v(e)),t._cryptoStore.deleteOutgoingRoomKeyRequest(r.requestId,l);case d:return t._cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,d,{state:h,cancellationTxnId:t._baseApis.makeTxnId()}).then((function(r){r?t._sendOutgoingRoomKeyRequestCancellation(r).catch((function(e){u.logger.error("Error sending room key request cancellation; will retry later.",e),t._startTimer()})):u.logger.log("Tried to cancel room key request for "+v(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+r.state)}}))}},{key:"getOutgoingSentRoomKeyRequest",value:function(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[d])}},{key:"_startTimer",value:function(){var e=this;if(!this._sendOutgoingRoomKeyRequestsTimer){this._sendOutgoingRoomKeyRequestsTimer=t.setTimeout((function(){if(e._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");e._sendOutgoingRoomKeyRequestsRunning=!0,e._sendOutgoingRoomKeyRequests().finally((function(){e._sendOutgoingRoomKeyRequestsRunning=!1})).catch((function(e){u.logger.warn("error in OutgoingRoomKeyRequestManager: ".concat(e))}))}),500)}}},{key:"_sendOutgoingRoomKeyRequests",value:function(){var e=this;return this._clientRunning?(u.logger.log("Looking for queued outgoing room key requests"),this._cryptoStore.getOutgoingRoomKeyRequestByState([h,p,l]).then((function(t){if(!t)return u.logger.log("No more outgoing room key requests"),void(e._sendOutgoingRoomKeyRequestsTimer=null);var r;switch(t.state){case l:r=e._sendOutgoingRoomKeyRequest(t);break;case h:r=e._sendOutgoingRoomKeyRequestCancellation(t);break;case p:r=e._sendOutgoingRoomKeyRequestCancellation(t,!0)}return r.then((function(){return e._sendOutgoingRoomKeyRequests()})).catch((function(t){u.logger.error("Error sending room key request; will retry later.",t),e._sendOutgoingRoomKeyRequestsTimer=null,e._startTimer()}))}))):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}},{key:"_sendOutgoingRoomKeyRequest",value:function(e){var t=this;u.logger.log("Requesting keys for ".concat(v(e.requestBody))+" from ".concat(g(e.recipients))+"(id ".concat(e.requestId,")"));var r={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(r,e.recipients,e.requestTxnId||e.requestId).then((function(){return t._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,l,{state:d})}))}},{key:"_sendOutgoingRoomKeyRequestCancellation",value:function(e,t){var r=this;u.logger.log("Sending cancellation for key request for "+"".concat(v(e.requestBody)," to ")+"".concat(g(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));var n={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((function(){return t?r._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,p,{state:l}):r._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,h)}))}},{key:"_sendMessageToDevices",value:function(e,t,r){var n={},i=!0,o=!1,s=void 0;try{for(var a,u=t[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var c=a.value;n[c.userId]||(n[c.userId]={}),n[c.userId][c.deviceId]=e}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}return this._baseApis.sendToDevice("m.room_key_request",n,r)}}]),e}();function v(e){return e.room_id+" / "+e.session_id}function g(e){return"["+c.map(e,(function(e){return"".concat(e.userId,":").concat(e.deviceId)})).join(",")+"]"}r.OutgoingRoomKeyRequestManager=f}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"../utils":117,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],60:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomList=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/classCallCheck")),s=n(e("@babel/runtime/helpers/createClass")),a=e("./store/indexeddb-crypto-store"),u=function(){function e(t){(0,o.default)(this,e),this._cryptoStore=t,this._roomEncryption={}}return(0,s.default)(e,[{key:"init",value:function(){var e=this;return i.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,i.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ROOMS],(function(t){e._cryptoStore.getEndToEndRooms(t,(function(t){e._roomEncryption=t}))})));case 2:case"end":return t.stop()}}),null,this)}},{key:"getRoomEncryption",value:function(e){return this._roomEncryption[e]||null}},{key:"isRoomEncrypted",value:function(e){return Boolean(this.getRoomEncryption(e))}},{key:"setRoomEncryption",value:function(e,t){var r=this;return i.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return this._roomEncryption[e]=t,n.next=3,i.default.awrap(this._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ROOMS],(function(n){r._cryptoStore.storeEndToEndRoom(e,t,n)})));case 3:case"end":return n.stop()}}),null,this)}}]),e}();r.RoomList=u},{"./store/indexeddb-crypto-store":72,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/regenerator":23}],61:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SecretStorage=r.SECRET_STORAGE_ALGORITHM_V1=void 0;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/classCallCheck")),c=i(e("@babel/runtime/helpers/createClass")),l=i(e("@babel/runtime/helpers/possibleConstructorReturn")),d=i(e("@babel/runtime/helpers/getPrototypeOf")),h=i(e("@babel/runtime/helpers/inherits")),p=e("events"),f=e("../logger"),v=n(e("./olmlib")),g=e("../randomstring"),m="m.secret_storage.v1.curve25519-aes-sha2";r.SECRET_STORAGE_ALGORITHM_V1=m;var y=function(e){function r(e,t,n){var i;return(0,u.default)(this,r),(i=(0,l.default)(this,(0,d.default)(r).call(this)))._baseApis=e,i._cryptoCallbacks=t,i._crossSigningInfo=n,i._requests={},i._incomingRequests={},i}return(0,h.default)(r,e),(0,c.default)(r,[{key:"getDefaultKeyId",value:function(){var e;return a.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.default_key"));case 2:if(e=t.sent){t.next=5;break}return t.abrupt("return",null);case 5:return t.abrupt("return",e.key);case 6:case"end":return t.stop()}}),null,this)}},{key:"setDefaultKeyId",value:function(e){var t=this;return new Promise((function(r){t._baseApis.on("accountData",(function n(i){"m.secret_storage.default_key"===i.getType()&&i.getContent().key===e&&(t._baseApis.removeListener("accountData",n),r())})),t._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}))}},{key:"addKey",value:function(e,r,n){var i,o,s,u,c;return a.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:i={algorithm:e},r||(r={}),r.name&&(i.name=r.name),l.t0=e,l.next=l.t0===m?6:9;break;case 6:o=new t.Olm.PkDecryption;try{u=(s=r).passphrase,c=s.pubkey,u&&c?(i.passphrase=u,i.pubkey=c):i.pubkey=c||o.generate_key()}finally{o.free()}return l.abrupt("break",10);case 9:throw new Error("Unknown key algorithm ".concat(r.algorithm));case 10:if(n){l.next=15;break}case 11:n=(0,g.randomString)(32);case 12:return l.next=14,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.key.".concat(n)));case 14:if(l.sent){l.next=11;break}case 15:return l.next=17,a.default.awrap(this._crossSigningInfo.signObject(i,"master"));case 17:return l.next=19,a.default.awrap(this._baseApis.setAccountData("m.secret_storage.key.".concat(n),i));case 19:return l.abrupt("return",n);case 20:case"end":return l.stop()}}),null,this)}},{key:"signKey",value:function(e){var t;return a.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e){r.next=4;break}return r.next=3,a.default.awrap(this.getDefaultKeyId());case 3:e=r.sent;case 4:if(e){r.next=6;break}throw new Error("signKey requires a key ID");case 6:return r.next=8,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.key.".concat(e)));case 8:if(t=r.sent){r.next=11;break}throw new Error("Key ".concat(e," does not exist in account data"));case 11:return r.next=13,a.default.awrap(this._crossSigningInfo.signObject(t,"master"));case 13:return r.next=15,a.default.awrap(this._baseApis.setAccountData("m.secret_storage.key.".concat(e),t));case 15:case"end":return r.stop()}}),null,this)}},{key:"hasKey",value:function(e){return a.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=4;break}return t.next=3,a.default.awrap(this.getDefaultKeyId());case 3:e=t.sent;case 4:if(e){t.next=6;break}return t.abrupt("return",!1);case 6:return t.abrupt("return",!!this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e));case 7:case"end":return t.stop()}}),null,this)}},{key:"store",value:function(e,r,n){var i,o,s,u,c,l,d,h,p,g;return a.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:if(i={},n){y.next=8;break}return y.next=4,a.default.awrap(this.getDefaultKeyId());case 4:if(o=y.sent){y.next=7;break}throw new Error("No keys specified and no default key present");case 7:n=[o];case 8:if(0!==n.length){y.next=10;break}throw new Error("Zero keys given to encrypt with!");case 10:s=!0,u=!1,c=void 0,y.prev=13,l=n[Symbol.iterator]();case 15:if(s=(d=l.next()).done){y.next=33;break}return h=d.value,y.next=19,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.key."+h));case 19:if(p=y.sent){y.next=22;break}throw new Error("Unknown key: "+h);case 22:(0,v.pkVerify)(p,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),y.t0=p.algorithm,y.next=y.t0===m?26:29;break;case 26:g=new t.Olm.PkEncryption;try{g.set_recipient_key(p.pubkey),i[h]=g.encrypt(r)}finally{g.free()}return y.abrupt("break",30);case 29:f.logger.warn("unknown algorithm for secret storage key "+h+": "+p.algorithm);case 30:s=!0,y.next=15;break;case 33:y.next=39;break;case 35:y.prev=35,y.t1=y.catch(13),u=!0,c=y.t1;case 39:y.prev=39,y.prev=40,s||null==l.return||l.return();case 42:if(y.prev=42,!u){y.next=45;break}throw c;case 45:return y.finish(42);case 46:return y.finish(39);case 47:return y.next=49,a.default.awrap(this._baseApis.setAccountData(e,{encrypted:i}));case 49:case"end":return y.stop()}}),null,this,[[13,35,39,47],[40,,42,46]])}},{key:"storePassthrough",value:function(e,t){return this._baseApis.setAccountData(e,{encrypted:(0,s.default)({},t,{passthrough:!0})})}},{key:"_fixupStoredSecret",value:function(e,t){var r,n;return a.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(1!==(r=Object.keys(t)).length||"encrypted"===r[0]||!t[r[0]].passthrough){i.next=13;break}return i.next=4,a.default.awrap(this.hasKey(r[0]));case 4:if(!i.sent){i.next=13;break}return console.log("Fixing up passthrough secret: "+e),i.next=9,a.default.awrap(this.storePassthrough(e,r[0]));case 9:return i.next=11,a.default.awrap(this._baseApis.getAccountDataFromServer(e));case 11:return n=i.sent,i.abrupt("return",n);case 13:return i.abrupt("return",null);case 14:case"end":return i.stop()}}),null,this)}},{key:"get",value:function(e){var t,r,n,i,s,u,c,l,d,h,p,f;return a.default.async((function(v){for(;;)switch(v.prev=v.next){case 0:return v.next=2,a.default.awrap(this._baseApis.getAccountDataFromServer(e));case 2:if(t=v.sent){v.next=5;break}return v.abrupt("return");case 5:if(t.encrypted){v.next=11;break}return v.next=8,a.default.awrap(this._fixupStoredSecret(e,t));case 8:if((t=v.sent)&&t.encrypted){v.next=11;break}throw new Error("Content is not encrypted!");case 11:r={},n=0,i=Object.keys(t.encrypted);case 13:if(!(n<i.length)){v.next=27;break}return s=i[n],v.next=17,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.key."+s));case 17:u=v.sent,c=t.encrypted[s],v.t0=u.algorithm,v.next=v.t0===m?22:24;break;case 22:return u.pubkey&&(c.ciphertext&&c.mac&&c.ephemeral||c.passthrough)&&(r[s]=u),v.abrupt("break",24);case 24:n++,v.next=13;break;case 27:return v.prev=27,v.next=30,a.default.awrap(this._getSecretStorageKey(r,e));case 30:if(h=v.sent,p=(0,o.default)(h,2),l=p[0],d=p[1],!(f=t.encrypted[l]).passthrough){v.next=37;break}return v.abrupt("return",d.get_private_key());case 37:v.t1=r[l].algorithm,v.next=v.t1===m?40:41;break;case 40:return v.abrupt("return",d.decrypt(f.ephemeral,f.mac,f.ciphertext));case 41:return v.prev=41,d&&d.free(),v.finish(41);case 44:case"end":return v.stop()}}),null,this,[[27,,41,44]])}},{key:"isStored",value:function(e,t){var r,n,i,o,s,u;return a.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,a.default.awrap(this._baseApis.getAccountDataFromServer(e));case 2:if(r=c.sent){c.next=5;break}return c.abrupt("return",!1);case 5:if(r.encrypted){c.next=11;break}return c.next=8,a.default.awrap(this._fixupStoredSecret(e,r));case 8:if((r=c.sent)&&r.encrypted){c.next=11;break}return c.abrupt("return",!1);case 11:void 0===t&&(t=!0),n=0,i=Object.keys(r.encrypted);case 13:if(!(n<i.length)){c.next=33;break}return o=i[n],c.next=17,a.default.awrap(this._baseApis.getAccountDataFromServer("m.secret_storage.key."+o));case 17:if(s=c.sent){c.next=20;break}return c.abrupt("return",!1);case 20:if(u=r.encrypted[o],t&&(0,v.pkVerify)(s,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),!u.passthrough){c.next=24;break}return c.abrupt("return",!0);case 24:c.t0=s.algorithm,c.next=c.t0===m?27:30;break;case 27:if(!(s.pubkey&&u.ciphertext&&u.mac&&u.ephemeral)){c.next=29;break}return c.abrupt("return",!0);case 29:return c.abrupt("break",30);case 30:n++,c.next=13;break;case 33:return c.abrupt("return",!1);case 34:case"end":return c.stop()}}),null,this)}},{key:"request",value:function(e,t){var r=this,n=this._baseApis.makeTxnId(),i=this._requests[n]={devices:t},o=new Promise((function(e,t){i.resolve=e,i.reject=t})),a={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:n},u={},c=!0,l=!1,d=void 0;try{for(var h,p=t[Symbol.iterator]();!(c=(h=p.next()).done);c=!0){u[h.value]=a}}catch(e){l=!0,d=e}finally{try{c||null==p.return||p.return()}finally{if(l)throw d}}return this._baseApis.sendToDevice("m.secret.request",(0,s.default)({},this._baseApis.getUserId(),u)),{request_id:n,promise:o,cancel:function(e){var o={action:"request_cancellation",requesting_device_id:r._baseApis.deviceId,request_id:n},a={},u=!0,c=!1,l=void 0;try{for(var d,h=t[Symbol.iterator]();!(u=(d=h.next()).done);u=!0){a[d.value]=o}}catch(e){c=!0,l=e}finally{try{u||null==h.return||h.return()}finally{if(c)throw l}}r._baseApis.sendToDevice("m.secret.request",(0,s.default)({},r._baseApis.getUserId(),a)),i.reject(new Error(e||"Cancelled"))}}}},{key:"_onRequestReceived",value:function(e){var t,r,n,i,o,u,c;return a.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(t=e.getSender(),r=e.getContent(),t===this._baseApis.getUserId()&&(r.name&&r.action&&r.requesting_device_id&&r.request_id)){l.next=4;break}return l.abrupt("return");case 4:if(n=r.requesting_device_id,"request_cancellation"!==r.action){l.next=9;break}this._incomingRequests[n]&&this._incomingRequests[n][r.request_id]&&(f.logger.info("received request cancellation for secret ("+t+", "+n+", "+r.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:n,request_id:r.request_id})),l.next=40;break;case 9:if("request"!==r.action){l.next=40;break}if(n!==this._baseApis.deviceId){l.next=12;break}return l.abrupt("return");case 12:if(f.logger.info("received request for secret ("+t+", "+n+", "+r.request_id+")"),this._cryptoCallbacks.onSecretRequested){l.next=15;break}return l.abrupt("return");case 15:return l.next=17,a.default.awrap(this._cryptoCallbacks.onSecretRequested({user_id:t,device_id:n,request_id:r.request_id,name:r.name,device_trust:this._baseApis.checkDeviceTrust(t,n)}));case 17:if(!(i=l.sent)){l.next=40;break}return o={type:"m.secret.send",content:{request_id:r.request_id,secret:i}},u={algorithm:v.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}},l.t0=a.default,l.t1=v,l.t2=this._baseApis._crypto._olmDevice,l.t3=this._baseApis,l.t4=s.default,l.t5={},l.t6=t,l.next=30,a.default.awrap(this._baseApis.getStoredDevice(t,n));case 30:return l.t7=l.sent,l.t8=[l.t7],l.t9=(0,l.t4)(l.t5,l.t6,l.t8),l.t10=l.t1.ensureOlmSessionsForDevices.call(l.t1,l.t2,l.t3,l.t9),l.next=36,l.t0.awrap.call(l.t0,l.t10);case 36:return l.next=38,a.default.awrap(v.encryptMessageForDevice(u.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,t,this._baseApis._crypto.getStoredDevice(t,n),o));case 38:c=(0,s.default)({},t,(0,s.default)({},n,u)),this._baseApis.sendToDevice("m.room.encrypted",c);case 40:case"end":return l.stop()}}),null,this)}},{key:"_onSecretReceived",value:function(e){if(e.getSender()===this._baseApis.getUserId()){var t=e.getContent();f.logger.log("got secret share for request ",t.request_id);var r=this._requests[t.request_id];if(r){var n=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(v.OLM_ALGORITHM,e.getSenderKey());if(!n)return void f.logger.log("secret share from unknown device with key",e.getSenderKey());if(!r.devices.includes(n.deviceId))return void f.logger.log("unsolicited secret share from device",n.deviceId);r.resolve(t.secret)}}}},{key:"_getSecretStorageKey",value:function(e,r){var n,i,s,u,c,l;return a.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(this._cryptoCallbacks.getSecretStorageKey){d.next=2;break}throw new Error("No getSecretStorageKey callback supplied");case 2:return d.next=4,a.default.awrap(this._cryptoCallbacks.getSecretStorageKey({keys:e},r));case 4:if(n=d.sent){d.next=7;break}throw new Error("getSecretStorageKey callback returned falsey");case 7:if(!(n.length<2)){d.next=9;break}throw new Error("getSecretStorageKey callback returned invalid data");case 9:if(i=(0,o.default)(n,2),s=i[0],u=i[1],e[s]){d.next=12;break}throw new Error("App returned unknown key from getSecretStorageKey!");case 12:d.t0=e[s].algorithm,d.next=d.t0===m?15:28;break;case 15:c=new t.Olm.PkDecryption,d.prev=16,l=c.init_with_private_key(u),d.next=24;break;case 20:throw d.prev=20,d.t1=d.catch(16),c.free(),new Error("getSecretStorageKey callback returned invalid key");case 24:if(l===e[s].pubkey){d.next=27;break}throw c.free(),new Error("getSecretStorageKey callback returned incorrect key");case 27:return d.abrupt("return",[s,c]);case 28:throw new Error("Unknown key type: "+e[s].algorithm);case 29:case"end":return d.stop()}}),null,this,[[16,20]])}}]),r}(p.EventEmitter);r.SecretStorage=y}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"../randomstring":104,"./olmlib":69,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,events:32}],62:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.registerAlgorithm=function(e,t,r){h[e]=t,p[e]=r},r.UnknownDeviceError=r.DecryptionError=r.DecryptionAlgorithm=r.EncryptionAlgorithm=r.DECRYPTION_CLASSES=r.ENCRYPTION_CLASSES=void 0;var i=n(e("@babel/runtime/helpers/possibleConstructorReturn")),o=n(e("@babel/runtime/helpers/getPrototypeOf")),s=n(e("@babel/runtime/helpers/assertThisInitialized")),a=n(e("@babel/runtime/helpers/inherits")),u=n(e("@babel/runtime/helpers/wrapNativeSuper")),c=n(e("@babel/runtime/regenerator")),l=n(e("@babel/runtime/helpers/classCallCheck")),d=n(e("@babel/runtime/helpers/createClass")),h={};r.ENCRYPTION_CLASSES=h;var p={};r.DECRYPTION_CLASSES=p;var f=function(){function e(t){(0,l.default)(this,e),this._userId=t.userId,this._deviceId=t.deviceId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return(0,d.default)(e,[{key:"onRoomMembership",value:function(e,t,r){}}]),e}();r.EncryptionAlgorithm=f;var v=function(){function e(t){(0,l.default)(this,e),this._userId=t.userId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return(0,d.default)(e,[{key:"onRoomKeyEvent",value:function(e){}},{key:"importRoomKey",value:function(e){}},{key:"hasKeysForKeyRequest",value:function(e){return Promise.resolve(!1)}},{key:"shareKeysWithDevice",value:function(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}},{key:"retryDecryptionFromSender",value:function(e){return c.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}))}}]),e}();r.DecryptionAlgorithm=v;var g=function(e){function t(e,r,n){var a;return(0,l.default)(this,t),(a=(0,i.default)(this,(0,o.default)(t).call(this,r))).code=e,a.name="DecryptionError",a.detailedString=function(e,t){var r=e.name+"[msg: "+e.message;t&&(r+=", "+Object.keys(t).map((function(e){return e+": "+t[e]})).join(", "));return r+="]"}((0,s.default)(a),n),a}return(0,a.default)(t,e),t}((0,u.default)(Error));r.DecryptionError=g;var m=function(e){function t(e,r){var n;return(0,l.default)(this,t),(n=(0,i.default)(this,(0,o.default)(t).call(this,e))).name="UnknownDeviceError",n.devices=r,n}return(0,a.default)(t,e),t}((0,u.default)(Error));r.UnknownDeviceError=m},{"@babel/runtime/helpers/assertThisInitialized":3,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/wrapNativeSuper":22,"@babel/runtime/regenerator":23}],63:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),e("./olm"),e("./megolm");var n=e("./base");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(r,e,{enumerable:!0,get:function(){return n[e]}})}))},{"./base":62,"./megolm":64,"./olm":65}],64:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault"),o=i(e("@babel/runtime/helpers/toConsumableArray")),s=i(e("@babel/runtime/helpers/slicedToArray")),a=i(e("@babel/runtime/helpers/defineProperty")),u=i(e("@babel/runtime/regenerator")),c=e("../../logger"),l=n(e("../../utils")),d=n(e("../olmlib")),h=e("./base"),p=e("../OlmDevice");function f(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={}}function v(e){(0,l.polyfillSuper)(this,h.EncryptionAlgorithm,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function g(e){(0,l.polyfillSuper)(this,h.DecryptionAlgorithm,e),this._pendingEvents={},this.olmlib=d}f.prototype.needsRotation=function(e,t){var r=(new Date).getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(c.logger.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)},f.prototype.markSharedWithDevice=function(e,t,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=r},f.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},f.prototype.sharedWithTooManyDevices=function(e){for(var t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return c.logger.log("Starting new megolm session because we shared with "+t),!0;for(var r in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(r)&&!e[t].hasOwnProperty(r))return c.logger.log("Starting new megolm session because we shared with "+t+":"+r),!0}},l.inherits(v,h.EncryptionAlgorithm),v.prototype._ensureOutboundSession=function(e,t){var r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return o=function(){return n},i=function(i){var o,s,a,l,d,h,f,v,g,m,y,_,b,S,k,E,w,I,R;return u.default.async((function(T){for(;;)switch(T.prev=T.next){case 0:if((n=i)&&n.needsRotation(r._sessionRotationPeriodMsgs,r._sessionRotationPeriodMs)&&(c.logger.log("Starting new megolm session because we need to rotate."),n=null),n&&n.sharedWithTooManyDevices(e)&&(n=null),n){T.next=10;break}return c.logger.log("Starting new megolm session for room ".concat(r._roomId)),T.next=7,u.default.awrap(r._prepareNewSession());case 7:n=T.sent,c.logger.log("Started new megolm session ".concat(n.sessionId," ")+"for room ".concat(r._roomId)),r._outboundSessions[n.sessionId]=n;case 10:o={},T.t0=u.default.keys(e);case 12:if((T.t1=T.t0()).done){T.next=31;break}if(s=T.t1.value,e.hasOwnProperty(s)){T.next=16;break}return T.abrupt("continue",12);case 16:a=e[s],T.t2=u.default.keys(a);case 18:if((T.t3=T.t2()).done){T.next=29;break}if(l=T.t3.value,a.hasOwnProperty(l)){T.next=22;break}return T.abrupt("continue",18);case 22:if(d=a[l],d.getIdentityKey()!=r._olmDevice.deviceCurve25519Key){T.next=26;break}return T.abrupt("continue",18);case 26:n.sharedWithDevices[s]&&void 0!==n.sharedWithDevices[s][l]||(o[s]=o[s]||[],o[s].push(d)),T.next=18;break;case 29:T.next=12;break;case 31:return h=[],T.next=34,u.default.awrap(r._shareKeyWithDevices(n,o,h));case 34:f={},T.t4=u.default.keys(t);case 36:if((T.t5=T.t4()).done){T.next=51;break}if(v=T.t5.value,t.hasOwnProperty(v)){T.next=40;break}return T.abrupt("continue",36);case 40:g=t[v],T.t6=u.default.keys(g);case 42:if((T.t7=T.t6()).done){T.next=49;break}if(m=T.t7.value,g.hasOwnProperty(m)){T.next=46;break}return T.abrupt("continue",42);case 46:n.blockedDevicesNotified[v]&&void 0!==n.blockedDevicesNotified[v][m]||(f[v]=f[v]||[],f[v].push(g[m])),T.next=42;break;case 49:T.next=36;break;case 51:return T.next=53,u.default.awrap(r._olmDevice.filterOutNotifiedErrorDevices(h));case 53:for(y=T.sent,_=!0,b=!1,S=void 0,T.prev=57,k=y[Symbol.iterator]();!(_=(E=k.next()).done);_=!0)w=E.value,I=w.userId,R=w.deviceInfo,f[I]=f[I]||[],f[I].push({code:"m.no_olm",reason:p.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:R});T.next=65;break;case 61:T.prev=61,T.t8=T.catch(57),b=!0,S=T.t8;case 65:T.prev=65,T.prev=66,_||null==k.return||k.return();case 68:if(T.prev=68,!b){T.next=71;break}throw S;case 71:return T.finish(68);case 72:return T.finish(65);case 73:return T.next=75,u.default.awrap(r._notifyBlockedDevices(n,f));case 75:case"end":return T.stop()}}),null,null,[[57,61,65,73],[66,,68,72]])},r=this,s=this._setupPromise.then(i),this._setupPromise=s.then(o,o),a.abrupt("return",s.then(o));case 6:case"end":return a.stop()}}),null,this)},v.prototype._prepareNewSession=function(){var e,t;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=this._olmDevice.createOutboundGroupSession(),t=this._olmDevice.getOutboundGroupSessionKey(e),r.next=4,u.default.awrap(this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key,{ed25519:this._olmDevice.deviceEd25519Key}));case 4:return this._crypto.backupInfo&&this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key).catch((function(e){c.logger.log("Failed to back up megolm session",e)})),r.abrupt("return",new f(e));case 6:case"end":return r.stop()}}),null,this)},v.prototype._splitUserDeviceMap=function(e,t,r,n,i){for(var o=[],s=0,a=0,u=0,l=Object.keys(n);u<l.length;u++){for(var d=l[u],h=n[d],p=r[d],f=0;f<h.length;f++){var v=h[f],g=v.deviceId;p[g].sessionId?(c.logger.log("share keys with device "+d+":"+g),o[s]||(o[s]=[]),o[s].push({userId:d,deviceInfo:v}),a++):(e.markSharedWithDevice(d,g,t),i.push({userId:d,deviceInfo:v}))}a>20&&(a=0,s++)}return o},v.prototype._splitBlockedDevices=function(e){for(var t=[],r=[t],n=0,i=Object.keys(e);n<i.length;n++){var o=i[n],s=e[o],a=!0,u=!1,c=void 0;try{for(var l,d=s[Symbol.iterator]();!(a=(l=d.next()).done);a=!0){var h=l.value;t.push({userId:o,blockedInfo:h})}}catch(e){u=!0,c=e}finally{try{a||null==d.return||d.return()}finally{if(u)throw c}}t.length>20&&(t=[],r.push(t))}return 0===t.length&&r.pop(),r},v.prototype._encryptAndSendKeysToDevices=function(e,t,r,n){for(var i=this,o={},s=[],a=0;a<r.length;a++){var u={algorithm:d.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},c=r[a],l=c.userId,h=c.deviceInfo,p=h.deviceId;o[l]||(o[l]={}),o[l][p]=u,s.push(d.encryptMessageForDevice(u.ciphertext,this._userId,this._deviceId,this._olmDevice,l,h,n))}return Promise.all(s).then((function(){return i._baseApis.sendToDevice("m.room.encrypted",o).then((function(){for(var r=0,n=Object.keys(o);r<n.length;r++)for(var i=n[r],s=0,a=Object.keys(o[i]);s<a.length;s++){var u=a[s];e.markSharedWithDevice(i,u,t)}}))}))},v.prototype._sendBlockedNotificationsToDevices=function(e,t,r){var n,i,o,s,a,c,l,d,h,p,f,v,g,m,y,_,b,S;return u.default.async((function(k){for(;;)switch(k.prev=k.next){case 0:for(n={},i=!0,o=!1,s=void 0,k.prev=4,a=t[Symbol.iterator]();!(i=(c=a.next()).done);i=!0)l=c.value,d=l.userId,h=l.blockedInfo,p=h.deviceInfo,f=p.deviceId,(v=Object.assign({},r)).code=h.code,v.reason=h.reason,"m.no_olm"===v.code&&(delete v.room_id,delete v.session_id),n[d]||(n[d]={}),n[d][f]=v;k.next=12;break;case 8:k.prev=8,k.t0=k.catch(4),o=!0,s=k.t0;case 12:k.prev=12,k.prev=13,i||null==a.return||a.return();case 15:if(k.prev=15,!o){k.next=18;break}throw s;case 18:return k.finish(15);case 19:return k.finish(12);case 20:return k.next=22,u.default.awrap(this._baseApis.sendToDevice("org.matrix.room_key.withheld",n));case 22:for(g=0,m=Object.keys(n);g<m.length;g++)for(y=m[g],_=0,b=Object.keys(n[y]);_<b.length;_++)S=b[_],e.markNotifiedBlockedDevice(y,S);case 23:case"end":return k.stop()}}),null,this,[[4,8,12,20],[13,,15,19]])},v.prototype.reshareKeyWithDevice=function(e,t,r,n){var i,o,s,l,h;return u.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:if(i=this._outboundSessions[t]){p.next=4;break}return c.logger.debug("megolm session ".concat(t," not found: not re-sharing keys")),p.abrupt("return");case 4:if(void 0!==i.sharedWithDevices[r]){p.next=7;break}return c.logger.debug("megolm session ".concat(t," never shared with user ").concat(r)),p.abrupt("return");case 7:if(void 0!==(o=i.sharedWithDevices[r][n.deviceId])){p.next=11;break}return c.logger.debug("megolm session ID "+t+" never shared with device "+r+":"+n.deviceId),p.abrupt("return");case 11:return p.next=13,u.default.awrap(this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,o));case 13:if(s=p.sent){p.next=17;break}return c.logger.warn("No inbound session key found for megolm ".concat(t,": not re-sharing keys")),p.abrupt("return");case 17:return p.next=19,u.default.awrap(d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,a.default)({},r,(0,a.default)({},n.deviceId,n))));case 19:return l={type:"m.forwarded_room_key",content:{algorithm:d.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:s.key,chain_index:s.chain_index,sender_key:e,sender_claimed_ed25519_key:s.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:s.forwarding_curve25519_key_chain}},h={algorithm:d.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},p.next=23,u.default.awrap(d.encryptMessageForDevice(h.ciphertext,this._userId,this._deviceId,this._olmDevice,r,n,l));case 23:return p.next=25,u.default.awrap(this._baseApis.sendToDevice("m.room.encrypted",(0,a.default)({},r,(0,a.default)({},n.deviceId,h))));case 25:c.logger.debug("Re-shared key for megolm session ".concat(t," ")+"with ".concat(r,":").concat(n.deviceId));case 26:case"end":return p.stop()}}),null,this)},v.prototype._shareKeyWithDevices=function(e,t,r){var n,i,o,s,a;return u.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return n=this._olmDevice.getOutboundGroupSessionKey(e.sessionId),i={type:"m.room_key",content:{algorithm:d.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:e.sessionId,session_key:n.key,chain_index:n.chain_index}},l.next=4,u.default.awrap(d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t));case 4:o=l.sent,s=this._splitUserDeviceMap(e,n.chain_index,o,t,r),a=0;case 7:if(!(a<s.length)){l.next=21;break}return l.prev=8,l.next=11,u.default.awrap(this._encryptAndSendKeysToDevices(e,n.chain_index,s[a],i));case 11:c.logger.log("Completed megolm keyshare for ".concat(e.sessionId," ")+"in ".concat(this._roomId," (slice ").concat(a+1,"/").concat(s.length,")")),l.next=18;break;case 14:throw l.prev=14,l.t0=l.catch(8),c.logger.log("megolm keyshare for ".concat(e.sessionId," in ").concat(this._roomId," ")+"(slice ".concat(a+1,"/").concat(s.length,") failed")),l.t0;case 18:a++,l.next=7;break;case 21:case"end":return l.stop()}}),null,this,[[8,14]])},v.prototype._notifyBlockedDevices=function(e,t){var r,n,i;return u.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:r={room_id:this._roomId,session_id:e.sessionId,algorithm:d.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},n=this._splitBlockedDevices(t),i=0;case 3:if(!(i<n.length)){o.next=17;break}return o.prev=4,o.next=7,u.default.awrap(this._sendBlockedNotificationsToDevices(e,n[i],r));case 7:c.logger.log("Completed blacklist notification for ".concat(e.sessionId," ")+"in ".concat(this._roomId," (slice ").concat(i+1,"/").concat(n.length,")")),o.next=14;break;case 10:throw o.prev=10,o.t0=o.catch(4),c.logger.log("blacklist notification for ".concat(e.sessionId," in ")+"".concat(this._roomId," (slice ").concat(i+1,"/").concat(n.length,") failed")),o.t0;case 14:i++,o.next=3;break;case 17:case"end":return o.stop()}}),null,this,[[4,10]])},v.prototype.encryptMessage=function(e,t,r){var n,i,o,a,l,h,p,f,v;return u.default.async((function(g){for(;;)switch(g.prev=g.next){case 0:return n=this,c.logger.log("Starting to encrypt event for ".concat(this._roomId)),g.next=4,u.default.awrap(this._getDevicesInRoom(e));case 4:return i=g.sent,o=(0,s.default)(i,2),a=o[0],l=o[1],this._crypto.getGlobalErrorOnUnknownDevices()&&n._checkForUnknownDevices(a),g.next=11,u.default.awrap(n._ensureOutboundSession(a,l));case 11:return h=g.sent,p={room_id:n._roomId,type:t,content:r},f=n._olmDevice.encryptGroupMessage(h.sessionId,JSON.stringify(p)),v={algorithm:d.MEGOLM_ALGORITHM,sender_key:n._olmDevice.deviceCurve25519Key,ciphertext:f,session_id:h.sessionId,device_id:n._deviceId},h.useCount++,g.abrupt("return",v);case 17:case"end":return g.stop()}}),null,this)},v.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then((function(){return null}))},v.prototype._checkForUnknownDevices=function(e){var t={};if(Object.keys(e).forEach((function(r){Object.keys(e[r]).forEach((function(n){var i=e[r][n];i.isUnverified()&&!i.isKnown()&&(t[r]||(t[r]={}),t[r][n]=i)}))})),Object.keys(t).length)throw new h.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},v.prototype._getDevicesInRoom=function(e){var t,r,n,i,o,s,a,c,d;return u.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,u.default.awrap(e.getEncryptionTargetMembers());case 2:return t=h.sent,r=l.map(t,(function(e){return e.userId})),n=this._crypto.getGlobalBlacklistUnverifiedDevices(),"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(n=e.getBlacklistUnverifiedDevices()),h.next=8,u.default.awrap(this._crypto.downloadKeys(r,!1));case 8:i=h.sent,o={},h.t0=u.default.keys(i);case 11:if((h.t1=h.t0()).done){h.next=26;break}if(s=h.t1.value,i.hasOwnProperty(s)){h.next=15;break}return h.abrupt("continue",11);case 15:a=i[s],h.t2=u.default.keys(a);case 17:if((h.t3=h.t2()).done){h.next=24;break}if(c=h.t3.value,a.hasOwnProperty(c)){h.next=21;break}return h.abrupt("continue",17);case 21:(a[c].isBlocked()||a[c].isUnverified()&&n)&&(o[s]||(o[s]={}),(d=a[c].isBlocked()?{code:"m.blacklisted",reason:p.WITHHELD_MESSAGES["m.blacklisted"]}:{code:"m.unverified",reason:p.WITHHELD_MESSAGES["m.unverified"]}).deviceInfo=a[c],o[s][c]=d,delete a[c]),h.next=17;break;case 24:h.next=11;break;case 26:return h.abrupt("return",[i,o]);case 27:case"end":return h.stop()}}),null,this)},l.inherits(g,h.DecryptionAlgorithm);var m={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};g.prototype.decryptEvent=function(e){var t,r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if((t=e.getWireContent()).sender_key&&t.session_id&&t.ciphertext){a.next=3;break}throw new h.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");case 3:return this._addEventToPendingList(e),a.prev=4,a.next=7,u.default.awrap(this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs()));case 7:r=a.sent,a.next=17;break;case 10:if(a.prev=10,a.t0=a.catch(4),"DecryptionError"!==a.t0.name){a.next=14;break}throw a.t0;case 14:throw n="OLM_DECRYPT_GROUP_MESSAGE_ERROR",a.t0&&"OLM.UNKNOWN_MESSAGE_INDEX"===a.t0.message&&(this._requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new h.DecryptionError(n,a.t0?a.t0.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id});case 17:if(null!==r){a.next=27;break}return this._requestKeysForEvent(e),a.next=21,u.default.awrap(this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4));case 21:if(!(i=a.sent)){a.next=26;break}throw o=m[i.type]||m.unknown,i.fixed&&(o+=" Trying to create a new secure channel and re-requesting the keys."),new h.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",o,{session:t.sender_key+"|"+t.session_id});case 26:throw new h.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id});case 27:if(this._removeEventFromPendingList(e),(s=JSON.parse(r.result)).room_id===e.getRoomId()){a.next=31;break}throw new h.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+s.room_id);case 31:return a.abrupt("return",{clearEvent:s,senderCurve25519Key:r.senderKey,claimedEd25519Key:r.keysClaimed.ed25519,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain});case 32:case"end":return a.stop()}}),null,this,[[4,10]])},g.prototype._requestKeysForEvent=function(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)},g.prototype._addEventToPendingList=function(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id;this._pendingEvents[r]||(this._pendingEvents[r]=new Map);var i=this._pendingEvents[r];i.has(n)||i.set(n,new Set),i.get(n).add(e)},g.prototype._removeEventFromPendingList=function(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id,i=this._pendingEvents[r],o=i&&i.get(n);o&&(o.delete(e),0===o.size&&i.delete(r),0===i.size&&delete this._pendingEvents[r])},g.prototype.onRoomKeyEvent=function(e){var t,r=this,n=e.getContent(),i=n.session_id,o=e.getSenderKey(),s=[],a=!1;if(n.room_id&&i&&n.session_key){if(o){if("m.forwarded_room_key"==e.getType()){if(a=!0,s=n.forwarding_curve25519_key_chain,l.isArray(s)||(s=[]),(s=s.slice()).push(o),!(o=n.sender_key))return void c.logger.error("forwarded_room_key event is missing sender_key field");var u=n.sender_claimed_ed25519_key;if(!u)return void c.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");t={ed25519:u}}else t=e.getKeysClaimed();return c.logger.log("Received and adding key for megolm session ".concat(o,"|").concat(i)),this._olmDevice.addInboundGroupSession(n.room_id,o,s,i,n.session_key,t,a).then((function(){r._retryDecryption(o,i).then((function(e){e&&r._crypto.cancelRoomKeyRequest({algorithm:n.algorithm,room_id:n.room_id,session_id:n.session_id,sender_key:o})}))})).then((function(){r._crypto.backupInfo&&r._crypto.backupGroupSession(n.room_id,o,s,n.session_id,n.session_key,t,a).catch((function(e){c.logger.log("Failed to back up megolm session",e)}))})).catch((function(e){c.logger.error("Error handling m.room_key_event: ".concat(e))}))}c.logger.error("key event has no sender key (not encrypted?)")}else c.logger.error("key event is missing fields")},g.prototype.onRoomKeyWithheldEvent=function(e){var t,r,n,i,o;return u.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(t=e.getContent(),r=t.sender_key,"m.no_olm"!==t.code){s.next=30;break}return n=e.getSender(),s.next=6,u.default.awrap(this._olmDevice.getSessionIdForDevice(r));case 6:if(!s.sent){s.next=11;break}return s.next=9,u.default.awrap(this._olmDevice.recordSessionProblem(r,"no_olm",!0));case 9:return this.retryDecryptionFromSender(r),s.abrupt("return");case 11:if(i=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,r)){s.next=18;break}return c.logger.info("Couldn't find device for identity key "+r+": not establishing session"),s.next=16,u.default.awrap(this._olmDevice.recordSessionProblem(r,"no_olm",!1));case 16:return this.retryDecryptionFromSender(r),s.abrupt("return");case 18:return s.next=20,u.default.awrap(d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,a.default)({},n,[i]),!1));case 20:return o={algorithm:d.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},s.next=23,u.default.awrap(d.encryptMessageForDevice(o.ciphertext,this._userId,this._deviceId,this._olmDevice,n,i,{type:"m.dummy"}));case 23:return s.next=25,u.default.awrap(this._olmDevice.recordSessionProblem(r,"no_olm",!0));case 25:return this.retryDecryptionFromSender(r),s.next=28,u.default.awrap(this._baseApis.sendToDevice("m.room.encrypted",(0,a.default)({},n,(0,a.default)({},i.deviceId,o))));case 28:s.next=32;break;case 30:return s.next=32,u.default.awrap(this._olmDevice.addInboundGroupSessionWithheld(t.room_id,r,t.session_id,t.code,t.reason));case 32:case"end":return s.stop()}}),null,this)},g.prototype.hasKeysForKeyRequest=function(e){var t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},g.prototype.shareKeysWithDevice=function(e){var t=this,r=e.userId,n=e.deviceId,i=this._crypto.getStoredDevice(r,n),o=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,a.default)({},r,[i])).then((function(e){return e[r][n].sessionId?(c.logger.log("sharing keys for session "+o.sender_key+"|"+o.session_id+" with device "+r+":"+n),t._buildKeyForwardingMessage(o.room_id,o.sender_key,o.session_id)):null})).then((function(e){var o={algorithm:d.OLM_ALGORITHM,sender_key:t._olmDevice.deviceCurve25519Key,ciphertext:{}};return t.olmlib.encryptMessageForDevice(o.ciphertext,t._userId,t._deviceId,t._olmDevice,r,i,e).then((function(){var e=(0,a.default)({},r,(0,a.default)({},n,o));return t._baseApis.sendToDevice("m.room.encrypted",e)}))}))},g.prototype._buildKeyForwardingMessage=function(e,t,r){var n;return u.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,u.default.awrap(this._olmDevice.getInboundGroupSessionKey(e,t,r));case 2:return n=i.sent,i.abrupt("return",{type:"m.forwarded_room_key",content:{algorithm:d.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:r,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain}});case 4:case"end":return i.stop()}}),null,this)},g.prototype.importRoomKey=function(e){var t=this;return this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).then((function(){t._crypto.backupInfo&&t._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch((function(e){c.logger.log("Failed to back up megolm session",e)})),t._retryDecryption(e.sender_key,e.session_id)}))},g.prototype._retryDecryption=function(e,t){var r,n,i=this;return u.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(r=this._pendingEvents[e]){s.next=3;break}return s.abrupt("return",!0);case 3:if(n=r.get(t)){s.next=6;break}return s.abrupt("return",!0);case 6:return n.delete(t),0===n.size&&this._pendingEvents[e],s.next=10,u.default.awrap(Promise.all((0,o.default)(n).map((function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,u.default.awrap(e.attemptDecryption(i._crypto));case 3:t.next=7;break;case 5:t.prev=5,t.t0=t.catch(0);case 7:case"end":return t.stop()}}),null,null,[[0,5]])}))));case 10:return s.abrupt("return",!(this._pendingEvents[e]||{})[t]);case 11:case"end":return s.stop()}}),null,this)},g.prototype.retryDecryptionFromSender=function(e){var t,r=this;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t=this._pendingEvents[e],c.logger.warn(t),t){n.next=4;break}return n.abrupt("return",!0);case 4:return delete this._pendingEvents[e],n.next=7,u.default.awrap(Promise.all((0,o.default)(t).map((function(e){var t,n;return u.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=(0,s.default)(e,2),t[0],n=t[1],i.next=3,u.default.awrap(Promise.all((0,o.default)(n).map((function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,c.logger.warn(e.getId()),t.next=4,u.default.awrap(e.attemptDecryption(r._crypto));case 4:t.next=8;break;case 6:t.prev=6,t.t0=t.catch(0);case 8:case"end":return t.stop()}}),null,null,[[0,6]])}))));case 3:case"end":return i.stop()}}))}))));case 7:return n.abrupt("return",!this._pendingEvents[e]);case 8:case"end":return n.stop()}}),null,this)},(0,h.registerAlgorithm)(d.MEGOLM_ALGORITHM,v,g)},{"../../logger":89,"../../utils":117,"../OlmDevice":58,"../olmlib":69,"./base":62,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/helpers/toConsumableArray":20,"@babel/runtime/regenerator":23}],65:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault")(e("@babel/runtime/regenerator")),o=e("../../logger"),s=n(e("../../utils")),a=n(e("../olmlib")),u=e("../deviceinfo"),c=e("./base"),l=u.DeviceInfo.DeviceVerification;function d(e){(0,s.polyfillSuper)(this,c.EncryptionAlgorithm,e),this._sessionPrepared=!1,this._prepPromise=null}function h(e){(0,s.polyfillSuper)(this,c.DecryptionAlgorithm,e)}s.inherits(d,c.EncryptionAlgorithm),d.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();var t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(r){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},d.prototype.encryptMessage=function(e,t,r){var n,o,u,c,d,h,p,f,v,g,m;return i.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:return y.next=2,i.default.awrap(e.getEncryptionTargetMembers());case 2:return n=y.sent,o=s.map(n,(function(e){return e.userId})),u=this,y.next=7,i.default.awrap(this._ensureSession(o));case 7:c={room_id:e.roomId,type:t,content:r},d={algorithm:a.OLM_ALGORITHM,sender_key:u._olmDevice.deviceCurve25519Key,ciphertext:{}},h=[],p=0;case 11:if(!(p<o.length)){y.next=29;break}f=o[p],v=u._crypto.getStoredDevicesForUser(f),g=0;case 15:if(!(g<v.length)){y.next=26;break}if(m=v[g],m.getIdentityKey()!=u._olmDevice.deviceCurve25519Key){y.next=20;break}return y.abrupt("continue",23);case 20:if(m.verified!=l.BLOCKED){y.next=22;break}return y.abrupt("continue",23);case 22:h.push(a.encryptMessageForDevice(d.ciphertext,u._userId,u._deviceId,u._olmDevice,f,m,c));case 23:++g,y.next=15;break;case 26:++p,y.next=11;break;case 29:return y.next=31,i.default.awrap(Promise.all(h).then((function(){return d})));case 31:return y.abrupt("return",y.sent);case 32:case"end":return y.stop()}}),null,this)},s.inherits(h,c.DecryptionAlgorithm),h.prototype.decryptEvent=function(e){var t,r,n,o,s,a,u;return i.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(t=e.getWireContent(),r=t.sender_key,n=t.ciphertext){l.next=5;break}throw new c.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");case 5:if(this._olmDevice.deviceCurve25519Key in n){l.next=7;break}throw new c.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");case 7:return o=n[this._olmDevice.deviceCurve25519Key],l.prev=8,l.next=11,i.default.awrap(this._decryptMessage(r,o));case 11:s=l.sent,l.next=17;break;case 14:throw l.prev=14,l.t0=l.catch(8),new c.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:r,err:l.t0});case 17:if((a=JSON.parse(s)).recipient==this._userId){l.next=20;break}throw new c.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+a.recipient);case 20:if(a.recipient_keys.ed25519==this._olmDevice.deviceEd25519Key){l.next=22;break}throw new c.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:a.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});case 22:if(a.sender==e.getSender()){l.next=24;break}throw new c.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+a.sender,{reported_sender:e.getSender()});case 24:if(a.room_id===e.getRoomId()){l.next=26;break}throw new c.DecryptionError("OLM_BAD_ROOM","Message intended for room "+a.room_id,{reported_room:e.room_id});case 26:return u=a.keys||{},l.abrupt("return",{clearEvent:a,senderCurve25519Key:r,claimedEd25519Key:u.ed25519||null});case 28:case"end":return l.stop()}}),null,this,[[8,14]])},h.prototype._decryptMessage=function(e,t){var r,n,s,a,u,c;return i.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,i.default.awrap(this._olmDevice.getSessionIdsForDevice(e));case 2:r=l.sent,n={},s=0;case 5:if(!(s<r.length)){l.next=26;break}return a=r[s],l.prev=7,l.next=10,i.default.awrap(this._olmDevice.decryptMessage(e,a,t.type,t.body));case 10:return u=l.sent,o.logger.log("Decrypted Olm message from "+e+" with session "+a),l.abrupt("return",u);case 15:return l.prev=15,l.t0=l.catch(7),l.next=19,i.default.awrap(this._olmDevice.matchesSession(e,a,t.type,t.body));case 19:if(!l.sent){l.next=22;break}throw new Error("Error decrypting prekey message with existing session id "+a+": "+l.t0.message);case 22:n[a]=l.t0.message;case 23:s++,l.next=5;break;case 26:if(0===t.type){l.next=30;break}if(0!==r.length){l.next=29;break}throw new Error("No existing sessions");case 29:throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(n));case 30:return l.prev=30,l.next=33,i.default.awrap(this._olmDevice.createInboundSession(e,t.type,t.body));case 33:c=l.sent,l.next=40;break;case 36:throw l.prev=36,l.t1=l.catch(30),n["(new)"]=l.t1.message,new Error("Error decrypting prekey message: "+JSON.stringify(n));case 40:return o.logger.log("created new inbound Olm session ID "+c.session_id+" with "+e),l.abrupt("return",c.payload);case 42:case"end":return l.stop()}}),null,this,[[7,15],[30,36]])},(0,c.registerAlgorithm)(a.OLM_ALGORITHM,d,h)},{"../../logger":89,"../../utils":117,"../deviceinfo":66,"../olmlib":69,"./base":62,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],66:[function(e,t,r){"use strict";function n(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=i.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceInfo=n,n.fromStorage=function(e,t){var r=new n(t);for(var i in e)e.hasOwnProperty(i)&&(r[i]=e[i]);return r},n.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},n.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},n.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},n.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},n.prototype.isBlocked=function(){return this.verified==i.BLOCKED},n.prototype.isVerified=function(){return this.verified==i.VERIFIED},n.prototype.isUnverified=function(){return this.verified==i.UNVERIFIED},n.prototype.isKnown=function(){return 1==this.known},n.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};var i=n.DeviceVerification},{}],67:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault"),i=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.isCryptoAvailable=function(){return Boolean(t.Olm)},r.Crypto=q,r.verificationMethods=void 0;var o,s=n(e("@babel/runtime/helpers/classCallCheck")),a=n(e("@babel/runtime/helpers/slicedToArray")),u=n(e("@babel/runtime/regenerator")),c=n(e("@babel/runtime/helpers/defineProperty")),l=n(e("another-json")),d=e("events"),h=e("../ReEmitter"),p=e("../logger"),f=i(e("../utils")),v=e("./OlmDevice"),g=i(e("./olmlib")),m=e("./DeviceList"),y=e("./deviceinfo"),_=i(e("./algorithms")),b=e("./CrossSigning"),S=e("./SecretStorage"),k=e("./OutgoingRoomKeyRequestManager"),E=e("./store/indexeddb-crypto-store"),w=e("./verification/QRCode"),I=e("./verification/SAS"),R=e("./key_passphrase"),T=e("./recoverykey"),x=e("./verification/request/VerificationRequest"),O=e("./verification/request/InRoomChannel"),C=e("./verification/request/ToDeviceChannel"),D=i(e("../http-api")),A=e("./verification/IllegalMethod"),P=y.DeviceInfo.DeviceVerification,M=(o={},(0,c.default)(o,w.ReciprocateQRCode.NAME,w.ReciprocateQRCode),(0,c.default)(o,I.SAS.NAME,I.SAS),(0,c.default)(o,w.SHOW_QR_CODE_METHOD,A.IllegalMethod),(0,c.default)(o,w.SCAN_QR_CODE_METHOD,A.IllegalMethod),o),U={RECIPROCATE_QR_CODE:w.ReciprocateQRCode.NAME,SAS:I.SAS.NAME};r.verificationMethods=U;function q(e,t,r,n,i,o,s,a){var c=this;if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._reEmitter=new h.ReEmitter(this),this._baseApis=e,this._sessionStore=t,this._userId=r,this._deviceId=n,this._clientStore=i,this._cryptoStore=o,this._roomList=s,a){this._verificationMethods=new Map;var l=!0,d=!1,p=void 0;try{for(var g,y=a[Symbol.iterator]();!(l=(g=y.next()).done);l=!0){var E=g.value;"string"==typeof E?M[E]&&this._verificationMethods.set(E,M[E]):E.NAME?this._verificationMethods.set(E.NAME,E):console.warn("Excluding unknown verification method ".concat(E))}}catch(e){d=!0,p=e}finally{try{l||null==y.return||y.return()}finally{if(d)throw p}}}else this._verificationMethods=M;this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new v.OlmDevice(o),this._deviceList=new m.DeviceList(e,o,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=f.keys(_.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new k.OutgoingRoomKeyRequestManager(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new C.ToDeviceRequests,this._inRoomVerificationRequests=new O.InRoomRequests;var w=this._baseApis._cryptoCallbacks||{};this._crossSigningInfo=new b.CrossSigningInfo(r,w),this._secretStorage=new S.SecretStorage(e,w,this._crossSigningInfo),!w.getCrossSigningKey&&w.getSecretStorageKey&&(w.getCrossSigningKey=function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",b.CrossSigningInfo.getFromSecretStorage(e,c._secretStorage));case 1:case"end":return t.stop()}}))})}function L(e){var t=5;if(!e._oneTimeKeyCheckInProgress){var r=Date.now();if(!(null!==e._lastOneTimeKeyCheck&&r-e._lastOneTimeKeyCheck<6e4)){e._lastOneTimeKeyCheck=r;var n=e._olmDevice.maxNumberOfOneTimeKeys(),i=Math.floor(n/2);e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then((function(){return void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({}).then((function(e){return e.one_time_key_counts.signed_curve25519||0}))})).then((function(e){return o(e)})).catch((function(e){p.logger.error("Error uploading one-time keys",e.stack||e)})).finally((function(){e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1}))}}function o(r){if(i<=r)return Promise.resolve();var n=Math.min(i-r,t);return e._olmDevice.generateOneTimeKeys(n).then((function(){return function(e){var t,r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,u.default.awrap(e._olmDevice.getOneTimeKeys());case 2:for(i in t=a.sent,r={},n=[],t.curve25519)t.curve25519.hasOwnProperty(i)&&(o={key:t.curve25519[i]},r["signed_curve25519:"+i]=o,n.push(e._signObject(o)));return a.next=8,u.default.awrap(Promise.all(n));case 8:return a.next=10,u.default.awrap(e._baseApis.uploadKeysRequest({one_time_keys:r}));case 10:return s=a.sent,a.next=13,u.default.awrap(e._olmDevice.markKeysAsPublished());case 13:return a.abrupt("return",s);case 14:case"end":return a.stop()}}))}(e)})).then((function(e){if(e.one_time_key_counts&&e.one_time_key_counts.signed_curve25519)return o(e.one_time_key_counts.signed_curve25519);throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}))}}f.inherits(q,d.EventEmitter),q.prototype.init=function(e){var r,n,i,o=this;return u.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return r=(e||{}).exportedOlmDevice,p.logger.log("Crypto: initialising Olm..."),s.next=4,u.default.awrap(t.Olm.init());case 4:return p.logger.log(r?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),s.next=7,u.default.awrap(this._olmDevice.init({fromExportedDevice:r}));case 7:return p.logger.log("Crypto: loading device list..."),s.next=10,u.default.awrap(this._deviceList.load());case 10:return this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,p.logger.log("Crypto: fetching own devices..."),(n=this._deviceList.getRawStoredDevicesForUser(this._userId))||(n={}),n[this._deviceId]||(p.logger.log("Crypto: adding this device to the store..."),i={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:P.VERIFIED,known:!0},n[this._deviceId]=i,this._deviceList.storeDevicesForUser(this._userId,n),this._deviceList.saveIfDirty()),s.next=18,u.default.awrap(this._cryptoStore.doTxn("readonly",[E.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){o._cryptoStore.getCrossSigningKeys(e,(function(e){e&&(p.logger.log("Loaded cross-signing public keys from crypto store"),o._crossSigningInfo.setKeys(e))}))})));case 18:this._deviceList.startTrackingDeviceList(this._userId),p.logger.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup();case 21:case"end":return s.stop()}}),null,this)},q.prototype.createRecoveryKeyFromPassphrase=function(e){var r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(r=new t.Olm.PkDecryption,a.prev=1,n={},!e){a.next=11;break}return a.next=6,u.default.awrap((0,R.keyFromPassphrase)(e));case 6:i=a.sent,n.passphrase={algorithm:"m.pbkdf2",iterations:i.iterations,salt:i.salt},n.pubkey=r.init_with_private_key(i.key),a.next=12;break;case 11:n.pubkey=r.generate_key();case 12:return o=r.get_private_key(),s=(0,T.encodeRecoveryKey)(o),a.abrupt("return",[n,s,o]);case 15:return a.prev=15,r&&r.free(),a.finish(15);case 18:case"end":return a.stop()}}),null,null,[[1,,15,18]])},q.prototype.bootstrapSecretStorage=function(){var e,t,r,n,i,o,s,a,c,l,d,h,f,v,g,m,y,_=arguments;return u.default.async((function(k){for(;;)switch(k.prev=k.next){case 0:if(e=_.length>0&&void 0!==_[0]?_[0]:{},t=e.authUploadDeviceSigningKeys,r=e.createSecretStorageKey,n=void 0===r?function(){return u.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}))}:r,i=e.keyBackupInfo,o=e.setupNewKeyBackup,s=e.setupNewSecretStorage,p.logger.log("Bootstrapping Secure Secret Storage"),a={},c=Object.assign({},this._baseApis._cryptoCallbacks),k.prev=4,k.t0=!s,!k.t0){k.next=10;break}return k.next=9,u.default.awrap(this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage));case 9:k.t0=k.sent;case 10:if(l=k.t0,this._crossSigningInfo.getId()&&l){k.next=26;break}if(p.logger.log("Cross-signing public and/or private keys not found, checking secret storage for private keys"),!l){k.next=19;break}return p.logger.log("Cross-signing private keys found in secret storage"),k.next=17,u.default.awrap(this.checkOwnCrossSigningTrust());case 17:k.next=24;break;case 19:return p.logger.log("Cross-signing private keys not found in secret storage, creating new keys"),this._baseApis._cryptoCallbacks.saveCrossSigningKeys=function(e){return Object.assign(a,e)},this._baseApis._cryptoCallbacks.getCrossSigningKey=function(e){return a[e]},k.next=24,u.default.awrap(this.resetCrossSigningKeys(b.CrossSigningLevel.MASTER,{authUploadDeviceSigningKeys:t}));case 24:k.next=27;break;case 26:p.logger.log("Cross signing keys are present in secret storage");case 27:if(k.t1=s,k.t1){k.next=32;break}return k.next=31,u.default.awrap(this.hasSecretStorageKey());case 31:k.t1=!k.sent;case 32:if(!k.t1){k.next=66;break}if(!i){k.next=55;break}return p.logger.log("Secret storage default key not found, using key backup key"),h={pubkey:i.auth_data.public_key},i.auth_data.private_key_salt&&i.auth_data.private_key_iterations&&(h.passphrase={algorithm:"m.pbkdf2",iterations:i.auth_data.private_key_iterations,salt:i.auth_data.private_key_salt}),k.next=39,u.default.awrap(this.addSecretStorageKey(S.SECRET_STORAGE_ALGORITHM_V1,h));case 39:return d=k.sent,this._secretStorage.storePassthrough("m.megolm_backup.v1",d),k.next=43,u.default.awrap(this.checkKeyBackup(i));case 43:if(!k.sent.trustInfo.usable){k.next=52;break}return console.log("Adding cross signing signature to key backup"),k.next=48,u.default.awrap(this._crossSigningInfo.signObject(i.auth_data,"master"));case 48:return k.next=50,u.default.awrap(this._baseApis._http.authedRequest(void 0,"PUT","/room_keys/version/"+i.version,void 0,i,{prefix:D.PREFIX_UNSTABLE}));case 50:k.next=53;break;case 52:console.log("Key backup is NOT TRUSTED: NOT adding cross signing signature");case 53:k.next=62;break;case 55:return p.logger.log("Secret storage default key not found, creating new key"),k.next=58,u.default.awrap(n());case 58:return f=k.sent,k.next=61,u.default.awrap(this.addSecretStorageKey(S.SECRET_STORAGE_ALGORITHM_V1,f));case 61:d=k.sent;case 62:return k.next=64,u.default.awrap(this.setDefaultSecretStorageKeyId(d));case 64:k.next=67;break;case 66:p.logger.log("Have secret storage key");case 67:if(!Object.keys(a).length){k.next=74;break}return p.logger.log("Storing cross-signing private keys in secret storage"),k.next=71,u.default.awrap(this._secretStorage.signKey());case 71:if(c.saveCrossSigningKeys){k.next=74;break}return k.next=74,u.default.awrap(b.CrossSigningInfo.storeInSecretStorage(a,this._secretStorage));case 74:if(!o||i){k.next=80;break}return k.next=77,u.default.awrap(this._baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!0}));case 77:return v=k.sent,k.next=80,u.default.awrap(this._baseApis.createKeyBackupVersion(v));case 80:for(k.prev=80,g=0,m=Object.keys(this._baseApis._cryptoCallbacks);g<m.length;g++)y=m[g],delete this._baseApis._cryptoCallbacks[y];return Object.assign(this._baseApis._cryptoCallbacks,c),k.finish(80);case 84:p.logger.log("Secure Secret Storage ready");case 85:case"end":return k.stop()}}),null,this,[[4,,80,84]])},q.prototype.addSecretStorageKey=function(e,t,r){return this._secretStorage.addKey(e,t,r)},q.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},q.prototype.storeSecret=function(e,t,r){return this._secretStorage.store(e,t,r)},q.prototype.getSecret=function(e){return this._secretStorage.get(e)},q.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},q.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},q.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},q.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},q.prototype.checkSecretStoragePrivateKey=function(e,r){var n=null;try{return(n=new t.Olm.PkDecryption).init_with_private_key(e)===r}finally{n&&n.free()}},q.prototype.checkCrossSigningPrivateKey=function(e,r){var n=null;try{return(n=new t.Olm.PkSigning).init_with_seed(e)===r}finally{n&&n.free()}},q.prototype.resetCrossSigningKeys=function(e){var t,r,n,i,o,s,c,l,d,h,f=this,v=arguments;return u.default.async((function(g){for(;;)switch(g.prev=g.next){case 0:return t=v.length>1&&void 0!==v[1]?v[1]:{},r=t.authUploadDeviceSigningKeys,n=void 0===r?function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.default.awrap(e());case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}))}:r,p.logger.info("Resetting cross-signing keys at level ".concat(e)),i=Object.assign({},this._crossSigningInfo.keys),g.prev=3,g.next=6,u.default.awrap(this._crossSigningInfo.resetKeys(e));case 6:return g.next=8,u.default.awrap(this._signObject(this._crossSigningInfo.keys.master));case 8:for(o={},s=0,c=Object.entries(this._crossSigningInfo.keys);s<c.length;s++)l=(0,a.default)(c[s],2),d=l[0],h=l[1],o[d+"_key"]=h;return g.next=12,u.default.awrap(n((function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,u.default.awrap(f._baseApis.uploadDeviceSigningKeys(e,o));case 2:case"end":return t.stop()}}))})));case 12:return g.next=14,u.default.awrap(this._cryptoStore.doTxn("readwrite",[E.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){f._cryptoStore.storeCrossSigningKeys(e,f._crossSigningInfo.keys)})));case 14:g.next=21;break;case 16:throw g.prev=16,g.t0=g.catch(3),p.logger.error("Resetting cross-signing keys failed, revert to previous keys",g.t0),this._crossSigningInfo.keys=i,g.t0;case 21:return this._baseApis.emit("crossSigning.keysChanged",{}),g.next=24,u.default.awrap(this._afterCrossSigningLocalKeyChange());case 24:p.logger.info("Cross-signing key reset complete");case 25:case"end":return g.stop()}}),null,this,[[3,16]])},q.prototype._afterCrossSigningLocalKeyChange=function(){var e,t,r,n,i,o,s,l,d,h,f,v,g,m,y,_,S;return u.default.async((function(k){for(;;)switch(k.prev=k.next){case 0:return e=this._deviceList.getStoredDevice(this._userId,this._deviceId),k.next=3,u.default.awrap(this._crossSigningInfo.signDevice(this._userId,e));case 3:return t=k.sent,k.next=6,u.default.awrap(this._baseApis.uploadKeySignatures((0,c.default)({},this._userId,(0,c.default)({},this._deviceId,t))));case 6:r={},n=0,i=Object.entries(this._deviceList._crossSigningInfo);case 8:if(!(n<i.length)){k.next=17;break}return o=(0,a.default)(i[n],2),s=o[0],l=o[1],k.next=12,u.default.awrap(this._checkForDeviceVerificationUpgrade(s,b.CrossSigningInfo.fromStorage(l,s)));case 12:(d=k.sent)&&(r[s]=d);case 14:n++,k.next=8;break;case 17:if(h=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications,!(Object.keys(r).length>0&&h)){k.next=56;break}return k.prev=19,k.next=22,u.default.awrap(h({users:r}));case 22:if(!(f=k.sent)){k.next=51;break}v=!0,g=!1,m=void 0,k.prev=27,y=f[Symbol.iterator]();case 29:if(v=(_=y.next()).done){k.next=37;break}if(!((S=_.value)in r)){k.next=34;break}return k.next=34,u.default.awrap(this._baseApis.setDeviceVerified(S,r[S].crossSigningInfo.getId()));case 34:v=!0,k.next=29;break;case 37:k.next=43;break;case 39:k.prev=39,k.t0=k.catch(27),g=!0,m=k.t0;case 43:k.prev=43,k.prev=44,v||null==y.return||y.return();case 46:if(k.prev=46,!g){k.next=49;break}throw m;case 49:return k.finish(46);case 50:return k.finish(43);case 51:k.next=56;break;case 53:k.prev=53,k.t1=k.catch(19),p.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",k.t1);case 56:case"end":return k.stop()}}),null,this,[[19,53],[27,39,43,51],[44,,46,50]])},q.prototype._checkForDeviceVerificationUpgrade=function(e,t){var r,n,i;return u.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(r=this._crossSigningInfo.checkUserTrust(t),!t.firstUse||r.verified){o.next=8;break}return n=this._deviceList.getRawStoredDevicesForUser(e),o.next=5,u.default.awrap(this._checkForValidDeviceSignature(e,t.keys.master,n));case 5:if(!(i=o.sent).length){o.next=8;break}return o.abrupt("return",{devices:i.map((function(e){return y.DeviceInfo.fromStorage(n[e],e)})),crossSigningInfo:t});case 8:case"end":return o.stop()}}),null,this)},q.prototype._checkForValidDeviceSignature=function(e,t,r){var n,i,o,s,c,l,d;return u.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(n=[],!(r&&t.signatures&&t.signatures[e])){h.next=18;break}i=0,o=Object.keys(t.signatures[e]);case 3:if(!(i<o.length)){h.next=18;break}if(s=o[i],c=s.split(":",2),l=(0,a.default)(c,2),!((d=l[1])in r&&r[d].verified===P.VERIFIED)){h.next=15;break}return h.prev=7,h.next=10,u.default.awrap(g.verifySignature(this._olmDevice,t,e,d,r[d].keys[s]));case 10:n.push(d),h.next=15;break;case 13:h.prev=13,h.t0=h.catch(7);case 15:i++,h.next=3;break;case 18:return h.abrupt("return",n);case 19:case"end":return h.stop()}}),null,this,[[7,13]])},q.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},q.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},q.prototype.checkUserTrust=function(e){var t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new b.UserTrustLevel(!1,!1)},q.prototype.checkDeviceTrust=function(e,t){var r=this._deviceList.getStoredDevice(e,t),n=r&&r.isVerified(),i=this._deviceList.getStoredCrossSigningForUser(e);return r&&i?this._crossSigningInfo.checkDeviceTrust(i,r,n):new b.DeviceTrustLevel(!1,!1,n)},q.prototype._onDeviceListUserCrossSigningUpdated=function(e){var t,r,n,i;return u.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(e!==this._userId){o.next=13;break}if(t=this._deviceList.getStoredCrossSigningForUser(e),r=t?t.getId():null,n=this._crossSigningInfo.getId(),i=n!==r,!n||!r||i){o.next=10;break}return o.next=8,u.default.awrap(this.checkOwnCrossSigningTrust());case 8:o.next=11;break;case 10:this.emit("crossSigning.keysChanged",{});case 11:o.next=16;break;case 13:return o.next=15,u.default.awrap(this._checkDeviceVerifications(e));case 15:this.emit("userTrustStatusChanged",e,this.checkUserTrust(e));case 16:case"end":return o.stop()}}),null,this)},q.prototype.checkOwnCrossSigningTrust=function(){var e,t,r,n,i,o,s,a,l,d,h;return u.default.async((function(f){for(;;)switch(f.prev=f.next){case 0:return e=this._userId,f.next=3,u.default.awrap(this.downloadKeys([this._userId]));case 3:if(t=this._deviceList.getStoredCrossSigningForUser(e)){f.next=7;break}return p.logger.error("Got cross-signing update event for user "+e+" but no new cross-signing information found!"),f.abrupt("return");case 7:if(r=t.getId(),!(n=this._crossSigningInfo.getId()!==r)){f.next=23;break}return p.logger.info("Got new master public key",r),i=null,f.prev=12,f.next=15,u.default.awrap(this._crossSigningInfo.getCrossSigningKey("master",r));case 15:if(o=f.sent,i=o[1]){f.next=19;break}throw new Error("Cross-signing master private key not available");case 19:return f.prev=19,i&&i.free(),f.finish(19);case 22:p.logger.info("Got matching private key from callback for new public master key");case 23:if(s=this._crossSigningInfo.getId("self_signing"),a=this._crossSigningInfo.getId("user_signing"),this._storeTrustedSelfKeys(t.keys),l={},s===t.getId("self_signing")){f.next=34;break}return p.logger.info("Got new self-signing key",t.getId("self_signing")),d=this._deviceList.getStoredDevice(this._userId,this._deviceId),f.next=32,u.default.awrap(this._crossSigningInfo.signDevice(this._userId,d));case 32:h=f.sent,l[this._deviceId]=h;case 34:if(a!==t.getId("user_signing")&&p.logger.info("Got new user-signing key",t.getId("user_signing")),!n){f.next=39;break}return f.next=38,u.default.awrap(this._signObject(this._crossSigningInfo.keys.master));case 38:l[this._crossSigningInfo.getId()]=this._crossSigningInfo.keys.master;case 39:if(!Object.keys(l).length){f.next=42;break}return f.next=42,u.default.awrap(this._baseApis.uploadKeySignatures((0,c.default)({},this._userId,l)));case 42:if(this.emit("userTrustStatusChanged",e,this.checkUserTrust(e)),!n){f.next=47;break}return this._baseApis.emit("crossSigning.keysChanged",{}),f.next=47,u.default.awrap(this._afterCrossSigningLocalKeyChange());case 47:return f.next=49,u.default.awrap(this.checkKeyBackup());case 49:case"end":return f.stop()}}),null,this,[[12,,19,22]])},q.prototype._storeTrustedSelfKeys=function(e){var t=this;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return this._crossSigningInfo.setKeys(e),r.next=3,u.default.awrap(this._cryptoStore.doTxn("readwrite",[E.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){t._cryptoStore.storeCrossSigningKeys(e,t._crossSigningInfo.keys)})));case 3:case"end":return r.stop()}}),null,this)},q.prototype._checkDeviceVerifications=function(e){var t,r,n;return u.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(!this._crossSigningInfo.keys.user_signing){i.next=14;break}if(!(t=this._deviceList.getStoredCrossSigningForUser(e))){i.next=14;break}return i.next=5,u.default.awrap(this._checkForDeviceVerificationUpgrade(e,t));case 5:if(r=i.sent,n=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications,!r||!n){i.next=14;break}return i.next=10,u.default.awrap(n({users:(0,c.default)({},e,r)}));case 10:if(!i.sent.includes(e)){i.next=14;break}return i.next=14,u.default.awrap(this._baseApis.setDeviceVerified(e,t.getId()));case 14:case"end":return i.stop()}}),null,this)},q.prototype._checkAndStartKeyBackup=function(){var e,t;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(p.logger.log("Checking key backup status..."),!this._baseApis.isGuest()){r.next=5;break}return p.logger.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,r.abrupt("return",null);case 5:return r.prev=5,r.next=8,u.default.awrap(this._baseApis.getKeyBackupVersion());case 8:e=r.sent,r.next=16;break;case 11:return r.prev=11,r.t0=r.catch(5),p.logger.log("Error checking for active key backup",r.t0),r.t0.httpStatus/100==4&&(this._checkedForBackup=!0),r.abrupt("return",null);case 16:return this._checkedForBackup=!0,r.next=19,u.default.awrap(this.isKeyBackupTrusted(e));case 19:return(t=r.sent).usable&&!this.backupInfo?(p.logger.log("Found usable key backup v"+e.version+": enabling key backups"),this._baseApis.enableKeyBackup(e)):!t.usable&&this.backupInfo?(p.logger.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(p.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(e)):p.logger.log("Backup version "+e.version+" still current")):p.logger.log("No usable key backup: not enabling key backup"),r.abrupt("return",{backupInfo:e,trustInfo:t});case 22:case"end":return r.stop()}}),null,this,[[5,11]])},q.prototype.setTrustedBackupPubKey=function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this._sessionStore.setLocalTrustedBackupPubKey(e),t.next=3,u.default.awrap(this.checkKeyBackup());case 3:case"end":return t.stop()}}),null,this)},q.prototype.checkKeyBackup=function(){return u.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return this._checkedForBackup=!1,e.abrupt("return",this._checkAndStartKeyBackup());case 2:case"end":return e.stop()}}),null,this)},q.prototype.isKeyBackupTrusted=function(e){var t,r,n,i,o,s,a,c,l,d;return u.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(t={usable:!1,trusted_locally:!1,sigs:[]},e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures){h.next=4;break}return p.logger.info("Key backup is absent or missing required data"),h.abrupt("return",t);case 4:r=this._sessionStore.getLocalTrustedBackupPubKey(),e.auth_data.public_key===r&&(p.logger.info("Backup public key "+r+" is trusted locally"),t.trusted_locally=!0),n=e.auth_data.signatures[this._userId]||[],i=0,o=Object.keys(n);case 8:if(!(i<o.length)){h.next=54;break}if(s=o[i],"ed25519"===(a=s.split(":"))[0]){h.next=14;break}return p.logger.log("Ignoring unknown signature type: "+a[0]),h.abrupt("continue",51);case 14:if(c={deviceId:a[1]},(l=this._crossSigningInfo.getId())!==c.deviceId){h.next=30;break}return c.crossSigningId=!0,h.prev=18,h.next=21,u.default.awrap(g.verifySignature(this._olmDevice,e.auth_data,this._userId,c.deviceId,l));case 21:c.valid=!0,h.next=28;break;case 24:h.prev=24,h.t0=h.catch(18),p.logger.warning("Bad signature from cross signing key "+l,h.t0),c.valid=!1;case 28:return t.sigs.push(c),h.abrupt("continue",51);case 30:if(!(d=this._deviceList.getStoredDevice(this._userId,c.deviceId))){h.next=48;break}return c.device=d,h.next=35,u.default.awrap(this.checkDeviceTrust(this._userId,c.deviceId));case 35:return c.deviceTrust=h.sent,h.prev=36,h.next=39,u.default.awrap(g.verifySignature(this._olmDevice,e.auth_data,this._userId,d.deviceId,d.getFingerprint()));case 39:c.valid=!0,h.next=46;break;case 42:h.prev=42,h.t1=h.catch(36),p.logger.info("Bad signature from key ID "+s+" userID "+this._userId+" device ID "+d.deviceId+" fingerprint: "+d.getFingerprint(),e.auth_data,h.t1),c.valid=!1;case 46:h.next=50;break;case 48:c.valid=null,p.logger.info("Ignoring signature from unknown key "+s);case 50:t.sigs.push(c);case 51:i++,h.next=8;break;case 54:return t.usable=t.sigs.some((function(e){return e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)})),t.usable|=t.trusted_locally,h.abrupt("return",t);case 57:case"end":return h.stop()}}),null,this,[[18,24],[36,42]])},q.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},q.prototype.registerEventHandlers=function(e){var t=this;e.on("RoomMember.membership",(function(e,r,n){try{t._onRoomMembership(e,r,n)}catch(e){p.logger.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",t._onToDeviceEvent.bind(t));var r=t._onTimelineEvent.bind(t);e.on("Room.timeline",r),e.on("Event.decrypted",r)},q.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},q.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop()},q.getOlmVersion=function(){return v.OlmDevice.getOlmVersion()},q.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},q.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},q.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},q.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},q.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},q.prototype.uploadDeviceKeys=function(){var e=this,t=e._userId,r=e._deviceId,n={algorithms:e._supportedAlgorithms,device_id:r,keys:e._deviceKeys,user_id:t};return e._signObject(n).then((function(){return e._baseApis.uploadKeysRequest({device_keys:n})}))},q.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},q.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},q.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},q.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},q.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},q.prototype.setDeviceVerification=function(e,t,r,n,i){var o,s,a,l,d,h,f,v;return u.default.async((function(g){for(;;)switch(g.prev=g.next){case 0:if(void 0===r&&(r=null),void 0===n&&(n=null),void 0===i&&(i=null),!(o=this._deviceList.getStoredCrossSigningForUser(e))||o.getId()!==t){g.next=23;break}if(null===n&&null===i){g.next=7;break}throw new Error("Cannot set blocked or known for a cross-signing key");case 7:if(r){g.next=9;break}throw new Error("Cannot set a cross-signing key as unverified");case 9:if(this._crossSigningInfo.getId()||e!==this._crossSigningInfo.userId||this._storeTrustedSelfKeys(o.keys),e===this._userId){g.next=22;break}return p.logger.info("Master key "+o.getId()+" for "+e+" marked verified. Signing..."),g.next=14,u.default.awrap(this._crossSigningInfo.signUser(o));case 14:if(!(s=g.sent)){g.next=19;break}return p.logger.info("Uploading signature for "+e+"..."),g.next=19,u.default.awrap(this._baseApis.uploadKeySignatures((0,c.default)({},e,(0,c.default)({},t,s))));case 19:return g.abrupt("return",s);case 22:return g.abrupt("return",o);case 23:if((a=this._deviceList.getRawStoredDevicesForUser(e))&&a[t]){g.next=26;break}throw new Error("Unknown device "+e+":"+t);case 26:if(l=a[t],d=l.verified,r?d=P.VERIFIED:null!==r&&d==P.VERIFIED&&(d=P.UNVERIFIED),n?d=P.BLOCKED:null!==n&&d==P.BLOCKED&&(d=P.UNVERIFIED),h=l.known,null!==i&&(h=i),l.verified===d&&l.known===h||(l.verified=d,l.known=h,this._deviceList.storeDevicesForUser(e,a),this._deviceList.saveIfDirty()),!r||e!==this._userId){g.next=42;break}return p.logger.info("Own device "+t+" marked verified: signing"),g.next=37,u.default.awrap(this._crossSigningInfo.signDevice(e,y.DeviceInfo.fromStorage(l,t)));case 37:if(!(f=g.sent)){g.next=42;break}return p.logger.info("Uploading signature for "+t),g.next=42,u.default.awrap(this._baseApis.uploadKeySignatures((0,c.default)({},e,(0,c.default)({},t,f))));case 42:return v=y.DeviceInfo.fromStorage(l,t),this.emit("deviceVerificationChanged",e,t,v),g.abrupt("return",v);case 45:case"end":return g.stop()}}),null,this)},q.prototype.findVerificationRequestDMInProgress=function(e){return this._inRoomVerificationRequests.findRequestInProgress(e)},q.prototype.requestVerificationDM=function(e,t){var r=this._inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);var n=new O.InRoomChannel(this._baseApis,t,e);return this._requestVerificationWithChannel(e,n,this._inRoomVerificationRequests)},q.prototype.requestVerification=function(e,t){t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));var r=this._toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);var n=new C.ToDeviceChannel(this._baseApis,e,t);return this._requestVerificationWithChannel(e,n,this._toDeviceVerificationRequests)},q.prototype._requestVerificationWithChannel=function(e,t,r){var n,i;return u.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new x.VerificationRequest(t,this._verificationMethods,this._baseApis),e.next=3,u.default.awrap(n.sendRequest());case 3:return(i=r.getRequestByChannel(t))?n=i:(p.logger.log("Crypto: adding new request to "+"requestsByTxnId with id ".concat(t.transactionId," ").concat(t.roomId)),r.setRequestByChannel(t,n)),e.abrupt("return",n);case 6:case"end":return e.stop()}}),null,this)},q.prototype.beginKeyVerification=function(e,t,r){var n,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(i){if(!(n=this._toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,i)))throw new Error("No request found for user ".concat(t," with ")+"transactionId ".concat(i))}else{i=C.ToDeviceChannel.makeTransactionId();var o=new C.ToDeviceChannel(this._baseApis,t,[r],i,r);n=new x.VerificationRequest(o,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,n)}return n.beginKeyVerification(e,{userId:t,deviceId:r})},q.prototype.getOlmSessionsForUser=function(e){var t,r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:t=this.getStoredDevicesForUser(e)||[],r={},n=0;case 3:if(!(n<t.length)){a.next=13;break}return i=t[n],o=i.getIdentityKey(),a.next=8,u.default.awrap(this._olmDevice.getSessionInfoForDevice(o));case 8:s=a.sent,r[i.deviceId]={deviceIdKey:o,sessions:s};case 10:++n,a.next=3;break;case 13:return a.abrupt("return",r);case 14:case"end":return a.stop()}}),null,this)},q.prototype.getEventSenderDeviceInfo=function(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;var n=this._deviceList.getDeviceByIdentityKey(r,t);if(null===n)return null;var i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(p.logger.warn("Event "+e.getId()+" claims ed25519 key "+i+"but sender device has key "+n.getFingerprint()),null):n:(p.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},q.prototype.forceDiscardSession=function(e){var t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},q.prototype.setRoomEncryption=function(e,t,r){var n,i,o,s;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(t.algorithm){r.next=3;break}return p.logger.log("Ignoring setRoomEncryption with no algorithm"),r.abrupt("return");case 3:if(!(n=this._roomList.getRoomEncryption(e))){r.next=8;break}if(JSON.stringify(n)==JSON.stringify(t)){r.next=8;break}return p.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e),r.abrupt("return");case 8:if(!this._roomEncryptors[e]){r.next=11;break}return r.abrupt("return");case 11:if(i=null,n||(i=this._roomList.setRoomEncryption(e,t)),o=_.ENCRYPTION_CLASSES[t.algorithm]){r.next=16;break}throw new Error("Unable to encrypt with "+t.algorithm);case 16:if(s=new o({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t}),this._roomEncryptors[e]=s,!i){r.next=21;break}return r.next=21,u.default.awrap(i);case 21:if(this._lazyLoadMembers){r.next=28;break}return p.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),r.next=25,u.default.awrap(this.trackRoomDevices(e));case 25:this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists(),r.next=29;break;case 28:p.logger.log("Enabling encryption in "+e);case 29:case"end":return r.stop()}}),null,this)},q.prototype.trackRoomDevices=function(e){var t,r=this,n=this._roomDeviceTrackingState[e];return n||(n=u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(r._roomEncryptors[e]){n.next=2;break}return n.abrupt("return");case 2:if(t=r._clientStore.getRoom(e)){n.next=5;break}throw new Error("Unable to start tracking devices in unknown room ".concat(e));case 5:return p.logger.log("Starting to track devices for room ".concat(e," ...")),n.next=8,u.default.awrap(t.getEncryptionTargetMembers());case 8:n.sent.forEach((function(e){r._deviceList.startTrackingDeviceList(e.userId)}));case 10:case"end":return n.stop()}})),this._roomDeviceTrackingState[e]=n),n},q.prototype.ensureOlmSessionsForUsers=function(e){for(var t={},r=0;r<e.length;++r){var n=e[r];t[n]=[];for(var i=this.getStoredDevicesForUser(n)||[],o=0;o<i.length;++o){var s=i[o];s.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(s.verified!=P.BLOCKED&&t[n].push(s))}}return g.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},q.prototype.exportRoomKeys=function(){var e,t=this;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return e=[],r.next=3,u.default.awrap(this._cryptoStore.doTxn("readonly",[E.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],(function(r){t._cryptoStore.getAllEndToEndInboundGroupSessions(r,(function(r){if(null!==r){var n=t._olmDevice.exportInboundGroupSession(r.senderKey,r.sessionId,r.sessionData);delete n.first_known_index,n.algorithm=g.MEGOLM_ALGORITHM,e.push(n)}}))})));case 3:return r.abrupt("return",e);case 4:case"end":return r.stop()}}),null,this)},q.prototype.importRoomKeys=function(e){var t=this;return Promise.all(e.map((function(e){return e.room_id&&e.algorithm?t._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e):(p.logger.warn("ignoring room key entry with missing fields",e),null)})))},q.prototype.scheduleKeyBackupSend=function(){var e,t,r,n=arguments;return u.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(e=n.length>0&&void 0!==n[0]?n[0]:1e4,!this._sendingBackups){i.next=3;break}return i.abrupt("return");case 3:return this._sendingBackups=!0,i.prev=4,t=Math.random()*e,i.next=8,u.default.awrap((0,f.sleep)(t));case 8:r=0;case 9:if(this.backupKey){i.next=12;break}return i.abrupt("return");case 12:return i.prev=12,i.next=15,u.default.awrap(this._backupPendingKeys(200));case 15:if(0!==i.sent){i.next=18;break}return i.abrupt("return");case 18:r=0,i.next=31;break;case 21:if(i.prev=21,i.t0=i.catch(12),r++,p.logger.log("Key backup request failed",i.t0),!i.t0.data){i.next=31;break}if("M_NOT_FOUND"!=i.t0.data.errcode&&"M_WRONG_ROOM_KEYS_VERSION"!=i.t0.data.errcode){i.next=31;break}return i.next=29,u.default.awrap(this.checkKeyBackup());case 29:throw this.emit("crypto.keyBackupFailed",i.t0.data.errcode),i.t0;case 31:if(!r){i.next=34;break}return i.next=34,u.default.awrap((0,f.sleep)(1e3*Math.pow(2,Math.min(r-1,4))));case 34:i.next=9;break;case 36:return i.prev=36,this._sendingBackups=!1,i.finish(36);case 39:case"end":return i.stop()}}),null,this,[[4,,36,39],[12,21]])},q.prototype._backupPendingKeys=function(e){var t,r,n,i,o,s,a,c,l,d,h,p,f,v,m;return u.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:return y.next=2,u.default.awrap(this._cryptoStore.getSessionsNeedingBackup(e));case 2:if((t=y.sent).length){y.next=5;break}return y.abrupt("return",0);case 5:return y.next=7,u.default.awrap(this._cryptoStore.countSessionsNeedingBackup());case 7:r=y.sent,this.emit("crypto.keyBackupSessionsRemaining",r),n={},i=!0,o=!1,s=void 0,y.prev=13,a=t[Symbol.iterator]();case 15:if(i=(c=a.next()).done){y.next=34;break}return l=c.value,d=l.sessionData.room_id,void 0===n[d]&&(n[d]={sessions:{}}),y.next=21,u.default.awrap(this._olmDevice.exportInboundGroupSession(l.senderKey,l.sessionId,l.sessionData));case 21:(h=y.sent).algorithm=g.MEGOLM_ALGORITHM,delete h.session_id,delete h.room_id,p=h.first_known_index,delete h.first_known_index,f=this.backupKey.encrypt(JSON.stringify(h)),v=(h.forwarding_curve25519_key_chain||[]).length,m=this._deviceList.getDeviceByIdentityKey(g.MEGOLM_ALGORITHM,l.senderKey),n[d].sessions[l.sessionId]={first_message_index:p,forwarded_count:v,is_verified:!(!m||!m.isVerified()),session_data:f};case 31:i=!0,y.next=15;break;case 34:y.next=40;break;case 36:y.prev=36,y.t0=y.catch(13),o=!0,s=y.t0;case 40:y.prev=40,y.prev=41,i||null==a.return||a.return();case 43:if(y.prev=43,!o){y.next=46;break}throw s;case 46:return y.finish(43);case 47:return y.finish(40);case 48:return y.next=50,u.default.awrap(this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}));case 50:return y.next=52,u.default.awrap(this._cryptoStore.unmarkSessionsNeedingBackup(t));case 52:return y.next=54,u.default.awrap(this._cryptoStore.countSessionsNeedingBackup());case 54:return r=y.sent,this.emit("crypto.keyBackupSessionsRemaining",r),y.abrupt("return",t.length);case 57:case"end":return y.stop()}}),null,this,[[13,36,40,48],[41,,43,47]])},q.prototype.backupGroupSession=function(e,t,r,n,i,o,s){return u.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.backupInfo){e.next=2;break}throw new Error("Key backups are not enabled");case 2:return e.next=4,u.default.awrap(this._cryptoStore.markSessionsNeedingBackup([{senderKey:t,sessionId:n}]));case 4:this.scheduleKeyBackupSend();case 5:case"end":return e.stop()}}),null,this)},q.prototype.scheduleAllGroupSessionsForBackup=function(){return u.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.default.awrap(this.flagAllGroupSessionsForBackup());case 2:this.scheduleKeyBackupSend(0);case 3:case"end":return e.stop()}}),null,this)},q.prototype.flagAllGroupSessionsForBackup=function(){var e,t=this;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u.default.awrap(this._cryptoStore.doTxn("readwrite",[E.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,E.IndexedDBCryptoStore.STORE_BACKUP],(function(e){t._cryptoStore.getAllEndToEndInboundGroupSessions(e,(function(r){null!==r&&t._cryptoStore.markSessionsNeedingBackup([r],e)}))})));case 2:return r.next=4,u.default.awrap(this._cryptoStore.countSessionsNeedingBackup());case 4:return e=r.sent,this.emit("crypto.keyBackupSessionsRemaining",e),r.abrupt("return",e);case 7:case"end":return r.stop()}}),null,this)},q.prototype.encryptEvent=function(e,t){var r,n,i,o,s;return u.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(t){a.next=2;break}throw new Error("Cannot send encrypted messages in unknown rooms");case 2:if(r=e.getRoomId(),n=this._roomEncryptors[r]){a.next=6;break}throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");case 6:return this._roomDeviceTrackingState[r]||this.trackRoomDevices(r),a.next=9,u.default.awrap(this._roomDeviceTrackingState[r]);case 9:return i=e.getContent(),(o=i["m.relates_to"])&&delete(i=Object.assign({},i))["m.relates_to"],a.next=14,u.default.awrap(n.encryptMessage(t,e.getType(),i));case 14:s=a.sent,o&&(s["m.relates_to"]=o),e.makeEncrypted("m.room.encrypted",s,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key);case 17:case"end":return a.stop()}}),null,this)},q.prototype.decryptEvent=function(e){if(e.isRedacted())return Promise.resolve({clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{}}});var t=e.getWireContent();return this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},q.prototype.handleDeviceListChanges=function(e,t){return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(e.oldSyncToken){r.next=2;break}return r.abrupt("return");case 2:return r.next=4,u.default.awrap(this._evalDeviceListChanges(t));case 4:case"end":return r.stop()}}),null,this)},q.prototype.requestRoomKey=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._outgoingRoomKeyRequestManager.sendRoomKeyRequest(e,t,r).catch((function(e){p.logger.error("Error requesting key for event",e)}))},q.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((function(e){p.logger.warn("Error clearing pending room key requests",e)}))},q.prototype.onCryptoEvent=function(e){var t,r;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.getRoomId(),r=e.getContent(),n.prev=2,n.next=5,u.default.awrap(this.setRoomEncryption(t,r,!0));case 5:n.next=10;break;case 7:n.prev=7,n.t0=n.catch(2),p.logger.error("Error configuring encryption in room "+t+":",n.t0);case 10:case"end":return n.stop()}}),null,this,[[2,7]])},q.prototype.onSyncWillProcess=function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:e.oldSyncToken||(p.logger.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={});case 1:case"end":return t.stop()}}),null,this)},q.prototype.onSyncCompleted=function(e){var t;return u.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:t=e.nextSyncToken,this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(L(this),this._processReceivedRoomKeyRequests());case 7:case"end":return r.stop()}}),null,this)},q.prototype._evalDeviceListChanges=function(e){var t,r=this;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach((function(e){r._deviceList.invalidateUserDeviceList(e)})),!(e.left&&Array.isArray(e.left)&&e.left.length)){n.next=8;break}return n.t0=Set,n.next=5,u.default.awrap(this._getTrackedE2eUsers());case 5:n.t1=n.sent,t=new n.t0(n.t1),e.left.forEach((function(e){t.has(e)||r._deviceList.stopTrackingDeviceList(e)}));case 8:case"end":return n.stop()}}),null,this)},q.prototype._getTrackedE2eUsers=function(){var e,t,r,n,i,o,s,a,c,l,d,h,p,f;return u.default.async((function(v){for(;;)switch(v.prev=v.next){case 0:e=[],t=!0,r=!1,n=void 0,v.prev=4,i=this._getTrackedE2eRooms()[Symbol.iterator]();case 6:if(t=(o=i.next()).done){v.next=33;break}return s=o.value,v.next=10,u.default.awrap(s.getEncryptionTargetMembers());case 10:for(a=v.sent,c=!0,l=!1,d=void 0,v.prev=14,h=a[Symbol.iterator]();!(c=(p=h.next()).done);c=!0)f=p.value,e.push(f.userId);v.next=22;break;case 18:v.prev=18,v.t0=v.catch(14),l=!0,d=v.t0;case 22:v.prev=22,v.prev=23,c||null==h.return||h.return();case 25:if(v.prev=25,!l){v.next=28;break}throw d;case 28:return v.finish(25);case 29:return v.finish(22);case 30:t=!0,v.next=6;break;case 33:v.next=39;break;case 35:v.prev=35,v.t1=v.catch(4),r=!0,n=v.t1;case 39:v.prev=39,v.prev=40,t||null==i.return||i.return();case 42:if(v.prev=42,!r){v.next=45;break}throw n;case 45:return v.finish(42);case 46:return v.finish(39);case 47:return v.abrupt("return",e);case 48:case"end":return v.stop()}}),null,this,[[4,35,39,47],[14,18,22,30],[23,,25,29],[40,,42,46]])},q.prototype._getTrackedE2eRooms=function(){var e=this;return this._clientStore.getRooms().filter((function(t){if(!e._roomEncryptors[t.roomId])return!1;if(!e._roomDeviceTrackingState[t.roomId])return!1;var r=t.getMyMembership();return"join"===r||"invite"===r}))},q.prototype._onToDeviceEvent=function(e){var t=this;try{p.logger.log("received to_device ".concat(e.getType()," from: ")+"".concat(e.getSender()," id: ").concat(e.getId())),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",(function(e){t._onToDeviceEvent(e)}))}catch(e){p.logger.error("Error handling toDeviceEvent:",e)}},q.prototype._onRoomKeyEvent=function(e){var t=e.getContent();t.room_id&&t.algorithm?(this._checkedForBackup||this._checkAndStartKeyBackup(),this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)):p.logger.error("key event is missing fields")},q.prototype._onRoomKeyWithheldEvent=function(e){var t=e.getContent();if(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key){p.logger.info("Got room key withheld event from ".concat(e.getSender()," (").concat(t.sender_key,") ")+"for ".concat(t.algorithm,"/").concat(t.room_id,"/").concat(t.session_id," ")+"with reason ".concat(t.code," (").concat(t.reason,")"));var r=this._getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){var n=this._getRoomDecryptors(t.algorithm),i=!0,o=!1,s=void 0;try{for(var a,u=n[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){a.value.retryDecryptionFromSender(t.sender_key)}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}}}else p.logger.error("key withheld event is missing fields")},q.prototype._onKeyVerificationMessage=function(e){var t=this;if(C.ToDeviceChannel.validateEvent(e,this._baseApis)){this._handleVerificationEvent(e,this._toDeviceVerificationRequests,(function(e){if(C.ToDeviceChannel.canCreateRequest(C.ToDeviceChannel.getEventType(e))){var r=e.getContent(),n=r&&r.from_device;if(n){var i=e.getSender(),o=new C.ToDeviceChannel(t._baseApis,i,[n]);return new x.VerificationRequest(o,t._verificationMethods,t._baseApis)}}}))}},q.prototype._onTimelineEvent=function(e,t,r,n){var i=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},s=o.liveEvent;if(O.InRoomChannel.validateEvent(e,this._baseApis)){var a=function(e){var t=new O.InRoomChannel(i._baseApis,e.getRoomId());return new x.VerificationRequest(t,i._verificationMethods,i._baseApis)};this._handleVerificationEvent(e,this._inRoomVerificationRequests,a,s)}},q.prototype._handleVerificationEvent=function(e,t,r){var n,i,o,s,a=arguments;return u.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(n=!(a.length>3&&void 0!==a[3])||a[3],i=t.getRequest(e),o=!1,i){c.next=10;break}if(i=r(e)){c.next=8;break}return p.logger.log("Crypto: could not find VerificationRequest for "+"".concat(e.getType(),", and could not create one, so ignoring.")),c.abrupt("return");case 8:o=!0,t.setRequest(e,i);case 10:return e.setVerificationRequest(i),c.prev=11,s=!!i.verifier,c.next=15,u.default.awrap(i.channel.handleEvent(e,i,n));case 15:!s&&i.verifier&&this._baseApis.emit("crypto.verification.start",i.verifier),c.next=21;break;case 18:c.prev=18,c.t0=c.catch(11),p.logger.error("error while handling verification event: "+c.t0.message);case 21:o&&!i.initiatedByMe&&!i.invalid&&!i.observeOnly&&this._baseApis.emit("crypto.verification.request",i);case 23:case"end":return c.stop()}}),null,this,[[11,18]])},q.prototype._onToDeviceBadEncrypted=function(e){var t,r,n,i,o,s,a,l,d,h,f,v,m,y,_,b,S=this;return u.default.async((function(k){for(;;)switch(k.prev=k.next){case 0:if(t=e.getWireContent(),r=e.getSender(),n=t.algorithm,i=t.sender_key,o=function(){var e=S._getRoomDecryptors(g.MEGOLM_ALGORITHM),t=!0,r=!1,n=void 0;try{for(var o,s=e[Symbol.iterator]();!(t=(o=s.next()).done);t=!0){o.value.retryDecryptionFromSender(i)}}catch(e){r=!0,n=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw n}}},void 0!==r&&void 0!==i&&void 0!==i){k.next=7;break}return k.abrupt("return");case 7:if(this._lastNewSessionForced[r]=this._lastNewSessionForced[r]||{},!((s=this._lastNewSessionForced[r][i]||0)+36e5>Date.now())){k.next=15;break}return p.logger.debug("New session already forced with device "+r+":"+i+" at "+s+": not forcing another"),k.next=13,u.default.awrap(this._olmDevice.recordSessionProblem(i,"wedged",!0));case 13:return o(),k.abrupt("return");case 15:if(a=this._deviceList.getDeviceByIdentityKey(n,i)){k.next=22;break}return p.logger.info("Couldn't find device for identity key "+i+": not re-establishing session"),k.next=20,u.default.awrap(this._olmDevice.recordSessionProblem(i,"wedged",!1));case 20:return o(),k.abrupt("return");case 22:return(l={})[r]=[a],k.next=26,u.default.awrap(g.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,l,!0));case 26:return this._lastNewSessionForced[r][i]=Date.now(),d={algorithm:g.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},k.next=30,u.default.awrap(g.encryptMessageForDevice(d.ciphertext,this._userId,this._deviceId,this._olmDevice,r,a,{type:"m.dummy"}));case 30:return k.next=32,u.default.awrap(this._olmDevice.recordSessionProblem(i,"wedged",!0));case 32:return o(),k.next=35,u.default.awrap(this._baseApis.sendToDevice("m.room.encrypted",(0,c.default)({},r,(0,c.default)({},a.deviceId,d))));case 35:return k.next=37,u.default.awrap(this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(r,a.deviceId));case 37:for(h=k.sent,f=!0,v=!1,m=void 0,k.prev=41,y=h[Symbol.iterator]();!(f=(_=y.next()).done);f=!0)b=_.value,this.requestRoomKey(b.requestBody,b.recipients,!0);k.next=49;break;case 45:k.prev=45,k.t0=k.catch(41),v=!0,m=k.t0;case 49:k.prev=49,k.prev=50,f||null==y.return||y.return();case 52:if(k.prev=52,!v){k.next=55;break}throw m;case 55:return k.finish(52);case 56:return k.finish(49);case 57:case"end":return k.stop()}}),null,this,[[41,45,49,57],[50,,52,56]])},q.prototype._onRoomMembership=function(e,t,r){var n=t.roomId,i=this._roomEncryptors[n];i&&(this._roomDeviceTrackingState[n]&&("join"==t.membership?(p.logger.log("Join event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(p.logger.log("Invite event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,r))},q.prototype._onRoomKeyRequestEvent=function(e){var t=e.getContent();if("request"===t.action){var r=new N(e);this._receivedRoomKeyRequests.push(r)}else if("request_cancellation"===t.action){var n=new B(e);this._receivedRoomKeyRequestCancellations.push(n)}},q.prototype._processReceivedRoomKeyRequests=function(){var e,t,r=this;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(!this._processingRoomKeyRequests){n.next=2;break}return n.abrupt("return");case 2:return this._processingRoomKeyRequests=!0,n.prev=3,e=this._receivedRoomKeyRequests,this._receivedRoomKeyRequests=[],t=this._receivedRoomKeyRequestCancellations,this._receivedRoomKeyRequestCancellations=[],n.next=10,u.default.awrap(Promise.all(e.map((function(e){return r._processReceivedRoomKeyRequest(e)}))));case 10:return n.next=12,u.default.awrap(Promise.all(t.map((function(e){return r._processReceivedRoomKeyRequestCancellation(e)}))));case 12:n.next=17;break;case 14:n.prev=14,n.t0=n.catch(3),p.logger.error("Error processing room key requsts: ".concat(n.t0));case 17:return n.prev=17,this._processingRoomKeyRequests=!1,n.finish(17);case 20:case"end":return n.stop()}}),null,this,[[3,14,17,20]])},q.prototype._processReceivedRoomKeyRequest=function(e){var t,r,n,i,o,s,a,c,l;return u.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:if(t=e.userId,r=e.deviceId,n=e.requestBody,i=n.room_id,o=n.algorithm,p.logger.log("m.room_key_request from ".concat(t,":").concat(r)+" for ".concat(i," / ").concat(n.session_id," (id ").concat(e.requestId,")")),t===this._userId){d.next=24;break}if(this._roomEncryptors[i]){d.next=10;break}return p.logger.debug("room key request for unencrypted room ".concat(i)),d.abrupt("return");case 10:if(s=this._roomEncryptors[i],a=this._deviceList.getStoredDevice(t,r)){d.next=15;break}return p.logger.debug("Ignoring keyshare for unknown device ".concat(t,":").concat(r)),d.abrupt("return");case 15:return d.prev=15,d.next=18,u.default.awrap(s.reshareKeyWithDevice(n.sender_key,n.session_id,t,a));case 18:d.next=23;break;case 20:d.prev=20,d.t0=d.catch(15),p.logger.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+a.deviceId,d.t0);case 23:return d.abrupt("return");case 24:if(this._roomDecryptors[i]){d.next=27;break}return p.logger.log("room key request for unencrypted room ".concat(i)),d.abrupt("return");case 27:if(c=this._roomDecryptors[i][o]){d.next=31;break}return p.logger.log("room key request for unknown alg ".concat(o," in room ").concat(i)),d.abrupt("return");case 31:return d.next=33,u.default.awrap(c.hasKeysForKeyRequest(e));case 33:if(d.sent){d.next=36;break}return p.logger.log("room key request for unknown session ".concat(i," / ")+n.session_id),d.abrupt("return");case 36:if(e.share=function(){c.shareKeysWithDevice(e)},!(l=this._deviceList.getStoredDevice(t,r))||!l.isVerified()){d.next=42;break}return p.logger.log("device is already verified: sharing keys"),e.share(),d.abrupt("return");case 42:this.emit("crypto.roomKeyRequest",e);case 43:case"end":return d.stop()}}),null,this,[[15,20]])},q.prototype._processReceivedRoomKeyRequestCancellation=function(e){return u.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:p.logger.log("m.room_key_request cancellation for ".concat(e.userId,":")+"".concat(e.deviceId," (id ").concat(e.requestId,")")),this.emit("crypto.roomKeyRequestCancellation",e);case 2:case"end":return t.stop()}}),null,this)},q.prototype._getRoomDecryptor=function(e,t){var r,n;if((e=e||null)&&((r=this._roomDecryptors[e])||(this._roomDecryptors[e]=r={}),n=r[t]))return n;var i=_.DECRYPTION_CLASSES[t];if(!i)throw new _.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),r&&(r[t]=n),n},q.prototype._getRoomDecryptors=function(e){for(var t=[],r=0,n=Object.values(this._roomDecryptors);r<n.length;r++){var i=n[r];e in i&&t.push(i[e])}return t},q.prototype._signObject=function(e){var t,r;return u.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.signatures||{},r=e.unsigned,delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},n.next=7,u.default.awrap(this._olmDevice.sign(l.default.stringify(e)));case 7:t[this._userId]["ed25519:"+this._deviceId]=n.sent,e.signatures=t,void 0!==r&&(e.unsigned=r);case 10:case"end":return n.stop()}}),null,this)};var N=function e(t){(0,s.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id,this.requestBody=r.body||{},this.share=function(){throw new Error("don't know how to share keys for this request yet")}},B=function e(t){(0,s.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../ReEmitter":49,"../http-api":86,"../logger":89,"../utils":117,"./CrossSigning":56,"./DeviceList":57,"./OlmDevice":58,"./OutgoingRoomKeyRequestManager":59,"./SecretStorage":61,"./algorithms":63,"./deviceinfo":66,"./key_passphrase":68,"./olmlib":69,"./recoverykey":70,"./store/indexeddb-crypto-store":72,"./verification/IllegalMethod":77,"./verification/QRCode":78,"./verification/SAS":79,"./verification/request/InRoomChannel":80,"./verification/request/ToDeviceChannel":81,"./verification/request/VerificationRequest":82,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,"another-json":24,events:32}],68:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.keyFromAuthData=function(e,r){return i.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.Olm){n.next=2;break}throw new Error("Olm is not available");case 2:if(e.private_key_salt&&e.private_key_iterations){n.next=4;break}throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");case 4:return n.next=6,i.default.awrap(a(r,e.private_key_salt,e.private_key_iterations));case 6:return n.abrupt("return",n.sent);case 7:case"end":return n.stop()}}))},r.keyFromPassphrase=function(e){var r,n;return i.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(t.Olm){u.next=2;break}throw new Error("Olm is not available");case 2:return r=(0,o.randomString)(32),u.next=5,i.default.awrap(a(e,r,s));case 5:return n=u.sent,u.abrupt("return",{key:n,salt:r,iterations:s});case 7:case"end":return u.stop()}}))},r.deriveKey=a;var i=n(e("@babel/runtime/regenerator")),o=e("../randomstring"),s=5e5;function a(e,r,n){var o,s,a,u;return i.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:if(o=t.crypto.subtle,s=t.TextEncoder,o&&s){c.next=4;break}throw new Error("Password-based backup is not avaiable on this platform");case 4:return c.next=6,i.default.awrap(o.importKey("raw",(new s).encode(e),{name:"PBKDF2"},!1,["deriveBits"]));case 6:return a=c.sent,c.next=9,i.default.awrap(o.deriveBits({name:"PBKDF2",salt:(new s).encode(r),iterations:n,hash:"SHA-512"},a,8*t.Olm.PRIVATE_KEY_LENGTH));case 9:return u=c.sent,c.abrupt("return",new Uint8Array(u));case 11:case"end":return c.stop()}}))}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../randomstring":104,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/regenerator":23}],69:[function(e,t,r){(function(t,n){"use strict";var i=e("@babel/runtime/helpers/interopRequireWildcard"),o=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.encryptMessageForDevice=function(e,t,r,n,i,o,c){var l,d,h;return s.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return l=o.getIdentityKey(),p.next=3,s.default.awrap(n.getSessionIdForDevice(l));case 3:if(null!==(d=p.sent)){p.next=6;break}return p.abrupt("return");case 6:return a.logger.log("Using sessionid "+d+" for device "+i+":"+o.deviceId),h={sender:t,sender_device:r,keys:{ed25519:n.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:o.getFingerprint()}},u.extend(h,c),p.next=11,s.default.awrap(n.encryptMessage(l,d,JSON.stringify(h)));case 11:e[l]=p.sent;case 12:case"end":return p.stop()}}))},r.ensureOlmSessionsForDevices=function(e,t,r,n){var i,o,u,c,d,h,p,f,v,g,m,y,_,b,S;return s.default.async((function(k){for(;;)switch(k.prev=k.next){case 0:i=[],o={},u={},k.t0=s.default.keys(r);case 4:if((k.t1=k.t0()).done){k.next=20;break}if(c=k.t1.value,r.hasOwnProperty(c)){k.next=8;break}return k.abrupt("continue",4);case 8:o[c]={},d=r[c],h=function(t){var r,a,l,h;return s.default.async((function(p){for(;;)switch(p.prev=p.next){case 0:return r=d[t],a=r.deviceId,l=r.getIdentityKey(),e._sessionsInProgress[l]||(e._sessionsInProgress[l]=new Promise((function(t,r){u[l]={resolve:function(){delete e._sessionsInProgress[l],t.apply(void 0,arguments)},reject:function(){delete e._sessionsInProgress[l],r.apply(void 0,arguments)}}}))),p.next=6,s.default.awrap(e.getSessionIdForDevice(l,u[l]));case 6:null!==(h=p.sent)&&u[l]&&(delete e._sessionsInProgress[l],u[l].resolve(),delete u[l]),(null===h||n)&&i.push([c,a]),o[c][a]={device:r,sessionId:h};case 10:case"end":return p.stop()}}))},p=0;case 12:if(!(p<d.length)){k.next=18;break}return k.next=15,s.default.awrap(h(p));case 15:p++,k.next=12;break;case 18:k.next=4;break;case 20:if(0!==i.length){k.next=22;break}return k.abrupt("return",o);case 22:return f="signed_curve25519",k.prev=23,k.next=26,s.default.awrap(t.claimOneTimeKeys(i,f));case 26:v=k.sent,k.next=34;break;case 29:for(k.prev=29,k.t2=k.catch(23),g=0,m=Object.values(u);g<m.length;g++)m[g].resolve();throw a.logger.log("failed to claim one-time keys",k.t2,i),k.t2;case 34:y=v.one_time_keys||{},_=[],b=function(t){if(!r.hasOwnProperty(t))return"continue";for(var i=y[t]||{},s=r[t],c=function(r){var c=s[r],d=c.deviceId,h=c.getIdentityKey();if(o[t][d].sessionId&&!n)return"continue";var p=i[d]||{},v=null;for(var g in p)0===g.indexOf(f+":")&&(v=p[g]);if(!v){var m="No one-time keys (alg="+f+") for device "+t+":"+d;return a.logger.warn(m),u[h]&&u[h].resolve(),"continue"}_.push(l(e,v,t,c).then((function(e){u[h]&&u[h].resolve(e),o[t][d].sessionId=e}),(function(e){throw u[h]&&u[h].resolve(),e})))},d=0;d<s.length;d++)c(d)},k.t3=s.default.keys(r);case 38:if((k.t4=k.t3()).done){k.next=45;break}if(S=k.t4.value,"continue"!==b(S)){k.next=43;break}return k.abrupt("continue",38);case 43:k.next=38;break;case 45:return k.next=47,s.default.awrap(Promise.all(_));case 47:return k.abrupt("return",o);case 48:case"end":return k.stop()}}),null,null,[[23,29]])},r.verifySignature=d,r.pkSign=function(e,r,n,i){var o=!1;if(r instanceof Uint8Array){var s=new t.Olm.PkSigning;i=s.init_with_seed(r),r=s,o=!0}var a=e.signatures||{};delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{var l=a[n]||{};return a[n]=l,l["ed25519:"+i]=r.sign(c.default.stringify(e))}finally{e.signatures=a,u&&(e.unsigned=u),o&&r.free()}},r.pkVerify=function(e,r,n){var i="ed25519:"+r;if(!(e.signatures&&e.signatures[n]&&e.signatures[n][i]))throw new Error("No signature");var o=e.signatures[n][i],s=new t.Olm.Utility,a=e.signatures;delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{s.ed25519_verify(r,c.default.stringify(e),o)}finally{e.signatures=a,u&&(e.unsigned=u),s.free()}},r.encodeBase64=function(e){return n.from(e).toString("base64")},r.decodeBase64=function(e){return n.from(e,"base64")},r.MEGOLM_BACKUP_ALGORITHM=r.MEGOLM_ALGORITHM=r.OLM_ALGORITHM=void 0;var s=o(e("@babel/runtime/regenerator")),a=e("../logger"),u=i(e("../utils")),c=o(e("another-json"));r.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2";r.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2";function l(e,t,r,n){var i,o;return s.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return i=n.deviceId,u.prev=1,u.next=4,s.default.awrap(d(e,t,r,i,n.getFingerprint()));case 4:u.next=10;break;case 6:return u.prev=6,u.t0=u.catch(1),a.logger.error("Unable to verify signature on one-time key for device "+r+":"+i+":",u.t0),u.abrupt("return",null);case 10:return u.prev=10,u.next=13,s.default.awrap(e.createOutboundSession(n.getIdentityKey(),t.key));case 13:o=u.sent,u.next=20;break;case 16:return u.prev=16,u.t1=u.catch(10),a.logger.error("Error starting olm session with device "+r+":"+i+": "+u.t1),u.abrupt("return",null);case 20:return a.logger.log("Started new olm sessionid "+o+" for device "+r+":"+i),u.abrupt("return",o);case 22:case"end":return u.stop()}}),null,null,[[1,6],[10,16]])}function d(e,t,r,n,i){var o,a,u,l,d,h;return s.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(o="ed25519:"+n,a=t.signatures||{},u=a[r]||{},l=u[o]){s.next=6;break}throw Error("No signature");case 6:delete(d=Object.assign({},t)).unsigned,delete d.signatures,h=c.default.stringify(d),e.verifySignature(i,h,l);case 11:case"end":return s.stop()}}))}r.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2"}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../logger":89,"../utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23,"another-json":24,buffer:30}],70:[function(e,t,r){(function(t,n){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.encodeRecoveryKey=function(e){var t=new n(s.length+e.length+1);t.set(s,0),t.set(e,s.length);for(var r=0,i=0;i<t.length-1;++i)r^=t[i];return t[t.length-1]=r,o.default.encode(t).match(/.{1,4}/g).join(" ")},r.decodeRecoveryKey=function(e){var r=o.default.decode(e.replace(/ /g,"")),n=0,i=!0,a=!1,u=void 0;try{for(var c,l=r[Symbol.iterator]();!(i=(c=l.next()).done);i=!0){var d=c.value;n^=d}}catch(e){a=!0,u=e}finally{try{i||null==l.return||l.return()}finally{if(a)throw u}}if(0!==n)throw new Error("Incorrect parity");for(var h=0;h<s.length;++h)if(r[h]!==s[h])throw new Error("Incorrect prefix");if(r.length!==s.length+t.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return r.slice(s.length,s.length+t.Olm.PRIVATE_KEY_LENGTH)};var o=i(e("bs58")),s=[139,1]}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"@babel/runtime/helpers/interopRequireDefault":10,bs58:29,buffer:30}],71:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.upgradeDatabase=function(e,t){u.logger.log("Upgrading IndexedDBCryptoStore from version ".concat(t)+" to ".concat(l)),t<1&&function(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]});t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]});if(t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}},r.Backend=r.VERSION=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/classCallCheck")),a=i(e("@babel/runtime/helpers/createClass")),u=e("../../logger"),c=n(e("../../utils")),l=9;r.VERSION=l;var d=function(){function e(t){var r=this;(0,s.default)(this,e),this._db=t,t.onversionchange=function(e){u.logger.log("versionchange for indexeddb ".concat(r._dbName,": closing")),t.close()}}return(0,a.default)(e,[{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=this,r=e.requestBody;return new Promise((function(n,i){var o=t._db.transaction("outgoingRoomKeyRequests","readwrite");o.onerror=i,t._getOutgoingRoomKeyRequest(o,r,(function(t){if(t)return u.logger.log("already have key request outstanding for "+"".concat(r.room_id," / ").concat(r.session_id,": ")+"not sending another"),void n(t);u.logger.log("enqueueing key request for ".concat(r.room_id," / ")+r.session_id),o.oncomplete=function(){n(e)},o.objectStore("outgoingRoomKeyRequests").add(e)}))}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){var t=this;return new Promise((function(r,n){var i=t._db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=n,t._getOutgoingRoomKeyRequest(i,e,(function(e){r(e)}))}))}},{key:"_getOutgoingRoomKeyRequest",value:function(e,t,r){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=function(e){var n=e.target.result;if(n){var i=n.value;c.deepCompare(i.requestBody,t)?r(i):n.continue()}else r(null)}}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){if(0===e.length)return Promise.resolve(null);var t,r=0;var n=this._db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),o=e[r];return i.index("state").openCursor(o).onsuccess=function n(i){var o=i.target.result;if(o)t=o.value;else if(!(++r>=e.length)){var s=e[r];i.target.source.openCursor(s).onsuccess=n}},p(n).then((function(){return t}))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n=0,i=[];var o=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=o.objectStore("outgoingRoomKeyRequests"),a=r[n];return s.index("state").openCursor(a).onsuccess=function o(s){var a=s.target.result;if(a){var u=a.value;u.recipients.includes({userId:e,deviceId:t})&&i.push(u),a.continue()}else{if(++n>=r.length)return;var c=r[n];s.target.source.openCursor(c).onsuccess=o}},p(o).then((function(){return i}))}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var n=null;var i=this._db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var i=e.target.result;if(i){var o=i.value;o.state==t?(Object.assign(o,r),i.update(o),n=o):u.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(o.state))}},p(i).then((function(){return n}))}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){var r=this._db.transaction("outgoingRoomKeyRequests","readwrite");return r.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var r=e.target.result;if(r){var n=r.value;n.state==t?r.delete():u.logger.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")"))}},p(r)}},{key:"getAccount",value:function(e,t){var r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}},{key:"storeAccount",value:function(e,t){e.objectStore("account").put(t,"-")}},{key:"getCrossSigningKeys",value:function(e,t){var r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}},{key:"storeCrossSigningKeys",value:function(e,t){e.objectStore("account").put(t,"crossSigningKeys")}},{key:"countEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").count();r.onsuccess=function(){t(r.result)}}},{key:"getEndToEndSessions",value:function(e,t,r){var n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){var e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(i)}catch(e){h(t,e)}}}},{key:"getEndToEndSession",value:function(e,t,r,n){var i=r.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){h(r,e)}}}},{key:"getAllEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").openCursor();r.onsuccess=function(){var n=r.result;if(n)t(n.value),n.continue();else try{t(null)}catch(t){h(e,t)}}}},{key:"storeEndToEndSession",value:function(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}},{key:"storeEndToEndSessionProblem",value:function(e,t,r){var n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return n=this._db.transaction("session_problems","readwrite"),n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:r,time:Date.now()}),i.abrupt("return",p(n));case 4:case"end":return i.stop()}}),null,this)}},{key:"getEndToEndSessionProblem",value:function(e,t){var r,n,i,s,a;return o.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:return n=this._db.transaction("session_problems","readwrite"),i=n.objectStore("session_problems"),s=i.index("deviceKey"),(a=s.getAll(e)).onsuccess=function(e){var n=a.result;if(n.length){n.sort((function(e,t){return e.time-t.time}));var i=n[n.length-1],o=!0,s=!1,u=void 0;try{for(var c,l=n[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var d=c.value;if(d.time>t)return void(r=Object.assign({},d,{fixed:i.fixed}))}}catch(e){s=!0,u=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw u}}r=i.fixed?null:i}else r=null},u.next=7,o.default.awrap(p(n));case 7:return u.abrupt("return",r);case 8:case"end":return u.stop()}}),null,this)}},{key:"filterOutNotifiedErrorDevices",value:function(e){var t,r,n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return t=this._db.transaction("notified_error_devices","readwrite"),r=t.objectStore("notified_error_devices"),n=[],i.next=5,o.default.awrap(Promise.all(e.map((function(e){return new Promise((function(t){var i=e.userId,o=e.deviceInfo,s=r.get([i,o.deviceId]);s.onsuccess=function(){s.result||(r.put({userId:i,deviceId:o.deviceId}),n.push(e)),t()}}))}))));case 5:return i.abrupt("return",n);case 6:case"end":return i.stop()}}),null,this)}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){var i=!1,o=!1,s=r.objectStore("inbound_group_sessions").get([e,t]);s.onsuccess=function(){try{i=s.result?s.result.session:null,!1!==o&&n(i,o)}catch(e){h(r,e)}};var a=r.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(i,o)}catch(e){h(r,e)}}}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){var r=e.objectStore("inbound_group_sessions").openCursor();r.onsuccess=function(){var n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){h(e,t)}n.continue()}else try{t(null)}catch(t){h(e,t)}}}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var i=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:r});i.onerror=function(r){"ConstraintError"===i.error.name?(r.stopPropagation(),r.preventDefault(),u.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):h(n,new Error("Failed to add inbound group session: "+i.error))}}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:r})}},{key:"getEndToEndDeviceData",value:function(e,t){var r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){h(e,t)}}}},{key:"storeEndToEndDeviceData",value:function(e,t){t.objectStore("device_data").put(e,"-")}},{key:"storeEndToEndRoom",value:function(e,t,r){r.objectStore("rooms").put(t,e)}},{key:"getEndToEndRooms",value:function(e,t){var r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){var i=n.result;if(i)r[i.key]=i.value,i.continue();else try{t(r)}catch(t){h(e,t)}}}},{key:"getSessionsNeedingBackup",value:function(e){var t=this;return new Promise((function(r,n){var i=[],o=t._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");o.onerror=n,o.oncomplete=function(){r(i)};var s=o.objectStore("sessions_needing_backup"),a=o.objectStore("inbound_group_sessions"),u=s.openCursor();u.onsuccess=function(){var t=u.result;if(t){var r=a.get(t.key);r.onsuccess=function(){i.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||i.length<e)&&t.continue()}}}))}},{key:"countSessionsNeedingBackup",value:function(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new Promise((function(e,r){var n=t.count();n.onerror=r,n.onsuccess=function(){return e(n.result)}}))}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return Promise.all(e.map((function(e){return new Promise((function(t,n){var i=r.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n}))})))}},{key:"markSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return Promise.all(e.map((function(e){return new Promise((function(t,n){var i=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n}))})))}},{key:"doTxn",value:function(e,t,r){var n=this._db.transaction(t,e),i=p(n),o=r(n);return i.then((function(){return o}))}}]),e}();function h(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function p(e){return new Promise((function(t,r){e.oncomplete=function(){void 0!==e._mx_abortexception&&r(e._mx_abortexception),t()},e.onerror=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(u.logger.log("Error performing indexeddb txn",t),r(t.target.error))},e.onabort=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(u.logger.log("Error performing indexeddb txn",t),r(t.target.error))}}))}r.Backend=d},{"../../logger":89,"../../utils":117,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],72:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IndexedDBCryptoStore=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/classCallCheck")),a=i(e("@babel/runtime/helpers/createClass")),u=e("../../logger"),c=e("./localStorage-crypto-store"),l=e("./memory-crypto-store"),d=n(e("./indexeddb-crypto-store-backend")),h=e("../../errors"),p=n(e("../../indexeddb-helpers")),f=function(){function e(t,r){(0,s.default)(this,e),this._indexedDB=t,this._dbName=r,this._backendPromise=null}return(0,a.default)(e,[{key:"_connect",value:function(){var r=this;return this._backendPromise?this._backendPromise:(this._backendPromise=new Promise((function(e,t){if(r._indexedDB){u.logger.log("connecting to indexeddb ".concat(r._dbName));var n=r._indexedDB.open(r._dbName,d.VERSION);n.onupgradeneeded=function(e){var t=e.target.result,r=e.oldVersion;d.upgradeDatabase(t,r)},n.onblocked=function(){u.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){u.logger.log("Error connecting to indexeddb",e),t(e.target.error)},n.onsuccess=function(t){var n=t.target.result;u.logger.log("connected to indexeddb ".concat(r._dbName)),e(new d.Backend(n))}}else t(new Error("no indexeddb support available"))})).then((function(t){return t.doTxn("readonly",[e.STORE_INBOUND_GROUP_SESSIONS,e.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){t.getEndToEndInboundGroupSession("","",e,(function(){}))})).then((function(){return t}))})).catch((function(e){if("VersionError"===e.name)throw u.logger.warn("Crypto DB is too new for us to use!",e),new h.InvalidCryptoStoreError(h.InvalidCryptoStoreError.TOO_NEW);u.logger.warn("unable to connect to indexeddb ".concat(r._dbName)+": falling back to localStorage store: ".concat(e));try{return new c.LocalStorageCryptoStore(t.localStorage)}catch(e){return u.logger.warn("unable to open localStorage: falling back to in-memory store: ".concat(e)),new l.MemoryCryptoStore}})),this._backendPromise)}},{key:"deleteAllData",value:function(){var e=this;return new Promise((function(t,r){if(e._indexedDB){u.logger.log("Removing indexeddb instance: ".concat(e._dbName));var n=e._indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){u.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){u.logger.log("Error deleting data from indexeddb",e),r(e.target.error)},n.onsuccess=function(){u.logger.log("Removed indexeddb instance: ".concat(e._dbName)),t()}}else r(new Error("no indexeddb support available"))})).catch((function(e){u.logger.warn("unable to delete IndexedDBCryptoStore: ".concat(e))}))}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){return this._connect().then((function(t){return t.getOrAddOutgoingRoomKeyRequest(e)}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){return this._connect().then((function(t){return t.getOutgoingRoomKeyRequest(e)}))}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){return this._connect().then((function(t){return t.getOutgoingRoomKeyRequestByState(e)}))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){return this._connect().then((function(n){return n.getOutgoingRoomKeyRequestsByTarget(e,t,r)}))}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){return this._connect().then((function(n){return n.updateOutgoingRoomKeyRequest(e,t,r)}))}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){return this._connect().then((function(r){return r.deleteOutgoingRoomKeyRequest(e,t)}))}},{key:"getAccount",value:function(e,t){this._backendPromise.then((function(r){r.getAccount(e,t)}))}},{key:"storeAccount",value:function(e,t){this._backendPromise.then((function(r){r.storeAccount(e,t)}))}},{key:"getCrossSigningKeys",value:function(e,t){this._backendPromise.then((function(r){r.getCrossSigningKeys(e,t)}))}},{key:"storeCrossSigningKeys",value:function(e,t){this._backendPromise.then((function(r){r.storeCrossSigningKeys(e,t)}))}},{key:"countEndToEndSessions",value:function(e,t){this._backendPromise.then((function(r){r.countEndToEndSessions(e,t)}))}},{key:"getEndToEndSession",value:function(e,t,r,n){this._backendPromise.then((function(i){i.getEndToEndSession(e,t,r,n)}))}},{key:"getEndToEndSessions",value:function(e,t,r){this._backendPromise.then((function(n){n.getEndToEndSessions(e,t,r)}))}},{key:"getAllEndToEndSessions",value:function(e,t){this._backendPromise.then((function(r){r.getAllEndToEndSessions(e,t)}))}},{key:"storeEndToEndSession",value:function(e,t,r,n){this._backendPromise.then((function(i){i.storeEndToEndSession(e,t,r,n)}))}},{key:"storeEndToEndSessionProblem",value:function(e,t,r){return this._backendPromise.then((function(n){return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,o.default.awrap(n.storeEndToEndSessionProblem(e,t,r));case 2:case"end":return i.stop()}}))}))}},{key:"getEndToEndSessionProblem",value:function(e,t){return this._backendPromise.then((function(r){return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(r.getEndToEndSessionProblem(e,t));case 2:return n.abrupt("return",n.sent);case 3:case"end":return n.stop()}}))}))}},{key:"filterOutNotifiedErrorDevices",value:function(e){return this._backendPromise.then((function(t){return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,o.default.awrap(t.filterOutNotifiedErrorDevices(e));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}}))}))}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.then((function(i){i.getEndToEndInboundGroupSession(e,t,r,n)}))}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){this._backendPromise.then((function(r){r.getAllEndToEndInboundGroupSessions(e,t)}))}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.then((function(i){i.addEndToEndInboundGroupSession(e,t,r,n)}))}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.then((function(i){i.storeEndToEndInboundGroupSession(e,t,r,n)}))}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){this._backendPromise.then((function(i){i.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}))}},{key:"storeEndToEndDeviceData",value:function(e,t){this._backendPromise.then((function(r){r.storeEndToEndDeviceData(e,t)}))}},{key:"getEndToEndDeviceData",value:function(e,t){this._backendPromise.then((function(r){r.getEndToEndDeviceData(e,t)}))}},{key:"storeEndToEndRoom",value:function(e,t,r){this._backendPromise.then((function(n){n.storeEndToEndRoom(e,t,r)}))}},{key:"getEndToEndRooms",value:function(e,t){this._backendPromise.then((function(r){r.getEndToEndRooms(e,t)}))}},{key:"getSessionsNeedingBackup",value:function(e){return this._connect().then((function(t){return t.getSessionsNeedingBackup(e)}))}},{key:"countSessionsNeedingBackup",value:function(e){return this._connect().then((function(t){return t.countSessionsNeedingBackup(e)}))}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){return this._connect().then((function(r){return r.unmarkSessionsNeedingBackup(e,t)}))}},{key:"markSessionsNeedingBackup",value:function(e,t){return this._connect().then((function(r){return r.markSessionsNeedingBackup(e,t)}))}},{key:"doTxn",value:function(e,t,r){return this._connect().then((function(n){return n.doTxn(e,t,r)}))}}],[{key:"exists",value:function(e,t){return p.exists(e,t)}}]),e}();r.IndexedDBCryptoStore=f,f.STORE_ACCOUNT="account",f.STORE_SESSIONS="sessions",f.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",f.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",f.STORE_DEVICE_DATA="device_data",f.STORE_ROOMS="rooms",f.STORE_BACKUP="sessions_needing_backup"}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../errors":83,"../../indexeddb-helpers":87,"../../logger":89,"./indexeddb-crypto-store-backend":71,"./localStorage-crypto-store":73,"./memory-crypto-store":74,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],73:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.LocalStorageCryptoStore=void 0;var i=n(e("@babel/runtime/helpers/defineProperty")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/slicedToArray")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/possibleConstructorReturn")),l=n(e("@babel/runtime/helpers/getPrototypeOf")),d=n(e("@babel/runtime/helpers/inherits")),h=e("../../logger"),p=e("./memory-crypto-store"),f="crypto.",v=f+"account",g=f+"cross_signing_keys",m=f+"notified_error_devices",y=f+"device_data",_=f+"inboundgroupsessions/",b=f+"inboundgroupsessions.withheld/",S=f+"rooms/",k=f+"sessionsneedingbackup";function E(e){return f+"sessions/"+e}function w(e){return f+"session.problems/"+e}function I(e,t){return _+e+"/"+t}function R(e,t){return b+e+"/"+t}function T(e){return S+e}var x=function(e){function t(e){var r;return(0,a.default)(this,t),(r=(0,c.default)(this,(0,l.default)(t).call(this))).store=e,r}return(0,d.default)(t,e),(0,u.default)(t,[{key:"countEndToEndSessions",value:function(e,t){for(var r=0,n=0;n<this.store.length;++n)this.store.key(n).startsWith(E(""))&&++r;t(r)}},{key:"_getEndToEndSessions",value:function(e,t,r){for(var n=O(this.store,E(e)),i={},o=0,a=Object.entries(n||{});o<a.length;o++){var u=(0,s.default)(a[o],2),c=u[0],l=u[1];i[c]="string"==typeof l?{session:l}:l}return i}},{key:"getEndToEndSession",value:function(e,t,r,n){n(this._getEndToEndSessions(e)[t]||{})}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._getEndToEndSessions(e)||{})}},{key:"getAllEndToEndSessions",value:function(e,t){for(var r=0;r<this.store.length;++r)if(this.store.key(r).startsWith(E("")))for(var n=this.store.key(r).split("/")[1],i=0,o=Object.values(this._getEndToEndSessions(n));i<o.length;i++){t(o[i])}}},{key:"storeEndToEndSession",value:function(e,t,r,n){var i=this._getEndToEndSessions(e)||{};i[t]=r,C(this.store,E(e),i)}},{key:"storeEndToEndSessionProblem",value:function(e,t,r){var n,i;return o.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:n=w(e),(i=O(this.store,n)||[]).push({type:t,fixed:r,time:Date.now()}),i.sort((function(e,t){return e.time-t.time})),C(this.store,n,i);case 5:case"end":return o.stop()}}),null,this)}},{key:"getEndToEndSessionProblem",value:function(e,t){var r,n,i,s,a,u,c,l,d;return o.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if(r=w(e),(n=O(this.store,r)||[]).length){o.next=4;break}return o.abrupt("return",null);case 4:i=n[n.length-1],s=!0,a=!1,u=void 0,o.prev=8,c=n[Symbol.iterator]();case 10:if(s=(l=c.next()).done){o.next=17;break}if(!((d=l.value).time>t)){o.next=14;break}return o.abrupt("return",Object.assign({},d,{fixed:i.fixed}));case 14:s=!0,o.next=10;break;case 17:o.next=23;break;case 19:o.prev=19,o.t0=o.catch(8),a=!0,u=o.t0;case 23:o.prev=23,o.prev=24,s||null==c.return||c.return();case 26:if(o.prev=26,!a){o.next=29;break}throw u;case 29:return o.finish(26);case 30:return o.finish(23);case 31:if(!i.fixed){o.next=35;break}return o.abrupt("return",null);case 35:return o.abrupt("return",i);case 36:case"end":return o.stop()}}),null,this,[[8,19,23,31],[24,,26,30]])}},{key:"filterOutNotifiedErrorDevices",value:function(e){var t,r,n,s,a,u,c,l,d,h;return o.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:for(t=O(this.store,m)||{},r=[],n=!0,s=!1,a=void 0,o.prev=5,u=e[Symbol.iterator]();!(n=(c=u.next()).done);n=!0)l=c.value,d=l.userId,h=l.deviceInfo,d in t?h.deviceId in t[d]||(r.push(l),t[d][h.deviceId]=!0):(r.push(l),t[d]=(0,i.default)({},h.deviceId,!0));o.next=13;break;case 9:o.prev=9,o.t0=o.catch(5),s=!0,a=o.t0;case 13:o.prev=13,o.prev=14,n||null==u.return||u.return();case 16:if(o.prev=16,!s){o.next=19;break}throw a;case 19:return o.finish(16);case 20:return o.finish(13);case 21:return C(this.store,m,t),o.abrupt("return",r);case 23:case"end":return o.stop()}}),null,this,[[5,9,13,21],[14,,16,20]])}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){n(O(this.store,I(e,t)),O(this.store,R(e,t)))}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);n.startsWith(_)&&t({senderKey:n.substr(_.length,43),sessionId:n.substr(_.length+44),sessionData:O(this.store,n)})}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){O(this.store,I(e,t))||this.storeEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){C(this.store,I(e,t),r)}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){C(this.store,R(e,t),r)}},{key:"getEndToEndDeviceData",value:function(e,t){t(O(this.store,y))}},{key:"storeEndToEndDeviceData",value:function(e,t){C(this.store,y,e)}},{key:"storeEndToEndRoom",value:function(e,t,r){C(this.store,T(e),t)}},{key:"getEndToEndRooms",value:function(e,t){for(var r={},n=T(""),i=0;i<this.store.length;++i){var o=this.store.key(i);if(o.startsWith(n))r[o.substr(n.length)]=O(this.store,o)}t(r)}},{key:"getSessionsNeedingBackup",value:function(e){var t=this,r=O(this.store,k)||{},n=[];for(var i in r){if(Object.prototype.hasOwnProperty.call(r,i))if("break"===function(){var r=i.substr(0,43),o=i.substr(44);if(t.getEndToEndInboundGroupSession(r,o,null,(function(e){n.push({senderKey:r,sessionId:o,sessionData:e})})),e&&i.length>=e)return"break"}())break}return Promise.resolve(n)}},{key:"countSessionsNeedingBackup",value:function(){var e=O(this.store,k)||{};return Promise.resolve(Object.keys(e).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t=O(this.store,k)||{},r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;delete t[a.senderKey+"/"+a.sessionId]}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return C(this.store,k,t),Promise.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t=O(this.store,k)||{},r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;t[a.senderKey+"/"+a.sessionId]=!0}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return C(this.store,k,t),Promise.resolve()}},{key:"deleteAllData",value:function(){return this.store.removeItem(v),Promise.resolve()}},{key:"getAccount",value:function(e,t){t(O(this.store,v))}},{key:"storeAccount",value:function(e,t){C(this.store,v,t)}},{key:"getCrossSigningKeys",value:function(e,t){t(O(this.store,g))}},{key:"storeCrossSigningKeys",value:function(e,t){C(this.store,g,t)}},{key:"doTxn",value:function(e,t,r){return Promise.resolve(r(null))}}],[{key:"exists",value:function(e){for(var t=e.length,r=0;r<t;r++)if(e.key(r).startsWith(f))return!0;return!1}}]),t}(p.MemoryCryptoStore);function O(e,t){try{return JSON.parse(e.getItem(t))}catch(e){h.logger.log("Error: Failed to get key %s: %s",t,e.stack||e),h.logger.log(e.stack)}return null}function C(e,t,r){e.setItem(t,JSON.stringify(r))}r.LocalStorageCryptoStore=x},{"../../logger":89,"./memory-crypto-store":74,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23}],74:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MemoryCryptoStore=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/helpers/slicedToArray")),u=i(e("@babel/runtime/helpers/classCallCheck")),c=i(e("@babel/runtime/helpers/createClass")),l=e("../../logger"),d=n(e("../../utils"));function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var p=function(){function e(){(0,u.default)(this,e),this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={}}return(0,c.default)(e,[{key:"deleteAllData",value:function(){return Promise.resolve()}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=this,r=e.requestBody;return d.promiseTry((function(){var n=t._getOutgoingRoomKeyRequest(r);return n?(l.logger.log("already have key request outstanding for "+"".concat(r.room_id," / ").concat(r.session_id,": ")+"not sending another"),n):(l.logger.log("enqueueing key request for ".concat(r.room_id," / ")+r.session_id),t._outgoingRoomKeyRequests.push(e),e)}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}},{key:"_getOutgoingRoomKeyRequest",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,o=this._outgoingRoomKeyRequests[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;if(d.deepCompare(s.requestBody,e))return s}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return null}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,o=this._outgoingRoomKeyRequests[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value,a=!0,u=!1,c=void 0;try{for(var l,d=e[Symbol.iterator]();!(a=(l=d.next()).done);a=!0){var h=l.value;if(s.state===h)return Promise.resolve(s)}}catch(e){u=!0,c=e}finally{try{a||null==d.return||d.return()}finally{if(u)throw c}}}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return Promise.resolve(null)}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n=[],i=!0,o=!1,s=void 0;try{for(var a,u=this._outgoingRoomKeyRequests[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var c=a.value,l=!0,d=!1,h=void 0;try{for(var p,f=r[Symbol.iterator]();!(l=(p=f.next()).done);l=!0){var v=p.value;c.state===v&&c.recipients.includes({userId:e,deviceId:t})&&n.push(c)}}catch(e){d=!0,h=e}finally{try{l||null==f.return||f.return()}finally{if(d)throw h}}}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}return Promise.resolve(n)}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var n=!0,i=!1,o=void 0;try{for(var s,a=this._outgoingRoomKeyRequests[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value;if(u.requestId===e)return u.state!=t?(l.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(u.state)),Promise.resolve(null)):(Object.assign(u,r),Promise.resolve(u))}}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return Promise.resolve(null)}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){for(var r=0;r<this._outgoingRoomKeyRequests.length;r++){var n=this._outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(l.logger.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")")),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}},{key:"getAccount",value:function(e,t){t(this._account)}},{key:"storeAccount",value:function(e,t){this._account=t}},{key:"getCrossSigningKeys",value:function(e,t){t(this._crossSigningKeys)}},{key:"storeCrossSigningKeys",value:function(e,t){this._crossSigningKeys=t}},{key:"countEndToEndSessions",value:function(e,t){return Object.keys(this._sessions).length}},{key:"getEndToEndSession",value:function(e,t,r,n){n((this._sessions[e]||{})[t]||null)}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._sessions[e]||{})}},{key:"getAllEndToEndSessions",value:function(e,t){Object.entries(this._sessions).forEach((function(e){var r=(0,a.default)(e,2),n=r[0],i=r[1];Object.entries(i).forEach((function(e){var r=(0,a.default)(e,2),i=r[0],o=r[1];t(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach((function(t){(0,s.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},o,{deviceKey:n,sessionId:i}))}))}))}},{key:"storeEndToEndSession",value:function(e,t,r,n){var i=this._sessions[e];void 0===i&&(i={},this._sessions[e]=i),i[t]=r}},{key:"storeEndToEndSessionProblem",value:function(e,t,r){var n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:(n=this._sessionProblems[e]=this._sessionProblems[e]||[]).push({type:t,fixed:r,time:Date.now()}),n.sort((function(e,t){return e.time-t.time}));case 3:case"end":return i.stop()}}),null,this)}},{key:"getEndToEndSessionProblem",value:function(e,t){var r,n,i,s,a,u,c,l;return o.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:if((r=this._sessionProblems[e]||[]).length){o.next=3;break}return o.abrupt("return",null);case 3:n=r[r.length-1],i=!0,s=!1,a=void 0,o.prev=7,u=r[Symbol.iterator]();case 9:if(i=(c=u.next()).done){o.next=16;break}if(!((l=c.value).time>t)){o.next=13;break}return o.abrupt("return",Object.assign({},l,{fixed:n.fixed}));case 13:i=!0,o.next=9;break;case 16:o.next=22;break;case 18:o.prev=18,o.t0=o.catch(7),s=!0,a=o.t0;case 22:o.prev=22,o.prev=23,i||null==u.return||u.return();case 25:if(o.prev=25,!s){o.next=28;break}throw a;case 28:return o.finish(25);case 29:return o.finish(22);case 30:if(!n.fixed){o.next=34;break}return o.abrupt("return",null);case 34:return o.abrupt("return",n);case 35:case"end":return o.stop()}}),null,this,[[7,18,22,30],[23,,25,29]])}},{key:"filterOutNotifiedErrorDevices",value:function(e){var t,r,n,i,a,u,c,l,d,h;return o.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:for(t=this._notifiedErrorDevices,r=[],n=!0,i=!1,a=void 0,o.prev=5,u=e[Symbol.iterator]();!(n=(c=u.next()).done);n=!0)l=c.value,d=l.userId,h=l.deviceInfo,d in t?h.deviceId in t[d]||(r.push(l),t[d][h.deviceId]=!0):(r.push(l),t[d]=(0,s.default)({},h.deviceId,!0));o.next=13;break;case 9:o.prev=9,o.t0=o.catch(5),i=!0,a=o.t0;case 13:o.prev=13,o.prev=14,n||null==u.return||u.return();case 16:if(o.prev=16,!i){o.next=19;break}throw a;case 19:return o.finish(16);case 20:return o.finish(13);case 21:return o.abrupt("return",r);case 22:case"end":return o.stop()}}),null,this,[[5,9,13,21],[14,,16,20]])}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){var i=e+"/"+t;n(this._inboundGroupSessions[i]||null,this._inboundGroupSessionsWithheld[i]||null)}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){for(var r=0,n=Object.keys(this._inboundGroupSessions);r<n.length;r++){var i=n[r];t({senderKey:i.substr(0,43),sessionId:i.substr(44),sessionData:this._inboundGroupSessions[i]})}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var i=e+"/"+t;void 0===this._inboundGroupSessions[i]&&(this._inboundGroupSessions[i]=r)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._inboundGroupSessions[e+"/"+t]=r}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){var i=e+"/"+t;this._inboundGroupSessionsWithheld[i]=r}},{key:"getEndToEndDeviceData",value:function(e,t){t(this._deviceData)}},{key:"storeEndToEndDeviceData",value:function(e,t){this._deviceData=e}},{key:"storeEndToEndRoom",value:function(e,t,r){this._rooms[e]=t}},{key:"getEndToEndRooms",value:function(e,t){t(this._rooms)}},{key:"getSessionsNeedingBackup",value:function(e){var t=[];for(var r in this._sessionsNeedingBackup)if(this._inboundGroupSessions[r]&&(t.push({senderKey:r.substr(0,43),sessionId:r.substr(44),sessionData:this._inboundGroupSessions[r]}),e&&r.length>=e))break;return Promise.resolve(t)}},{key:"countSessionsNeedingBackup",value:function(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value,a=s.senderKey+"/"+s.sessionId;delete this._sessionsNeedingBackup[a]}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return Promise.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value,a=s.senderKey+"/"+s.sessionId;this._sessionsNeedingBackup[a]=!0}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return Promise.resolve()}},{key:"doTxn",value:function(e,t,r){return Promise.resolve(r(null))}}]),e}();r.MemoryCryptoStore=p},{"../../logger":89,"../../utils":117,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23}],75:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.VerificationBase=r.SwitchStartEventError=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/defineProperty")),s=n(e("@babel/runtime/helpers/slicedToArray")),a=n(e("@babel/runtime/helpers/createClass")),u=n(e("@babel/runtime/helpers/classCallCheck")),c=n(e("@babel/runtime/helpers/possibleConstructorReturn")),l=n(e("@babel/runtime/helpers/getPrototypeOf")),d=n(e("@babel/runtime/helpers/inherits")),h=n(e("@babel/runtime/helpers/wrapNativeSuper")),p=e("../../models/event"),f=e("events"),v=e("../../logger"),g=e("../deviceinfo"),m=e("./Error"),y=new Error("Verification timed out"),_=function(e){function t(e){var r;return(0,u.default)(this,t),(r=(0,c.default)(this,(0,l.default)(t).call(this))).startEvent=e,r}return(0,d.default)(t,e),t}((0,h.default)(Error));r.SwitchStartEventError=_;var b=function(e){function t(e,r,n,i,o,s){var a;return(0,u.default)(this,t),(a=(0,c.default)(this,(0,l.default)(t).call(this)))._channel=e,a._baseApis=r,a.userId=n,a.deviceId=i,a.startEvent=o,a.request=s,a.cancelled=!1,a._done=!1,a._promise=null,a._transactionTimeoutTimer=null,a}return(0,d.default)(t,e),(0,a.default)(t,[{key:"_resetTimer",value:function(){var e=this;v.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout((function(){e._done||e.cancelled||(v.logger.info("Triggering verification timeout"),e.cancel(y))}),6e5)}},{key:"_endTimer",value:function(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}},{key:"_send",value:function(e,t){return this._channel.send(e,t)}},{key:"_waitForEvent",value:function(e){var t=this;return this._done?Promise.reject(new Error("Verification is already done")):(this._expectedEvent=e,new Promise((function(e,r){t._resolveEvent=e,t._rejectEvent=r})))}},{key:"canSwitchStartEvent",value:function(){return!1}},{key:"switchStartEvent",value:function(e){if(this.canSwitchStartEvent(e))if(this._rejectEvent){var t=this._rejectEvent;this._rejectEvent=void 0,t(new _(e))}else this.startEvent=e}},{key:"handleEvent",value:function(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){var t=this._reject;this._reject=void 0;var r=e.getContent(),n=r.reason,i=r.code;t(new Error("Other side cancelled verification "+"because ".concat(n," (").concat(i,")")))}else if(this._expectedEvent){var o=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){var s=this._rejectEvent;this._rejectEvent=void 0,s(o)}this.cancel(o)}}},{key:"done",value:function(){this._endTimer(),this._done||(this._channel.needsDoneMessage&&this._send("m.key.verification.done",{}),this._resolve())}},{key:"cancel",value:function(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.userId&&this.deviceId)if(e===y){var t=(0,m.newTimeoutError)();this._send(t.getType(),t.getContent())}else if(e instanceof p.MatrixEvent){if(e.getSender()!==this.userId){var r=e.getContent();"m.key.verification.cancel"===e.getType()?(r.code=r.code||"m.unknown",r.reason=r.reason||r.body||"Unknown reason",this._send("m.key.verification.cancel",r)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:r.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}},{key:"verify",value:function(){var e=this;return this._promise?this._promise:(this._promise=new Promise((function(t,r){e._resolve=function(){e._done=!0,e._endTimer(),t.apply(void 0,arguments)},e._reject=function(){e._done=!0,e._endTimer(),r.apply(void 0,arguments)}})),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this._promise)}},{key:"_verifyKeys",value:function(e,t,r){var n,a,u,c,l,d,h,p,f,m,y,_;return i.default.async((function(b){for(;;)switch(b.prev=b.next){case 0:n=[],a=0,u=Object.entries(t);case 2:if(!(a<u.length)){b.next=25;break}return c=(0,s.default)(u[a],2),l=c[0],d=c[1],h=l.split(":",2)[1],b.next=7,i.default.awrap(this._baseApis.getStoredDevice(e,h));case 7:if(!(p=b.sent)){b.next=14;break}return b.next=11,i.default.awrap(r(l,p,d));case 11:n.push(h),b.next=22;break;case 14:if(!(f=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(e))||f.getId()!==h){b.next=21;break}return b.next=18,i.default.awrap(r(l,g.DeviceInfo.fromStorage({keys:(0,o.default)({},l,h)},h),d));case 18:n.push(h),b.next=22;break;case 21:v.logger.warn("verification: Could not find device ".concat(h," to verify"));case 22:a++,b.next=2;break;case 25:if(n.length){b.next=27;break}throw new Error("No devices could be verified");case 27:v.logger.info("Verification completed! Marking devices verified: ",n),m=0,y=n;case 29:if(!(m<y.length)){b.next=36;break}return _=y[m],b.next=33,i.default.awrap(this._baseApis.setDeviceVerified(e,_));case 33:m++,b.next=29;break;case 36:case"end":return b.stop()}}),null,this)}},{key:"initiatedByMe",get:function(){if(!this.startEvent)return!0;var e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}}]),t}(f.EventEmitter);r.VerificationBase=b},{"../../logger":89,"../../models/event":94,"../deviceinfo":66,"./Error":76,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/helpers/wrapNativeSuper":22,"@babel/runtime/regenerator":23,events:32}],76:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.newVerificationError=i,r.errorFactory=o,r.errorFromEvent=function(e){var t=e.getContent();if(t){var r=t.code,n=t.reason;return{code:r,reason:n}}return{code:"Unknown error",reason:"m.unknown"}},r.newInvalidMessageError=r.newUserMismatchError=r.newKeyMismatchError=r.newUnexpectedMessageError=r.newUnknownMethodError=r.newUnknownTransactionError=r.newTimeoutError=r.newUserCancelledError=void 0;var n=e("../../models/event");function i(e,t,r){var i=Object.assign({},{code:e,reason:t},r);return new n.MatrixEvent({type:"m.key.verification.cancel",content:i})}function o(e,t){return function(r){return i(e,t,r)}}var s=o("m.user","Cancelled by user");r.newUserCancelledError=s;var a=o("m.timeout","Timed out");r.newTimeoutError=a;var u=o("m.unknown_transaction","Unknown transaction");r.newUnknownTransactionError=u;var c=o("m.unknown_method","Unknown method");r.newUnknownMethodError=c;var l=o("m.unexpected_message","Unexpected message");r.newUnexpectedMessageError=l;var d=o("m.key_mismatch","Key mismatch");r.newKeyMismatchError=d;var h=o("m.user_error","User mismatch");r.newUserMismatchError=h;var p=o("m.invalid_message","Invalid message");r.newInvalidMessageError=p},{"../../models/event":94}],77:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IllegalMethod=void 0;var i=n(e("@babel/runtime/helpers/construct")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/classCallCheck")),a=n(e("@babel/runtime/helpers/createClass")),u=n(e("@babel/runtime/helpers/possibleConstructorReturn")),c=n(e("@babel/runtime/helpers/getPrototypeOf")),l=n(e("@babel/runtime/helpers/inherits")),d=function(e){function t(){return(0,s.default)(this,t),(0,u.default)(this,(0,c.default)(t).apply(this,arguments))}return(0,l.default)(t,e),(0,a.default)(t,[{key:"_doVerification",value:function(){return o.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Verification is not possible with this method");case 1:case"end":return e.stop()}}))}}],[{key:"factory",value:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(0,i.default)(t,r)}},{key:"NAME",get:function(){return"org.matrix.illegal_method"}}]),t}(e("./Base").VerificationBase);r.IllegalMethod=d},{"./Base":75,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/construct":5,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/regenerator":23}],78:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.ReciprocateQRCode=r.SCAN_QR_CODE_METHOD=r.SHOW_QR_CODE_METHOD=void 0;var i=n(e("@babel/runtime/helpers/construct")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/defineProperty")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/possibleConstructorReturn")),l=n(e("@babel/runtime/helpers/getPrototypeOf")),d=n(e("@babel/runtime/helpers/inherits")),h=e("./Base"),p=e("./Error");r.SHOW_QR_CODE_METHOD="m.qr_code.show.v1";r.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";var f=function(e){function t(){return(0,a.default)(this,t),(0,c.default)(this,(0,l.default)(t).apply(this,arguments))}return(0,d.default)(t,e),(0,u.default)(t,[{key:"_doVerification",value:function(){var e,t,r,n,i,a,u,c=this;return o.default.async((function(l){for(;;)switch(l.prev=l.next){case 0:if(this.startEvent){l.next=2;break}throw new Error("It is not currently possible to start verificationwith this method yet.");case 2:if(e=this.startEvent.getSender(),this.userId){l.next=10;break}return console.log("Asking to confirm user ID"),l.next=7,o.default.awrap(new Promise((function(t,r){c.emit("confirm_user_id",{userId:e,confirm:t,cancel:function(){return r((0,p.newUserMismatchError)())}})})));case 7:this.userId=l.sent,l.next=12;break;case 10:if(e===this.userId){l.next=12;break}throw(0,p.newUserMismatchError)({expected:this.userId,actual:e});case 12:if(this.startEvent.getContent().secret===this.request.encodedSharedSecret){l.next=14;break}throw(0,p.newKeyMismatchError)();case 14:if(t=this._baseApis.getStoredCrossSigningForUser(this.userId)){l.next=17;break}throw new Error("Missing cross signing info");case 17:return r=t.getId("master"),n="ed25519:".concat(r),i=(0,s.default)({},n,r),l.next=22,o.default.awrap(this._baseApis.getStoredDevicesForUser(this.userId));case 22:if(l.t0=l.sent,l.t0){l.next=25;break}l.t0=[];case 25:if(a=l.t0,u=a.find((function(e){return e.deviceId===c.request.estimatedTargetDevice.deviceId}))){l.next=29;break}throw new Error("Device not found, somehow");case 29:return i["ed25519:".concat(u.deviceId)]=u.getFingerprint(),this.request.requestingUserId===this.request.receivingUserId&&delete i[n],l.next=33,o.default.awrap(this._verifyKeys(this.userId,i,(function(e,t,r){var n=i[e];if(!n)throw(0,p.newKeyMismatchError)();if(r!==n)throw console.error("key ID from key info does not match"),(0,p.newKeyMismatchError)();for(var o in t.keys)if(o.startsWith("ed25519")){var s=i[o];if(!s)throw(0,p.newKeyMismatchError)();if(t.keys[o]!==s)throw console.error("master key does not match"),(0,p.newKeyMismatchError)()}})));case 33:case"end":return l.stop()}}),null,this)}}],[{key:"factory",value:function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(0,i.default)(t,r)}},{key:"NAME",get:function(){return"m.reciprocate.v1"}}]),t}(h.VerificationBase);r.ReciprocateQRCode=f},{"./Base":75,"./Error":76,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/construct":5,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/regenerator":23}],79:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SAS=void 0;var i,o=n(e("@babel/runtime/helpers/slicedToArray")),s=n(e("@babel/runtime/regenerator")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/possibleConstructorReturn")),l=n(e("@babel/runtime/helpers/getPrototypeOf")),d=n(e("@babel/runtime/helpers/inherits")),h=e("./Base"),p=n(e("another-json")),f=e("./Error"),v=e("../../logger"),g="m.key.verification.start",m=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"],y=(0,f.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),_=(0,f.errorFactory)("m.mismatched_commitment","Mismatched commitment");var b=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];var S={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((function(e){return b[e]}))}};function k(e,t){var r={},n=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value;u in S&&(r[u]=S[u](e))}}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}var E={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function w(e,t){return function(){for(var r=e[E[t]],n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];var s=r.apply(e,i);return v.logger.log("SAS calculateMAC:",t,i,s),s}}var I=["curve25519"],R=["sha256"],T=["hkdf-hmac-sha256","hmac-sha256"],x=Object.keys(S),O=new Set(I),C=new Set(R),D=new Set(T),A=new Set(x);function P(e,t){return e instanceof Array?e.filter((function(e){return t.has(e)})):[]}var M=function(e){function r(){return(0,a.default)(this,r),(0,c.default)(this,(0,l.default)(r).apply(this,arguments))}return(0,d.default)(r,e),(0,u.default)(r,[{key:"_doVerification",value:function(){var e;return s.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,s.default.awrap(t.Olm.init());case 2:return i=i||new t.Olm.Utility,r.next=5,s.default.awrap(this._baseApis.downloadKeys([this.userId]));case 5:e=!1;case 6:if(r.prev=6,!this.initiatedByMe){r.next=13;break}return r.next=10,s.default.awrap(this._doSendVerification());case 10:return r.abrupt("return",r.sent);case 13:return r.next=15,s.default.awrap(this._doRespondVerification());case 15:return r.abrupt("return",r.sent);case 16:r.next=26;break;case 18:if(r.prev=18,r.t0=r.catch(6),!(r.t0 instanceof h.SwitchStartEventError)){r.next=25;break}this.startEvent=r.t0.startEvent,e=!0,r.next=26;break;case 25:throw r.t0;case 26:if(e){r.next=6;break}case 27:case"end":return r.stop()}}),null,this,[[6,18]])}},{key:"canSwitchStartEvent",value:function(e){if(e.getType()!==g)return!1;var t=e.getContent();return t&&t.method===r.NAME&&this._waitingForAccept}},{key:"_sendStart",value:function(){var e;return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this._channel.completeContent(g,{method:r.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:I,hashes:R,message_authentication_codes:T,short_authentication_string:x}),t.next=3,s.default.awrap(this._channel.sendCompleted(g,e));case 3:return t.abrupt("return",e);case 4:case"end":return t.stop()}}),null,this)}},{key:"_doSendVerification",value:function(){var e,r,n,a,u,c,l,d,v,g,m,b,S,E=this;return s.default.async((function(w){for(;;)switch(w.prev=w.next){case 0:if(this._waitingForAccept=!0,!this.startEvent){w.next=5;break}e=this._channel.completedContentFromEvent(this.startEvent),w.next=8;break;case 5:return w.next=7,s.default.awrap(this._sendStart());case 7:e=w.sent;case 8:if(this.initiatedByMe){w.next=10;break}throw new h.SwitchStartEventError(this.startEvent);case 10:return w.prev=10,w.next=13,s.default.awrap(this._waitForEvent("m.key.verification.accept"));case 13:r=w.sent;case 14:return w.prev=14,this._waitingForAccept=!1,w.finish(14);case 17:if(n=r.getContent(),a=P(n.short_authentication_string,A),O.has(n.key_agreement_protocol)&&C.has(n.hash)&&D.has(n.message_authentication_code)&&a.length){w.next=21;break}throw(0,f.newUnknownMethodError)();case 21:if("string"==typeof n.commitment){w.next=23;break}throw(0,f.newInvalidMessageError)();case 23:return u=n.message_authentication_code,c=n.commitment,l=new t.Olm.SAS,w.prev=26,this._send("m.key.verification.key",{key:l.get_pubkey()}),w.next=30,s.default.awrap(this._waitForEvent("m.key.verification.key"));case 30:if(r=w.sent,n=r.getContent(),d=n.key+p.default.stringify(e),i.sha256(d)===c){w.next=35;break}throw _();case 35:return l.set_their_key(n.key),v="MATRIX_KEY_VERIFICATION_SAS"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,g=l.generate_bytes(v,6),m=new Promise((function(e,t){E.sasEvent={sas:k(g,a),confirm:function(){E._sendMAC(l,u),e()},cancel:function(){return t((0,f.newUserCancelledError)())},mismatch:function(){return t(y())}},E.emit("show_sas",E.sasEvent)})),w.next=41,s.default.awrap(Promise.all([this._waitForEvent("m.key.verification.mac").then((function(e){return E._expectedEvent="m.key.verification.done",e})),m]));case 41:return b=w.sent,S=(0,o.default)(b,1),r=S[0],n=r.getContent(),w.next=47,s.default.awrap(this._checkMAC(l,n,u));case 47:return w.prev=47,l.free(),w.finish(47);case 50:case"end":return w.stop()}}),null,this,[[10,,14,17],[26,,47,50]])}},{key:"_doRespondVerification",value:function(){var e,r,n,a,u,c,l,d,h,v,g,m,_,b=this;return s.default.async((function(S){for(;;)switch(S.prev=S.next){case 0:if(e=this._channel.completedContentFromEvent(this.startEvent),r=P(I,new Set(e.key_agreement_protocols))[0],n=P(R,new Set(e.hashes))[0],a=P(T,new Set(e.message_authentication_codes))[0],u=P(e.short_authentication_string,A),void 0!==r&&void 0!==n&&void 0!==a&&u.length){S.next=7;break}throw(0,f.newUnknownMethodError)();case 7:return c=new t.Olm.SAS,S.prev=8,l=c.get_pubkey()+p.default.stringify(e),this._send("m.key.verification.accept",{key_agreement_protocol:r,hash:n,message_authentication_code:a,short_authentication_string:u,commitment:i.sha256(l)}),S.next=13,s.default.awrap(this._waitForEvent("m.key.verification.key"));case 13:return d=S.sent,e=d.getContent(),c.set_their_key(e.key),this._send("m.key.verification.key",{key:c.get_pubkey()}),h="MATRIX_KEY_VERIFICATION_SAS"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId,v=c.generate_bytes(h,6),g=new Promise((function(e,t){b.sasEvent={sas:k(v,u),confirm:function(){b._sendMAC(c,a),e()},cancel:function(){return t((0,f.newUserCancelledError)())},mismatch:function(){return t(y())}},b.emit("show_sas",b.sasEvent)})),S.next=22,s.default.awrap(Promise.all([this._waitForEvent("m.key.verification.mac").then((function(e){return b._expectedEvent="m.key.verification.done",e})),g]));case 22:return m=S.sent,_=(0,o.default)(m,1),d=_[0],e=d.getContent(),S.next=28,s.default.awrap(this._checkMAC(c,e,a));case 28:return S.prev=28,c.free(),S.finish(28);case 31:case"end":return S.stop()}}),null,this,[[8,,28,31]])}},{key:"_sendMAC",value:function(e,t){var r={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,o="ed25519:".concat(this._baseApis.deviceId);r[o]=w(e,t)(this._baseApis.getDeviceEd25519Key(),i+o),n.push(o);var s=this._baseApis.getCrossSigningId();if(s){var a="ed25519:".concat(s);r[a]=w(e,t)(s,i+a),n.push(a)}var u=w(e,t)(n.sort().join(","),i+"KEY_IDS");this._send("m.key.verification.mac",{mac:r,keys:u})}},{key:"_checkMAC",value:function(e,t,r){var n;return s.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId,t.keys===w(e,r)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS")){i.next=3;break}throw(0,f.newKeyMismatchError)();case 3:return i.next=5,s.default.awrap(this._verifyKeys(this.userId,t.mac,(function(t,i,o){if(o!==w(e,r)(i.keys[t],n+t))throw(0,f.newKeyMismatchError)()})));case 5:case"end":return i.stop()}}),null,this)}},{key:"events",get:function(){return m}}],[{key:"NAME",get:function(){return"m.sas.v1"}}]),r}(h.VerificationBase);r.SAS=M}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../logger":89,"./Base":75,"./Error":76,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,"another-json":24}],80:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.InRoomRequests=r.InRoomChannel=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/classCallCheck")),s=n(e("@babel/runtime/helpers/createClass")),a=e("./VerificationRequest"),u=e("../../../logger"),c=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,o.default)(this,e),this._client=t,this._roomId=r,this.userId=n,this._requestEventId=null}return(0,s.default)(e,[{key:"getTimestamp",value:function(e){return e.getTs()}},{key:"handleEvent",value:function(t,r,n){var o,s,a,c,l,d;return i.default.async((function(h){for(;;)switch(h.prev=h.next){case 0:if(o=e.getEventType(t),t.getRoomId()===this._roomId){h.next=3;break}return h.abrupt("return");case 3:if(null===this.userId&&(s=e.getOtherPartyUserId(t,this._client))&&(this.userId=s),a=this._client.getUserId(),c=t.getSender(),null===this.userId){h.next=10;break}if(c===a||c===this.userId){h.next=10;break}return u.logger.log("InRoomChannel: ignoring verification event from "+"non-participating sender ".concat(c)),h.abrupt("return");case 10:return null===this._requestEventId&&(this._requestEventId=e.getTransactionId(t)),l=!!t.getUnsigned().transaction_id,d=t.getSender()===this._client.getUserId(),h.next=15,i.default.awrap(r.handleEvent(o,t,n,l,d));case 15:return h.abrupt("return",h.sent);case 16:case"end":return h.stop()}}),null,this)}},{key:"completedContentFromEvent",value:function(e){var t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}},{key:"completeContent",value:function(e,t){return t=Object.assign({},t),e!==a.REQUEST_TYPE&&e!==a.READY_TYPE&&e!==a.START_TYPE||(t.from_device=this._client.getDeviceId()),e===a.REQUEST_TYPE?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:a.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}},{key:"send",value:function(e,t){var r=this.completeContent(e,t);return this.sendCompleted(e,r)}},{key:"sendCompleted",value:function(e,t){var r,n;return i.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return r=e,e===a.REQUEST_TYPE&&(r="m.room.message"),o.next=4,i.default.awrap(this._client.sendEvent(this._roomId,r,t));case 4:n=o.sent,e===a.REQUEST_TYPE&&(this._requestEventId=n.event_id);case 6:case"end":return o.stop()}}),null,this)}},{key:"needsDoneMessage",get:function(){return!0}},{key:"receiveStartFromOtherDevices",get:function(){return!0}},{key:"roomId",get:function(){return this._roomId}},{key:"transactionId",get:function(){return this._requestEventId}}],[{key:"getOtherPartyUserId",value:function(t,r){if(e.getEventType(t)===a.REQUEST_TYPE){var n=r.getUserId(),i=t.getSender(),o=t.getContent().to;return i===n?o:o===n?i:void 0}}},{key:"canCreateRequest",value:function(e){return e===a.REQUEST_TYPE}},{key:"getTransactionId",value:function(t){if(e.getEventType(t)===a.REQUEST_TYPE)return t.getId();var r=t.getRelation();return r&&"m.reference"===r.rel_type?r.event_id:void 0}},{key:"validateEvent",value:function(t,r){var n=e.getTransactionId(t);if("string"!=typeof n||0===n.length)return!1;var i=e.getEventType(t),o=t.getContent();if(i===a.REQUEST_TYPE){if(!o||"string"!=typeof o.to||!o.to.length)return u.logger.log("InRoomChannel: validateEvent: no valid to "+(o&&o.to)),!1;if(!e.getOtherPartyUserId(t,r))return u.logger.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(t.getSender())+", ".concat(o&&o.to)),!1}return a.VerificationRequest.validateEvent(i,t,r)}},{key:"getEventType",value:function(e){var t=e.getType();if("m.room.message"===t){var r=e.getContent();if(r)if(r.msgtype===a.REQUEST_TYPE)return a.REQUEST_TYPE}return t&&t!==a.REQUEST_TYPE?t:""}}]),e}();r.InRoomChannel=c;var l=function(){function e(){(0,o.default)(this,e),this._requestsByRoomId=new Map}return(0,s.default)(e,[{key:"getRequest",value:function(e){var t=e.getRoomId(),r=c.getTransactionId(e);return this._getRequestByTxnId(t,r)}},{key:"getRequestByChannel",value:function(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}},{key:"_getRequestByTxnId",value:function(e,t){var r=this._requestsByRoomId.get(e);if(r)return r.get(t)}},{key:"setRequest",value:function(e,t){this._setRequest(e.getRoomId(),c.getTransactionId(e),t)}},{key:"setRequestByChannel",value:function(e,t){this._setRequest(e.roomId,e.transactionId,t)}},{key:"_setRequest",value:function(e,t,r){var n=this._requestsByRoomId.get(e);n||(n=new Map,this._requestsByRoomId.set(e,n)),n.set(t,r)}},{key:"removeRequest",value:function(e){var t=e.getRoomId(),r=this._requestsByRoomId.get(t);r&&(r.delete(c.getTransactionId(e)),0===r.size&&this._requestsByRoomId.delete(t))}},{key:"findRequestInProgress",value:function(e){var t=this._requestsByRoomId.get(e);if(t){var r=!0,n=!1,i=void 0;try{for(var o,s=t.values()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;if(a.pending)return a}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}}}}]),e}();r.InRoomRequests=l},{"../../../logger":89,"./VerificationRequest":82,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/regenerator":23}],81:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.ToDeviceRequests=r.ToDeviceChannel=void 0;var i=n(e("@babel/runtime/helpers/defineProperty")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/typeof")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=e("../../../randomstring"),l=e("../../../logger"),d=e("./VerificationRequest"),h=e("../Error"),p=e("../../../models/event"),f=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,a.default)(this,e),this._client=t,this.userId=r,this._devices=n,this.transactionId=i,this._deviceId=o}return(0,u.default)(e,[{key:"isToDevices",value:function(e){var t=this;if(e.length===this._devices.length){var r=!0,n=!1,i=void 0;try{for(var o,a=function(){var e=o.value;if(!t._devices.find((function(t){return t.deviceId===e.deviceId})))return{v:!1}},u=e[Symbol.iterator]();!(r=(o=u.next()).done);r=!0){var c=a();if("object"===(0,s.default)(c))return c.v}}catch(e){n=!0,i=e}finally{try{r||null==u.return||u.return()}finally{if(n)throw i}}return!0}return!1}},{key:"getTimestamp",value:function(e){var t=e.getContent();return t&&t.timestamp}},{key:"handleEvent",value:function(e,t,r){var n,i,s,a,u,c,l,p,f=this;return o.default.async((function(v){for(;;)switch(v.prev=v.next){case 0:if(n=e.getType(),i=e.getContent(),n!==d.REQUEST_TYPE&&n!==d.READY_TYPE&&n!==d.START_TYPE){v.next=9;break}if(this.transactionId||(this.transactionId=i.transaction_id),s=i.from_device,!this._deviceId&&this._devices.includes(s)&&(this._deviceId=s),this._deviceId&&this._deviceId===s){v.next=9;break}return a=this.completeContent((0,h.errorFromEvent)((0,h.newUnexpectedMessageError)())),v.abrupt("return",this._sendToDevices(d.CANCEL_TYPE,a,[s]));case 9:return u=t.phase===d.PHASE_STARTED||t.phase===d.PHASE_READY,v.next=12,o.default.awrap(t.handleEvent(e.getType(),e,r,!1,!1));case 12:if(c=t.phase===d.PHASE_STARTED||t.phase===d.PHASE_READY,!(n===d.START_TYPE||n===d.READY_TYPE)||u||!c||!this._deviceId){v.next=20;break}if(!(l=this._devices.filter((function(e){return e!==f._deviceId}))).length){v.next=20;break}return p=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"}),v.next=20,o.default.awrap(this._sendToDevices(d.CANCEL_TYPE,p,l));case 20:case"end":return v.stop()}}),null,this)}},{key:"completedContentFromEvent",value:function(e){return e.getContent()}},{key:"completeContent",value:function(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==d.REQUEST_TYPE&&e!==d.READY_TYPE&&e!==d.START_TYPE||(t.from_device=this._client.getDeviceId()),e===d.REQUEST_TYPE&&(t.timestamp=Date.now()),t}},{key:"send",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t!==d.REQUEST_TYPE&&t!==d.START_TYPE||this.transactionId||(this.transactionId=e.makeTransactionId());var n=this.completeContent(t,r);return this.sendCompleted(t,n)}},{key:"sendCompleted",value:function(e,t){var r,n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(e!==d.REQUEST_TYPE){i.next=6;break}return i.next=3,o.default.awrap(this._sendToDevices(e,t,this._devices));case 3:r=i.sent,i.next=9;break;case 6:return i.next=8,o.default.awrap(this._sendToDevices(e,t,[this._deviceId]));case 8:r=i.sent;case 9:return n=new p.MatrixEvent({sender:this._client.getUserId(),content:t,type:e}),i.next=12,o.default.awrap(this._request.handleEvent(e,n,!0,!0,!0));case 12:return i.abrupt("return",r);case 13:case"end":return i.stop()}}),null,this)}},{key:"_sendToDevices",value:function(e,t,r){if(r.length){var n={},o=!0,s=!1,a=void 0;try{for(var u,c=r[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){n[u.value]=t}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return this._client.sendToDevice(e,(0,i.default)({},this.userId,n))}return Promise.resolve()}},{key:"deviceId",get:function(){return this._deviceId}},{key:"needsDoneMessage",get:function(){return!0}}],[{key:"getEventType",value:function(e){return e.getType()}},{key:"getTransactionId",value:function(e){var t=e.getContent();return t&&t.transaction_id}},{key:"canCreateRequest",value:function(e){return e===d.REQUEST_TYPE||e===d.START_TYPE}},{key:"validateEvent",value:function(e,t){if(e.isCancelled())return l.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;var r=e.getContent();if(!r)return l.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return l.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;var n=e.getType();if(n===d.REQUEST_TYPE){if(!Number.isFinite(r.timestamp))return l.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return l.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return d.VerificationRequest.validateEvent(n,e,t)}},{key:"makeTransactionId",value:function(){return(0,c.randomString)(32)}}]),e}();r.ToDeviceChannel=f;var v=function(){function e(){(0,a.default)(this,e),this._requestsByUserId=new Map}return(0,u.default)(e,[{key:"getRequest",value:function(e){return this.getRequestBySenderAndTxnId(e.getSender(),f.getTransactionId(e))}},{key:"getRequestByChannel",value:function(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}},{key:"getRequestBySenderAndTxnId",value:function(e,t){var r=this._requestsByUserId.get(e);if(r)return r.get(t)}},{key:"setRequest",value:function(e,t){this.setRequestBySenderAndTxnId(e.getSender(),f.getTransactionId(e),t)}},{key:"setRequestByChannel",value:function(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}},{key:"setRequestBySenderAndTxnId",value:function(e,t,r){var n=this._requestsByUserId.get(e);n||(n=new Map,this._requestsByUserId.set(e,n)),n.set(t,r)}},{key:"removeRequest",value:function(e){var t=e.getSender(),r=this._requestsByUserId.get(t);r&&(r.delete(f.getTransactionId(e)),0===r.size&&this._requestsByUserId.delete(t))}},{key:"findRequestInProgress",value:function(e,t){var r=this._requestsByUserId.get(e);if(r){var n=!0,i=!1,o=void 0;try{for(var s,a=r.values()[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value;if(u.pending&&u.channel.isToDevices(t))return u}}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}}}}]),e}();r.ToDeviceRequests=v},{"../../../logger":89,"../../../models/event":94,"../../../randomstring":104,"../Error":76,"./VerificationRequest":82,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/typeof":21,"@babel/runtime/regenerator":23}],82:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.VerificationRequest=r.PHASE_DONE=r.PHASE_CANCELLED=r.PHASE_STARTED=r.PHASE_READY=r.PHASE_REQUESTED=r.PHASE_UNSENT=r.READY_TYPE=r.DONE_TYPE=r.CANCEL_TYPE=r.START_TYPE=r.REQUEST_TYPE=r.EVENT_PREFIX=void 0;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/regenerator")),a=i(e("@babel/runtime/helpers/toConsumableArray")),u=i(e("@babel/runtime/helpers/classCallCheck")),c=i(e("@babel/runtime/helpers/createClass")),l=i(e("@babel/runtime/helpers/possibleConstructorReturn")),d=i(e("@babel/runtime/helpers/getPrototypeOf")),h=i(e("@babel/runtime/helpers/assertThisInitialized")),p=i(e("@babel/runtime/helpers/inherits")),f=i(e("@babel/runtime/helpers/defineProperty")),v=e("../../../logger"),g=e("events"),m=e("../Error"),y=n(e("../../olmlib")),_="m.key.verification.";r.EVENT_PREFIX=_;var b=_+"request";r.REQUEST_TYPE=b;var S=_+"start";r.START_TYPE=S;var k=_+"cancel";r.CANCEL_TYPE=k;r.DONE_TYPE="m.key.verification.done";var E=_+"ready";r.READY_TYPE=E;var w=1;r.PHASE_UNSENT=w;r.PHASE_REQUESTED=2;r.PHASE_READY=3;r.PHASE_STARTED=4;r.PHASE_CANCELLED=5;r.PHASE_DONE=6;var I=function(e){function r(e,t,n){var i;return(0,u.default)(this,r),i=(0,l.default)(this,(0,d.default)(r).call(this)),(0,f.default)((0,h.default)(i),"_cancelOnTimeout",(function(){try{i.cancel({reason:"Other party didn't accept in time",code:"m.timeout"})}catch(e){v.logger.error("Error while cancelling verification request",e)}})),i.channel=e,i.channel._request=(0,h.default)(i),i._verificationMethods=t,i._client=n,i._commonMethods=[],i._setPhase(w,!1),i._eventsByUs=new Map,i._eventsByThem=new Map,i._observeOnly=!1,i._timeoutTimer=null,i._sharedSecret=null,i._accepting=!1,i._declining=!1,i}return(0,p.default)(r,e),(0,c.default)(r,[{key:"otherPartySupportsMethod",value:function(e){if(!this.ready&&!this.started)return!1;var t=this._eventsByThem.get(b)||this._eventsByThem.get(E);if(!t)return!1;var r=t.getContent();if(!r)return!1;var n=r.methods;return!!Array.isArray(n)&&n.includes(e)}},{key:"beginKeyVerification",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier){var r=2===this.phase||3===this.phase||this.phase===w&&this.channel.constructor.canCreateRequest(S);if(r){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw(0,m.newUnknownMethodError)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw(0,m.newUnknownMethodError)()}}return this._verifier}},{key:"sendRequest",value:function(){var e;return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.observeOnly||this._phase!==w){t.next=5;break}return e=(0,a.default)(this._verificationMethods.keys()),t.next=4,s.default.awrap(this.channel.send(b,{methods:e}));case 4:this._generateSharedSecret();case 5:case"end":return t.stop()}}),null,this)}},{key:"cancel",value:function(){var e,t,r,n,i,o=arguments;return s.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(e=o.length>0&&void 0!==o[0]?o[0]:{},t=e.reason,r=void 0===t?"User declined":t,n=e.code,i=void 0===n?"m.user":n,this.observeOnly||5===this._phase){a.next=11;break}if(this._declining=!0,this.emit("change"),!this._verifier){a.next=8;break}return a.abrupt("return",this._verifier.cancel((0,m.errorFactory)(i,r)()));case 8:return this._cancellingUserId=this._client.getUserId(),a.next=11,s.default.awrap(this.channel.send(k,{code:i,reason:r}));case 11:case"end":return a.stop()}}),null,this)}},{key:"accept",value:function(){var e;return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.observeOnly||2!==this.phase||this.initiatedByMe){t.next=7;break}return e=(0,a.default)(this._verificationMethods.keys()),this._accepting=!0,this.emit("change"),t.next=6,s.default.awrap(this.channel.send(E,{methods:e}));case 6:this._generateSharedSecret();case 7:case"end":return t.stop()}}),null,this)}},{key:"_generateSharedSecret",value:function(){var e=new Uint8Array(32);t.crypto.getRandomValues(e),this._sharedSecret=y.encodeBase64(e)}},{key:"waitFor",value:function(e){var t=this;return new Promise((function(r,n){var i=function i(){var o=!1;return e(t)?(r(t),o=!0):t.cancelled&&(n(new Error("cancelled")),o=!0),o&&t.off("change",i),o};i()||t.on("change",i)}))}},{key:"_setPhase",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._phase=e,t&&this.emit("change")}},{key:"_getEventByEither",value:function(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}},{key:"_getEventBy",value:function(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}},{key:"_calculatePhaseTransitions",value:function(){var e=[{phase:w}],t=function(){return e[e.length-1].phase},r=this._eventsByThem.has(b),n=this._getEventBy(b,r);n&&e.push({phase:2,event:n});var i,o=n&&this._getEventBy(E,!r);if(o&&2===t()&&e.push({phase:3,event:o}),o||!n){var s=this._eventsByThem.get(S),a=this._eventsByUs.get(S);i=s&&a?s.getSender()<a.getSender()?s:a:s||a}else i=this._getEventBy(S,!r);if(i){var u=2===t()&&n.getSender()!==i.getSender(),c=t()===w&&this.channel.constructor.canCreateRequest(S);(u||3===t()||c)&&e.push({phase:4,event:i})}this._eventsByUs.get("m.key.verification.done")&&4===t()&&e.push({phase:6});var l=this._getEventByEither(k);return l&&6!==t()?(e.push({phase:5,event:l}),e):e}},{key:"_transitionToPhase",value:function(e){var t=this,r=e.phase,n=e.event;if((2===r||3===r)&&!this._wasSentByOwnDevice(n)){var i=n.getContent();this._commonMethods=i.methods.filter((function(e){return t._verificationMethods.has(e)}))}if(this.observeOnly||2!==r&&4!==r&&3!==r||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(n)&&!this._wasSentByOwnDevice(n)&&(this._observeOnly=!0),4===r){var o=n.getContent().method;this._verifier||this.observeOnly||(this._verifier=this._createVerifier(o,n))}}},{key:"handleEvent",value:function(e,t,r,n,i){var o,a,u,c,l,d,h,p,f,g,m,y,_,b,S,E,w=this;return s.default.async((function(I){for(;;)switch(I.prev=I.next){case 0:if(this.pending){I.next=2;break}return I.abrupt("return");case 2:if(o=this._observeOnly,this._adjustObserveOnly(t,r),this.observeOnly||n){I.next=9;break}return I.next=7,s.default.awrap(this._cancelOnError(e,t));case 7:if(!I.sent){I.next=9;break}return I.abrupt("return");case 9:for(a=this.phase,this._addEvent(e,t,i),u=this._calculatePhaseTransitions(),c=u.findIndex((function(e){return e.phase===w.phase})),l=u.slice(c+1),d=!0,h=!1,p=void 0,I.prev=17,f=l[Symbol.iterator]();!(d=(g=f.next()).done);d=!0)m=g.value,this._transitionToPhase(m);I.next=25;break;case 21:I.prev=21,I.t0=I.catch(17),h=!0,p=I.t0;case 25:I.prev=25,I.prev=26,d||null==f.return||f.return();case 28:if(I.prev=28,!h){I.next=31;break}throw p;case 31:return I.finish(28);case 32:return I.finish(25);case 33:try{this._verifier&&!this.observeOnly&&(y=this._verifier.startEvent,_=y?y.getSender():this._client.getUserId(),b=t.getSender()<_,this._verifier.canSwitchStartEvent(t)&&b?this._verifier.switchStartEvent(t):n||(e===k||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t)),l.length?(S=l[l.length-1],E=S.phase,this._setupTimeout(E),this._setPhase(E)):this._observeOnly!==o&&this.emit("change")}finally{v.logger.log("Verification request ".concat(this.channel.transactionId,": ")+"".concat(e," event with ").concat(JSON.stringify(t.getContent())," ")+"deviceId:".concat(this.channel.deviceId," ")+"sender:".concat(t.getSender(),", isSentByUs:").concat(i," ")+"phase:".concat(a,"=>").concat(this.phase,", ")+"observeOnly:".concat(o,"=>").concat(this._observeOnly))}case 34:case"end":return I.stop()}}),null,this,[[17,21,25,33],[26,,28,32]])}},{key:"_setupTimeout",value:function(e){(!this._timeoutTimer&&!this.observeOnly&&2===e&&this.initiatedByMe&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer)&&((4===e||3===e||6===e||5===e)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null))}},{key:"_cancelOnError",value:function(e,t){var r,n,i,o;return s.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(e!==S){a.next=6;break}if(r=t.getContent().method,this._verificationMethods.has(r)){a.next=6;break}return a.next=5,s.default.awrap(this.cancel((0,m.errorFromEvent)((0,m.newUnknownMethodError)())));case 5:return a.abrupt("return",!0);case 6:if(n=e===b&&this.phase!==w,i=e===E&&2!==this.phase,!n&&!i){a.next=14;break}return v.logger.warn("Cancelling, unexpected ".concat(e," verification ")+"event from ".concat(t.getSender())),o="Unexpected ".concat(e," event in phase ").concat(this.phase),a.next=13,s.default.awrap(this.cancel((0,m.errorFromEvent)((0,m.newUnexpectedMessageError)({reason:o}))));case 13:return a.abrupt("return",!0);case 14:return a.abrupt("return",!1);case 15:case"end":return a.stop()}}),null,this)}},{key:"_adjustObserveOnly",value:function(e,t){t||(this._observeOnly=!0);var r=this.channel.getTimestamp(e);if(Number.isFinite(r)){var n=Date.now()-r;(n>597e3||n<-3e5)&&(this._observeOnly=!0)}}},{key:"_addEvent",value:function(e,t,r){if(r?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===b){var n=!0,i=!1,s=void 0;try{for(var a,u=this._eventsByThem.entries()[Symbol.iterator]();!(n=(a=u.next()).done);n=!0){var c=(0,o.default)(a.value,2),l=c[0];c[1].getSender()!==this.otherUserId&&this._eventsByThem.delete(l)}}catch(e){i=!0,s=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw s}}}}},{key:"_createVerifier",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r||(r=this.targetDevice);var n=r,i=n.userId,o=n.deviceId,s=this._verificationMethods.get(e);if(s)return new s(this.channel,this._client,i,o,t,this);v.logger.warn("could not find verifier constructor for method",e)}},{key:"_wasSentByOwnUser",value:function(e){return e.getSender()===this._client.getUserId()}},{key:"_wasSentByOwnDevice",value:function(e){if(!this._wasSentByOwnUser(e))return!1;var t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}},{key:"invalid",get:function(){return this.phase===w}},{key:"requested",get:function(){return 2===this.phase}},{key:"cancelled",get:function(){return 5===this.phase}},{key:"ready",get:function(){return 3===this.phase}},{key:"started",get:function(){return 4===this.phase}},{key:"done",get:function(){return 6===this.phase}},{key:"methods",get:function(){return this._commonMethods}},{key:"timeout",get:function(){var e=this._getEventByEither(b);if(e){var t=Date.now()-this.channel.getTimestamp(e);return Math.max(0,6e5-t)}return 0}},{key:"requestEvent",get:function(){return this._getEventByEither(b)}},{key:"phase",get:function(){return this._phase}},{key:"verifier",get:function(){return this._verifier}},{key:"canAccept",get:function(){return this.phase<3&&!this._accepting&&!this._declining}},{key:"accepting",get:function(){return this._accepting}},{key:"declining",get:function(){return this._declining}},{key:"pending",get:function(){return!this.observeOnly&&6!==this._phase&&5!==this._phase}},{key:"initiatedByMe",get:function(){var e=this._eventsByUs.size+this._eventsByThem.size===0;if(this._phase===w&&e)return!0;var t=this._eventsByUs.has(b),r=this._eventsByThem.has(b);if(t&&!r)return!0;if(!t&&r)return!1;var n=this._eventsByUs.has(S),i=this._eventsByThem.has(S);return!(!n||i)}},{key:"requestingUserId",get:function(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}},{key:"receivingUserId",get:function(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}},{key:"otherUserId",get:function(){return this.channel.userId}},{key:"cancellingUserId",get:function(){var e=this._eventsByUs.get(k),t=this._eventsByThem.get(k);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}},{key:"cancellationCode",get:function(){var e=this._getEventByEither(k);return e?e.getContent().code:null}},{key:"observeOnly",get:function(){return this._observeOnly}},{key:"encodedSharedSecret",get:function(){return this._sharedSecret||this._generateSharedSecret(),this._sharedSecret}},{key:"targetDevice",get:function(){var e=(this._eventsByThem.get(b)||this._eventsByThem.get(E)||this._eventsByThem.get(S)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}}],[{key:"validateEvent",value:function(e,t,r){var n=t.getContent();return!(!e||!e.startsWith(_))&&(n?e!==b&&e!==E||Array.isArray(n.methods)?e!==b&&e!==E&&e!==S||"string"==typeof n.from_device&&0!==n.from_device.length||(v.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(v.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(v.logger.log("VerificationRequest: validateEvent: no content"),!1))}}]),r}(g.EventEmitter);r.VerificationRequest=I}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../../logger":89,"../../olmlib":69,"../Error":76,"@babel/runtime/helpers/assertThisInitialized":3,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/helpers/toConsumableArray":20,"@babel/runtime/regenerator":23,events:32}],83:[function(e,t,r){"use strict";function n(e,t){var r="Store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again",n=Reflect.construct(Error,[r]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function i(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again",r=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this)),r.reason=e,r.name="InvalidCryptoStoreError",r}Object.defineProperty(r,"__esModule",{value:!0}),r.InvalidStoreError=n,r.InvalidCryptoStoreError=i,n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),i.TOO_NEW="TOO_NEW",i.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(i,Error)},{}],84:[function(e,t,r){"use strict";function n(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}Object.defineProperty(r,"__esModule",{value:!0}),r.FilterComponent=n,n.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},n.prototype._checkFields=function(e,t,r,n){for(var i={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){var r=t.slice(0,-1);return e.substr(0,r.length)===r}return e===t}(r,e)}},o=0;o<Object.keys(i).length;o++){var s=Object.keys(i)[o],a=i[s];if(this["not_"+s].filter(a).length>0)return!1;var u=this[s];if(u&&!u.map(a))return!1}var c=this.filter_json.contains_url;return void 0===c||c===n},n.prototype.filter=function(e){return e.filter(this.check,this)},n.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10}},{}],85:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Filter=o;var n=e("./filter-component");function i(e,t,r){for(var n=t.split("."),i=e,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=r}function o(e,t){this.userId=e,this.filterId=t,this.definition={}}o.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},o.LAZY_LOADING_SYNC_FILTER={room:{state:o.LAZY_LOADING_MESSAGES_FILTER}},o.prototype.getFilterId=function(){return this.filterId},o.prototype.getDefinition=function(){return this.definition},o.prototype.setDefinition=function(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new n.FilterComponent(r),this._room_timeline_filter=new n.FilterComponent(t&&t.timeline||{})},o.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},o.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},o.prototype.setTimelineLimit=function(e){i(this.definition,"room.timeline.limit",e)},o.prototype.setIncludeLeaveRooms=function(e){i(this.definition,"room.include_leave",e)},o.fromJson=function(e,t,r){var n=new o(e,t);return n.setDefinition(r),n}},{"./filter-component":84}],86:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixHttpApi=l,r.MatrixError=h,r.PREFIX_MEDIA_R0=r.PREFIX_IDENTITY_V2=r.PREFIX_IDENTITY_V1=r.PREFIX_UNSTABLE=r.PREFIX_R0=void 0;var o=i(e("@babel/runtime/helpers/typeof")),s=e("content-type"),a=n(e("./utils")),u=e("./logger"),c=n(e("./realtime-callbacks"));r.PREFIX_R0="/_matrix/client/r0";r.PREFIX_UNSTABLE="/_matrix/client/unstable";r.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1";r.PREFIX_IDENTITY_V2="/_matrix/identity/v2";function l(e,t){a.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}r.PREFIX_MEDIA_R0="/_matrix/media/r0",l.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){var e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(e,r){a.isFunction(r)?r={callback:r}:void 0===r&&(r={});var n=!1!==r.includeFilename,i=r.type||e.type||"application/octet-stream",o=r.name||e.name,s=e;s.stream&&"function"!=typeof s.stream&&(u.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),s=s.stream);var l=r.rawResponse;void 0===l&&(t.XMLHttpRequest?l=!1:(u.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),l=!0));var h=r.onlyContentUri;l||void 0!==h||(t.XMLHttpRequest?(u.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);var p,f={loaded:0,total:0},v=null;if(l||(v=function(e){var t=JSON.parse(e);if(h&&void 0===(t=t.content_uri))throw Error("Bad response");return t}),t.XMLHttpRequest){var g=a.defer(),m=new t.XMLHttpRequest;f.xhr=m;var y=d(g,r.callback,this.opts.onlyData),_=function(){m.abort(),y(new Error("Timeout"))};m.timeout_timer=c.setTimeout(_,3e4),m.onreadystatechange=function(){switch(m.readyState){case t.XMLHttpRequest.DONE:var e;c.clearTimeout(m.timeout_timer);try{if(!m.responseText)throw new Error("No response body.");e=m.responseText,v&&(e=v(e))}catch(e){return e.http_status=m.status,void y(e)}y(void 0,m,e)}},m.upload.addEventListener("progress",(function(e){c.clearTimeout(m.timeout_timer),f.loaded=e.loaded,f.total=e.total,m.timeout_timer=c.setTimeout(_,3e4),r.progressHandler&&r.progressHandler({loaded:e.loaded,total:e.total})}));var b=this.opts.baseUrl+"/_matrix/media/r0/upload",S=[];n&&o&&S.push("filename="+encodeURIComponent(o)),this.useAuthorizationHeader||S.push("access_token="+encodeURIComponent(this.opts.accessToken)),S.length>0&&(b+="?"+S.join("&")),m.open("POST",b),this.useAuthorizationHeader&&m.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),m.setRequestHeader("Content-Type",i),m.send(s),(p=g.promise).abort=m.abort.bind(m)}else{var k={};n&&o&&(k.filename=o),p=this.authedRequest(r.callback,"POST","/upload",k,s,{prefix:"/_matrix/media/r0",headers:{"Content-Type":i},json:!1,bodyParser:v})}var E=this,w=p.finally((function(){for(var e=0;e<E.uploads.length;++e)if(E.uploads[e]===f)return void E.uploads.splice(e,1)}));return w.abort=p.abort,f.promise=w,this.uploads.push(f),w},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,r,n,i,s){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");var u=this.opts.idBaseUrl+i+r;if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+(0,o.default)(e));var c={uri:u,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"===(0,o.default)(n)&&(c.json=n),s&&(c.headers.Authorization="Bearer ".concat(s));var l=a.defer();return this.opts.request(c,d(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,r,n,i,o){n||(n={}),this.useAuthorizationHeader?(isFinite(o)&&(o={localTimeoutMs:o}),o||(o={}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);var s=this.request(e,t,r,n,i,o),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,r,n,i,o){var s=void 0!==(o=o||{}).prefix?o.prefix:this.opts.prefix,a=this.opts.baseUrl+s+r;return this.requestOtherUrl(e,t,a,n,i,o)},requestOtherUrl:function(e,t,r,n,i,o){return null==o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,r,n,i,o)},getUrl:function(e,t,r){var n="";return t&&(n="?"+a.encodeParams(t)),this.opts.baseUrl+r+e+n},_request:function(e,t,r,n,i,s){if(void 0!==e&&!a.isFunction(e))throw Error("Expected callback to be a function but got "+(0,o.default)(e));s=s||{};var u=this;if(this.opts.extraParams)for(var l in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(l)&&(n[l]=this.opts.extraParams[l]);var p=a.extend({},s.headers||{}),f=void 0===s.json||s.json,v=s.bodyParser;f&&(i&&(i=JSON.stringify(i),p["content-type"]="application/json"),p.accept||(p.accept="application/json"),void 0===v&&(v=function(e){return JSON.parse(e)}));var g,m,y=a.defer(),_=!1,b=s.localTimeoutMs||this.opts.localTimeoutMs,S=function(){b&&(g&&c.clearTimeout(g),g=c.setTimeout((function(){_=!0,m&&m.abort&&m.abort(),y.reject(new h({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:b}))}),b))};S();var k=y.promise;try{(m=this.opts.request({uri:r,method:t,withCredentials:!1,qs:n,qsStringifyOptions:s.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:b,headers:p||{},_matrix_opts:this.opts},(function(t,r,n){b&&(c.clearTimeout(g),_)||d(y,e,u.opts.onlyData,v)(t,r,n)})))&&("onprogress"in m&&(m.onprogress=function(e){S()}),m.abort&&(k.abort=m.abort.bind(m)))}catch(t){y.reject(t),e&&e(t)}return k}};var d=function(e,t,r,n){return t=t||function(){},function(i,a,u){if(!i)try{a.statusCode>=400?i=function(e,t){var r,n=e.statusCode,i=function(e){var t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return(0,s.parse)(t)}catch(e){throw new Error("Error parsing Content-Type '".concat(t,"': ").concat(e))}}(e);if(i)if("application/json"===i.type){var a="object"===(0,o.default)(t)?t:JSON.parse(t);r=new h(a)}else"text/plain"===i.type&&(r=new Error("Server returned ".concat(n," error: ").concat(t)));r||(r=new Error("Server returned ".concat(n," error")));return r.httpStatus=n,r}(a,u):n&&(u=n(u))}catch(e){i=new Error("Error parsing server response: ".concat(e))}if(i)e.reject(i),t(i);else{var c={code:a.statusCode,headers:a.headers,data:u};e.resolve(r?u:c),t(null,r?u:c)}}};function h(e){e=e||{},this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}h.prototype=Object.create(Error.prototype),h.prototype.constructor=h}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":89,"./realtime-callbacks":105,"./utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/typeof":21,"content-type":31}],87:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.exists=function(e,t){return new Promise((function(r,n){var i=!0,o=e.open(t);o.onupgradeneeded=function(){i=!1},o.onblocked=function(){return n()},o.onsuccess=function(){o.result.close(),i||e.deleteDatabase(t),r(i)},o.onerror=function(e){return n(e.target.error)}}))}},{}],88:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.InteractiveAuth=c;var o=i(e("@babel/runtime/regenerator")),s=i(e("url")),a=n(e("./utils")),u=e("./logger");function c(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}c.prototype={attemptAuth:function(){var e=this;return new Promise((function(t,r){e._resolveFunc=t,e._rejectFunc=r,e._data.flows?e._startNextAuthStage():(e._busyChangedCallback&&e._busyChangedCallback(!0),e._doRequest(e._data).finally((function(){e._busyChangedCallback&&e._busyChangedCallback(!1)})))}))},poll:function(){var e,t,r;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(this._data.session){n.next=2;break}return n.abrupt("return");case 2:if(!this._submitPromise){n.next=4;break}return n.abrupt("return");case 4:if(e={},"m.login.email.identity"!=this._currentStage){n.next=14;break}if(!this._emailSid){n.next=14;break}return t={sid:this._emailSid,client_secret:this._clientSecret},n.next=10,o.default.awrap(this._matrixClient.doesServerRequireIdServerParam());case 10:if(!n.sent){n.next=13;break}r=s.default.parse(this._matrixClient.getIdentityServerUrl()),t.id_server=r.host;case 13:e={type:"m.login.email.identity",threepid_creds:t};case 14:this.submitAuthDict(e,!0);case 15:case"end":return n.stop()}}),null,this)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){var t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow:function(){return this._chosenFlow},submitAuthDict:function(e,t){var r;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(this._resolveFunc){n.next=2;break}throw new Error("submitAuthDict() called before attemptAuth()");case 2:!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);case 3:if(!this._submitPromise){n.next=13;break}return n.prev=4,n.next=7,o.default.awrap(this._submitPromise);case 7:n.next=11;break;case 9:n.prev=9,n.t0=n.catch(4);case 11:n.next=3;break;case 13:return r={session:this._data.session},a.extend(r,e),n.prev=15,this._submitPromise=this._doRequest(r,t),n.next=19,o.default.awrap(this._submitPromise);case 19:return n.prev=19,this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1),n.finish(19);case 23:case"end":return n.stop()}}),null,this,[[4,9],[15,,19,23]])},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:function(e,t){var r,n,i,s;return o.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,o.default.awrap(this._requestCallback(e,t));case 3:r=a.sent,this._resolveFunc(r),a.next=30;break;case 7:if(a.prev=7,a.t0=a.catch(0),n=a.t0.data?a.t0.data.flows:null,i=Boolean(this._data.flows)||Boolean(n),401===a.t0.httpStatus&&a.t0.data&&i||(t?u.logger.log("Background poll request failed doing UI auth: ignoring",a.t0):this._rejectFunc(a.t0)),a.t0.data.flows||a.t0.data.completed||a.t0.data.session||(a.t0.data.flows=this._data.flows,a.t0.data.completed=this._data.completed,a.t0.data.session=this._data.session),this._data=a.t0.data,this._startNextAuthStage(),this._emailSid||this._requestingEmailToken||!this._chosenFlow.stages.includes("m.login.email.identity")){a.next=30;break}return this._requestingEmailToken=!0,a.prev=17,a.next=20,o.default.awrap(this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session));case 20:s=a.sent,this._emailSid=s.sid,a.next=27;break;case 24:a.prev=24,a.t1=a.catch(17),this._rejectFunc(a.t1);case 27:return a.prev=27,this._requestingEmailToken=!1,a.finish(27);case 30:case"end":return a.stop()}}),null,this,[[0,7],[17,24,27,30]])},_startNextAuthStage:function(){var e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"!==e)if(this._data.errcode||this._data.error)this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});else{var t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)}else this.submitAuthDict({type:"m.login.dummy"})},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),u.logger.log("Active flow => %s",JSON.stringify(this._chosenFlow));var e=this._firstUncompletedStage(this._chosenFlow);return u.logger.log("Next stage: %s",e),e},_chooseFlow:function(){var e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),r=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber),n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value,c=!1,l=!1,d=!0,h=!1,p=void 0;try{for(var f,v=u.stages[Symbol.iterator]();!(d=(f=v.next()).done);d=!0){var g=f.value;"m.login.email.identity"===g?c=!0:"m.login.msisdn"==g&&(l=!0)}}catch(m){h=!0,p=m}finally{try{d||null==v.return||v.return()}finally{if(h)throw p}}if(c==t&&l==r)return u}}catch(m){i=!0,o=m}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}var m=new Error("No appropriate authentication flow found");throw m.name="NoAuthFlowFoundError",m.required_stages=[],t&&m.required_stages.push("m.login.email.identity"),r&&m.required_stages.push("m.login.msisdn"),m.available_flows=e,m},_firstUncompletedStage:function(e){for(var t=(this._data||{}).completed||[],r=0;r<e.stages.length;++r){var n=e.stages[r];if(-1===t.indexOf(n))return n}}}},{"./logger":89,"./utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23,url:47}],89:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.logger=void 0;var i=n(e("loglevel"));i.default.methodFactory=function(e,t,r){return function(){var t,r,n="error"===e||"warn"===e||"trace"===e||"info"===e;return n?(t=console)[e].apply(t,arguments):(r=console).log.apply(r,arguments)}};var o=i.default.getLogger("matrix");r.logger=o,o.setLevel(i.default.levels.DEBUG)},{"@babel/runtime/helpers/interopRequireDefault":10,loglevel:34}],90:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0});var i={ContentHelpers:!0,request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,createNewMatrixCall:!0,setMatrixCallAudioOutput:!0,setMatrixCallAudioInput:!0,setMatrixCallVideoInput:!0};r.request=function(e){C=e},r.getRequest=function(){return C},r.wrapRequest=function(e){var t=C;C=function(r,n){return e(t,r,n)}},r.setCryptoStoreFactory=function(e){P=e},r.createClient=function(e){"string"==typeof e&&(e={baseUrl:e});return e.request=e.request||C,e.store=e.store||new a.MemoryStore({localStorage:t.localStorage}),e.scheduler=e.scheduler||new u.MatrixScheduler,e.cryptoStore=e.cryptoStore||P(),new c.MatrixClient(e)},Object.defineProperty(r,"createNewMatrixCall",{enumerable:!0,get:function(){return D.createNewMatrixCall}}),Object.defineProperty(r,"setMatrixCallAudioOutput",{enumerable:!0,get:function(){return D.setAudioOutput}}),Object.defineProperty(r,"setMatrixCallAudioInput",{enumerable:!0,get:function(){return D.setAudioInput}}),Object.defineProperty(r,"setMatrixCallVideoInput",{enumerable:!0,get:function(){return D.setVideoInput}}),r.ContentHelpers=void 0;var o=n(e("@babel/runtime/helpers/interopRequireWildcard")),s=e("./crypto/store/memory-crypto-store");Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=e("./store/memory");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return a[e]}}))}));var u=e("./scheduler");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return u[e]}}))}));var c=e("./client");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=e("./http-api");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=e("./autodiscovery");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return d[e]}}))}));var h=e("./sync-accumulator");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return h[e]}}))}));var p=e("./errors");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=e("./models/event");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return f[e]}}))}));var v=e("./models/room");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return v[e]}}))}));var g=e("./models/group");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return g[e]}}))}));var m=e("./models/event-timeline");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return m[e]}}))}));var y=e("./models/event-timeline-set");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=e("./models/room-member");Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return _[e]}}))}));var b=e("./models/room-state");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return b[e]}}))}));var S=e("./models/user");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return S[e]}}))}));var k=e("./filter");Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return k[e]}}))}));var E=e("./timeline-window");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return E[e]}}))}));var w=e("./interactive-auth");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return w[e]}}))}));var I=e("./service-types");Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return I[e]}}))}));var R=e("./store/indexeddb");Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return R[e]}}))}));var T=e("./store/session/webstorage");Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return T[e]}}))}));var x=e("./crypto/store/indexeddb-crypto-store");Object.keys(x).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return x[e]}}))}));var O=e("./content-repo");Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(r,e,{enumerable:!0,get:function(){return O[e]}}))}));var C,D=e("./webrtc/call"),A=Promise.resolve().then((function(){return(0,o.default)(e("./content-helpers"))}));r.ContentHelpers=A;var P=function(){return new s.MemoryCryptoStore}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./autodiscovery":50,"./client":53,"./content-helpers":54,"./content-repo":55,"./crypto/store/indexeddb-crypto-store":72,"./crypto/store/memory-crypto-store":74,"./errors":83,"./filter":85,"./http-api":86,"./interactive-auth":88,"./models/event":94,"./models/event-timeline":93,"./models/event-timeline-set":92,"./models/group":95,"./models/room":100,"./models/room-member":97,"./models/room-state":98,"./models/user":102,"./scheduler":106,"./service-types":107,"./store/indexeddb":110,"./store/memory":111,"./store/session/webstorage":112,"./sync-accumulator":114,"./timeline-window":116,"./webrtc/call":118,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11}],91:[function(e,t,r){"use strict";function n(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}Object.defineProperty(r,"__esModule",{value:!0}),r.EventContext=n,n.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},n.prototype.getTimeline=function(){return this._timeline},n.prototype.getOurEventIndex=function(){return this._ourEventIndex},n.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},n.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},n.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)}},{}],92:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.EventTimelineSet=d;var i,o=e("events"),s=e("./event-timeline"),a=e("./event"),u=n(e("../utils")),c=e("../logger"),l=e("./relations");function d(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new s.EventTimeline(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}i=c.logger.log.bind(c.logger),u.inherits(d,o.EventEmitter),d.prototype.getTimelines=function(){return this._timelines},d.prototype.getFilter=function(){return this._filter},d.prototype.setFilter=function(e){this._filter=e},d.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},d.prototype.getLiveTimeline=function(){return this._liveTimeline},d.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},d.prototype.replaceEventId=function(e,t){var r=this._eventIdToTimeline[e];r&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=r)},d.prototype.resetLiveTimeline=function(e,t){var r=!this._timelineSupport||!t,n=this._liveTimeline,i=r?n.forkLive(s.EventTimeline.FORWARDS):n.fork(s.EventTimeline.FORWARDS);r?(this._timelines=[i],this._eventIdToTimeline={}):this._timelines.push(i),t&&n.setPaginationToken(t,s.EventTimeline.FORWARDS),i.setPaginationToken(e,s.EventTimeline.BACKWARDS),this._liveTimeline=i,this.emit("Room.timelineReset",this.room,this,r)},d.prototype.getTimelineForEvent=function(e){var t=this._eventIdToTimeline[e];return void 0===t?null:t},d.prototype.findEventById=function(e){var t=this.getTimelineForEvent(e);if(t)return u.findElement(t.getEvents(),(function(t){return t.getId()==e}))},d.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new s.EventTimeline(this);return this._timelines.push(e),e},d.prototype.addEventsToTimeline=function(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this._filter||(e=this._filter.filterRoomTimeline(e)).length){for(var o=t?s.EventTimeline.BACKWARDS:s.EventTimeline.FORWARDS,a=t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS,u=!1,l=!1,d=0;d<e.length;d++){var h=e[d],p=h.getId(),f=this._eventIdToTimeline[p];if(f)if(l=!1,f!=r){var v=r.getNeighbouringTimeline(o);if(v)i(f==v?"Event "+p+" in neighbouring timeline - switching to "+f:"Event "+p+" already in a different timeline "+f),r=f;else{c.logger.info("Already have timeline for "+p+" - joining timeline "+r+" to "+f);var g=f===this._liveTimeline,m=r===this._liveTimeline,y=o===s.EventTimeline.BACKWARDS&&g,_=o===s.EventTimeline.FORWARDS&&m;y||_?(y&&c.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+f+")"),_&&c.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")")):(r.setNeighbouringTimeline(f,o),f.setNeighbouringTimeline(r,a),r=f,u=!0)}}else i("Event "+p+" already in timeline "+r);else this.addEventToTimeline(h,r,t),l=!0,u=!0}if(l||!u){if(o===s.EventTimeline.FORWARDS&&r===this._liveTimeline)return c.logger.warn({lastEventWasNew:l,didUpdate:u}),void c.logger.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(n));r.setPaginationToken(n,o)}}},d.prototype.addLiveEvent=function(e,t,r){if(this._filter&&!this._filter.filterRoomTimeline([e]).length)return;var n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){i("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var o=n.getEvents(),a=0;a<o.length;a++)if(o[a].getId()===e.getId()){s.EventTimeline.setEventMetadata(e,n.getState(s.EventTimeline.FORWARDS),!1),o[a].encryptedType||(o[a]=e);break}}else i("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1,r)},d.prototype.addEventToTimeline=function(e,t,r,n){var i=e.getId();t.addEvent(e,r),this._eventIdToTimeline[i]=t,this.setRelationsTarget(e),this.aggregateRelations(e);var o={timeline:t,liveEvent:!r&&t==this._liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(r),!1,o)},d.prototype.handleRemoteEcho=function(e,t,r){var n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[r]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.removeEvent=function(e){var t=this._eventIdToTimeline[e];if(!t)return null;var r=t.removeEvent(e);if(r){delete this._eventIdToTimeline[e];var n={timeline:t};this.emit("Room.timeline",r,this.room,void 0,!0,n)}return r},d.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;var r=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===r)return null;if(void 0===n)return null;if(r===n){for(var i,o,a=r.getEvents(),u=0;u<a.length&&(void 0===i||void 0===o);u++){var c=a[u].getId();c==e&&(i=u),c==t&&(o=u)}return i-o}for(var l=r;l;){if(l===n)return-1;l=l.getNeighbouringTimeline(s.EventTimeline.FORWARDS)}for(l=r;l;){if(l===n)return 1;l=l.getNeighbouringTimeline(s.EventTimeline.BACKWARDS)}return null},d.prototype.getRelationsForEvent=function(e,t,r){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!r)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[r]},d.prototype.setRelationsTarget=function(e){if(this._unstableClientRelationAggregation){var t=this._relations[e.getId()];if(t){var r=t["m.replace"];if(r){var n=r["m.room.message"];n&&n.setTargetEvent(e)}}}},d.prototype.aggregateRelations=function(e){var t=this;if(this._unstableClientRelationAggregation&&!e.isRedacted()&&e.status!==a.EventStatus.CANCELLED)if(e.isBeingDecrypted())e.once("Event.decrypted",(function(){t.aggregateRelations(e)}));else{var r=e.getRelation();if(r){var n=r.event_id,i=r.rel_type,o=e.getType(),s=this._relations[n];s||(s=this._relations[n]={});var u=s[i];u||(u=s[i]={});var c,d=u[o],h=!1;d||(d=u[o]=new l.Relations(i,o,this.room),h=!0,(c=this.findEventById(n))&&d.setTargetEvent(c)),d.addEvent(e),h&&c&&c.emit("Event.relationsCreated",i,o)}}}},{"../logger":89,"../utils":117,"./event":94,"./event-timeline":93,"./relations":96,"@babel/runtime/helpers/interopRequireWildcard":11,events:32}],93:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.EventTimeline=i;var n=e("./room-state");function i(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new n.RoomState(this._roomId),this._startState.paginationToken=null,this._endState=new n.RoomState(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}i.BACKWARDS="b",i.FORWARDS="f",i.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");var t=!0,r=!1,n=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;Object.freeze(s)}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}this._startState.setStateEvents(e),this._endState.setStateEvents(e)},i.prototype.forkLive=function(e){var t=this.getState(e),r=new i(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t,this._endState=t.clone(),r},i.prototype.fork=function(e){var t=this.getState(e),r=new i(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t.clone(),r},i.prototype.getRoomId=function(){return this._roomId},i.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},i.prototype.getTimelineSet=function(){return this._eventTimelineSet},i.prototype.getBaseIndex=function(){return this._baseIndex},i.prototype.getEvents=function(){return this._events},i.prototype.getState=function(e){if(e==i.BACKWARDS)return this._startState;if(e==i.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},i.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},i.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},i.prototype.getNeighbouringTimeline=function(e){if(e==i.BACKWARDS)return this._prevTimeline;if(e==i.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},i.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==i.BACKWARDS)this._prevTimeline=e;else{if(t!=i.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},i.prototype.addEvent=function(e,t){var r,n=t?this._startState:this._endState,o=this.getTimelineSet();o.room&&o.room.getUnfilteredTimelineSet()===o&&(i.setEventMetadata(e,n,t),e.isState()&&(n.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||i.setEventMetadata(e,n,t))),r=t?0:this._events.length,this._events.splice(r,0,e),t&&this._baseIndex++},i.setEventMetadata=function(e,t,r){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)},i.prototype.removeEvent=function(e){for(var t=this._events.length-1;t>=0;t--){var r=this._events[t];if(r.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,r}return null},i.prototype.toString=function(){return this._name}},{"./room-state":98}],94:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixEvent=r.EventStatus=void 0;var o=i(e("@babel/runtime/regenerator")),s=e("events"),a=n(e("../utils")),u=e("../logger");r.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};var c={};function l(e){return c[e]||(c[e]=e),c[e]}var d=function(e){["state_key","type","sender","room_id","membership"].forEach((function(t){e[t]&&(e[t]=l(e[t]))})),["membership","avatar_url","displayname"].forEach((function(t){e.content&&e.content[t]&&(e.content[t]=l(e.content[t]))})),["rel_type"].forEach((function(t){e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=l(e.content["m.relates_to"][t]))})),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._decryptionPromise=null,this._retryDecryption=!1,this.verificationRequest=null};r.MatrixEvent=d,a.inherits(d,s.EventEmitter),a.extend(d.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getLocalAge:function(){return Date.now()-this.getTs()},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,r,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=r,this._claimedEd25519Key=n},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},attemptDecryption:function(e){return o.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isEncrypted()){t.next=2;break}throw new Error("Attempt to decrypt event which isn't encrypted");case 2:if(!this._clearEvent||!this._clearEvent.content||"m.bad.encrypted"===this._clearEvent.content.msgtype){t.next=4;break}throw new Error("Attempt to decrypt event which has already been encrypted");case 4:if(!this._decryptionPromise){t.next=8;break}return u.logger.log("Event ".concat(this.getId()," already being decrypted; queueing a retry")),this._retryDecryption=!0,t.abrupt("return",this._decryptionPromise);case 8:return this._decryptionPromise=this._decryptionLoop(e),t.abrupt("return",this._decryptionPromise);case 10:case"end":return t.stop()}}),null,this)},cancelAndResendKeyRequest:function(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){var t=this.getWireContent(),r=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&r.push({userId:n,deviceId:t.device_id}),r},_decryptionLoop:function(e){var t,r;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(Promise.resolve());case 2:if(this._retryDecryption=!1,t=void 0,r=void 0,n.prev=6,e){n.next=11;break}t=this._badEncryptedMessage("Encryption not enabled"),n.next=14;break;case 11:return n.next=13,o.default.awrap(e.decryptEvent(this));case 13:t=n.sent;case 14:n.next=29;break;case 16:if(n.prev=16,n.t0=n.catch(6),"DecryptionError"===n.t0.name){n.next=23;break}return u.logger.error("Error decrypting event (id=".concat(this.getId(),"): ").concat(n.t0.stack||n.t0)),this._decryptionPromise=null,this._retryDecryption=!1,n.abrupt("return");case 23:if(r=n.t0,!this._retryDecryption){n.next=27;break}return u.logger.log("Got error decrypting event (id=".concat(this.getId(),": ")+"".concat(n.t0,"), but retrying")),n.abrupt("continue",2);case 27:u.logger.warn("Error decrypting event (id=".concat(this.getId(),"): ").concat(n.t0.detailedString)),t=this._badEncryptedMessage(n.t0.message);case 29:return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(t),this.setPushActions(null),this.emit("Event.decrypted",this,r),n.abrupt("return");case 37:case"end":return n.stop()}}),null,this,[[6,16]])},_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[]},getClearContent:function(){var e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");var t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(h[t]||delete this.event[t]);var r=p[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(r[t]||delete n[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){var t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit("Event.localEventIdReplaced",this)},isSending:function(){return!!this.status},setStatus:function(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId:function(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=this.getWireContent(),r=t&&t["m.relates_to"];return r&&r.rel_type&&r.event_id&&(e&&r.rel_type===e||!e)},getRelation:function(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced:function(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus:function(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation:function(e){var t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId:function(){var e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent:function(){return this._replacingEvent},replacingEventDate:function(){var e=this.getServerAggregatedRelation("m.replace");if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent:function(){return this._localRedactionEvent},getAssociatedId:function(){var e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation:function(){return!!this.getAssociatedId()},updateAssociatedId:function(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e},isCancelled:function(){return this._isCancelled},toJSON:function(){var e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e},setVerificationRequest:function(e){this.verificationRequest=e}});var h=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),p={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},{"../logger":89,"../utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23,events:32}],95:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.Group=s;var i=n(e("../utils")),o=e("events");function s(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}i.inherits(s,o.EventEmitter),s.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},s.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},s.prototype.setInviter=function(e){this.inviter=e}},{"../utils":117,"@babel/runtime/helpers/interopRequireWildcard":11,events:32}],96:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.Relations=void 0;var i=n(e("@babel/runtime/helpers/toConsumableArray")),o=n(e("@babel/runtime/helpers/classCallCheck")),s=n(e("@babel/runtime/helpers/createClass")),a=n(e("@babel/runtime/helpers/possibleConstructorReturn")),u=n(e("@babel/runtime/helpers/getPrototypeOf")),c=n(e("@babel/runtime/helpers/assertThisInitialized")),l=n(e("@babel/runtime/helpers/inherits")),d=n(e("@babel/runtime/helpers/defineProperty")),h=e("events"),p=e("../models/event"),f=function(e){function t(e,r,n){var i;return(0,o.default)(this,t),i=(0,a.default)(this,(0,u.default)(t).call(this)),(0,d.default)((0,c.default)(i),"_onEventStatus",(function(e,t){e.isSending()?t===p.EventStatus.CANCELLED&&(e.removeListener("Event.status",i._onEventStatus),i._removeEvent(e)):e.removeListener("Event.status",i._onEventStatus)})),(0,d.default)((0,c.default)(i),"_onBeforeRedaction",(function(e){i._relations.has(e)&&(i._relations.delete(e),"m.annotation"===i.relationType?i._removeAnnotationFromAggregation(e):"m.replace"===i.relationType&&i._targetEvent&&i._targetEvent.makeReplaced(i.getLastReplacement()),e.removeListener("Event.beforeRedaction",i._onBeforeRedaction),i.emit("Relations.redaction",e))})),i.relationType=e,i.eventType=r,i._relations=new Set,i._annotationsByKey={},i._annotationsBySender={},i._sortedAnnotationsByKey=[],i._targetEvent=null,i}return(0,l.default)(t,e),(0,s.default)(t,[{key:"addEvent",value:function(e){if(!this._relations.has(e)){var t=e.getRelation();if(t){var r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(e.isSending()&&e.on("Event.status",this._onEventStatus),this._relations.add(e),"m.annotation"===this.relationType?this._addAnnotationToAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",e)):console.error("Event relation info doesn't match this container")}else console.error("Event must have relation info")}}},{key:"_removeEvent",value:function(e){if(this._relations.has(e)){var t=e.getRelation();if(t){var r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),this.emit("Relations.remove",e)):console.error("Event relation info doesn't match this container")}else console.error("Event must have relation info")}}},{key:"getRelations",value:function(){return(0,i.default)(this._relations)}},{key:"_addAnnotationToAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r||(r=this._annotationsByKey[t]=new Set,this._sortedAnnotationsByKey.push([t,r])),r.add(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size}));var n=e.getSender(),i=this._annotationsBySender[n];i||(i=this._annotationsBySender[n]=new Set),i.add(e)}}},{key:"_removeAnnotationFromAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r&&(r.delete(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size})));var n=e.getSender(),i=this._annotationsBySender[n];i&&i.delete(e)}}},{key:"getSortedAnnotationsByKey",value:function(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}},{key:"getAnnotationsBySender",value:function(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}},{key:"getLastReplacement",value:function(){var e=this;if("m.replace"!==this.relationType)return null;if(!this._targetEvent)return null;var t=this._targetEvent.getServerAggregatedRelation("m.replace"),r=t&&t.origin_server_ts;return this.getRelations().reduce((function(t,n){return n.getSender()!==e._targetEvent.getSender()?t:r&&r>n.getTs()?t:t&&t.getTs()>n.getTs()?t:n}),null)}},{key:"setTargetEvent",value:function(e){if(!this._targetEvent&&(this._targetEvent=e,"m.replace"===this.relationType)){var t=this.getLastReplacement();t&&this._targetEvent.makeReplaced(t)}}}]),t}(h.EventEmitter);r.Relations=f},{"../models/event":94,"@babel/runtime/helpers/assertThisInitialized":3,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/defineProperty":7,"@babel/runtime/helpers/getPrototypeOf":8,"@babel/runtime/helpers/inherits":9,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/possibleConstructorReturn":17,"@babel/runtime/helpers/toConsumableArray":20,events:32}],97:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomMember=a;var i=e("events"),o=e("../content-repo"),s=n(e("../utils"));function a(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime()}s.inherits(a,i.EventEmitter),a.prototype.markOutOfBand=function(){this._isOutOfBand=!0},a.prototype.isOutOfBand=function(){return this._isOutOfBand},a.prototype.setMembershipEvent=function(e,t){if("m.room.member"===e.getType()){this._isOutOfBand=!1,this.events.member=e;var r=this.membership;this.membership=e.getDirectionalContent().membership;var n=this.name;this.name=function(e,t,r){if(!t||t===e)return e;if(!s.removeHiddenChars(t))return e;if(!r)return t;var n=/@.+:.+/.test(t);n||(n=/[\u200E\u200F\u202A-\u202F]/.test(t));if(!n){var i=r.getUserIdsWithDisplayName(t);n=i.some((function(t){return t!==e}))}if(n)return t+" ("+e+")";return t}(this.userId,e.getDirectionalContent().displayname,t),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,r!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,r)),n!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,n))}},a.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"===e.getType()){var t=e.getDirectionalContent(),r=t.users_default||0;s.forEach(s.values(t.users),(function(e){r=Math.max(r,e)}));var n=this.powerLevel,i=this.powerLevelNorm;t.users&&void 0!==t.users[this.userId]?this.powerLevel=t.users[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),n===this.powerLevel&&i===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}},a.prototype.setTypingEvent=function(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;s.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}},a.prototype._updateModifiedTime=function(){this._modified=Date.now()},a.prototype.getLastModifiedTime=function(){return this._modified},a.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},a.prototype.getDMInviter=function(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return r}},a.prototype.getAvatarUrl=function(e,t,r,n,i,s){void 0===i&&(i=!0);var a=this.getMxcAvatarUrl();if(!a&&!i)return null;var u=(0,o.getHttpUriForMxc)(e,a,t,r,n,s);return u||(i?(0,o.getIdenticonUri)(e,this.userId,t,r):null)},a.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}},{"../content-repo":55,"../utils":117,"@babel/runtime/helpers/interopRequireWildcard":11,events:32}],98:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomState=c;var i=e("events"),o=e("./room-member"),s=e("../logger"),a=n(e("../utils")),u=1;function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.roomId=e,this.members={},this.events={},this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:u}),this._oobMemberFlags=t}function l(e,t,r){var n=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],n){var i=a.removeHiddenChars(n),o=e._displayNameToUserIds[i];if(o){var s=o.filter((function(e){return e!==t}));e._displayNameToUserIds[i]=s}}e._userIdsToDisplayNames[t]=r;var u=r&&a.removeHiddenChars(r);u&&(e._displayNameToUserIds[u]||(e._displayNameToUserIds[u]=[]),e._displayNameToUserIds[u].push(t))}a.inherits(c,i.EventEmitter),c.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((function(e,t){return"join"===t.membership?e+1:e}),0)),this._joinedMemberCount)},c.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},c.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((function(e,t){return"invite"===t.membership?e+1:e}),0)),this._invitedMemberCount)},c.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},c.prototype.getMembers=function(){return a.values(this.members)},c.prototype.getMembersExcept=function(e){return a.values(this.members).filter((function(t){return!e.includes(t.userId)}))},c.prototype.getMember=function(e){return this.members[e]||null},c.prototype.getSentinelMember=function(e){if(!e)return null;var t=this._sentinels[e];if(void 0===t){t=new o.RoomMember(this.roomId,e);var r=this.members[e];r&&t.setMembershipEvent(r.events.member,this),this._sentinels[e]=t}return t},c.prototype.getStateEvents=function(e,t){if(!this.events[e])return void 0===t?[]:null;if(void 0===t)return a.values(this.events[e]);var r=this.events[e][t];return r||null},c.prototype.clone=function(){var e=new c(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=u,Object.values(this.events).forEach((function(t){var r=Object.values(t);e.setStateEvents(r)})),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach((function(t){t.isOutOfBand()&&e.getMember(t.userId).markOutOfBand()})),e},c.prototype.setUnknownStateEvents=function(e){var t=this,r=e.filter((function(e){return void 0===t.events[e.getType()]||void 0===t.events[e.getType()][e.getStateKey()]}));this.setStateEvents(r)},c.prototype.setStateEvents=function(e){var t=this;this._updateModifiedTime(),a.forEach(e,(function(e){e.getRoomId()===t.roomId&&e.isState()&&(t._setStateEvent(e),"m.room.member"===e.getType()&&(l(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;var r=(t.getContent().third_party_invite.signed||{}).token;if(!r)return;if(!e.getStateEvents("m.room.third_party_invite",r))return;e._tokenToInvite[r]=t}(t,e)),t.emit("RoomState.events",e,t))})),a.forEach(e,(function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){var r=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=t._getOrCreateMember(r,e);n.setMembershipEvent(e,t),t._updateMember(n),t.emit("RoomState.members",e,t,n)}else if("m.room.power_levels"===e.getType()){var i=a.values(t.members);a.forEach(i,(function(r){r.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,r)})),t._sentinels={}}}))},c.prototype._getOrCreateMember=function(e,t){var r=this.members[e];return r||(r=new o.RoomMember(this.roomId,e),this.members[e]=r,this.emit("RoomState.newMember",t,this,r)),r},c.prototype._setStateEvent=function(e){void 0===this.events[e.getType()]&&(this.events[e.getType()]={}),this.events[e.getType()][e.getStateKey()]=e},c.prototype._updateMember=function(e){var t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},c.prototype.needsOutOfBandMembers=function(){return this._oobMemberFlags.status===u},c.prototype.markOutOfBandMembersStarted=function(){this._oobMemberFlags.status===u&&(this._oobMemberFlags.status=2)},c.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=u)},c.prototype.clearOutOfBandMembers=function(){var e=this,t=0;Object.keys(this.members).forEach((function(r){e.members[r].isOutOfBand()&&(++t,delete e.members[r])})),s.logger.log("LL: RoomState removed ".concat(t," members...")),this._oobMemberFlags.status=u},c.prototype.setOutOfBandMembers=function(e){var t=this;s.logger.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),2===this._oobMemberFlags.status&&(s.logger.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach((function(e){return t._setOutOfBandMember(e)})))},c.prototype._setOutOfBandMember=function(e){if("m.room.member"===e.getType()){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this._getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),l(this,n.userId,n.name),this._setStateEvent(e),this._updateMember(n),this.emit("RoomState.members",e,this,n)}}},c.prototype.setTypingEvent=function(e){a.forEach(a.values(this.members),(function(t){t.setTypingEvent(e)}))},c.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},c.prototype._updateModifiedTime=function(){this._modified=Date.now()},c.prototype.getLastModifiedTime=function(){return this._modified},c.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[a.removeHiddenChars(e)]||[]},c.prototype.maySendRedactionForEvent=function(e,t){var r=this.getMember(t);if(!r||"leave"===r.membership)return!1;if(e.status||e.isRedacted())return!1;var n=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?n:this._hasSufficientPowerLevelFor("redact",r.powerLevel)},c.prototype._hasSufficientPowerLevelFor=function(e,t){var r=this.getStateEvents("m.room.power_levels",""),n={};r&&(n=r.getContent());var i=50;return a.isNumber(n[e])&&(i=n[e]),t>=i},c.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},c.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},c.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},c.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},c.prototype._maySendEventOfType=function(e,t,r){var n,i=this.getStateEvents("m.room.power_levels",""),o={},s=0,a=0,u=0;if(i){o=(n=i.getContent()).events||{},s=Number.isFinite(n.state_default)?n.state_default:50;var c=n.users&&n.users[t];Number.isFinite(c)?u=c:Number.isFinite(n.users_default)&&(u=n.users_default),Number.isFinite(n.events_default)&&(a=n.events_default)}var l=r?s:a;return Number.isFinite(o[e])&&(l=o[e]),u>=l},c.prototype.mayTriggerNotifOfType=function(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents("m.room.power_levels",""),i=50;return n&&n.getContent()&&n.getContent().notifications&&a.isNumber(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i}},{"../logger":89,"../utils":117,"./room-member":97,"@babel/runtime/helpers/interopRequireWildcard":11,events:32}],99:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.RoomSummary=function(e,t){this.roomId=e,this.info=t}},{}],100:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.Room=_;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/regenerator")),a=e("events"),u=e("./event-timeline-set"),c=e("./event-timeline"),l=e("../content-repo"),d=n(e("../utils")),h=e("./event"),p=e("./room-member"),f=e("./room-summary"),v=e("../logger"),g=e("../ReEmitter"),m=["1","2","3","4","5"];function y(e,t,r){var n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][r]={},n.content[t.getId()][r][e]={ts:t.getTs()},new h.MatrixEvent(n)}function _(e,t,r,n){if((n=n||{}).pendingEventOrdering=n.pendingEventOrdering||"chronological",this.reEmitter=new g.ReEmitter(this),-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");this.myUserId=r,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=n.storageToken,this._opts=n,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new u.EventTimelineSet(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._client=t,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=Promise.resolve()}d.inherits(_,a.EventEmitter),_.prototype.getVersion=function(){var e=this.currentState.getStateEvents("m.room.create","");if(!e)return v.logger.warn("Room "+this.room_id+" does not have an m.room.create event"),"1";var t=e.getContent().room_version;return void 0===t?"1":t},_.prototype.shouldUpgradeToVersion=function(){return m.includes(this.getVersion())?null:"5"},_.prototype.getRecommendedVersion=function(){var e,t,r,n,i,o,a,u,c,l;return s.default.async((function(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,s.default.awrap(this._client.getCapabilities());case 2:if(e=d.sent,t=e["m.room_versions"]){d.next=25;break}for(t={default:"5",available:{}},r=!0,n=!1,i=void 0,d.prev=9,o=m[Symbol.iterator]();!(r=(a=o.next()).done);r=!0)u=a.value,t.available[u]="stable";d.next=17;break;case 13:d.prev=13,d.t0=d.catch(9),n=!0,i=d.t0;case 17:d.prev=17,d.prev=18,r||null==o.return||o.return();case 20:if(d.prev=20,!n){d.next=23;break}throw i;case 23:return d.finish(20);case 24:return d.finish(17);case 25:if(!(c=this._checkVersionAgainstCapability(t)).urgent||!c.needsUpgrade){d.next=38;break}return v.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),d.next=30,s.default.awrap(this._client.getCapabilities(!0));case 30:if(l=d.sent,t=l["m.room_versions"]){d.next=37;break}return v.logger.warn("No room version capability - assuming upgrade required."),d.abrupt("return",c);case 37:c=this._checkVersionAgainstCapability(t);case 38:return d.abrupt("return",c);case 39:case"end":return d.stop()}}),null,this,[[9,13,17,25],[18,,20,24]])},_.prototype._checkVersionAgainstCapability=function(e){var t=this.getVersion();v.logger.log("[".concat(this.roomId,"] Current version: ").concat(t)),v.logger.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default?r:Object.keys(e.available).filter((function(t){return"stable"===e.available[t]})).includes(t)?r:(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?v.logger.warn("URGENT upgrade required on ".concat(this.roomId)):v.logger.warn("Non-urgent upgrade required on ".concat(this.roomId)),r)},_.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},_.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},_.prototype.hasPendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call hasPendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList.some((function(t){return t.getId()===e}))},_.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},_.prototype.getLastActiveTimestamp=function(){var e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER},_.prototype.getMyMembership=function(){return this._selfMembership},_.prototype.getDMInviter=function(){if(this.myUserId){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership&&(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length))return this._summaryHeroes[0]},_.prototype.guessDMUserId=function(){var e=this,t=this.getMember(this.myUserId);if(t){var r=t.getDMInviter();if(r)return r}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];var n=this.currentState.getMembers().find((function(t){return t.userId!==e.myUserId}));return n?n.userId:this.myUserId},_.prototype.getAvatarFallbackMember=function(){var e=this;if(!(this.getInvitedAndJoinedMemberCount()>2)){var t=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(t){var r=this._summaryHeroes.map((function(t){return e.getMember(t)})).find((function(e){return!!e}));if(r)return r}var n=this.currentState.getMembers();if(n.length<=2){var i=n.find((function(t){return t.userId!==e.myUserId}));if(i)return i}if(t){var o=this._summaryHeroes.map((function(t){return e._client.getUser(t)})).find((function(e){return!!e}));if(o){var s=new p.RoomMember(this.roomId,o.userId);return s.user=o,s}}}},_.prototype.updateMyMembership=function(e){var t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},_.prototype._loadMembersFromServer=function(){var e,t,r,n,i;return s.default.async((function(o){for(;;)switch(o.prev=o.next){case 0:return e=this._client.store.getSyncToken(),t=d.encodeParams({not_membership:"leave",at:e}),r=d.encodeUri("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),n=this._client._http,o.next=6,s.default.awrap(n.authedRequest(void 0,"GET",r));case 6:return i=o.sent,o.abrupt("return",i.chunk);case 8:case"end":return o.stop()}}),null,this)},_.prototype._loadMembers=function(){var e,t,r;return s.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e=!1,n.next=3,s.default.awrap(this._client.store.getOutOfBandMembers(this.roomId));case 3:if(null!==(t=n.sent)){n.next=10;break}return e=!0,n.next=8,s.default.awrap(this._loadMembersFromServer());case 8:t=n.sent,v.logger.log("LL: got ".concat(t.length," ")+"members from server for room ".concat(this.roomId));case 10:return r=t.map(this._client.getEventMapper()),n.abrupt("return",{memberEvents:r,fromServer:e});case 12:case"end":return n.stop()}}),null,this)},_.prototype.loadMembersIfNeeded=function(){var e=this;if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();var t=this._loadMembers().then((function(t){return e.currentState.setOutOfBandMembers(t.memberEvents),e._client.isCryptoEnabled()&&e._client.isRoomEncrypted(e.roomId)&&e._client._crypto.trackRoomDevices(e.roomId),t.fromServer})).catch((function(t){throw e._membersPromise=null,e.currentState.markOutOfBandMembersFailed(),t}));return t.then((function(t){if(t){var r=e.currentState.getMembers().filter((function(e){return e.isOutOfBand()})).map((function(e){return e.events.member.event}));return v.logger.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(e.roomId)),e._client.store.setOutOfBandMembers(e.roomId,r).catch((function(e){v.logger.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((function(e){v.logger.error(e)})),this._membersPromise=t,this._membersPromise},_.prototype.clearLoadedMembersIfNeeded=function(){return s.default.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._opts.lazyLoadMembers||!this._membersPromise){e.next=7;break}return e.next=3,s.default.awrap(this.loadMembersIfNeeded());case 3:return e.next=5,s.default.awrap(this._client.store.clearOutOfBandMembers(this.roomId));case 5:this.currentState.clearOutOfBandMembers(),this._membersPromise=null;case 7:case"end":return e.stop()}}),null,this)},_.prototype._cleanupAfterLeaving=function(){var e=this;this.clearLoadedMembersIfNeeded().catch((function(t){v.logger.error("error after clearing loaded members from "+"room ".concat(e.roomId," after leaving")),v.logger.log(t)}))},_.prototype.resetLiveTimeline=function(e,t){for(var r=0;r<this._timelineSets.length;r++)this._timelineSets[r].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},_.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(c.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(c.EventTimeline.FORWARDS)},_.prototype.hasUnverifiedDevices=function(){var e,t,r,n,i,o,a;return s.default.async((function(u){for(;;)switch(u.prev=u.next){case 0:if(this._client.isRoomEncrypted(this.roomId)){u.next=2;break}return u.abrupt("return",!1);case 2:return u.next=4,s.default.awrap(this.getEncryptionTargetMembers());case 4:e=u.sent,t=!0,r=!1,n=void 0,u.prev=8,i=e[Symbol.iterator]();case 10:if(t=(o=i.next()).done){u.next=20;break}return a=o.value,u.next=14,s.default.awrap(this._client.getStoredDevicesForUser(a.userId));case 14:if(!u.sent.some((function(e){return e.isUnverified()}))){u.next=17;break}return u.abrupt("return",!0);case 17:t=!0,u.next=10;break;case 20:u.next=26;break;case 22:u.prev=22,u.t0=u.catch(8),r=!0,n=u.t0;case 26:u.prev=26,u.prev=27,t||null==i.return||i.return();case 29:if(u.prev=29,!r){u.next=32;break}throw n;case 32:return u.finish(29);case 33:return u.finish(26);case 34:return u.abrupt("return",!1);case 35:case"end":return u.stop()}}),null,this,[[8,22,26,34],[27,,29,33]])},_.prototype.getTimelineSets=function(){return this._timelineSets},_.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},_.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},_.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},_.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},_.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},_.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},_.prototype.setSummary=function(e){var t=this,r=e["m.heroes"],n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(r)&&(this._summaryHeroes=r.filter((function(e){return e!==t.myUserId})))},_.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},_.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},_.prototype.getAvatarUrl=function(e,t,r,n,i){var o=this.currentState.getStateEvents("m.room.avatar","");if(void 0===i&&(i=!0),!o&&!i)return null;var s=o?o.getContent().url:null;return s?(0,l.getHttpUriForMxc)(e,s,t,r,n):i?(0,l.getIdenticonUri)(e,this.roomId,t,r):null},_.prototype.getAliases=function(){var e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(var r=function(r){var n=t[r];if(d.isArray(n.getContent().aliases)){var i=n.getContent().aliases.filter((function(e){return"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":".concat(n.getStateKey())))}));Array.prototype.push.apply(e,i)}},n=0;n<t.length;++n)r(n);return e},_.prototype.getCanonicalAlias=function(){var e=this.currentState.getStateEvents("m.room.canonical_alias","");return e?e.getContent().alias:null},_.prototype.addEventsToTimeline=function(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)},_.prototype.getMember=function(e){return this.currentState.getMember(e)},_.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},_.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},_.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},_.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},_.prototype.getMembersWithMembership=function(e){return d.filter(this.currentState.getMembers(),(function(t){return t.membership===e}))},_.prototype.getEncryptionTargetMembers=function(){var e;return s.default.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s.default.awrap(this.loadMembersIfNeeded());case 2:return e=this.getMembersWithMembership("join"),this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),t.abrupt("return",e);case 5:case"end":return t.stop()}}),null,this)},_.prototype.shouldEncryptForInvitedMembers=function(){var e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},_.prototype.getDefaultRoomName=function(e){return S(this,e,!0)},_.prototype.hasMembershipState=function(e,t){var r=this.getMember(e);return!!r&&r.membership===t},_.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];var t=Object.assign({filter:e},this._opts),r=new u.EventTimelineSet(this,t);this.reEmitter.reEmit(r,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=r,this._timelineSets.push(r);var n=this.getLiveTimeline();n.getEvents().forEach((function(e){r.addLiveEvent(e)}));for(var i=n;i.getNeighbouringTimeline(c.EventTimeline.BACKWARDS);)i=i.getNeighbouringTimeline(c.EventTimeline.BACKWARDS);return r.getLiveTimeline().setPaginationToken(i.getPaginationToken(c.EventTimeline.BACKWARDS),c.EventTimeline.BACKWARDS),r},_.prototype.removeFilteredTimelineSet=function(e){var t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];var r=this._timelineSets.indexOf(t);r>-1&&this._timelineSets.splice(r,1)},_.prototype._addLiveEvent=function(e,t,r){if(e.isRedaction()){var n=e.event.redacts,i=this.getUnfilteredTimelineSet().findEventById(n);if(i){if(i.makeRedacted(e),i.getStateKey())this.currentState.getStateEvents(i.getType(),i.getStateKey()).getId()===i.getId()&&this.currentState.setStateEvents([i]);this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){var o=this._txnToEvent[e.getUnsigned().transaction_id];if(o)return void this._handleRemoteEcho(e,o)}for(var s=0;s<this._timelineSets.length;s++)this._timelineSets[s].addLiveEvent(e,t,r);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(y(e.sender.userId,e,"m.read"),!0)},_.prototype.addPendingEvent=function(e,t){if(e.status!==h.EventStatus.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(c.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(c.EventTimeline.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some((function(e){return e.status===h.EventStatus.NOT_SENT}))&&(v.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(h.EventStatus.NOT_SENT)),this._pendingEventList.push(e),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this._pendingEventList&&this._pendingEventList.find((function(e){return e.getId()===r}));n||(n=this.getUnfilteredTimelineSet().findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(var i=0;i<this._timelineSets.length;i++){var o=this._timelineSets[i];o.getFilter()?o.getFilter().filterRoomTimeline([e]).length&&o.addEventToTimeline(e,o.getLiveTimeline(),!1):o.addEventToTimeline(e,o.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},_.prototype._aggregateNonLiveRelation=function(e){for(var t=0;t<this._timelineSets.length;t++){var r=this._timelineSets[t];r.getFilter()?r.getFilter().filterRoomTimeline([e]).length&&r.aggregateRelations(e):r.aggregateRelations(e)}},_.prototype._handleRemoteEcho=function(e,t){var r=t.getId(),n=e.getId(),i=t.status;delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&d.removeElement(this._pendingEventList,(function(e){return e.getId()==r}),!1),t.handleRemoteEcho(e.event);for(var o=0;o<this._timelineSets.length;o++){this._timelineSets[o].handleRemoteEcho(t,r,n)}this.emit("Room.localEchoUpdated",t,this,r,i)};var b={};function S(e,t,r){if(!r){var n=e.currentState.getStateEvents("m.room.name","");if(n&&n.getContent()&&n.getContent().name)return n.getContent().name}var i=e.getCanonicalAlias();if(!i){var o=e.getAliases();o.length&&(i=o[0])}if(i)return i;var s=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1,a=null;if(e._summaryHeroes)a=e._summaryHeroes.map((function(t){var r=e.getMember(t);return r?r.name:t}));else{var u=e.currentState.getMembers().filter((function(e){return e.userId!==t&&("invite"===e.membership||"join"===e.membership)}));u.sort((function(e,t){return e.userId.localeCompare(t.userId)})),a=(u=u.slice(0,5)).map((function(e){return e.name}))}if(s)return k(a,s);if("join"==e.getMyMembership()){var c=e.currentState.getStateEvents("m.room.third_party_invite");if(c&&c.length){var l=c.map((function(e){return e.getContent().display_name}));return"Inviting ".concat(k(l))}}var d=a;return d.length||(d=e.currentState.getMembers().filter((function(e){return e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership})).map((function(e){return e.name}))),d.length?"Empty room (was ".concat(k(d),")"):"Empty room"}function k(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length+1)-1;return e.length?1===e.length&&t<=1?e[0]:2===e.length&&t<=2?"".concat(e[0]," and ").concat(e[1]):t>1?"".concat(e[0]," and ").concat(t," others"):"".concat(e[0]," and 1 other"):"Empty room"}b[h.EventStatus.ENCRYPTING]=[h.EventStatus.SENDING,h.EventStatus.NOT_SENT],b[h.EventStatus.SENDING]=[h.EventStatus.ENCRYPTING,h.EventStatus.QUEUED,h.EventStatus.NOT_SENT,h.EventStatus.SENT],b[h.EventStatus.QUEUED]=[h.EventStatus.SENDING,h.EventStatus.CANCELLED],b[h.EventStatus.SENT]=[],b[h.EventStatus.NOT_SENT]=[h.EventStatus.SENDING,h.EventStatus.QUEUED,h.EventStatus.CANCELLED],b[h.EventStatus.CANCELLED]=[],_.prototype.updatePendingEvent=function(e,t,r){if(v.logger.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId())),t==h.EventStatus.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==h.EventStatus.SENT&&this.getUnfilteredTimelineSet().eventIdToTimeline(r))return;var n=e.status,i=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var s=b[n];if(!s||s.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==h.EventStatus.SENT){e.replaceLocalEventId(r);for(var a=0;a<this._timelineSets.length;a++)this._timelineSets[a].replaceEventId(i,r)}else if(t==h.EventStatus.CANCELLED){if(this._pendingEventList){var u=this._pendingEventList.findIndex((function(e){return e.getId()===i}));if(-1!==u){var c=this._pendingEventList.splice(u,1),l=(0,o.default)(c,1)[0];l.isRedaction()&&this._revertRedactionLocalEcho(l)}}this.removeEvent(i)}this.emit("Room.localEchoUpdated",e,this,i,n)},_.prototype._revertRedactionLocalEcho=function(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),r.isRelation()&&this._aggregateNonLiveRelation(r))}},_.prototype.addLiveEvents=function(e,t,r){var n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){var i=this._timelineSets[n].getLiveTimeline();if(i.getPaginationToken(c.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+i.getPaginationToken(c.EventTimeline.FORWARDS)+")");if(i.getNeighbouringTimeline(c.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this._addLiveEvent(e[n],t,r)},_.prototype.addEphemeralEvents=function(e){var t=!0,r=!1,n=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;"m.typing"===s.getType()?this.currentState.setTypingEvent(s):"m.receipt"===s.getType()&&this.addReceipt(s)}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}},_.prototype.removeEvents=function(e){for(var t=0;t<e.length;++t)this.removeEvent(e[t])},_.prototype.removeEvent=function(e){for(var t=!1,r=0;r<this._timelineSets.length;r++){var n=this._timelineSets[r].removeEvent(e);n&&(n.isRedaction()&&this._revertRedactionLocalEcho(n),t=!0)}return t},_.prototype.recalculate=function(){var e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);if(t&&"invite"===t.getContent().membership){var r=t.event.invite_room_state||[];d.forEach(r,(function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new h.MatrixEvent({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}))}var n=this.name;this.name=S(this,this.myUserId),this.summary=new f.RoomSummary(this.roomId,{title:this.name}),n!==this.name&&this.emit("Room.name",this)},_.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},_.prototype.getEventReadUpTo=function(e,t){var r=this._receipts;return t&&(r=this._realReceipts),void 0===r["m.read"]||void 0===r["m.read"][e]?null:r["m.read"][e].eventId},_.prototype.hasUserReadEvent=function(e,t){var r=this.getEventReadUpTo(e,!1);if(r===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(var n=this.timeline.length-1;n>=0;--n){var i=this.timeline[n];if(i.getId()===t)return!1;if(i.getId()===r)return!0}return!1},_.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},_.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},_.prototype._addReceiptsToStructure=function(e,t){var r=this;d.keys(e.getContent()).forEach((function(n){d.keys(e.getContent()[n]).forEach((function(i){d.keys(e.getContent()[n][i]).forEach((function(o){var s=e.getContent()[n][i][o];t[i]||(t[i]={});var a=t[i][o];if(a){var u=r.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,n);if(null!==u&&u>=0)return}else t[i][o]={};t[i][o]={eventId:n,data:s}}))}))}))},_.prototype._buildReceiptCache=function(e){var t={};return d.keys(e).forEach((function(r){d.keys(e[r]).forEach((function(n){var i=e[r][n];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:n,type:r,data:i.data})}))})),t},_.prototype._addLocalEchoReceipt=function(e,t,r){this.addReceipt(y(e,t,r),!0)},_.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},_.prototype.addAccountData=function(e){for(var t=0;t<e.length;t++){var r=e[t];"m.tag"===r.getType()&&this.addTags(r),this.accountData[r.getType()]=r,this.emit("Room.accountData",r,this)}},_.prototype.getAccountData=function(e){return this.accountData[e]},_.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)}},{"../ReEmitter":49,"../content-repo":55,"../logger":89,"../utils":117,"./event":94,"./event-timeline":93,"./event-timeline-set":92,"./room-member":97,"./room-summary":99,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,events:32}],101:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.SearchResult=s;var i=n(e("../utils")),o=e("./event-context");function s(e,t){this.rank=e,this.context=t}s.fromJson=function(e,t){var r=e.context||{},n=r.events_before||[],a=r.events_after||[],u=new o.EventContext(t(e.result));return u.setPaginateToken(r.start,!0),u.addEvents(i.map(n,t),!0),u.addEvents(i.map(a,t),!1),u.setPaginateToken(r.end,!1),new s(e.rank,u)}},{"../utils":117,"./event-context":91,"@babel/runtime/helpers/interopRequireWildcard":11}],102:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.User=s;var i=n(e("../utils")),o=e("events");function s(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}i.inherits(s,o.EventEmitter),s.prototype.setPresenceEvent=function(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push("User.currentlyActive"),this.presence=e.getContent().presence,r.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(var n=0;n<r.length;n++)this.emit(r[n],e,this)}},s.prototype.setDisplayName=function(e){var t=this.displayName;this.displayName=e,e!==t&&this._updateModifiedTime()},s.prototype.setRawDisplayName=function(e){this.rawDisplayName=e},s.prototype.setAvatarUrl=function(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},s.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},{"../utils":117,"@babel/runtime/helpers/interopRequireWildcard":11,events:32}],103:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.PushProcessor=u;var i=n(e("@babel/runtime/helpers/typeof")),o=e("./utils"),s=["override","content","room","sender","underride"],a=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function u(e){var t=this,r={},n=function(e,r,n){for(var o=0;o<s.length;++o)for(var a=s[o],u=r[a],c=0;c<u.length;++c){var l=u[c];if(l.enabled){var d=i(a,l,n);if(d&&t.ruleMatchesEvent(d,e))return l.kind=a,l}}return null},i=function(e,t,r){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":n.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;n.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return r&&n.conditions.push({kind:"device",profile_tag:r}),n},c=function(e,t){var r={event_match:f,device:p,contains_display_name:h,room_member_count:d,sender_notification_permission:l};return!!r[e.kind]&&r[e.kind](e,t)},l=function(t,r){var n=t.key;if(!n)return!1;var i=e.getRoom(r.getRoomId());return!(!i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,r.getSender())},d=function(t,r){if(!t.is)return!1;var n=e.getRoom(r.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;var s=o[1],a=parseInt(o[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return i==a;case"<":return i<a;case">":return i>a;case"<=":return i<=a;case">=":return i>=a;default:return!1}},h=function(t,r){var n=r.getContent();if(r.isEncrypted()&&r.getClearContent()&&(n=r.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var i=e.getRoom(r.getRoomId());if(!(i&&i.currentState&&i.currentState.members&&i.currentState.getMember(e.credentials.userId)))return!1;var s=i.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+(0,o.escapeRegExp)(s)+"(\\W|$)","i");return n.body.search(a)>-1},p=function(e,t){return!1},f=function(e,t){if(!e.key)return!1;var r,n=g(e.key,t);return"string"==typeof n&&(e.value?e.value===n:(r="content.body"==e.key?v("(^|\\W)",e.pattern,"(\\W|$)"):v("^",e.pattern,"$"),!!n.match(r)))},v=function(e,t,n){return r[t]?r[t]:(r[t]=new RegExp(e+(0,o.globToRegexp)(t)+n,"i"),r[t])},g=function(e,t){var r,n=e.split("."),i=n[0];for("content"===i?(r=t.getContent(),n.shift()):"type"===i?(r=t.getType(),n.shift()):r=t.event;n.length>0;){var s=n.shift();if((0,o.isNullOrUndefined)(r[s]))return null;r=r[s]}return r},m=function(t,r){var i=function(t,r){if(!r||!r.device)return null;if(t.getSender()==e.credentials.userId)return null;for(var i=Object.keys(r.device),o=0;o<i.length;++o){var s=i[o],a=r.device[s],u=n(a,s);if(u)return u}return n(t,r.global)}(t,r);if(!i)return{};var o=u.actionListToActionsObject(i.actions);return void 0===o.tweaks.highlight&&(o.tweaks.highlight="content"==i.kind),o};this.ruleMatchesEvent=function(e,t){for(var r=!0,n=0;n<e.conditions.length;++n){var i=e.conditions[n];r&=c(i,t)}return r},this.actionsForEvent=function(t){var r=function(e){var t=JSON.parse(JSON.stringify(e));e.global||(e.global={}),e.global.override||(e.global.override=[]);var r=e.global.override,n=!0,i=!1,o=void 0;try{for(var s,u=function(){var e=s.value;if(!r.find((function(t){return t.rule_id===e.rule_id}))){var t=e.rule_id;console.warn("Adding default global override for ".concat(t)),r.push(e)}},c=a[Symbol.iterator]();!(n=(s=c.next()).done);n=!0)u()}catch(e){i=!0,o=e}finally{try{n||null==c.return||c.return()}finally{if(i)throw o}}return t}(e.pushRules);return m(t,r)},this.getPushRuleById=function(t){for(var r=0,n=["device","global"];r<n.length;r++){var i=n[r];if(void 0!==e.pushRules[i]){var o=!0,a=!1,u=void 0;try{for(var c,l=s[Symbol.iterator]();!(o=(c=l.next()).done);o=!0){var d=c.value;if(void 0!==e.pushRules[i][d]){var h=!0,p=!1,f=void 0;try{for(var v,g=e.pushRules[i][d][Symbol.iterator]();!(h=(v=g.next()).done);h=!0){var m=v.value;if(m.rule_id===t)return m}}catch(e){p=!0,f=e}finally{try{h||null==g.return||g.return()}finally{if(p)throw f}}}}}catch(e){a=!0,u=e}finally{try{o||null==l.return||l.return()}finally{if(a)throw u}}}}return null}}u.actionListToActionsObject=function(e){for(var t={notify:!1,tweaks:{}},r=0;r<e.length;++r){var n=e[r];"notify"===n?t.notify=!0:"object"===(0,i.default)(n)&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t},u.rewriteDefaultRules=function(e){var t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.override=t.global.override.map((function(e){var t=a.find((function(t){return t.rule_id===e.rule_id}));return t?(e.default=t.default,e.conditions=t.conditions,e.actions=t.actions,e):e})),t}},{"./utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/typeof":21}],104:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.randomString=function(e){let t="";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;++n)t+=r.charAt(Math.floor(Math.random()*r.length));return t}},{}],105:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.setNow=function(e){c=e||Date.now},r.setTimeout=function(e,t){(t=t||0)<0&&(t=0);var r=Array.prototype.slice.call(arguments,2),n=c()+t,i=s++;u("setTimeout: scheduling cb",i,"at",n,"(delay",t,")");var o={runAt:n,func:e,params:r,key:i},d=function(e,t){var r=0,n=e.length;for(;r<n;){var i=r+n>>1;t(e[i])>0?n=i:r=i+1}return r}(a,(function(e){return e.runAt-n}));return a.splice(d,0,o),l(),i},r.clearTimeout=function(e){if(0===a.length)return;var t;for(t=0;t<a.length;t++){if(a[t].key==e){a.splice(t,1);break}}0===t&&l()};var n,i=e("./logger"),o=1e3,s=0,a=[],u=function(){};var c=Date.now;function l(){n&&t.clearTimeout(n);var e=a[0];if(e){var r=c(),i=Math.min(e.runAt-r,o);u("_scheduleRealCallback: now:",r,"delay:",i),n=t.setTimeout(d,i)}else u("_scheduleRealCallback: no more callbacks, not rescheduling")}function d(){var e,r=c();u("_runCallbacks: now:",r);for(var n=[];;){var o=a[0];if(!o||o.runAt>r)break;e=a.shift(),u("_runCallbacks: popping",e.key),n.push(e)}l();for(var s=0;s<n.length;s++){e=n[s];try{e.func.apply(t,e.params)}catch(e){i.logger.error("Uncaught exception in callback function",e.stack||e)}}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":89}],106:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixScheduler=a;var i=n(e("./utils")),o=e("./logger"),s=!1;function a(e,t){this.retryAlgorithm=e||a.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||a.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function u(e){e._procFn&&i.forEach(i.filter(i.keys(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),l("Spinning up queue: '%s'",t),function e(t,r){var n=function(e,t){var r=e._queues[t];if(!i.isArray(r))return null;return r[0]}(t,r);if(!n){var o=t._activeQueues.indexOf(r);return o>=0&&t._activeQueues.splice(o,1),void l("Stopping queue '%s' as it is now empty",r)}l("Queue '%s' has %s pending events",r,t._queues[r].length),Promise.resolve().then((function(){return t._procFn(n.event)})).then((function(i){c(t,r),l("Queue '%s' sent event %s",r,n.event.getId()),n.defer.resolve(i),e(t,r)}),(function(i){n.attempts+=1;var o=t.retryAlgorithm(n.event,n.attempts,i);l("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,i,n.event.getId(),o),-1===o?(l("Queue '%s' giving up on event %s",r,n.event.getId()),c(t,r),n.defer.reject(i),e(t,r)):setTimeout((function(){e(t,r)}),o)}))}(e,t)}))}function c(e,t){var r=e._queues[t];return i.isArray(r)?r.shift():null}function l(){s&&o.logger.log.apply(o.logger,arguments)}a.prototype.getQueueForEvent=function(e){var t=this.queueAlgorithm(e);return t&&this._queues[t]?i.map(this._queues[t],(function(e){return e.event})):null},a.prototype.removeEventFromQueue=function(e){var t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;var r=!1;return i.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return r=!0,!0})),r},a.prototype.setProcessFunction=function(e){this._procFn=e,u(this)},a.prototype.queueEvent=function(e){var t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);var r=i.defer();return this._queues[t].push({event:e,defer:r,attempts:0}),l("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),u(this),r.promise},a.RETRY_BACKOFF_RATELIMIT=function(e,t,r){if(400===r.httpStatus||403===r.httpStatus||401===r.httpStatus)return-1;if("rejected"===r.cors)return-1;if("M_TOO_LARGE"===r.name)return-1;if("M_LIMIT_EXCEEDED"===r.name){var n=r.data.retry_after_ms;if(n)return n}return t>4?-1:1e3*Math.pow(2,t)},a.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},{"./logger":89,"./utils":117,"@babel/runtime/helpers/interopRequireWildcard":11}],107:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SERVICE_TYPES=void 0;var n=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"});r.SERVICE_TYPES=n},{}],108:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.LocalIndexedDBStoreBackend=g;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/slicedToArray")),a=e("../sync-accumulator"),u=n(e("../utils")),c=n(e("../indexeddb-helpers")),l=e("../logger");function d(e,t,r){var n=e.openCursor(t);return new Promise((function(e,t){var i=[];n.onerror=function(e){t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=function(t){var n=t.target.result;n?(i.push(r(n)),n.continue()):e(i)}}))}function h(e){return new Promise((function(t,r){e.oncomplete=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function p(e){return new Promise((function(t,r){e.onsuccess=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function f(e){return new Promise((function(t,r){e.onsuccess=function(){return t(e)},e.onerror=function(e){return r(e)}}))}function v(e){return p(e).then((function(e){return e.target.result}))}function g(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new a.SyncAccumulator,this._isNewlyCreated=!1}g.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),c.exists(e,t)},g.prototype={connect:function(){var e=this;if(!this._disconnected)return l.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,l.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");var t=this.indexedDB.open(this._dbName,3);return t.onupgradeneeded=function(t){var r=t.target.result,n=t.oldVersion;l.logger.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(n)),n<1&&(e._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(r)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(r),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(r)},t.onblocked=function(){l.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},l.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),p(t).then((function(t){return l.logger.log("LocalIndexedDBStoreBackend.connect: connected"),e.db=t.target.result,e.db.onversionchange=function(){e.db.close()},e._init()}))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){var e=this;return Promise.all([this._loadAccountData(),this._loadSyncData()]).then((function(t){var r=(0,s.default)(t,2),n=r[0],i=r[1];l.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),e._syncAccumulator.accumulate({next_batch:i.nextBatch,rooms:i.roomsData,groups:i.groupsData,account_data:{events:n}})}))},getOutOfBandMembers:function(e){var t=this;return new Promise((function(r,n){var i=t.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),o=IDBKeyRange.only(e),s=i.openCursor(o),a=[],u=!1;s.onsuccess=function(e){var t=e.target.result;if(!t)return a.length||u?r(a):r(null);var n=t.value;n.oob_written?u=!0:a.push(n),t.continue()},s.onerror=function(e){n(e)}})).then((function(t){return l.logger.log("LL: got ".concat(t&&t.length)+" membershipEvents from storage for room ".concat(e," ...")),t}))},setOutOfBandMembers:function(e,t){var r,n,i;return o.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return l.logger.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e)),r=this.db.transaction(["oob_membership_events"],"readwrite"),n=r.objectStore("oob_membership_events"),t.forEach((function(e){n.put(e)})),i={room_id:e,oob_written:!0,state_key:0},n.put(i),s.next=8,o.default.awrap(h(r));case 8:l.logger.log("LL: backend done storing for ".concat(e,"!"));case 9:case"end":return s.stop()}}),null,this)},clearOutOfBandMembers:function(e){var t,r,n,i,a,u,c,d,h,p,g,m,y;return o.default.async((function(_){for(;;)switch(_.prev=_.next){case 0:return t=this.db.transaction(["oob_membership_events"],"readonly"),r=t.objectStore("oob_membership_events"),n=r.index("room"),i=IDBKeyRange.only(e),a=v(n.openKeyCursor(i,"next")).then((function(e){return e&&e.primaryKey[1]})),u=v(n.openKeyCursor(i,"prev")).then((function(e){return e&&e.primaryKey[1]})),_.next=8,o.default.awrap(Promise.all([a,u]));case 8:return c=_.sent,d=(0,s.default)(c,2),h=d[0],p=d[1],g=this.db.transaction(["oob_membership_events"],"readwrite"),m=g.objectStore("oob_membership_events"),y=IDBKeyRange.bound([e,h],[e,p]),l.logger.log("LL: Deleting all users + marker in storage for "+"room ".concat(e,", with key range:"),[e,h],[e,p]),_.next=18,o.default.awrap(f(m.delete(y)));case 18:case"end":return _.stop()}}),null,this)},clearDatabase:function(){var e=this;return new Promise((function(t,r){l.logger.log("Removing indexeddb instance: ".concat(e._dbName));var n=e.indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){l.logger.log("can't yet delete indexeddb ".concat(e._dbName)+" because it is open elsewhere")},n.onerror=function(e){l.logger.warn("unable to delete js-sdk store indexeddb: ".concat(e.target.error)),t()},n.onsuccess=function(){l.logger.log("Removed indexeddb instance: ".concat(e._dbName)),t()}}))},getSavedSync:function(e){void 0===e&&(e=!0);var t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(u.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){var t=this;return Promise.resolve().then((function(){t._syncAccumulator.accumulate(e)}))},syncToDatabase:function(e){var t=this._syncAccumulator.getJSON();return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,r){var n=this;return l.logger.log("Persisting sync data up to ",e),u.promiseTry((function(){var i=n.db.transaction(["sync"],"readwrite");return i.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:r}),h(i)}))},_persistAccountData:function(e){var t=this;return u.promiseTry((function(){for(var r=t.db.transaction(["accountData"],"readwrite"),n=r.objectStore("accountData"),i=0;i<e.length;i++)n.put(e[i]);return h(r)}))},_persistUserPresenceEvents:function(e){var t=this;return u.promiseTry((function(){var r=t.db.transaction(["users"],"readwrite"),n=r.objectStore("users"),i=!0,o=!1,s=void 0;try{for(var a,u=e[Symbol.iterator]();!(i=(a=u.next()).done);i=!0){var c=a.value;n.put({userId:c[0],event:c[1]})}}catch(e){o=!0,s=e}finally{try{i||null==u.return||u.return()}finally{if(o)throw s}}return h(r)}))},getUserPresenceEvents:function(){var e=this;return u.promiseTry((function(){return d(e.db.transaction(["users"],"readonly").objectStore("users"),void 0,(function(e){return[e.value.userId,e.value.event]}))}))},_loadAccountData:function(){var e=this;return l.logger.log("LocalIndexedDBStoreBackend: loading account data..."),u.promiseTry((function(){return d(e.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(function(e){return e.value})).then((function(e){return l.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e}))}))},_loadSyncData:function(){var e=this;return l.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),u.promiseTry((function(){return d(e.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(function(e){return e.value})).then((function(e){return l.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&l.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{}}))}))},getClientOptions:function(){var e=this;return Promise.resolve().then((function(){return d(e.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(function(e){if(e.value&&e.value&&e.value.options)return e.value.options})).then((function(e){return e[0]}))}))},storeClientOptions:function(e){var t;return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=this.db.transaction(["client_options"],"readwrite"),t.objectStore("client_options").put({clobber:"-",options:e}),r.next=5,o.default.awrap(h(t));case 5:case"end":return r.stop()}}),null,this)}}},{"../indexeddb-helpers":87,"../logger":89,"../sync-accumulator":114,"../utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23}],109:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.RemoteIndexedDBStoreBackend=o;var n=e("../logger"),i=e("../utils");function o(e,t,r){this._workerScript=e,this._dbName=t,this._workerApi=r,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}o.prototype={connect:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("connect")}))},clearDatabase:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("clearDatabase")}))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then((function(){n.logger.log("IndexedDB worker is ready")}))),this._startPromise},_doCmd:function(e,t){var r=this;return Promise.resolve().then((function(){var n=r._nextSeq++,o=(0,i.defer)();return r._inFlight[n]=o,r._worker.postMessage({command:e,seq:n,args:t}),o.promise}))},_onWorkerMessage:function(e){var t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void n.logger.error("Got reply from worker with no seq");var r=this._inFlight[t.seq];if(void 0===r)return void n.logger.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)r.resolve(t.result);else{var i=new Error(t.error.message);i.name=t.error.name,r.reject(i)}}else n.logger.warn("Unrecognised message from worker: "+t)}}},{"../logger":89,"../utils":117}],110:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IndexedDBStore=v;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/slicedToArray")),a=e("./memory"),u=n(e("../utils")),c=e("events"),l=e("./indexeddb-local-backend.js"),d=e("./indexeddb-remote-backend.js"),h=e("../models/user"),p=e("../models/event"),f=e("../logger");function v(e){if(a.MemoryStore.call(this,e),!e.indexedDB)throw new Error("Missing required option: indexedDB");if(e.workerScript){var r=e.workerApi;r||(r=t.Worker),this.backend=new d.RemoteIndexedDBStoreBackend(e.workerScript,e.dbName,r)}else this.backend=new l.LocalIndexedDBStoreBackend(e.indexedDB,e.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function g(e,t){return function(){var r,n,i,s,u=arguments;return o.default.async((function(c){for(;;)switch(c.prev=c.next){case 0:for(r=u.length,n=new Array(r),i=0;i<r;i++)n[i]=u[i];return c.prev=1,c.next=4,o.default.awrap(e.call.apply(e,[this].concat(n)));case 4:return c.abrupt("return",c.sent);case 7:return c.prev=7,c.t0=c.catch(1),f.logger.error("IndexedDBStore failure, degrading to MemoryStore",c.t0),this.emit("degraded",c.t0),c.prev=11,f.logger.log("IndexedDBStore trying to delete degraded data"),c.next=15,o.default.awrap(this.backend.clearDatabase());case 15:f.logger.log("IndexedDBStore delete after degrading succeeeded"),c.next=21;break;case 18:c.prev=18,c.t1=c.catch(11),f.logger.warn("IndexedDBStore delete after degrading failed",c.t1);case 21:if(Object.setPrototypeOf(this,a.MemoryStore.prototype),!t){c.next=26;break}return c.next=25,o.default.awrap((s=a.MemoryStore.prototype[t]).call.apply(s,[this].concat(n)));case 25:return c.abrupt("return",c.sent);case 26:case"end":return c.stop()}}),null,this,[[1,7],[11,18]])}}u.inherits(v,a.MemoryStore),u.extend(v.prototype,c.EventEmitter.prototype),v.exists=function(e,t){return l.LocalIndexedDBStoreBackend.exists(e,t)},v.prototype.startup=function(){var e=this;return this.startedUp?(f.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(f.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((function(){return f.logger.log("IndexedDBStore.startup: loading presence events"),e.backend.getUserPresenceEvents()})).then((function(t){f.logger.log("IndexedDBStore.startup: processing presence events"),t.forEach((function(t){var r=(0,s.default)(t,2),n=r[0],i=r[1],o=new h.User(n);i&&o.setPresenceEvent(new p.MatrixEvent(i)),e._userModifiedMap[o.userId]=o.getLastModifiedTime(),e.storeUser(o)}))})))},v.prototype.getSavedSync=g((function(){return this.backend.getSavedSync()}),"getSavedSync"),v.prototype.isNewlyCreated=g((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),v.prototype.getSavedSyncToken=g((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),v.prototype.deleteAllData=g((function(){return a.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then((function(){f.logger.log("Deleted indexeddb data.")}),(function(e){throw f.logger.error("Failed to delete indexeddb data: ".concat(e)),e}))})),v.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},v.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},v.prototype._reallySave=g((function(){this._syncTs=Date.now();var e=[],t=!0,r=!1,n=void 0;try{for(var i,o=this.getUsers()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var s=i.value;this._userModifiedMap[s.userId]!==s.getLastModifiedTime()&&(s.events.presence&&(e.push([s.userId,s.events.presence.event]),this._userModifiedMap[s.userId]=s.getLastModifiedTime()))}}catch(e){r=!0,n=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw n}}return this.backend.syncToDatabase(e)})),v.prototype.setSyncData=g((function(e){return this.backend.setSyncData(e)}),"setSyncData"),v.prototype.getOutOfBandMembers=g((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),v.prototype.setOutOfBandMembers=g((function(e,t){return a.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),v.prototype.clearOutOfBandMembers=g((function(e){return a.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),v.prototype.getClientOptions=g((function(){return this.backend.getClientOptions()}),"getClientOptions"),v.prototype.storeClientOptions=g((function(e){return a.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"../models/event":94,"../models/user":102,"../utils":117,"./indexeddb-local-backend.js":108,"./indexeddb-remote-backend.js":109,"./memory":111,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/helpers/slicedToArray":19,"@babel/runtime/regenerator":23,events:32}],111:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.MemoryStore=s;var i=e("../models/user"),o=n(e("../utils"));function s(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}s.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return o.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));var t=this;e.currentState.getMembers().forEach((function(r){t._onRoomMember(null,e.currentState,r)}))},_onRoomMember:function(e,t,r){if("invite"!==r.membership){var n=this.users[r.userId]||new i.User(r.userId);r.name&&(n.setDisplayName(r.name),r.events.member&&n.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&n.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[n.userId]=n}},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return o.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return o.map(o.values(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return o.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;try{return this.localStorage.getItem("mxjssdk_memory_filter_"+e)}catch(e){}return null},setFilterIdByName:function(e,t){if(this.localStorage)try{this.localStorage.setItem("mxjssdk_memory_filter_"+e,t)}catch(e){}},storeAccountDataEvents:function(e){var t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},{"../models/user":102,"../utils":117,"@babel/runtime/helpers/interopRequireWildcard":11}],112:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.WebStorageSessionStore=u;var i=n(e("../../utils")),o=e("../../logger"),s=!1,a="session.e2e.";function u(e){if(this.store=e,!(i.isFunction(e.getItem)&&i.isFunction(e.setItem)&&i.isFunction(e.removeItem)&&i.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}u.prototype={removeEndToEndAccount:function(){this.store.removeItem(c)},getEndToEndAccount:function(){return this.store.getItem(c)},getAllEndToEndDevices:function(){for(var e=p(""),t={},r=0;r<this.store.length;++r){var n=this.store.key(r),i=n.substr(e.length);n.startsWith(e)&&(t[i]=g(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return g(this.store,d)},getEndToEndDeviceSyncToken:function(){return g(this.store,l)},removeEndToEndDeviceData:function(){y(this.store,p("")),y(this.store,d),y(this.store,l)},getEndToEndSessions:function(e){return g(this.store,f(e))},getAllEndToEndSessions:function(){var e=m(this.store,f("")),t={},r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;t[a.substr(f("").length)]=g(this.store,a)}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return t},removeAllEndToEndSessions:function(){y(this.store,f(""))},getAllEndToEndInboundGroupSessionKeys:function(){for(var e=a+"inboundgroupsessions/",t=[],r=0;r<this.store.length;r++){var n=this.store.key(r);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){var r=function(e,t){return a+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(r)},removeAllEndToEndInboundGroupSessions:function(){y(this.store,a+"inboundgroupsessions/")},getAllEndToEndRooms:function(){var e=m(this.store,v("")),t={},r=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var a=o.value;t[a.substr(v("").length)]=g(this.store,a)}}catch(e){n=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw i}}return t},removeAllEndToEndRooms:function(){y(this.store,v(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(h,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(h)}};var c=a+"account",l=a+"device_sync_token",d=a+"device_tracking",h=a+"trusted_backup_pubkey";function p(e){return a+"devices/"+e}function f(e){return a+"sessions/"+e}function v(e){return a+"rooms/"+e}function g(e,t){try{return JSON.parse(e.getItem(t))}catch(e){_("Failed to get key %s: %s",t,e),_(e.stack)}return null}function m(e,t){for(var r=[],n=0;n<e.length;++n){var i=e.key(n);i.startsWith(t)&&r.push(i)}return r}function y(e,t){for(var r=[],n=0;n<e.length;++n){var i=e.key(n);i.startsWith(t)&&r.push(i)}for(var o=0,s=r;o<s.length;o++){var a=s[o];e.removeItem(a)}}function _(){s&&o.logger.log.apply(o.logger,arguments)}},{"../../logger":89,"../../utils":117,"@babel/runtime/helpers/interopRequireWildcard":11}],113:[function(e,t,r){"use strict";function n(){this.fromToken=null}Object.defineProperty(r,"__esModule",{value:!0}),r.StubStore=n,n.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}},{}],114:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SyncAccumulator=void 0;var i=n(e("@babel/runtime/helpers/classCallCheck")),o=n(e("@babel/runtime/helpers/createClass")),s=e("./logger"),a=e("./utils"),u=function(){function e(t){(0,i.default)(this,e),(t=t||{}).maxTimelineEntries=t.maxTimelineEntries||50,this.opts=t,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}return(0,o.default)(e,[{key:"accumulate",value:function(e){this._accumulateRooms(e),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}},{key:"_accumulateAccountData",value:function(e){var t=this;e.account_data&&e.account_data.events&&e.account_data.events.forEach((function(e){t.accountData[e.type]=e}))}},{key:"_accumulateRooms",value:function(e){var t=this;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((function(r){t._accumulateRoom(r,"invite",e.rooms.invite[r])})),e.rooms.join&&Object.keys(e.rooms.join).forEach((function(r){t._accumulateRoom(r,"join",e.rooms.join[r])})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((function(r){t._accumulateRoom(r,"leave",e.rooms.leave[r])})))}},{key:"_accumulateRoom",value:function(e,t,r){switch(t){case"invite":this._accumulateInviteState(e,r);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,r);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:s.logger.error("Unknown cateogory: ",t)}}},{key:"_accumulateInviteState",value:function(e,t){if(t.invite_state&&t.invite_state.events)if(this.inviteRooms[e]){var r=this.inviteRooms[e];t.invite_state.events.forEach((function(e){for(var t=!1,n=0;n<r.invite_state.events.length;n++){var i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)}))}else this.inviteRooms[e]={invite_state:t.invite_state}}},{key:"_accumulateJoinState",value:function(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});var r=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((function(e){r._accountData[e.type]=e})),t.unread_notifications&&(r._unreadNotifications=t.unread_notifications),t.summary){var n=r._summary,i=t.summary;n["m.heroes"]=i["m.heroes"]||n["m.heroes"],n["m.joined_member_count"]=i["m.joined_member_count"]||n["m.joined_member_count"],n["m.invited_member_count"]=i["m.invited_member_count"]||n["m.invited_member_count"]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((function(e){"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach((function(t){e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach((function(n){r._readReceipts[n]={data:e.content[t]["m.read"][n],eventId:t}}))}))})),t.timeline&&t.timeline.limited&&(r._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((function(e){c(r._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach((function(e,n){c(r._currentState,e),r._timeline.push({event:e,token:0===n?t.timeline.prev_batch:null})})),r._timeline.length>this.opts.maxTimelineEntries)for(var o=r._timeline.length-this.opts.maxTimelineEntries;o<r._timeline.length;o++)if(r._timeline[o].token){r._timeline=r._timeline.slice(o,r._timeline.length);break}}},{key:"_accumulateGroups",value:function(e){var t=this;e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach((function(r){t._accumulateGroup(r,"invite",e.groups.invite[r])})),e.groups.join&&Object.keys(e.groups.join).forEach((function(r){t._accumulateGroup(r,"join",e.groups.join[r])})),e.groups.leave&&Object.keys(e.groups.leave).forEach((function(r){t._accumulateGroup(r,"leave",e.groups.leave[r])})))}},{key:"_accumulateGroup",value:function(e,t,r){for(var n=0,i=["invite","join","leave"];n<i.length;n++){var o=i[n];delete this.groups[o][e]}this.groups[t][e]=r}},{key:"getJSON",value:function(){var e=this,t={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((function(r){t.invite[r]=e.inviteRooms[r]})),Object.keys(this.joinRooms).forEach((function(r){var n=e.joinRooms[r],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach((function(e){i.account_data.events.push(n._accountData[e])}));var o={type:"m.receipt",room_id:r,content:{}};Object.keys(n._readReceipts).forEach((function(e){var t=n._readReceipts[e];o.content[t.eventId]||(o.content[t.eventId]={"m.read":{}}),o.content[t.eventId]["m.read"][e]=t.data})),Object.keys(o.content).length>0&&i.ephemeral.events.push(o),n._timeline.forEach((function(e){if(!i.timeline.prev_batch){if(!e.token)return;i.timeline.prev_batch=e.token}i.timeline.events.push(e.event)}));for(var s=Object.create(null),u=i.timeline.events.length-1;u>=0;u--){var l=i.timeline.events[u];if(null!==l.state_key&&void 0!==l.state_key){var d=(0,a.deepCopy)(l);d.unsigned&&(d.unsigned.prev_content&&(d.content=d.unsigned.prev_content),d.unsigned.prev_sender&&(d.sender=d.unsigned.prev_sender)),c(s,d)}}Object.keys(n._currentState).forEach((function(e){Object.keys(n._currentState[e]).forEach((function(t){var r=n._currentState[e][t];s[e]&&s[e][t]&&(r=s[e][t]),i.state.events.push(r)}))})),t.join[r]=i}));var r=[];return Object.keys(this.accountData).forEach((function(t){r.push(e.accountData[t])})),{nextBatch:this.nextBatch,roomsData:t,groupsData:this.groups,accountData:r}}},{key:"getNextBatchToken",value:function(){return this.nextBatch}}]),e}();function c(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}r.SyncAccumulator=u},{"./logger":89,"./utils":117,"@babel/runtime/helpers/classCallCheck":4,"@babel/runtime/helpers/createClass":6,"@babel/runtime/helpers/interopRequireDefault":10}],115:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SyncApi=y;var o=i(e("@babel/runtime/regenerator")),s=e("./models/user"),a=e("./models/room"),u=e("./models/group"),c=n(e("./utils")),l=e("./filter"),d=e("./models/event-timeline"),h=e("./pushprocessor"),p=e("./logger"),f=e("./errors"),v=!0;function g(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function m(){v&&p.logger.log.apply(p.logger,arguments)}function y(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function _(e,t){var r=new s.User(t);return e.reEmitter.reEmit(r,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),r}y.prototype.createRoom=function(e){var t=this.client,r=t.timelineSupport,n=t.unstableClientRelationAggregation,i=new a.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:r,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(i,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(i),i},y.prototype.createGroup=function(e){var t=this.client,r=new u.Group(e);return t.reEmitter.reEmit(r,["Group.profile","Group.myMembership"]),t.store.storeGroup(r),r},y.prototype._registerStateListeners=function(e){var t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,r,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},y.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},y.prototype.syncLeftRooms=function(){var e=this.client,t=this,r=new l.Filter(this.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);var n=this.opts.pollTimeout+8e4,i={timeout:0};return e.getOrCreateFilter(g(e.credentials.userId,"LEFT_ROOMS"),r).then((function(t){return i.filter=t,e._http.authedRequest(void 0,"GET","/sync",i,void 0,n)})).then((function(r){var n=[];r.rooms&&r.rooms.leave&&(n=t._mapSyncResponseToRoomArray(r.rooms.leave));var i=[];return n.forEach((function(r){var n=r.room;if(i.push(n),r.isBrandNewRoom){r.timeline=r.timeline||{};var o=t._mapSyncEventsFormat(r.timeline,n),s=t._mapSyncEventsFormat(r.state,n);n.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,d.EventTimeline.BACKWARDS),t._processRoomEvents(n,s,o),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,o)}})),i}))},y.prototype.peek=function(e){var t=this,r=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then((function(n){n.messages=n.messages||{},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];var i=t.createRoom(e),o=c.map(c.deepCopy(n.state),r.getEventMapper()),s=c.map(n.state,r.getEventMapper()),a=c.map(n.messages.chunk,r.getEventMapper());return n.presence&&c.isArray(n.presence)&&n.presence.map(r.getEventMapper()).forEach((function(e){var t=r.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=_(r,e.getContent().user_id)).setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),n.messages.start&&(i.oldState.paginationToken=n.messages.start),i.oldState.setStateEvents(o),i.currentState.setStateEvents(s),t._resolveInvites(i),i.recalculate(),i.addEventsToTimeline(a.reverse(),!0,i.getLiveTimeline(),n.messages.start),r.store.storeRoom(i),r.emit("Room",i),t._peekPoll(i),i}))},y.prototype.stopPeeking=function(){this._peekRoomId=null},y.prototype._peekPoll=function(e,t){if(this._peekRoomId===e.roomId){var r=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(r._peekRoomId===e.roomId){t.chunk.filter((function(e){return"m.presence"===e.type})).map(r.client.getEventMapper()).forEach((function(e){var t=r.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=_(r.client,e.getContent().user_id)).setPresenceEvent(e),r.client.store.storeUser(t)),r.client.emit("event",e)}));var n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(r.client.getEventMapper());e.addLiveEvents(n),r._peekPoll(e,t.end)}else m("Stopped peeking in room %s",e.roomId)}),(function(n){p.logger.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){r._peekPoll(e,t)}),3e4)}))}else m("Stopped peeking in room %s",e.roomId)},y.prototype.getSyncState=function(){return this._syncState},y.prototype.getSyncStateData=function(){return this._syncStateData},y.prototype.recoverFromSyncStartupError=function(e,t){var r;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.default.awrap(e);case 2:return r=this._startKeepAlives(),this._updateSyncState("ERROR",{error:t}),n.next=6,o.default.awrap(r);case 6:case"end":return n.stop()}}),null,this)},y.prototype._wasLazyLoadingToggled=function(e){var t,r;return o.default.async((function(n){for(;;)switch(n.prev=n.next){case 0:return e=!!e,t=!1,n.next=4,o.default.awrap(this.client.store.isNewlyCreated());case 4:if(n.sent){n.next=11;break}return n.next=8,o.default.awrap(this.client.store.getClientOptions());case 8:return(r=n.sent)&&(t=!!r.lazyLoadMembers),n.abrupt("return",t!==e);case 11:return n.abrupt("return",!1);case 12:case"end":return n.stop()}}),null,this)},y.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(p.logger.warn("Token no longer valid - assuming logout"),this.stop(),!0)},y.prototype.sync=function(){var e=this,r=this.client,n=this;this._running=!0,t.document&&(this._onOnlineBound=this._onOnline.bind(this),t.document.addEventListener("online",this._onOnlineBound,!1));var i=Promise.resolve(),s=null;var a=function(){var t,n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(m("Checking lazy load status..."),e.opts.lazyLoadMembers&&r.isGuest()&&(e.opts.lazyLoadMembers=!1),!e.opts.lazyLoadMembers){i.next=24;break}return m("Checking server lazy load support..."),i.next=6,o.default.awrap(r.doesServerSupportLazyLoading());case 6:if(!i.sent){i.next=22;break}return i.prev=8,m("Creating and storing lazy load sync filter..."),i.next=12,o.default.awrap(r.createFilter(l.Filter.LAZY_LOADING_SYNC_FILTER));case 12:e.opts.filter=i.sent,m("Created and stored lazy load sync filter"),i.next=20;break;case 16:throw i.prev=16,i.t0=i.catch(8),p.logger.error("Creating and storing lazy load sync filter failed",i.t0),i.t0;case 20:i.next=24;break;case 22:m("LL: lazy loading requested but not supported by server, so disabling"),e.opts.lazyLoadMembers=!1;case 24:return m("Checking whether lazy loading has changed in store..."),i.next=27,o.default.awrap(e._wasLazyLoadingToggled(e.opts.lazyLoadMembers));case 27:if(!i.sent){i.next=35;break}return e._storeIsInvalid=!0,t=f.InvalidStoreError.TOGGLED_LAZY_LOADING,n=new f.InvalidStoreError(t,!!e.opts.lazyLoadMembers),e._updateSyncState("ERROR",{error:n}),p.logger.warn("InvalidStoreError: store is not usable: stopping sync."),i.abrupt("return");case 35:return e.opts.lazyLoadMembers&&e.opts.crypto&&e.opts.crypto.enableLazyLoading(),i.prev=36,m("Storing client options..."),i.next=40,o.default.awrap(e.client._storeClientOptions());case 40:m("Stored client options"),i.next=47;break;case 43:throw i.prev=43,i.t1=i.catch(36),p.logger.error("Storing client options failed",i.t1),i.t1;case 47:u();case 48:case"end":return i.stop()}}),null,null,[[8,16],[36,43]])};function u(){var e,t;return o.default.async((function(a){for(;;)switch(a.prev=a.next){case 0:return m("Getting filter..."),n.opts.filter?e=n.opts.filter:(e=new l.Filter(r.credentials.userId)).setTimelineLimit(n.opts.initialSyncLimit),a.prev=2,a.next=5,o.default.awrap(r.getOrCreateFilter(g(r.credentials.userId),e));case 5:t=a.sent,a.next=18;break;case 8:if(a.prev=8,a.t0=a.catch(2),p.logger.error("Getting filter failed",a.t0),!n._shouldAbortSync(a.t0)){a.next=13;break}return a.abrupt("return");case 13:return m("Waiting for saved sync before retrying filter..."),a.next=16,o.default.awrap(n.recoverFromSyncStartupError(i,a.t0));case 16:return u(),a.abrupt("return");case 18:return r.resetNotifTimelineSet(),null===n._currentSyncRequest&&(m("Sending first sync request..."),n._currentSyncRequest=n._doSyncRequest({filterId:t},s)),m("Waiting for saved sync before starting sync processing..."),a.next=23,o.default.awrap(i);case 23:n._sync({filterId:t});case 24:case"end":return a.stop()}}),null,null,[[2,8]])}r.isGuest()?n._sync({}):(m("Getting saved sync token..."),i=r.store.getSavedSyncToken().then((function(e){return m("Got saved sync token"),s=e,m("Getting saved sync..."),r.store.getSavedSync()})).then((function(e){if(m("Got reply from saved sync, exists? ".concat(!!e)),e)return n._syncFromCache(e)})).catch((function(e){p.logger.error("Getting saved sync failed",e)})),function e(){var t;return o.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.prev=0,m("Getting push rules..."),s.next=4,o.default.awrap(r.getPushRules());case 4:t=s.sent,m("Got push rules"),r.pushRules=t,s.next=19;break;case 9:if(s.prev=9,s.t0=s.catch(0),p.logger.error("Getting push rules failed",s.t0),!n._shouldAbortSync(s.t0)){s.next=14;break}return s.abrupt("return");case 14:return m("Waiting for saved sync before retrying push rules..."),s.next=17,o.default.awrap(n.recoverFromSyncStartupError(i,s.t0));case 17:return e(),s.abrupt("return");case 19:a();case 20:case"end":return s.stop()}}),null,null,[[0,9]])}())},y.prototype.stop=function(){m("SyncApi.stop"),t.document&&(t.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},y.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},y.prototype._syncFromCache=function(e){var t,r,n;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:return m("sync(): not doing HTTP hit, instead returning stored /sync data"),t=e.nextBatch,this.client.store.setSyncToken(t),r={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}},i.prev=5,i.next=8,o.default.awrap(this._processSyncResponse(r,n));case 8:i.next=13;break;case 10:i.prev=10,i.t0=i.catch(5),p.logger.error("Error processing cached sync",i.t0.stack||i.t0);case 13:this._storeIsInvalid||this._updateSyncState("PREPARED",r);case 14:case"end":return i.stop()}}),null,this,[[5,10]])},y.prototype._sync=function(e){var t,r,n,i;return o.default.async((function(s){for(;;)switch(s.prev=s.next){case 0:if(t=this.client,this._running){s.next=6;break}return m("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),this._updateSyncState("STOPPED"),s.abrupt("return");case 6:return r=t.store.getSyncToken(),s.prev=7,null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,r)),s.next=11,o.default.awrap(this._currentSyncRequest);case 11:n=s.sent,s.next=18;break;case 14:return s.prev=14,s.t0=s.catch(7),this._onSyncError(s.t0,e),s.abrupt("return");case 18:return s.prev=18,this._currentSyncRequest=null,s.finish(18);case 21:return t.store.setSyncToken(n.next_batch),this._failedSyncCount=0,s.next=25,o.default.awrap(t.store.setSyncData(n));case 25:if(i={oldSyncToken:r,nextSyncToken:n.next_batch,catchingUp:this._catchingUp},!this.opts.crypto){s.next=29;break}return s.next=29,o.default.awrap(this.opts.crypto.onSyncWillProcess(i));case 29:return s.prev=29,s.next=32,o.default.awrap(this._processSyncResponse(i,n));case 32:s.next=38;break;case 34:s.prev=34,s.t1=s.catch(29),p.logger.error("Caught /sync error",s.t1.stack||s.t1),this.client.emit("sync.unexpectedError",s.t1);case 38:if(i.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",i),e.hasSyncedBefore=!0),!this.opts.crypto){s.next=43;break}return s.next=43,o.default.awrap(this.opts.crypto.onSyncCompleted(i));case 43:if(this._updateSyncState("SYNCING",i),!t.store.wantsSave()){s.next=49;break}if(!this.opts.crypto){s.next=48;break}return s.next=48,o.default.awrap(this.opts.crypto.saveDeviceList(0));case 48:t.store.save();case 49:this._sync(e);case 50:case"end":return s.stop()}}),null,this,[[7,14,18,21],[29,34]])},y.prototype._doSyncRequest=function(e,t){var r=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",r,void 0,r.timeout+8e4)},y.prototype._getSyncParams=function(e,t){var r=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,r=0);var n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());var i={filter:n,timeout:r};return this.opts.disablePresence&&(i.set_presence="offline"),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i},y.prototype._onSyncError=function(e,t){var r=this;if(!this._running)return m("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");p.logger.error("/sync error %s",e),p.logger.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,p.logger.log("Number of consecutive failed sync requests:",this._failedSyncCount),m("Starting keep-alive"),this._startKeepAlives().then((function(e){e&&"ERROR"===r.getSyncState()&&r._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),r._sync(t)})),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},y.prototype._processSyncResponse=function(e,t){var r,n,i,s,a,u,l,f;return o.default.async((function(v){for(;;)switch(v.prev=v.next){case 0:return r=this.client,n=this,t.presence&&c.isArray(t.presence.events)&&t.presence.events.map(r.getEventMapper()).forEach((function(e){var t=r.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=_(r,e.getSender())).setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),t.account_data&&c.isArray(t.account_data.events)&&(i=t.account_data.events.map(r.getEventMapper()),r.store.storeAccountDataEvents(i),i.forEach((function(e){if("m.push_rules"===e.getType()){var t=e.getContent();r.pushRules=h.PushProcessor.rewriteDefaultRules(t)}return r.emit("accountData",e),e}))),t.to_device&&c.isArray(t.to_device.events)&&t.to_device.events.length>0?(s=[],t.to_device.events.map(r.getEventMapper()).map((function(e){if("m.key.verification.cancel"===e.getType()){var t=e.getContent().transaction_id;t&&s.push(t)}return e})).forEach((function(e){var t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){var n=t.transaction_id;s.includes(n)&&e.flagCancelled()}r.emit("toDeviceEvent",e)}else p.logger.log("Ignoring undecryptable to-device event from "+e.getSender())}))):this._catchingUp=!1,t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave")),a=[],u=[],l=[],t.rooms&&(t.rooms.invite&&(a=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(u=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(l=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],a.forEach((function(e){var t=e.room,i=n._mapSyncEventsFormat(e.invite_state,t);n._processRoomEvents(t,i),e.isBrandNewRoom&&(t.recalculate(),r.store.storeRoom(t),r.emit("Room",t)),i.forEach((function(e){r.emit("event",e)})),t.updateMyMembership("invite")})),v.next=14,o.default.awrap(c.promiseMapSeries(u,(function(t){var i,s,a,u,l,h,p,f,v,g;return o.default.async((function(y){for(;;)switch(y.prev=y.next){case 0:if(g=function(e){var t;return o.default.async((function(i){for(;;)switch(i.prev=i.next){case 0:if(r.emit("event",e),!e.isState()||"m.room.encryption"!=e.getType()||!n.opts.crypto){i.next=4;break}return i.next=4,o.default.awrap(n.opts.crypto.onCryptoEvent(e));case 4:e.isState()&&"im.vector.user_status"===e.getType()&&((t=r.store.getUser(e.getStateKey()))?t._unstable_updateStatusMessage(e):((t=_(r,e.getStateKey()))._unstable_updateStatusMessage(e),r.store.storeUser(t)));case 5:case"end":return i.stop()}}))},i=t.room,s=n._mapSyncEventsFormat(t.state,i),a=n._mapSyncEventsFormat(t.timeline,i),u=n._mapSyncEventsFormat(t.ephemeral),l=n._mapSyncEventsFormat(t.account_data),t.unread_notifications&&(i.setUnreadNotificationCount("total",t.unread_notifications.notification_count),(!(h=r.isRoomEncrypted(i.roomId))||h&&i.getUnreadNotificationCount("highlight")<=0)&&i.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)),t.timeline=t.timeline||{},!t.isBrandNewRoom){y.next=12;break}i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,d.EventTimeline.BACKWARDS),y.next=26;break;case 12:if(!t.timeline.limited){y.next=26;break}p=!0,f=a.length-1;case 15:if(!(f>=0)){y.next=25;break}if(v=a[f].getId(),!i.getTimelineForEvent(v)){y.next=22;break}return m("Already have event "+v+" in limited sync - not resetting"),p=!1,a.splice(0,f),y.abrupt("break",25);case 22:f--,y.next=15;break;case 25:p&&(n._deregisterStateListeners(i),i.resetLiveTimeline(t.timeline.prev_batch,n.opts.canResetEntireTimeline(i.roomId)?null:e.oldSyncToken),r.resetNotifTimelineSet(),n._registerStateListeners(i));case 26:return n._processRoomEvents(i,s,a,e.fromCache),t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(u),i.addAccountData(l),i.recalculate(),t.isBrandNewRoom&&(r.store.storeRoom(i),r.emit("Room",i)),n._processEventsForNotifs(i,a),y.next=35,o.default.awrap(c.promiseMapSeries(s,g));case 35:return y.next=37,o.default.awrap(c.promiseMapSeries(a,g));case 37:u.forEach((function(e){r.emit("event",e)})),l.forEach((function(e){r.emit("event",e)})),i.updateMyMembership("join");case 40:case"end":return y.stop()}}))})));case 14:if(l.forEach((function(e){var t=e.room,i=n._mapSyncEventsFormat(e.state,t),o=n._mapSyncEventsFormat(e.timeline,t),s=n._mapSyncEventsFormat(e.account_data);n._processRoomEvents(t,i,o),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(r.store.storeRoom(t),r.emit("Room",t)),n._processEventsForNotifs(t,o),i.forEach((function(e){r.emit("event",e)})),o.forEach((function(e){r.emit("event",e)})),s.forEach((function(e){r.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){r.getNotifTimelineSet().addLiveEvent(e)}))),!t.device_lists){v.next=22;break}if(!this.opts.crypto){v.next=22;break}return v.next=20,o.default.awrap(this.opts.crypto.handleDeviceListChanges(e,t.device_lists));case 20:v.next=22;break;case 22:this.opts.crypto&&t.device_one_time_keys_count&&(f=t.device_one_time_keys_count.signed_curve25519||0,this.opts.crypto.updateOneTimeKeyCount(f));case 23:case"end":return v.stop()}}),null,this)},y.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);return e>0?this._keepAliveTimer=setTimeout(this._pokeKeepAlive.bind(this),e):this._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=c.defer()),this._connectionReturnedDefer.promise},y.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);var t=this;function r(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){r()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(r,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},y.prototype._processGroupSyncEntry=function(e,t){for(var r=0,n=Object.keys(e);r<n.length;r++){var i=n[r],o=e[i],s=this.client.store.getGroup(i),a=null===s;null===s&&(s=this.createGroup(i)),o.profile&&s.setProfile(o.profile.name,o.profile.avatar_url),o.inviter&&s.setInviter({userId:o.inviter}),s.setMyMembership(t),a&&this.client.emit("Group",s)}},y.prototype._mapSyncResponseToRoomArray=function(e){var t=this.client,r=this;return c.keys(e).map((function(n){var i=e[n],o=t.store.getRoom(n),s=!1;return o||(o=r.createRoom(n),s=!0),i.room=o,i.isBrandNewRoom=s,i}))},y.prototype._mapSyncEventsFormat=function(e,t){if(!e||!c.isArray(e.events))return[];var r=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),r(e)}))},y.prototype._resolveInvites=function(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership("invite").forEach((function(r){if(!r._requestedProfileInfo){r._requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then((function(t){var n=r.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}}))}},y.prototype._processRoomEvents=function(e,t,r,n){var i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){var s=!0,a=!1,u=void 0;try{for(var c,l=t[Symbol.iterator]();!(s=(c=l.next()).done);s=!0){var d=c.value;this.client.getPushActionsForEvent(d)}}catch(e){a=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(a)throw u}}i.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(r||[],null,n)},y.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(var r=0;r<t.length;r++){var n=this.client.getPushActionsForEvent(t[r]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this._notifEvents.push(t[r])}},y.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},y.prototype._updateSyncState=function(e,t){var r=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,r,t)},y.prototype._onOnline=function(){m("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./errors":83,"./filter":85,"./logger":89,"./models/event-timeline":93,"./models/group":95,"./models/room":100,"./models/user":102,"./pushprocessor":103,"./utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23}],116:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.TimelineWindow=o,r.TimelineIndex=s;var n=e("./models/event-timeline"),i=(e("./logger"),function(){});function o(e,t,r){r=r||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=r.windowLimit||1e3}function s(e,t){this.timeline=e,this.index=t}o.prototype.load=function(e,t){var r=this;t=t||20;var n=function(n){var i,o=n.getEvents();if(e){for(var a=0;a<o.length;a++)if(o[a].getId()==e){i=a;break}if(void 0===i)throw new Error("getEventTimeline result didn't include requested event")}else i=o.length;var u=Math.min(o.length,i+Math.ceil(t/2)),c=Math.max(0,u-t);r._start=new s(n,c-n.getBaseIndex()),r._end=new s(n,u-n.getBaseIndex()),r._eventCount=u-c};if(e){var i=this._timelineSet.getTimelineForEvent(e);return i?(n(i),Promise.resolve(i)):this._client.getEventTimeline(this._timelineSet,e).then(n)}return n(this._timelineSet.getLiveTimeline()),Promise.resolve()},o.prototype.getTimelineIndex=function(e){if(e==n.EventTimeline.BACKWARDS)return this._start;if(e==n.EventTimeline.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},o.prototype.extend=function(e,t){var r=this.getTimelineIndex(e);if(!r)return i("TimelineWindow: no timeline yet"),!1;var o=e==n.EventTimeline.BACKWARDS?r.retreat(t):r.advance(t);if(o){this._eventCount+=o,i("TimelineWindow: increased cap by "+o+" (now "+this._eventCount+")");var s=this._eventCount-this._windowLimit;return s>0&&this.unpaginate(s,e!=n.EventTimeline.BACKWARDS),!0}return!1},o.prototype.canPaginate=function(e){var t=this.getTimelineIndex(e);if(!t)return i("TimelineWindow: no timeline yet"),!1;if(e==n.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},o.prototype.paginate=function(e,t,r,o){void 0===r&&(r=!0),void 0===o&&(o=5);var s=this.getTimelineIndex(e);if(!s)return i("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!r||0===o)return Promise.resolve(!1);if(!s.timeline.getPaginationToken(e))return i("TimelineWindow: no token"),Promise.resolve(!1);i("TimelineWindow: starting request");var a=this,u=this._client.paginateEventTimeline(s.timeline,{backwards:e==n.EventTimeline.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then((function(r){return i("TimelineWindow: request completed with result "+r),!!r&&a.paginate(e,t,!0,o-1)}));return s.pendingPaginate=u,u},o.prototype.unpaginate=function(e,t){var r=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,i("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},o.prototype.getEvents=function(){if(!this._start)return[];for(var e=[],t=this._start.timeline;;){var r=t.getEvents(),i=0,o=r.length;t===this._start.timeline&&(i=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(var s=i;s<o;s++)e.push(r[s]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(n.EventTimeline.FORWARDS)}return e},s.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},s.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},s.prototype.advance=function(e){if(!e)return 0;var t;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?n.EventTimeline.BACKWARDS:n.EventTimeline.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),i("paginate: switched to new neighbour"),this.advance(e)):0},s.prototype.retreat=function(e){return-1*this.advance(-1*e)}},{"./logger":89,"./models/event-timeline":93}],117:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0});const i=e("unhomoglyph");r.encodeParams=function(e){let t="";for(const r in e)e.hasOwnProperty(r)&&(t+="&"+encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.substring(1)},r.encodeUri=function(e,t){for(const r in t)t.hasOwnProperty(r)&&(e=e.replace(r,encodeURIComponent(t[r])));return e},r.map=function(e,t){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=t(e[n]);return r},r.filter=function(e,t){const r=[];for(let n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r},r.keys=function(e){const t=[];for(const r in e)e.hasOwnProperty(r)&&t.push(r);return t},r.values=function(e){const t=[];for(const r in e)e.hasOwnProperty(r)&&t.push(e[r]);return t},r.forEach=function(e,t){for(let r=0;r<e.length;r++)t(e[r],r)},r.findElement=function(e,t,r){let n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e[n]}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e[n]},r.removeElement=function(e,t,r){let n,i;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i;return!1},r.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},r.isArray=function(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)},r.checkObjectHasKeys=function(e,t){for(let r=0;r<t.length;r++)if(!e.hasOwnProperty(t[r]))throw new Error("Missing required key: "+t[r])},r.checkObjectHasNoAdditionalKeys=function(e,t){for(const r in e)if(e.hasOwnProperty(r)&&-1===t.indexOf(r))throw new Error("Unknown key: "+r)},r.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},r.deepCompare=function e(t,r){if(t===r)return!0;if(typeof t!=typeof r)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(r))return!0;if(null===t||null===r)return t===r;if(!(t instanceof Object))return!1;if(t.constructor!==r.constructor||t.prototype!==r.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===r.toString();if(t instanceof Array){if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1}else{let n;for(n in r)if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;for(n in r){if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}}return!0},r.extend=function(){const e=arguments[0]||{};for(let t=1;t<arguments.length;t++){const r=arguments[t];for(const t in r)e[t]=r[t]}return e},r.runPolyfills=function(){Array.prototype.filter||(Array.prototype.filter=function(e){if(null==this)throw new TypeError;const t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError;const n=[],i=arguments.length>=2?arguments[1]:void 0;for(let o=0;o<r;o++)if(o in t){const r=t[o];e.call(i,r,o,t)&&n.push(r)}return n}),Array.prototype.map||(Array.prototype.map=function(e,t){let r,n;if(null==this)throw new TypeError(" this is null or not defined");const i=Object(this),o=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");arguments.length>1&&(r=t);const s=new Array(o);for(n=0;n<o;){let t,o;n in i&&(t=i[n],o=e.call(r,t,n,i),s[n]=o),n++}return s}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){let r,n;if(null==this)throw new TypeError(" this is null or not defined");const i=Object(this),o=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(r=t),n=0;n<o;){let t;n in i&&(t=i[n],e.call(r,t,n,i)),n++}})},r.inherits=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},r.polyfillSuper=function(e,t,...r){try{t.call(e,...r)}catch(n){const i=new t(...r);Object.assign(e,i)}},r.isNumber=function(e){return"number"==typeof e&&isFinite(e)},r.removeHiddenChars=function(e){return i.default(e.normalize("NFD").replace(o,""))};const o=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function s(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}r.escapeRegExp=s,r.globToRegexp=function(e,t){t="boolean"!=typeof t||t;let r=s(e);return r=r.replace(/\\\*/g,".*"),r=r.replace(/\?/g,"."),t&&(r=r.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,r,n,i){return"["+(t?"^":"")+r.replace(/\\-/,"-")+"]"}))),r},r.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e},r.sleep=function(e,t){return new Promise(r=>{setTimeout(r,e,t)})},r.isNullOrUndefined=function(e){return null==e},r.defer=function(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});return{resolve:e,reject:t,promise:r}},r.promiseMapSeries=function(e,t){return n(this,void 0,void 0,(function*(){for(const r of yield e)yield t(yield r)}))},r.promiseTry=function(e){return new Promise(t=>t(e()))}},{unhomoglyph:46}],118:[function(e,t,r){(function(t){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixCall=c,r.setAudioOutput=function(e){l=e},r.setAudioInput=function(e){d=e},r.setVideoInput=function(e){h=e},r.createNewMatrixCall=function(e,r,n){var i=t.window,o=t.document;if(!i||!o)return null;var a={};a.isOpenWebRTC=function(){var e=o.getElementById("script");if(!e||!e.length)return!1;for(var t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1};var u=i.navigator.getUserMedia||i.navigator.webkitGetUserMedia||i.navigator.mozGetUserMedia;u&&(a.getUserMedia=function(){return u.apply(i.navigator,arguments)});try{a.RtcPeerConnection=i.RTCPeerConnection||i.webkitRTCPeerConnection||i.mozRTCPeerConnection,a.RtcSessionDescription=i.RTCSessionDescription||i.webkitRTCSessionDescription||i.mozRTCSessionDescription,a.RtcIceCandidate=i.RTCIceCandidate||i.webkitRTCIceCandidate||i.mozRTCIceCandidate,a.vendor=null,i.mozRTCPeerConnection?a.vendor="mozilla":i.webkitRTCPeerConnection?a.vendor="webkit":i.RTCPeerConnection&&(a.vendor="generic")}catch(e){return s.logger.error("Failed to set up WebRTC object: possible browser interference?"),s.logger.error(e),null}if(!(a.RtcIceCandidate&&a.RtcSessionDescription&&a.RtcPeerConnection&&a.getUserMedia))return null;var l=!!n&&n.forceTURN;return new c({webRtc:a,client:e,URL:i.URL,roomId:r,turnServers:e.getTurnServers(),forceTURN:e._forceTURN||l})};var o=i(e("@babel/runtime/regenerator")),s=e("../logger"),a=e("events"),u=n(e("../utils"));function c(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[c.FALLBACK_ICE_SERVER]}),u.forEach(this.turnServers,(function(e){u.checkObjectHasKeys(e,["urls"])})),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=Object.create(null),this.screenSharingStream=null,this._answerContent=null}c.CALL_TIMEOUT_MS=6e4,c.FALLBACK_ICE_SERVER="stun:turn.matrix.org",c.ERR_LOCAL_OFFER_FAILED="local_offer_failed",c.ERR_NO_USER_MEDIA="no_user_media",c.ERR_UNKNOWN_DEVICES="unknown_devices",c.ERR_SEND_INVITE="send_invite",c.ERR_SEND_ANSWER="send_answer",u.inherits(c,a.EventEmitter),c.prototype.placeVoiceCall=function(){w("placeVoiceCall"),k(this),R(this,O("voice")),this.type="voice"},c.prototype.placeVideoCall=function(e,t){w("placeVideoCall"),k(this),this.localVideoElement=t,this.remoteVideoElement=e,R(this,O("video")),this.type="video",b(this)},c.prototype.placeScreenSharingCall=function(e,t){w("placeScreenSharingCall"),k(this);var r=x(this);if(r){this.localVideoElement=t,this.remoteVideoElement=e;var n=this;this.webRtc.getUserMedia(r,(function(e){n.screenSharingStream=e,w("Got screen stream, requesting audio stream...");var t=O("voice");R(n,t)}),(function(e){n.emit("error",E(c.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))})),this.type="video",b(this)}},c.prototype.playElement=function(e,t){s.logger.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return s.logger.log("previous promise completed for "+t),e.play()}),(function(){return s.logger.log("previous promise failed for "+t),e.play()})):this.mediaPromises[t]=e.play()},c.prototype.pauseElement=function(e,t){s.logger.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return s.logger.log("previous promise completed for "+t),e.pause()}),(function(){return s.logger.log("previous promise failed for "+t),e.pause()})):this.mediaPromises[t]=e.pause()},c.prototype.assignElement=function(e,t,r){s.logger.log("queuing assign on "+r+" element "+e+" for "+t),this.mediaPromises[r]?this.mediaPromises[r]=this.mediaPromises[r].then((function(){s.logger.log("previous promise completed for "+r),e.srcObject=t}),(function(){s.logger.log("previous promise failed for "+r),e.srcObject=t})):e.srcObject=t},c.prototype.getLocalVideoElement=function(){return this.localVideoElement},c.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},c.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},c.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;var t=this;setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)}},c.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,b(this)},c.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,S(this)},c.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=T(this);var t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),C(t,t._onSetRemoteDescriptionSuccess),C(t,t._onSetRemoteDescriptionError)),v(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout((function(){"ringing"==t.state&&(w("Call invite has expired. Hanging up."),t.hangupParty="remote",v(t,"ended"),_(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))}),this.msg.lifetime-e.getAge())},c.prototype._initWithHangup=function(e){this.msg=e.getContent(),v(this,"ended")},c.prototype.answer=function(){w("Answering call %s of type %s",this.callId,this.type);this._answerContent?this._sendAnswer():this.localAVStream||this.waitForLocalAVStream?this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&v(this,"wait_local_media"):(this.webRtc.getUserMedia(O(this.type),C(this,this._maybeGotUserMediaForAnswer),C(this,this._maybeGotUserMediaForAnswer)),v(this,"wait_local_media"))},c.prototype._replacedBy=function(e){w(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(w("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):"create_offer"==this.state?(w("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream):"invite_sent"==this.state&&(w("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},c.prototype.hangup=function(e,t){if("ended"!=this.state){w("Ending call "+this.callId),y(this,"local",e,!t);var r={version:0,call_id:this.callId,reason:e};g(this,"m.call.hangup",r)}},c.prototype.setLocalVideoMuted=function(e){this.localAVStream&&p(this.localAVStream.getVideoTracks(),!e)},c.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!f(this.localAVStream.getVideoTracks())},c.prototype.setMicrophoneMuted=function(e){this.localAVStream&&p(this.localAVStream.getAudioTracks(),!e)},c.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!f(this.localAVStream.getAudioTracks())},c.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)this.successor._maybeGotUserMediaForAnswer(e);else if("ended"!=this.state){w("_maybeGotUserMediaForInvite -> "+this.type);var t=this,r=e,n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){var i=this.getLocalVideoElement();i&&"video"==this.type&&(i.autoplay=!0,this.screenSharingStream?(w("Setting screen sharing stream to the local video element"),this.assignElement(i,this.screenSharingStream,"localVideo")):this.assignElement(i,e,"localVideo"),i.muted=!0,setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,p(e.getAudioTracks(),!0),this.peerConn=T(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return w("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);w("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=T(this)}this.peerConn.createOffer(C(t,t._gotLocalOffer),C(t,t._getLocalOfferFailed),n),v(t,"create_offer")}},c.prototype._sendAnswer=function(e){var t=this;g(this,"m.call.answer",this._answerContent).then((function(){v(t,"connecting"),I(t)})).catch((function(e){v(t,"ringing"),t.client.cancelPendingEvent(e.event);var r=c.ERR_SEND_ANSWER,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(r=c.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.emit("error",E(r,n)),e}))},c.prototype._maybeGotUserMediaForAnswer=function(e){var t=this;if("ended"!=t.state){var r=e;if(e instanceof MediaStream){var n=t.getLocalVideoElement();n&&"video"==t.type&&(n.autoplay=!0,this.assignElement(n,e,"localVideo"),n.muted=!0,setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),t.localAVStream=e,p(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return w("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);w("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}var i={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer((function(e){w("Created answer: ",e),t.peerConn.setLocalDescription(e,(function(){t._answerContent={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}},t._sendAnswer()}),(function(){w("Error setting local description!")}),i)}),(function(e){w("Failed to create answer: "+e)})),v(t,"create_answer")}},c.prototype._gotLocalIceCandidate=function(e){if(e.candidate){if(w("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),"ended"==this.state)return;var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};m(this,t)}},c.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(w("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),(function(){}),(function(e){})))},c.prototype._receivedAnswer=function(e){if("ended"!=this.state){this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),C(this,this._onSetRemoteDescriptionSuccess),C(this,this._onSetRemoteDescriptionError)),v(this,"connecting")}},c.prototype._gotLocalOffer=function(e){var t=this;w("Created offer: ",e),"ended"!=t.state?t.peerConn.setLocalDescription(e,(function(){var e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:c.CALL_TIMEOUT_MS};g(t,"m.call.invite",e).then((function(){v(t,"invite_sent"),setTimeout((function(){"invite_sent"==t.state&&t.hangup("invite_timeout")}),c.CALL_TIMEOUT_MS)})).catch((function(e){var r=c.ERR_SEND_INVITE,n="Failed to send invite";throw"UnknownDeviceError"==e.name&&(r=c.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.client.cancelPendingEvent(e.event),y(t,"local",r,!1),t.emit("error",E(r,n)),e}))}),(function(){w("Error setting local description!")})):w("Ignoring newly created offer on call ID "+t.callId+" because the call has ended")},c.prototype._getLocalOfferFailed=function(e){this.emit("error",E(c.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},c.prototype._getUserMediaFailed=function(e){y(this,"local","user_media_failed",!1),this.emit("error",E(c.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?"))},c.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(w("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(v(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},c.prototype._onSignallingStateChanged=function(){w("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},c.prototype._onSetRemoteDescriptionSuccess=function(){w("Set remote description")},c.prototype._onSetRemoteDescriptionError=function(e){w("Failed to set remote description"+e)},c.prototype._onAddStream=function(e){w("Stream id "+e.stream.id+" added");var t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);var r=this;D(t,(function(e){w("Track id "+e.id+" added"),e.onstarted=C(r,r._onRemoteStreamTrackStarted)})),void 0!==e.stream.oninactive?e.stream.oninactive=C(r,r._onRemoteStreamEnded):e.stream.onended=C(r,r._onRemoteStreamEnded),e.stream.onstarted=C(r,r._onRemoteStreamStarted),"video"===this.type?(b(this),S(this)):S(this)},c.prototype._onRemoteStreamStarted=function(e){v(this,"connected")},c.prototype._onRemoteStreamEnded=function(e){w("Remote stream ended"),this.hangupParty="remote",v(this,"ended"),_(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},c.prototype._onRemoteStreamTrackStarted=function(e){v(this,"connected")},c.prototype._onHangupReceived=function(e){w("Hangup received"),y(this,"remote",e.reason,!0)},c.prototype._onAnsweredElsewhere=function(e){w("Answered elsewhere"),y(this,"remote","answered_elsewhere",!0)};var l,d,h,p=function(e,t){for(var r=0;r<e.length;r++)e[r].enabled=t},f=function(e){for(var t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},v=function(e,t){var r=e.state;e.state=t,e.emit("state",t,r)},g=function(e,t,r){return e.client.sendEvent(e.roomId,t,r)},m=function(e,t){e.candidateSendQueue.push(t),"ringing"!=e.state&&0===e.candidateSendTries&&setTimeout((function(){I(e)}),100)},y=function(e,t,r,n){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=r,v(e,"ended"),_(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),n&&e.emit("hangup",e)},_=function(e){w("stopAllMedia (stream=%s)",e.localAVStream),e.localAVStream&&(D(e.localAVStream,(function(e){e.stop&&e.stop()})),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(D(e.screenSharingStream,(function(e){e.stop&&e.stop()})),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&D(e.remoteAVStream,(function(e){e.stop&&e.stop()})),e.remoteAStream&&D(e.remoteAStream,(function(e){e.stop&&e.stop()}))},b=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){var t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout((function(){var t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&v(e,"connected")}),0)}},S=function(e){var t;return o.default.async((function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.getRemoteAudioElement()||!e.remoteAStream){r.next=8;break}if(t=e.getRemoteAudioElement(),!l){r.next=5;break}return r.next=5,o.default.awrap(t.setSinkId(l));case 5:t.autoplay=!0,e.assignElement(t,e.remoteAStream,"remoteAudio"),setTimeout((function(){var t=e.getRemoteAudioElement();t.play&&e.playElement(t,"remoteAudio"),e.webRtc.isOpenWebRTC()&&v(e,"connected")}),0);case 8:case"end":return r.stop()}}))},k=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},E=function(e,t){var r=new Error(t);return r.code=e,r},w=function(){s.logger.log.apply(s.logger,arguments)},I=function e(t){if(0!==t.candidateSendQueue.length){var r=t.candidateSendQueue;t.candidateSendQueue=[],++t.candidateSendTries;var n={version:0,call_id:t.callId,candidates:r};w("Attempting to send "+r.length+" candidates"),g(t,"m.call.candidates",n).then((function(){t.candidateSendTries=0,e(t)}),(function(n){for(var i=0;i<r.length;i++)t.candidateSendQueue.push(r[i]);if(t.candidateSendTries>5)return w("Failed to send candidates on attempt %s. Giving up for now.",t.candidateSendTries),void(t.candidateSendTries=0);var o=500*Math.pow(2,t.candidateSendTries);++t.candidateSendTries,w("Failed to send candidates. Retrying in "+o+"ms"),setTimeout((function(){e(t)}),o)}))}},R=function(e,t){e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,C(e,e._maybeGotUserMediaForInvite),C(e,e._maybeGotUserMediaForInvite)),v(e,"wait_local_media"),e.direction="outbound",e.config=t},T=function(e){var t=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:e.turnServers});return t.oniceconnectionstatechange=C(e,e._onIceConnectionStateChanged),t.onsignalingstatechange=C(e,e._onSignallingStateChanged),t.onicecandidate=C(e,e._gotLocalIceCandidate),t.onaddstream=C(e,e._onAddStream),t},x=function(e){var r=t.screen;if(r)return{video:{mediaSource:"screen",mandatory:{chromeMediaSource:"screen",chromeMediaSourceId:""+Date.now(),maxWidth:r.width,maxHeight:r.height,minFrameRate:1,maxFrameRate:10}}};e.emit("error",E(c.ERR_NO_USER_MEDIA,"Couldn't determine screen sharing constaints."))},O=function(e){var r=!!t.window.navigator.webkitGetUserMedia;switch(e){case"voice":return{audio:{deviceId:d?{ideal:d}:void 0},video:!1};case"video":return{audio:{deviceId:d?{ideal:d}:void 0},video:{deviceId:h?{ideal:h}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}}}},C=function(e,t){return function(){return t.apply(e,arguments)}},D=function(e,t){!function(e,t){for(var r=e.getVideoTracks(),n=0;n<r.length;n++)t(r[n])}(e,t),function(e,t){for(var r=e.getAudioTracks(),n=0;n<r.length;n++)t(r[n])}(e,t)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":89,"../utils":117,"@babel/runtime/helpers/interopRequireDefault":10,"@babel/runtime/helpers/interopRequireWildcard":11,"@babel/runtime/regenerator":23,events:32}]},{},[52]);